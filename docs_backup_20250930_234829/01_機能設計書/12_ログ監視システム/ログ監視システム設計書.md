# ログ監視システム設計書

## 1. 概要

### 1.1 システム概要
社内システムの運用状況を包括的に監視・分析するためのログ監視システムを構築する。
フロントエンド・バックエンド・データベースの各層からログを収集し、リアルタイム監視とログ分析機能を提供する。

### 1.2 目的
- **運用監視**: システムの稼働状況をリアルタイムで監視
- **障害検知**: エラーや異常な動作の早期発見
- **パフォーマンス分析**: システムの性能監視と最適化
- **セキュリティ監査**: 不正アクセスやセキュリティイベントの追跡
- **利用統計**: ユーザー行動とシステム利用傾向の分析

### 1.3 対象範囲
- **フロントエンド**: Vue.js アプリケーションログ
- **バックエンド**: Express.js サーバーログ
- **データベース**: PostgreSQL クエリログ
- **インフラ**: Docker コンテナログ
- **ネットワーク**: API アクセスログ

## 2. ログ分類体系

### 2.1 ログレベル
| レベル | 数値 | 説明 | 用途 |
|--------|------|------|------|
| FATAL | 60 | システム停止レベルの致命的エラー | サービス停止、データ破損 |
| ERROR | 50 | エラー（処理継続可能） | API エラー、認証失敗 |
| WARN | 40 | 警告（注意が必要） | 非推奨機能使用、リソース不足警告 |
| INFO | 30 | 一般情報 | ユーザーアクション、システム状態変更 |
| DEBUG | 20 | デバッグ情報 | 開発時の詳細ログ |
| TRACE | 10 | 詳細トレース | 関数呼び出し、変数値 |

### 2.2 ログカテゴリ
| カテゴリ | 識別子 | 説明 | 例 |
|----------|--------|------|-----|
| 認証 | AUTH | ログイン・認証関連 | ログイン成功/失敗、セッション管理 |
| API | API | APIアクセス | リクエスト/レスポンス、パフォーマンス |
| データベース | DB | データベース操作 | クエリ実行、トランザクション |
| セキュリティ | SEC | セキュリティイベント | 不正アクセス、権限違反 |
| システム | SYS | システム動作 | 起動/停止、設定変更 |
| ユーザー | USER | ユーザー操作 | 画面遷移、データ操作 |
| パフォーマンス | PERF | 性能監視 | 応答時間、リソース使用量 |
| エラー | ERR | エラー詳細 | スタックトレース、エラー詳細 |

### 2.3 ログ構造
```typescript
interface LogEntry {
  // 基本情報
  timestamp: string          // ISO 8601 形式のタイムスタンプ
  level: LogLevel           // ログレベル
  category: LogCategory     // ログカテゴリ
  message: string           // メッセージ本文

  // 追跡情報
  traceId: string          // トレースID（リクエスト追跡用）
  sessionId?: string       // セッションID
  userId?: string          // ユーザーID

  // システム情報
  source: LogSource        // ログソース（frontend/backend/database）
  hostname: string         // ホスト名
  service: string          // サービス名

  // 詳細情報
  details?: Record<string, any>  // 追加詳細情報
  error?: ErrorInfo        // エラー詳細（エラーログの場合）
  performance?: PerformanceInfo  // パフォーマンス情報

  // メタデータ
  tags?: string[]          // タグ
  environment: string      // 環境（development/staging/production）
}
```

## 3. システム構成

### 3.1 アーキテクチャ概要
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Frontend      │    │   Backend       │    │   Database      │
│   (Vue.js)      │    │   (Express)     │    │   (PostgreSQL)  │
├─────────────────┤    ├─────────────────┤    ├─────────────────┤
│ • Client Logs   │    │ • Server Logs   │    │ • Query Logs    │
│ • User Actions  │    │ • API Logs      │    │ • Slow Queries  │
│ • Errors        │    │ • Auth Logs     │    │ • Connection    │
│ • Performance   │    │ • Performance   │    │   Logs          │
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │                      │                      │
          │                      │                      │
          └──────────────────────┼──────────────────────┘
                                 │
                         ┌───────▼────────┐
                         │  Log Collector │
                         │   (Backend)    │
                         └───────┬────────┘
                                 │
                         ┌───────▼────────┐
                         │  Log Storage   │
                         │ (PostgreSQL)   │
                         └───────┬────────┘
                                 │
                         ┌───────▼────────┐
                         │ Log Dashboard  │
                         │  (Frontend)    │
                         └────────────────┘
```

### 3.2 コンポーネント詳細

#### 3.2.1 ログ収集層
- **フロントエンドログ収集**: ブラウザコンソール、ユーザーアクション、エラー
- **バックエンドログ収集**: サーバーログ、APIアクセス、システムイベント
- **データベースログ収集**: クエリログ、パフォーマンスログ

#### 3.2.2 ログ処理層
- **ログ正規化**: 各ソースからのログを統一形式に変換
- **フィルタリング**: ログレベル・カテゴリによる選別
- **エンリッチメント**: 追加情報の付与（地理情報、デバイス情報等）

#### 3.2.3 ログ保存層
- **データベース**: 構造化ログデータの永続化
- **インデックス**: 高速検索のためのインデックス作成
- **ローテーション**: 古いログの自動削除・アーカイブ

#### 3.2.4 ログ分析層
- **リアルタイム監視**: ダッシュボードでの即座な表示
- **アラート**: 閾値を超えた際の通知
- **レポート**: 定期的な分析レポート生成

## 4. データベース設計

### 4.1 ログテーブル (logs)
```sql
CREATE TABLE logs (
  id BIGSERIAL PRIMARY KEY,
  timestamp TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
  level INTEGER NOT NULL,
  category VARCHAR(50) NOT NULL,
  message TEXT NOT NULL,

  -- 追跡情報
  trace_id VARCHAR(100),
  session_id VARCHAR(100),
  user_id INTEGER REFERENCES "User"(id),

  -- システム情報
  source VARCHAR(50) NOT NULL,
  hostname VARCHAR(255),
  service VARCHAR(100),

  -- 詳細情報（JSONB形式）
  details JSONB,
  error_info JSONB,
  performance_info JSONB,

  -- メタデータ
  tags TEXT[],
  environment VARCHAR(50) NOT NULL DEFAULT 'development',

  -- インデックス用
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_logs_timestamp ON logs (timestamp DESC);
CREATE INDEX idx_logs_level ON logs (level);
CREATE INDEX idx_logs_category ON logs (category);
CREATE INDEX idx_logs_source ON logs (source);
CREATE INDEX idx_logs_trace_id ON logs (trace_id);
CREATE INDEX idx_logs_user_id ON logs (user_id);
CREATE INDEX idx_logs_environment ON logs (environment);
CREATE INDEX idx_logs_details_gin ON logs USING GIN (details);
```

### 4.2 ログ統計テーブル (log_statistics)
```sql
CREATE TABLE log_statistics (
  id SERIAL PRIMARY KEY,
  date DATE NOT NULL,
  hour INTEGER CHECK (hour >= 0 AND hour <= 23),
  level INTEGER NOT NULL,
  category VARCHAR(50) NOT NULL,
  source VARCHAR(50) NOT NULL,
  count INTEGER NOT NULL DEFAULT 0,

  UNIQUE(date, hour, level, category, source)
);

CREATE INDEX idx_log_statistics_date ON log_statistics (date DESC);
```

### 4.3 アラート設定テーブル (alert_rules)
```sql
CREATE TABLE alert_rules (
  id SERIAL PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  description TEXT,

  -- 条件
  level INTEGER,
  category VARCHAR(50),
  source VARCHAR(50),
  message_pattern TEXT,

  -- 閾値
  threshold_count INTEGER NOT NULL DEFAULT 1,
  threshold_period INTEGER NOT NULL DEFAULT 300, -- 秒

  -- 通知設定
  notification_channels TEXT[], -- email, slack, webhook

  is_enabled BOOLEAN NOT NULL DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);
```

## 5. API設計

### 5.1 ログ収集API

#### POST /api/logs
```typescript
// ログエントリ送信
interface LogRequest {
  logs: LogEntry[]
}

interface LogResponse {
  success: boolean
  received: number
  errors?: string[]
}
```

#### POST /api/logs/batch
```typescript
// バッチログ送信（大量ログ用）
interface BatchLogRequest {
  logs: LogEntry[]
  compression?: 'gzip' | 'none'
}
```

### 5.2 ログ検索API

#### GET /api/logs/search
```typescript
interface LogSearchParams {
  // 時間範囲
  startTime?: string
  endTime?: string

  // フィルタ
  levels?: LogLevel[]
  categories?: LogCategory[]
  sources?: LogSource[]
  traceId?: string
  userId?: string

  // 検索
  query?: string        // フリーテキスト検索

  // ページング
  page?: number
  pageSize?: number

  // ソート
  sortBy?: 'timestamp' | 'level'
  sortOrder?: 'asc' | 'desc'
}

interface LogSearchResponse {
  logs: LogEntry[]
  total: number
  page: number
  pageSize: number
  hasNext: boolean
}
```

#### GET /api/logs/statistics
```typescript
interface LogStatisticsParams {
  startTime: string
  endTime: string
  groupBy: 'hour' | 'day' | 'category' | 'level'
  categories?: string[]
  levels?: number[]
}

interface LogStatisticsResponse {
  statistics: {
    key: string
    count: number
    percentage: number
  }[]
  total: number
  period: {
    start: string
    end: string
  }
}
```

## 6. フロントエンド設計

### 6.1 ログ監視ダッシュボード

#### 6.1.1 画面構成
```
┌─────────────────────────────────────────────────────────┐
│                   ログ監視ダッシュボード                      │
├─────────────────────────────────────────────────────────┤
│ 🔍 フィルタ                                              │
│ [時間範囲] [レベル] [カテゴリ] [ソース] [検索ワード]          │
├─────────────────────────────────────────────────────────┤
│ 📊 統計情報                                              │
│ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐        │
│ │総ログ数 │ │エラー数 │ │警告数  │ │情報数  │        │
│ │ 12,345  │ │   23   │ │   156  │ │ 12,166 │        │
│ └─────────┘ └─────────┘ └─────────┘ └─────────┘        │
├─────────────────────────────────────────────────────────┤
│ 📈 グラフ表示                                            │
│ ┌─────────────────────────────────────────────────────┐ │
│ │          時系列ログ数グラフ                         │ │
│ │                                                   │ │
│ └─────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│ 📋 ログ一覧                                              │
│ ┌─────────────────────────────────────────────────────┐ │
│ │時刻      │レベル│カテゴリ│メッセージ              │ │
│ │10:30:15  │ERROR │AUTH   │ログイン失敗             │ │
│ │10:29:45  │INFO  │USER   │ユーザー作成             │ │
│ │10:29:30  │WARN  │DB     │スロークエリ検出          │ │
│ └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

#### 6.1.2 主要コンポーネント

##### LogDashboard.vue
```vue
<template>
  <div class="log-dashboard">
    <!-- フィルタセクション -->
    <LogFilters
      v-model="filters"
      @update="handleFilterUpdate"
    />

    <!-- 統計セクション -->
    <LogStatistics
      :data="statistics"
      :loading="statisticsLoading"
    />

    <!-- グラフセクション -->
    <LogCharts
      :data="chartData"
      :loading="chartLoading"
    />

    <!-- ログ一覧セクション -->
    <LogTable
      :logs="logs"
      :loading="tableLoading"
      @load-more="handleLoadMore"
    />
  </div>
</template>
```

##### LogFilters.vue
```vue
<template>
  <el-card class="log-filters">
    <el-form :inline="true" :model="filters">
      <el-form-item label="時間範囲">
        <el-date-picker
          v-model="filters.timeRange"
          type="datetimerange"
          range-separator="〜"
          start-placeholder="開始日時"
          end-placeholder="終了日時"
        />
      </el-form-item>

      <el-form-item label="レベル">
        <el-select v-model="filters.levels" multiple>
          <el-option label="FATAL" value="60" />
          <el-option label="ERROR" value="50" />
          <el-option label="WARN" value="40" />
          <el-option label="INFO" value="30" />
          <el-option label="DEBUG" value="20" />
        </el-select>
      </el-form-item>

      <el-form-item label="カテゴリ">
        <el-select v-model="filters.categories" multiple>
          <el-option label="認証" value="AUTH" />
          <el-option label="API" value="API" />
          <el-option label="データベース" value="DB" />
          <el-option label="セキュリティ" value="SEC" />
        </el-select>
      </el-form-item>

      <el-form-item>
        <el-button type="primary" @click="handleSearch">検索</el-button>
        <el-button @click="handleReset">リセット</el-button>
      </el-form-item>
    </el-form>
  </el-card>
</template>
```

## 7. ログ収集実装

### 7.1 フロントエンドログ収集

#### 7.1.1 LogService.ts
```typescript
export class LogService {
  private static instance: LogService
  private buffer: LogEntry[] = []
  private flushInterval: number = 5000 // 5秒毎に送信

  static getInstance(): LogService {
    if (!LogService.instance) {
      LogService.instance = new LogService()
    }
    return LogService.instance
  }

  // ログエントリ追加
  log(level: LogLevel, category: LogCategory, message: string, details?: any) {
    const entry: LogEntry = {
      timestamp: new Date().toISOString(),
      level,
      category,
      message,
      traceId: this.generateTraceId(),
      sessionId: this.getSessionId(),
      userId: this.getCurrentUserId(),
      source: 'frontend',
      hostname: window.location.hostname,
      service: 'websys-frontend',
      details,
      environment: process.env.NODE_ENV || 'development'
    }

    this.buffer.push(entry)

    // バッファが満杯の場合は即座に送信
    if (this.buffer.length >= 100) {
      this.flush()
    }
  }

  // バッファをサーバーに送信
  private async flush() {
    if (this.buffer.length === 0) return

    const logs = [...this.buffer]
    this.buffer = []

    try {
      await api.post('/api/logs', { logs })
    } catch (error) {
      console.error('ログ送信エラー:', error)
      // エラー時はバッファに戻す
      this.buffer.unshift(...logs)
    }
  }
}

// 便利関数
export const logError = (message: string, error?: any) =>
  LogService.getInstance().log('ERROR', 'ERR', message, { error })

export const logInfo = (message: string, details?: any) =>
  LogService.getInstance().log('INFO', 'USER', message, details)

export const logPerformance = (action: string, duration: number) =>
  LogService.getInstance().log('INFO', 'PERF', `${action} completed`, { duration })
```

#### 7.1.2 グローバルエラーハンドリング
```typescript
// main.ts
import { logError } from '@/utils/LogService'

// 未処理エラーをキャッチ
window.addEventListener('error', (event) => {
  logError('Uncaught error', {
    message: event.message,
    filename: event.filename,
    lineno: event.lineno,
    colno: event.colno,
    stack: event.error?.stack
  })
})

// Promise reject をキャッチ
window.addEventListener('unhandledrejection', (event) => {
  logError('Unhandled promise rejection', {
    reason: event.reason
  })
})
```

### 7.2 バックエンドログ収集

#### 7.2.1 Logger.ts
```typescript
import winston from 'winston'

// カスタム形式
const customFormat = winston.format.combine(
  winston.format.timestamp(),
  winston.format.errors({ stack: true }),
  winston.format.json(),
  winston.format.printf(({ timestamp, level, message, ...meta }) => {
    return JSON.stringify({
      timestamp,
      level: getLogLevelNumber(level),
      category: meta.category || 'SYS',
      message,
      traceId: meta.traceId,
      sessionId: meta.sessionId,
      userId: meta.userId,
      source: 'backend',
      hostname: os.hostname(),
      service: 'websys-backend',
      details: meta.details,
      error: meta.error,
      environment: process.env.NODE_ENV || 'development'
    })
  })
)

export const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: customFormat,
  transports: [
    new winston.transports.Console(),
    new winston.transports.File({
      filename: 'logs/error.log',
      level: 'error'
    }),
    new winston.transports.File({
      filename: 'logs/combined.log'
    })
  ]
})
```

#### 7.2.2 API アクセスログ
```typescript
// middleware/apiLogger.ts
export const apiLogger = (req: Request, res: Response, next: NextFunction) => {
  const startTime = Date.now()

  res.on('finish', () => {
    const duration = Date.now() - startTime

    logger.info('API Request', {
      category: 'API',
      traceId: req.headers['x-trace-id'],
      sessionId: req.sessionId,
      userId: req.user?.id,
      details: {
        method: req.method,
        url: req.url,
        statusCode: res.statusCode,
        duration,
        userAgent: req.headers['user-agent'],
        ip: req.ip
      }
    })
  })

  next()
}
```

## 8. アラート機能

### 8.1 リアルタイムアラート
```typescript
// AlertService.ts
export class AlertService {
  private rules: AlertRule[] = []
  private counters: Map<string, number> = new Map()

  // ログチェック
  checkLog(log: LogEntry) {
    for (const rule of this.rules) {
      if (this.matchesRule(log, rule)) {
        this.incrementCounter(rule)

        if (this.exceedsThreshold(rule)) {
          this.sendAlert(rule, log)
        }
      }
    }
  }

  // アラート送信
  private async sendAlert(rule: AlertRule, log: LogEntry) {
    const alert = {
      ruleName: rule.name,
      message: `Alert: ${rule.name} triggered`,
      log,
      timestamp: new Date().toISOString()
    }

    for (const channel of rule.notificationChannels) {
      switch (channel) {
        case 'email':
          await this.sendEmailAlert(alert)
          break
        case 'slack':
          await this.sendSlackAlert(alert)
          break
        case 'webhook':
          await this.sendWebhookAlert(alert)
          break
      }
    }
  }
}
```

## 9. 実装スケジュール

### 9.1 Phase 1 (1週間): 基盤構築
- [ ] データベーススキーマ作成
- [ ] バックエンドログAPI実装
- [ ] フロントエンドログ収集実装
- [ ] 基本的なログ蓄積機能

### 9.2 Phase 2 (1週間): 監視ダッシュボード
- [ ] ログ検索API実装
- [ ] フロントエンドダッシュボード作成
- [ ] リアルタイム表示機能
- [ ] フィルタ・検索機能

### 9.3 Phase 3 (1週間): 分析・アラート
- [ ] ログ統計・分析機能
- [ ] アラート機能実装
- [ ] レポート生成機能
- [ ] パフォーマンス最適化

### 9.4 Phase 4 (1週間): 高度な機能
- [ ] ログ相関分析
- [ ] 異常検知機能
- [ ] 自動スケーリング連携
- [ ] 運用ツール統合

## 10. 運用・保守

### 10.1 ログ保持期間
- **ERROR/FATAL**: 1年間
- **WARN**: 6ヶ月間
- **INFO**: 3ヶ月間
- **DEBUG/TRACE**: 1ヶ月間

### 10.2 パフォーマンス要件
- **ログ取り込み**: 1000件/秒
- **検索レスポンス**: 500ms以内
- **ダッシュボード更新**: 5秒間隔
- **アラート通知**: 30秒以内

### 10.3 セキュリティ
- **アクセス制御**: RBAC による閲覧権限管理
- **データマスキング**: 個人情報の自動マスキング
- **暗号化**: 保存時暗号化（PostgreSQL TDE）
- **監査ログ**: 監視システム自体のアクセスログ

---

**作成日**: 2025年9月20日
**作成者**: 開発チーム
**バージョン**: 1.0.0
**次回レビュー**: 2025年10月1日