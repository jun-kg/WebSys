# 機能管理システム要件定義書

## 1. システム概要

### 1.1 目的
組織内の部署単位で利用可能な機能を制御し、柔軟なアクセス権限管理を実現するシステムを構築する。

### 1.2 背景
- 組織の規模拡大に伴い、部署ごとに必要な機能が異なる
- セキュリティとコンプライアンスの観点から、適切な権限管理が必要
- システム管理者の負担軽減と効率的な運用が求められている

## 2. 機能要件

### 2.1 ユーザー管理機能の拡張

#### 2.1.1 会社情報管理
- 会社マスタの登録・編集・削除
- 会社コード、会社名、業種、設立日、従業員数などの管理
- 契約プラン情報の管理

#### 2.1.2 部署情報管理
- 部署マスタの登録・編集・削除
- 部署コード、部署名、親部署、部署階層の管理
- 部署の有効/無効状態の管理

#### 2.1.3 ユーザー所属管理
- ユーザーと会社・部署の紐付け
- 複数部署への兼務対応
- 主所属と副所属の概念
- 異動履歴の管理

### 2.2 機能管理

#### 2.2.1 機能マスタ管理
- システム機能の登録・編集・削除
- 機能コード、機能名、機能説明の管理
- 機能カテゴリ（モジュール）の定義
- 機能の階層構造（親機能・子機能）

#### 2.2.2 機能権限設定
- 部署単位での機能利用可否設定
- 機能ごとの操作権限（閲覧・編集・削除・承認）
- 権限の継承ルール（上位部署から下位部署へ）
- 例外権限の設定

### 2.3 権限管理

#### 2.3.1 ロールベース権限
- システム管理者：全機能・全データへのアクセス
- 機能管理者：機能権限の設定・管理
- 部署管理者：所属部署の権限管理
- 一般ユーザー：割り当てられた機能のみ利用可能

#### 2.3.2 権限チェック機能
- ログイン時の利用可能機能判定
- リアルタイムの権限検証
- APIレベルでのアクセス制御
- 画面表示制御（メニュー、ボタンの表示/非表示）

### 2.4 管理機能

#### 2.4.1 権限一覧表示
- 部署別機能権限マトリクス表示
- ユーザー別権限一覧
- 機能別利用部署一覧

#### 2.4.2 権限変更履歴
- 権限変更のログ記録
- 変更者、変更日時、変更内容の記録
- 監査対応のための履歴保持

#### 2.4.3 権限テンプレート
- 部署タイプ別の標準権限セット
- テンプレートの作成・編集・複製
- 一括権限設定機能

## 3. 非機能要件

### 3.1 性能要件
- 権限チェック：100ms以内でレスポンス
- 1000部署、10000ユーザーまでの規模に対応
- 同時接続数：500ユーザー

### 3.2 セキュリティ要件
- 権限情報の暗号化保存
- 不正アクセスの検知・ブロック
- 権限昇格攻撃への対策
- セッション管理の強化

### 3.3 可用性要件
- システム稼働率：99.9%以上
- 権限情報のキャッシュ機能
- 障害時の縮退運転対応

### 3.4 運用要件
- 権限設定のバックアップ・リストア
- 権限設定のエクスポート・インポート
- 定期的な権限棚卸機能

## 4. システム構成

### 4.1 データモデル

#### 主要エンティティ
1. **Company（会社）**
   - id, code, name, industry, established_date, employee_count

2. **Department（部署）**
   - id, company_id, code, name, parent_id, level, is_active

3. **User（ユーザー）** ※既存テーブル拡張
   - 既存フィールド + company_id, primary_department_id

4. **UserDepartment（ユーザー所属）**
   - user_id, department_id, is_primary, assigned_date, role

5. **Feature（機能）**
   - id, code, name, description, category, parent_id, is_active

6. **DepartmentFeature（部署機能権限）**
   - department_id, feature_id, can_view, can_create, can_edit, can_delete, can_approve

7. **FeaturePermissionTemplate（権限テンプレート）**
   - id, name, description, department_type

8. **AuditLog（監査ログ）**
   - id, user_id, action, target_type, target_id, changes, timestamp

### 4.2 システムアーキテクチャ
- フロントエンド：Vue.js + Element Plus
- バックエンド：Express + TypeScript
- データベース：PostgreSQL
- 認証：JWT + 権限情報キャッシュ
- キャッシュ：Redis（オプション）

## 5. 画面構成

### 5.1 管理画面
1. **会社管理画面**
   - 会社一覧・登録・編集・削除

2. **部署管理画面**
   - 部署ツリー表示
   - 部署情報の編集
   - 部署階層の変更

3. **ユーザー管理画面** ※既存画面拡張
   - 所属部署の設定
   - 複数部署への所属設定

4. **機能管理画面**
   - 機能一覧・登録・編集
   - 機能カテゴリ管理

5. **権限設定画面**
   - 部署×機能のマトリクス表示
   - チェックボックスによる権限設定
   - 一括設定機能

6. **権限テンプレート画面**
   - テンプレート一覧・作成・編集
   - テンプレート適用

7. **監査ログ画面**
   - 権限変更履歴の検索・表示
   - CSVエクスポート

### 5.2 ユーザー向け画面
1. **ダッシュボード**
   - 利用可能機能の表示
   - 所属部署情報の表示

2. **メニュー**
   - 権限に基づく動的メニュー生成

## 6. API設計概要

### 6.1 会社・部署管理API
- GET /api/companies
- POST /api/companies
- PUT /api/companies/:id
- DELETE /api/companies/:id
- GET /api/departments
- GET /api/departments/tree
- POST /api/departments
- PUT /api/departments/:id

### 6.2 機能管理API
- GET /api/features
- POST /api/features
- PUT /api/features/:id
- GET /api/features/categories

### 6.3 権限管理API
- GET /api/permissions/department/:departmentId
- POST /api/permissions/department/:departmentId
- GET /api/permissions/user/:userId
- GET /api/permissions/check
- POST /api/permissions/template/apply

### 6.4 監査API
- GET /api/audit/logs
- GET /api/audit/export

## 7. 実装優先順位

### フェーズ1（基本機能）
1. 会社・部署マスタの実装
2. ユーザー所属管理の実装
3. 機能マスタの実装
4. 基本的な権限設定機能

### フェーズ2（権限制御）
1. APIレベルの権限チェック
2. 画面表示制御
3. 権限継承機能
4. 権限キャッシュ機能

### フェーズ3（運用機能）
1. 権限テンプレート機能
2. 監査ログ機能
3. 権限棚卸機能
4. バックアップ・リストア機能

## 8. 移行計画

### 8.1 既存データの移行
- 既存ユーザーデータへのデフォルト会社・部署設定
- 既存機能の機能マスタへの登録
- 初期権限設定の投入

### 8.2 段階的導入
1. 開発環境での検証
2. 限定部署でのパイロット運用
3. 全社展開

## 9. リスクと対策

### 9.1 技術的リスク
- **リスク**：権限チェックによるパフォーマンス低下
- **対策**：キャッシュ機能の実装、インデックスの最適化

### 9.2 運用リスク
- **リスク**：権限設定ミスによるアクセス不可
- **対策**：権限テスト機能、ロールバック機能の実装

### 9.3 セキュリティリスク
- **リスク**：権限昇格攻撃
- **対策**：多層防御、監査ログによる検知

## 10. 成功指標

### 10.1 定量的指標
- 権限設定作業時間：50%削減
- 権限関連の問い合わせ：30%削減
- システムレスポンス：現状維持

### 10.2 定性的指標
- 管理者の運用負荷軽減
- セキュリティレベルの向上
- ユーザー満足度の向上