# システム全体 データ辞書・バリデーション定義書

## 1. 概要

システム全体の項目名、データ型、有効範囲、文字数を統一管理するマスタードキュメントです。
新規項目追加時は必ずこのドキュメントを更新し、全項目の一貫性を保持します。

**最終更新**: 2025-09-27
**管理対象**: 全データベースカラム、API項目、UI項目

## 2. データ型定義

### 2.1 基本データ型

| 型名 | Prisma型 | TypeScript型 | 説明 | 備考 |
|------|----------|--------------|------|------|
| **ID** | Int @id @default(autoincrement()) | number | 主キー | 1〜2,147,483,647 |
| **BigID** | BigInt @id @default(autoincrement()) | bigint | 大容量主キー | ログ等大量データ用 |
| **Code** | String | string | コード値 | 英数字・アンダースコア・ハイフン |
| **Name** | String | string | 名称 | 日本語・英語対応 |
| **Email** | String | string | メールアドレス | RFC5322準拠 |
| **Password** | String | string | パスワード | ハッシュ化後保存 |
| **Phone** | String | string | 電話番号 | ハイフンあり/なし対応 |
| **URL** | String | string | URL | http/https必須 |
| **Timestamp** | DateTime | Date | 日時 | ISO8601形式 |
| **Money** | Decimal(15,2) | number | 金額 | 最大999兆円、小数2桁 |
| **Percentage** | Decimal(5,2) | number | パーセント | 0.00〜100.00 |
| **Json** | Json | object | JSON構造体 | 動的データ保存用 |
| **Flag** | Boolean | boolean | フラグ | true/false |
| **Status** | String | string | ステータス | 定義済み値のみ |
| **Role** | UserRole | UserRole | ユーザー権限 | enum定義 |

### 2.2 文字列サイズ規約

| 用途 | 最小 | 最大 | 推奨 | 例 |
|------|------|------|------|-----|
| **極短コード** | 1 | 10 | 5 | "ADMIN", "JP" |
| **短コード** | 3 | 20 | 15 | "USER_MANAGEMENT" |
| **中コード** | 5 | 50 | 30 | "WORKFLOW_APPROVAL_REQUEST" |
| **短名称** | 1 | 50 | 20 | "ユーザー管理", "承認申請" |
| **中名称** | 1 | 100 | 50 | "申請承認ワークフロー管理システム" |
| **長名称** | 1 | 255 | 100 | "株式会社〇〇 東京本社 システム開発部" |
| **短説明** | 0 | 500 | 200 | "この機能は..." |
| **長説明** | 0 | 2000 | 1000 | 詳細説明・備考欄 |
| **URL** | 1 | 2048 | 255 | "https://example.com" |
| **メール** | 5 | 254 | 50 | "user@example.com" |
| **電話** | 10 | 20 | 15 | "03-1234-5678" |

## 3. 項目辞書

### 3.1 共通項目

| 項目名 | データ型 | 桁数 | 必須 | 初期値 | 説明 | バリデーション |
|--------|----------|------|------|--------|------|----------------|
| **id** | ID | - | ✅ | auto | 主キー | - |
| **createdAt** | Timestamp | - | ✅ | now() | 作成日時 | - |
| **updatedAt** | Timestamp | - | ✅ | now() | 更新日時 | 自動更新 |
| **createdBy** | ID | - | ❌ | null | 作成者ID | 存在チェック |
| **updatedBy** | ID | - | ❌ | null | 更新者ID | 存在チェック |
| **isActive** | Flag | - | ✅ | true | 有効フラグ | - |
| **displayOrder** | Int | - | ✅ | 0 | 表示順序 | 0〜99999 |

### 3.2 ユーザー関連項目

| 項目名 | データ型 | 桁数 | 必須 | 初期値 | 説明 | バリデーション | 使用箇所 |
|--------|----------|------|------|--------|------|----------------|-----------|
| **username** | Code | 3-30 | ✅ | - | ユーザー名 | UNIQUE, 英数字_- | users |
| **email** | Email | 5-254 | ✅ | - | メールアドレス | UNIQUE, EMAIL形式 | users |
| **password** | Password | 1-128 | ✅ | - | パスワード(ハッシュ) | 8文字以上(入力時) | users |
| **name** | 短名称 | 1-50 | ✅ | - | 氏名 | 1文字以上 | users |
| **employeeCode** | Code | 0-20 | ❌ | null | 社員番号 | 英数字-, UNIQUE | users |
| **joinDate** | Timestamp | - | ❌ | null | 入社日 | 過去日付 | users |
| **leaveDate** | Timestamp | - | ❌ | null | 退職日 | joinDate以降 | users |
| **role** | Role | - | ✅ | USER | ユーザー権限 | enum値 | users |
| **lastLoginAt** | Timestamp | - | ❌ | null | 最終ログイン日時 | - | users |

### 3.3 組織関連項目

| 項目名 | データ型 | 桁数 | 必須 | 初期値 | 説明 | バリデーション | 使用箇所 |
|--------|----------|------|------|--------|------|----------------|-----------|
| **companyId** | ID | - | ✅ | - | 会社ID | 存在チェック | 全テーブル |
| **code** | 短コード | 1-20 | ✅ | - | 組織コード | 英数字_-, 会社内UNIQUE | companies, departments |
| **name** | 中名称 | 1-100 | ✅ | - | 組織名 | 1文字以上 | companies, departments |
| **nameKana** | 中名称 | 0-100 | ❌ | null | 組織名(カナ) | カタカナ・ひらがな | companies, departments |
| **parentId** | ID | - | ❌ | null | 親組織ID | 存在チェック、循環参照禁止 | departments |
| **level** | Int | - | ✅ | 1 | 階層レベル | 1〜10 | departments |
| **path** | 長名称 | 0-255 | ❌ | null | 階層パス | "/root/dept1/sub1" | departments |

### 3.4 会社情報項目

| 項目名 | データ型 | 桁数 | 必須 | 初期値 | 説明 | バリデーション | 使用箇所 |
|--------|----------|------|------|--------|------|----------------|-----------|
| **industry** | 短名称 | 0-50 | ❌ | null | 業界 | - | companies |
| **establishedDate** | Timestamp | - | ❌ | null | 設立日 | 過去日付 | companies |
| **employeeCount** | Int | - | ❌ | null | 従業員数 | 1〜999999 | companies |
| **address** | 長名称 | 0-255 | ❌ | null | 住所 | - | companies |
| **phone** | Phone | 10-20 | ❌ | null | 電話番号 | 電話番号形式 | companies |
| **contractPlan** | Status | 1-20 | ✅ | STANDARD | 契約プラン | enum値 | companies |
| **maxUsers** | Int | - | ✅ | 100 | 最大ユーザー数 | 1〜999999 | companies |

### 3.5 権限関連項目

| 項目名 | データ型 | 桁数 | 必須 | 初期値 | 説明 | バリデーション | 使用箇所 |
|--------|----------|------|------|--------|------|----------------|-----------|
| **featureId** | ID | - | ✅ | - | 機能ID | 存在チェック | permissions |
| **departmentId** | ID | - | ✅ | - | 部署ID | 存在チェック | permissions |
| **canView** | Flag | - | ✅ | false | 閲覧権限 | - | permissions |
| **canCreate** | Flag | - | ✅ | false | 作成権限 | - | permissions |
| **canEdit** | Flag | - | ✅ | false | 編集権限 | - | permissions |
| **canDelete** | Flag | - | ✅ | false | 削除権限 | - | permissions |
| **canApprove** | Flag | - | ✅ | false | 承認権限 | - | permissions |
| **canExport** | Flag | - | ✅ | false | エクスポート権限 | - | permissions |
| **inheritFromParent** | Flag | - | ✅ | true | 親権限継承 | - | permissions |

### 3.6 ワークフロー関連項目

| 項目名 | データ型 | 桁数 | 必須 | 初期値 | 説明 | バリデーション | 使用箇所 |
|--------|----------|------|------|--------|------|----------------|-----------|
| **requestNumber** | Code | 10-30 | ✅ | auto | 申請番号 | UNIQUE, 自動生成 | workflow_requests |
| **workflowTypeId** | ID | - | ✅ | - | ワークフロータイプID | 存在チェック | workflow_requests |
| **requesterId** | ID | - | ✅ | - | 申請者ID | 存在チェック | workflow_requests |
| **title** | 中名称 | 1-100 | ✅ | - | 申請タイトル | 1文字以上 | workflow_requests |
| **description** | 長説明 | 0-2000 | ❌ | null | 申請内容 | - | workflow_requests |
| **formData** | Json | - | ✅ | {} | フォームデータ | 有効JSON | workflow_requests |
| **amount** | Money | - | ❌ | null | 金額 | 0以上 | workflow_requests |
| **status** | Status | 5-20 | ✅ | DRAFT | ステータス | enum値 | workflow_requests |
| **currentStep** | Int | - | ✅ | 1 | 現在ステップ | 1以上 | workflow_requests |
| **priority** | Status | 3-10 | ✅ | NORMAL | 優先度 | enum値 | workflow_requests |
| **dueDate** | Timestamp | - | ❌ | null | 期限日 | 未来日付 | workflow_requests |
| **submittedAt** | Timestamp | - | ❌ | null | 申請日時 | - | workflow_requests |
| **completedAt** | Timestamp | - | ❌ | null | 完了日時 | submittedAt以降 | workflow_requests |
| **isUrgent** | Flag | - | ✅ | false | 緊急フラグ | - | workflow_requests |

### 3.7 承認関連項目

| 項目名 | データ型 | 桁数 | 必須 | 初期値 | 説明 | バリデーション | 使用箇所 |
|--------|----------|------|------|--------|------|----------------|-----------|
| **approverId** | ID | - | ✅ | - | 承認者ID | 存在チェック | approval_history |
| **stepNumber** | Int | - | ✅ | - | ステップ番号 | 1以上 | approval_history |
| **action** | Status | 5-20 | ✅ | - | 承認アクション | enum値 | approval_history |
| **comment** | 長説明 | 0-2000 | ❌ | null | 承認コメント | - | approval_history |
| **processedAt** | Timestamp | - | ✅ | now() | 処理日時 | - | approval_history |
| **processingTime** | Int | - | ❌ | null | 処理時間(分) | 0以上 | approval_history |
| **delegatedFrom** | ID | - | ❌ | null | 代理元ID | 存在チェック | approval_history |
| **delegatedTo** | ID | - | ❌ | null | 代理先ID | 存在チェック | approval_history |

### 3.8 通知関連項目

| 項目名 | データ型 | 桁数 | 必須 | 初期値 | 説明 | バリデーション | 使用箇所 |
|--------|----------|------|------|--------|------|----------------|-----------|
| **type** | Status | 5-30 | ✅ | - | 通知タイプ | enum値 | notifications |
| **title** | 中名称 | 1-100 | ✅ | - | 通知タイトル | 1文字以上 | notifications |
| **message** | 長説明 | 1-2000 | ✅ | - | 通知メッセージ | 1文字以上 | notifications |
| **isRead** | Flag | - | ✅ | false | 既読フラグ | - | notifications |
| **readAt** | Timestamp | - | ❌ | null | 既読日時 | - | notifications |
| **emailSent** | Flag | - | ✅ | false | メール送信済み | - | notifications |
| **emailSentAt** | Timestamp | - | ❌ | null | メール送信日時 | - | notifications |
| **actionUrl** | URL | 0-2048 | ❌ | null | アクションURL | URL形式 | notifications |

### 3.9 ファイル関連項目

| 項目名 | データ型 | 桁数 | 必須 | 初期値 | 説明 | バリデーション | 使用箇所 |
|--------|----------|------|------|--------|------|----------------|-----------|
| **fileName** | 中名称 | 1-255 | ✅ | - | ファイル名 | 1文字以上 | attachments |
| **fileSize** | Int | - | ✅ | - | ファイルサイズ(byte) | 1以上 | attachments |
| **mimeType** | 短名称 | 1-100 | ✅ | - | MIMEタイプ | 有効MIME | attachments |
| **fileUrl** | URL | 1-2048 | ✅ | - | ファイルURL | URL形式 | attachments |
| **thumbnailUrl** | URL | 0-2048 | ❌ | null | サムネイルURL | URL形式 | attachments |
| **uploadedBy** | ID | - | ✅ | - | アップロード者ID | 存在チェック | attachments |
| **uploadedAt** | Timestamp | - | ✅ | now() | アップロード日時 | - | attachments |
| **isDeleted** | Flag | - | ✅ | false | 削除フラグ | - | attachments |
| **deletedAt** | Timestamp | - | ❌ | null | 削除日時 | - | attachments |

## 4. enum定義

### 4.1 UserRole（ユーザー権限）

```typescript
enum UserRole {
  ADMIN = 'ADMIN',           // システム管理者
  USER = 'USER',             // 一般ユーザー
  GUEST = 'GUEST',           // ゲストユーザー
  MANAGER = 'MANAGER'        // マネージャー
}
```

### 4.2 WorkflowStatus（ワークフロー状態）

```typescript
enum WorkflowStatus {
  DRAFT = 'DRAFT',           // 下書き
  PENDING = 'PENDING',       // 承認待ち
  APPROVED = 'APPROVED',     // 承認済み
  REJECTED = 'REJECTED',     // 却下
  CANCELLED = 'CANCELLED',   // 取り消し
  RETURNED = 'RETURNED'      // 差し戻し
}
```

### 4.3 ApprovalAction（承認アクション）

```typescript
enum ApprovalAction {
  APPROVE = 'APPROVE',       // 承認
  REJECT = 'REJECT',         // 却下
  RETURN = 'RETURN',         // 差し戻し
  DELEGATE = 'DELEGATE',     // 代理
  SKIP = 'SKIP',             // スキップ
  AUTO_APPROVE = 'AUTO_APPROVE' // 自動承認
}
```

### 4.4 Priority（優先度）

```typescript
enum Priority {
  LOW = 'LOW',               // 低
  NORMAL = 'NORMAL',         // 通常
  HIGH = 'HIGH',             // 高
  URGENT = 'URGENT'          // 緊急
}
```

### 4.5 NotificationType（通知タイプ）

```typescript
enum NotificationType {
  REQUEST_SUBMITTED = 'REQUEST_SUBMITTED',     // 申請受付
  APPROVAL_REQUIRED = 'APPROVAL_REQUIRED',     // 承認要求
  APPROVED = 'APPROVED',                       // 承認完了
  REJECTED = 'REJECTED',                       // 却下
  RETURNED = 'RETURNED',                       // 差し戻し
  COMPLETED = 'COMPLETED',                     // 処理完了
  DEADLINE_APPROACHING = 'DEADLINE_APPROACHING', // 期限間近
  OVERDUE = 'OVERDUE'                          // 期限超過
}
```

## 5. バリデーション定義

### 5.1 共通バリデーション関数

```typescript
// 文字列長バリデーション
export const validateLength = (value: string, min: number, max: number): boolean => {
  return value.length >= min && value.length <= max
}

// メールアドレスバリデーション
export const validateEmail = (email: string): boolean => {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
  return emailRegex.test(email) && validateLength(email, 5, 254)
}

// コードバリデーション（英数字、アンダースコア、ハイフン）
export const validateCode = (code: string): boolean => {
  const codeRegex = /^[a-zA-Z0-9_-]+$/
  return codeRegex.test(code)
}

// 電話番号バリデーション
export const validatePhone = (phone: string): boolean => {
  const phoneRegex = /^[\d-+().\s]+$/
  return phoneRegex.test(phone) && validateLength(phone, 10, 20)
}

// URLバリデーション
export const validateUrl = (url: string): boolean => {
  try {
    new URL(url)
    return validateLength(url, 1, 2048)
  } catch {
    return false
  }
}

// 日付バリデーション（未来日付）
export const validateFutureDate = (date: Date): boolean => {
  return date > new Date()
}

// 日付バリデーション（過去日付）
export const validatePastDate = (date: Date): boolean => {
  return date <= new Date()
}

// 金額バリデーション
export const validateAmount = (amount: number): boolean => {
  return amount >= 0 && amount <= 999999999999.99
}

// パーセンテージバリデーション
export const validatePercentage = (percentage: number): boolean => {
  return percentage >= 0 && percentage <= 100
}
```

### 5.2 項目別バリデーション定義

```typescript
export const validationRules = {
  // ユーザー関連
  username: {
    required: true,
    minLength: 3,
    maxLength: 30,
    pattern: /^[a-zA-Z0-9_-]+$/,
    unique: true
  },

  email: {
    required: true,
    minLength: 5,
    maxLength: 254,
    format: 'email',
    unique: true
  },

  password: {
    required: true,
    minLength: 8,
    maxLength: 128,
    pattern: /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d@$!%*?&]{8,}$/,
    message: 'パスワードは8文字以上で、大文字・小文字・数字を含む必要があります'
  },

  name: {
    required: true,
    minLength: 1,
    maxLength: 50,
    trim: true
  },

  employeeCode: {
    required: false,
    minLength: 1,
    maxLength: 20,
    pattern: /^[a-zA-Z0-9-]+$/,
    unique: true
  },

  // 組織関連
  companyCode: {
    required: true,
    minLength: 1,
    maxLength: 20,
    pattern: /^[a-zA-Z0-9_-]+$/,
    unique: 'per_system'
  },

  departmentCode: {
    required: true,
    minLength: 1,
    maxLength: 20,
    pattern: /^[a-zA-Z0-9_-]+$/,
    unique: 'per_company'
  },

  // ワークフロー関連
  requestNumber: {
    required: true,
    minLength: 10,
    maxLength: 30,
    pattern: /^[A-Z0-9-]+$/,
    unique: true,
    autoGenerate: true
  },

  title: {
    required: true,
    minLength: 1,
    maxLength: 100,
    trim: true
  },

  description: {
    required: false,
    maxLength: 2000,
    trim: true
  },

  amount: {
    required: false,
    min: 0,
    max: 999999999999.99,
    decimal: 2
  },

  // ファイル関連
  fileName: {
    required: true,
    minLength: 1,
    maxLength: 255,
    pattern: /^[^<>:"/\\|?*]+$/
  },

  fileSize: {
    required: true,
    min: 1,
    max: 1073741824, // 1GB
    type: 'integer'
  },

  mimeType: {
    required: true,
    allowedValues: [
      'image/jpeg', 'image/png', 'image/gif',
      'application/pdf', 'text/plain',
      'application/vnd.ms-excel',
      'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    ]
  }
}
```

### 5.3 express-validator統合

```typescript
import { body, param, query } from 'express-validator'

// ユーザー作成バリデーション
export const validateCreateUser = [
  body('username')
    .isLength({ min: 3, max: 30 })
    .matches(/^[a-zA-Z0-9_-]+$/)
    .withMessage('ユーザー名は3-30文字の英数字、アンダースコア、ハイフンで入力してください'),

  body('email')
    .isEmail()
    .isLength({ max: 254 })
    .normalizeEmail()
    .withMessage('有効なメールアドレスを入力してください'),

  body('password')
    .isLength({ min: 8, max: 128 })
    .matches(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d@$!%*?&]{8,}$/)
    .withMessage('パスワードは8文字以上で、大文字・小文字・数字を含む必要があります'),

  body('name')
    .isLength({ min: 1, max: 50 })
    .trim()
    .withMessage('氏名は1-50文字で入力してください'),

  body('employeeCode')
    .optional()
    .isLength({ max: 20 })
    .matches(/^[a-zA-Z0-9-]+$/)
    .withMessage('社員番号は英数字とハイフンで入力してください')
]

// ワークフロー申請バリデーション
export const validateCreateWorkflowRequest = [
  body('workflowTypeId')
    .isInt({ min: 1 })
    .withMessage('ワークフロータイプIDは1以上の整数で入力してください'),

  body('title')
    .isLength({ min: 1, max: 100 })
    .trim()
    .withMessage('タイトルは1-100文字で入力してください'),

  body('description')
    .optional()
    .isLength({ max: 2000 })
    .trim()
    .withMessage('説明は2000文字以内で入力してください'),

  body('amount')
    .optional()
    .isDecimal({ decimal_digits: '0,2' })
    .custom((value) => {
      const num = parseFloat(value)
      if (num < 0 || num > 999999999999.99) {
        throw new Error('金額は0以上、999兆円以下で入力してください')
      }
      return true
    }),

  body('formData')
    .isObject()
    .withMessage('フォームデータは有効なJSONオブジェクトで入力してください')
]
```

## 6. 管理ルール

### 6.1 新規項目追加時の手順

1. **事前確認**
   - 既存項目で類似のものがないか確認
   - データ型・桁数が既存規約に準拠しているか確認

2. **項目定義**
   - データ辞書への項目追加
   - バリデーション定義の追加
   - enum定義の追加（必要に応じて）

3. **実装**
   - Prismaスキーマ更新
   - TypeScript型定義更新
   - バリデーション実装

4. **ドキュメント更新**
   - このドキュメントの更新
   - 関連設計書の更新

### 6.2 項目変更時の影響確認

```typescript
// 項目変更影響チェックリスト
const changeImpactCheck = {
  database: [
    'Prismaスキーマ更新',
    'マイグレーションファイル作成',
    'インデックス影響確認'
  ],

  backend: [
    'TypeScript型定義更新',
    'バリデーション更新',
    'API仕様書更新'
  ],

  frontend: [
    'Vue コンポーネント更新',
    'バリデーション更新',
    'UI表示確認'
  ],

  test: [
    '単体テスト更新',
    '統合テスト更新',
    'バリデーションテスト更新'
  ]
}
```

### 6.3 データ型変更時の注意事項

| 変更種別 | 注意事項 | 対応方法 |
|----------|----------|----------|
| **桁数拡張** | 既存データの整合性確認 | マイグレーション |
| **桁数縮小** | データ切り捨てリスク | 事前データ確認 |
| **型変更** | 互換性確認必須 | 段階的移行 |
| **必須化** | デフォルト値設定 | NOT NULL制約追加 |
| **任意化** | 既存ロジック影響 | NULL チェック追加 |

## 7. バリデーションエラーメッセージ

### 7.1 日本語エラーメッセージ定義

```typescript
export const errorMessages = {
  required: '{field}は必須です',
  minLength: '{field}は{min}文字以上で入力してください',
  maxLength: '{field}は{max}文字以内で入力してください',
  pattern: '{field}の形式が正しくありません',
  email: '有効なメールアドレスを入力してください',
  unique: 'この{field}は既に使用されています',
  min: '{field}は{min}以上で入力してください',
  max: '{field}は{max}以下で入力してください',
  integer: '{field}は整数で入力してください',
  decimal: '{field}は小数点以下{places}桁以内で入力してください',
  date: '{field}は有効な日付を入力してください',
  futureDate: '{field}は未来の日付を入力してください',
  pastDate: '{field}は過去の日付を入力してください',
  url: '{field}は有効なURLを入力してください',
  phone: '{field}は有効な電話番号を入力してください'
}

// エラーメッセージ生成関数
export const generateErrorMessage = (
  rule: string,
  field: string,
  params?: Record<string, any>
): string => {
  let message = errorMessages[rule] || 'バリデーションエラーが発生しました'

  // パラメータ置換
  message = message.replace('{field}', field)
  if (params) {
    Object.keys(params).forEach(key => {
      message = message.replace(`{${key}}`, params[key])
    })
  }

  return message
}
```

## 8. 今後の拡張計画

### 8.1 国際化対応

- 多言語項目名対応
- 地域別バリデーション（電話番号形式等）
- 通貨・日付形式の地域対応

### 8.2 高度なバリデーション

- 相関チェック（開始日 ≤ 終了日等）
- 外部システム連携チェック
- ビジネスルールバリデーション

### 8.3 自動化

- スキーマからバリデーション自動生成
- ドキュメント自動更新
- テストケース自動生成

---

**管理責任者**: システム開発チーム
**更新頻度**: 新機能追加時・項目変更時は必須更新
**レビュー**: 月次でデータ整合性確認