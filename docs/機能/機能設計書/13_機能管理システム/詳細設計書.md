# 機能管理システム詳細設計書

## 1. システムアーキテクチャ

### 1.1 全体構成
```
┌─────────────────────────────────────────────────────────┐
│                     Frontend (Vue.js)                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  権限管理UI  │  │  部署管理UI  │  │  機能管理UI  │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────┐
│                   Backend (Express)                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ 認証ミドル   │→ │ 権限ミドル   │→ │  APIルート   │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ 権限サービス │  │ キャッシュ   │  │  監査ログ    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────┐
│                   Database (PostgreSQL)                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │   Company    │  │  Department  │  │    User      │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │   Feature    │  │  Permission  │  │  AuditLog    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 1.2 認証・認可フロー
```
1. ユーザーログイン
   ↓
2. JWT発行（ユーザーID、会社ID、部署IDを含む）
   ↓
3. APIリクエスト時
   ├→ JWT検証
   ├→ ユーザー部署情報取得
   ├→ 機能権限チェック
   └→ アクセス許可/拒否
```

## 2. データベース詳細設計

### 2.1 テーブル定義

#### Company（会社）
```sql
CREATE TABLE companies (
    id SERIAL PRIMARY KEY,
    code VARCHAR(20) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    name_kana VARCHAR(100),
    industry VARCHAR(50),
    established_date DATE,
    employee_count INTEGER,
    address TEXT,
    phone VARCHAR(20),
    email VARCHAR(100),
    contract_plan VARCHAR(50) DEFAULT 'STANDARD',
    max_users INTEGER DEFAULT 100,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by INTEGER REFERENCES users(id),
    updated_by INTEGER REFERENCES users(id)
);

CREATE INDEX idx_companies_code ON companies(code);
CREATE INDEX idx_companies_active ON companies(is_active);
```

#### Department（部署）
```sql
CREATE TABLE departments (
    id SERIAL PRIMARY KEY,
    company_id INTEGER NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
    code VARCHAR(20) NOT NULL,
    name VARCHAR(100) NOT NULL,
    name_kana VARCHAR(100),
    parent_id INTEGER REFERENCES departments(id),
    level INTEGER NOT NULL DEFAULT 1,
    path TEXT, -- 階層パス（例：/1/3/7）
    display_order INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by INTEGER REFERENCES users(id),
    updated_by INTEGER REFERENCES users(id),
    UNIQUE(company_id, code)
);

CREATE INDEX idx_departments_company ON departments(company_id);
CREATE INDEX idx_departments_parent ON departments(parent_id);
CREATE INDEX idx_departments_path ON departments(path);
CREATE INDEX idx_departments_active ON departments(is_active);
```

#### UserDepartment（ユーザー所属）
```sql
CREATE TABLE user_departments (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    department_id INTEGER NOT NULL REFERENCES departments(id) ON DELETE CASCADE,
    is_primary BOOLEAN DEFAULT false,
    role VARCHAR(50) DEFAULT 'MEMBER', -- MANAGER, LEADER, MEMBER
    assigned_date DATE NOT NULL DEFAULT CURRENT_DATE,
    expired_date DATE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, department_id)
);

CREATE INDEX idx_user_departments_user ON user_departments(user_id);
CREATE INDEX idx_user_departments_dept ON user_departments(department_id);
CREATE INDEX idx_user_departments_primary ON user_departments(is_primary);
```

#### Feature（機能）
```sql
CREATE TABLE features (
    id SERIAL PRIMARY KEY,
    code VARCHAR(50) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    category VARCHAR(50) NOT NULL, -- USER_MGMT, LOG_MGMT, REPORT, etc
    parent_id INTEGER REFERENCES features(id),
    path TEXT, -- 階層パス
    url_pattern VARCHAR(200), -- 対応するURLパターン
    api_pattern VARCHAR(200), -- 対応するAPIパターン
    icon VARCHAR(50),
    display_order INTEGER DEFAULT 0,
    is_menu_item BOOLEAN DEFAULT true,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_features_code ON features(code);
CREATE INDEX idx_features_category ON features(category);
CREATE INDEX idx_features_parent ON features(parent_id);
CREATE INDEX idx_features_active ON features(is_active);
```

#### DepartmentFeaturePermission（部署機能権限）
```sql
CREATE TABLE department_feature_permissions (
    id SERIAL PRIMARY KEY,
    department_id INTEGER NOT NULL REFERENCES departments(id) ON DELETE CASCADE,
    feature_id INTEGER NOT NULL REFERENCES features(id) ON DELETE CASCADE,
    can_view BOOLEAN DEFAULT false,
    can_create BOOLEAN DEFAULT false,
    can_edit BOOLEAN DEFAULT false,
    can_delete BOOLEAN DEFAULT false,
    can_approve BOOLEAN DEFAULT false,
    can_export BOOLEAN DEFAULT false,
    inherit_from_parent BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by INTEGER REFERENCES users(id),
    updated_by INTEGER REFERENCES users(id),
    UNIQUE(department_id, feature_id)
);

CREATE INDEX idx_dept_feature_dept ON department_feature_permissions(department_id);
CREATE INDEX idx_dept_feature_feature ON department_feature_permissions(feature_id);
```

#### PermissionTemplate（権限テンプレート）
```sql
CREATE TABLE permission_templates (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    department_type VARCHAR(50), -- SALES, HR, IT, FINANCE, etc
    company_id INTEGER REFERENCES companies(id),
    is_system_template BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by INTEGER REFERENCES users(id)
);

CREATE TABLE permission_template_details (
    id SERIAL PRIMARY KEY,
    template_id INTEGER NOT NULL REFERENCES permission_templates(id) ON DELETE CASCADE,
    feature_id INTEGER NOT NULL REFERENCES features(id),
    can_view BOOLEAN DEFAULT false,
    can_create BOOLEAN DEFAULT false,
    can_edit BOOLEAN DEFAULT false,
    can_delete BOOLEAN DEFAULT false,
    can_approve BOOLEAN DEFAULT false,
    can_export BOOLEAN DEFAULT false,
    UNIQUE(template_id, feature_id)
);
```

#### PermissionAuditLog（権限変更監査ログ）
```sql
CREATE TABLE permission_audit_logs (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id),
    action VARCHAR(50) NOT NULL, -- GRANT, REVOKE, MODIFY
    target_type VARCHAR(50) NOT NULL, -- DEPARTMENT, USER, TEMPLATE
    target_id INTEGER NOT NULL,
    feature_id INTEGER REFERENCES features(id),
    old_permissions JSONB,
    new_permissions JSONB,
    reason TEXT,
    ip_address VARCHAR(45),
    user_agent TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_audit_user ON permission_audit_logs(user_id);
CREATE INDEX idx_audit_action ON permission_audit_logs(action);
CREATE INDEX idx_audit_target ON permission_audit_logs(target_type, target_id);
CREATE INDEX idx_audit_created ON permission_audit_logs(created_at);
```

### 2.2 ユーザーテーブル拡張
```sql
ALTER TABLE users
ADD COLUMN company_id INTEGER REFERENCES companies(id),
ADD COLUMN primary_department_id INTEGER REFERENCES departments(id),
ADD COLUMN employee_code VARCHAR(50),
ADD COLUMN join_date DATE,
ADD COLUMN leave_date DATE;

CREATE INDEX idx_users_company ON users(company_id);
CREATE INDEX idx_users_primary_dept ON users(primary_department_id);
```

## 3. API詳細設計

### 3.1 認証・権限チェックミドルウェア

#### authMiddleware.ts
```typescript
interface JWTPayload {
  userId: number;
  companyId: number;
  departmentIds: number[];
  role: 'ADMIN' | 'MANAGER' | 'USER';
}

export const authMiddleware = async (req, res, next) => {
  try {
    const token = req.headers.authorization?.replace('Bearer ', '');
    const decoded = jwt.verify(token, process.env.JWT_SECRET) as JWTPayload;

    // ユーザー情報と権限を取得
    const user = await getUserWithPermissions(decoded.userId);
    req.user = user;
    req.permissions = await getEffectivePermissions(user);

    next();
  } catch (error) {
    res.status(401).json({ error: 'Unauthorized' });
  }
};
```

#### permissionMiddleware.ts
```typescript
export const requirePermission = (featureCode: string, action: string) => {
  return async (req, res, next) => {
    const userPermissions = req.permissions;

    if (!hasPermission(userPermissions, featureCode, action)) {
      // 監査ログに記録
      await logAccessDenied(req.user.id, featureCode, action);
      return res.status(403).json({ error: 'Forbidden' });
    }

    next();
  };
};
```

### 3.2 権限サービス

#### permissionService.ts
```typescript
export class PermissionService {
  private cache: Map<string, any> = new Map();

  async getEffectivePermissions(userId: number): Promise<PermissionSet> {
    const cacheKey = `permissions:${userId}`;

    // キャッシュチェック
    if (this.cache.has(cacheKey)) {
      return this.cache.get(cacheKey);
    }

    // ユーザーの部署を取得
    const departments = await this.getUserDepartments(userId);

    // 部署の権限を取得（継承含む）
    const permissions = await this.getDepartmentPermissions(departments);

    // 個別権限のマージ
    const userPermissions = await this.getUserSpecificPermissions(userId);
    const merged = this.mergePermissions(permissions, userPermissions);

    // キャッシュに保存（5分間）
    this.cache.set(cacheKey, merged);
    setTimeout(() => this.cache.delete(cacheKey), 5 * 60 * 1000);

    return merged;
  }

  private async getDepartmentPermissions(departments: Department[]): Promise<PermissionSet> {
    const permissions = new Map();

    for (const dept of departments) {
      // 部署の権限を取得
      const deptPerms = await db.departmentFeaturePermissions.findMany({
        where: { departmentId: dept.id }
      });

      // 親部署の権限も考慮（inherit_from_parent = true の場合）
      if (dept.parentId) {
        const parentPerms = await this.getParentPermissions(dept.parentId);
        this.mergePermissions(permissions, parentPerms);
      }

      // 現在の部署の権限をマージ
      this.mergePermissions(permissions, deptPerms);
    }

    return permissions;
  }

  hasPermission(permissions: PermissionSet, featureCode: string, action: string): boolean {
    const feature = permissions.get(featureCode);
    if (!feature) return false;

    const actionMap = {
      'view': feature.canView,
      'create': feature.canCreate,
      'edit': feature.canEdit,
      'delete': feature.canDelete,
      'approve': feature.canApprove,
      'export': feature.canExport
    };

    return actionMap[action] || false;
  }
}
```

### 3.3 APIエンドポイント実装

#### 会社管理API
```typescript
// GET /api/companies
router.get('/companies', requirePermission('COMPANY_MGMT', 'view'), async (req, res) => {
  const companies = await db.companies.findMany({
    where: { isActive: true },
    orderBy: { name: 'asc' }
  });
  res.json(companies);
});

// POST /api/companies
router.post('/companies', requirePermission('COMPANY_MGMT', 'create'), async (req, res) => {
  const { code, name, industry, employeeCount } = req.body;

  // バリデーション
  if (!code || !name) {
    return res.status(400).json({ error: 'Required fields missing' });
  }

  try {
    const company = await db.companies.create({
      data: {
        code,
        name,
        industry,
        employeeCount,
        createdBy: req.user.id
      }
    });

    // 監査ログ記録
    await logAudit(req.user.id, 'CREATE', 'COMPANY', company.id);

    res.status(201).json(company);
  } catch (error) {
    res.status(500).json({ error: 'Failed to create company' });
  }
});
```

#### 部署管理API
```typescript
// GET /api/departments/tree
router.get('/departments/tree', requirePermission('DEPT_MGMT', 'view'), async (req, res) => {
  const { companyId } = req.query;

  const departments = await db.departments.findMany({
    where: {
      companyId: Number(companyId),
      isActive: true
    },
    orderBy: [
      { level: 'asc' },
      { displayOrder: 'asc' },
      { name: 'asc' }
    ]
  });

  // ツリー構造に変換
  const tree = buildDepartmentTree(departments);
  res.json(tree);
});

function buildDepartmentTree(departments: Department[]): DepartmentNode[] {
  const map = new Map();
  const roots: DepartmentNode[] = [];

  // マップ作成
  departments.forEach(dept => {
    map.set(dept.id, { ...dept, children: [] });
  });

  // ツリー構築
  departments.forEach(dept => {
    if (dept.parentId) {
      const parent = map.get(dept.parentId);
      if (parent) {
        parent.children.push(map.get(dept.id));
      }
    } else {
      roots.push(map.get(dept.id));
    }
  });

  return roots;
}
```

#### 権限管理API
```typescript
// GET /api/permissions/department/:departmentId
router.get('/permissions/department/:departmentId',
  requirePermission('PERMISSION_MGMT', 'view'),
  async (req, res) => {
    const { departmentId } = req.params;

    // 全機能を取得
    const features = await db.features.findMany({
      where: { isActive: true },
      orderBy: [
        { category: 'asc' },
        { displayOrder: 'asc' }
      ]
    });

    // 部署の権限を取得
    const permissions = await db.departmentFeaturePermissions.findMany({
      where: { departmentId: Number(departmentId) }
    });

    // 権限マップ作成
    const permissionMap = new Map();
    permissions.forEach(p => {
      permissionMap.set(p.featureId, p);
    });

    // 機能リストに権限情報を付与
    const result = features.map(feature => ({
      ...feature,
      permissions: permissionMap.get(feature.id) || {
        canView: false,
        canCreate: false,
        canEdit: false,
        canDelete: false,
        canApprove: false,
        canExport: false
      }
    }));

    res.json(result);
});

// POST /api/permissions/department/:departmentId
router.post('/permissions/department/:departmentId',
  requirePermission('PERMISSION_MGMT', 'edit'),
  async (req, res) => {
    const { departmentId } = req.params;
    const { permissions } = req.body;

    try {
      // トランザクション開始
      await db.$transaction(async (prisma) => {
        // 既存権限を削除
        await prisma.departmentFeaturePermissions.deleteMany({
          where: { departmentId: Number(departmentId) }
        });

        // 新規権限を作成
        const data = permissions.map(p => ({
          departmentId: Number(departmentId),
          featureId: p.featureId,
          canView: p.canView,
          canCreate: p.canCreate,
          canEdit: p.canEdit,
          canDelete: p.canDelete,
          canApprove: p.canApprove,
          canExport: p.canExport,
          createdBy: req.user.id,
          updatedBy: req.user.id
        }));

        await prisma.departmentFeaturePermissions.createMany({ data });

        // 監査ログ記録
        await logAudit(req.user.id, 'MODIFY', 'DEPARTMENT_PERMISSION', departmentId, {
          old: [],
          new: permissions
        });
      });

      // キャッシュクリア
      await clearPermissionCache(departmentId);

      res.json({ success: true });
    } catch (error) {
      res.status(500).json({ error: 'Failed to update permissions' });
    }
});
```

## 4. フロントエンド実装

### 4.1 Vuexストア設計

#### permission.store.ts
```typescript
interface PermissionState {
  userPermissions: Map<string, FeaturePermission>;
  departments: Department[];
  features: Feature[];
  loading: boolean;
}

const permissionModule = {
  namespaced: true,

  state: (): PermissionState => ({
    userPermissions: new Map(),
    departments: [],
    features: [],
    loading: false
  }),

  mutations: {
    SET_USER_PERMISSIONS(state, permissions) {
      state.userPermissions = new Map(
        permissions.map(p => [p.featureCode, p])
      );
    },
    SET_DEPARTMENTS(state, departments) {
      state.departments = departments;
    },
    SET_FEATURES(state, features) {
      state.features = features;
    }
  },

  actions: {
    async loadUserPermissions({ commit }) {
      const response = await api.get('/api/permissions/my');
      commit('SET_USER_PERMISSIONS', response.data);
    },

    async updateDepartmentPermissions({ commit }, { departmentId, permissions }) {
      await api.post(`/api/permissions/department/${departmentId}`, {
        permissions
      });
      // 権限更新後、ユーザー権限を再読み込み
      await this.dispatch('permission/loadUserPermissions');
    }
  },

  getters: {
    hasPermission: (state) => (featureCode: string, action: string) => {
      const permission = state.userPermissions.get(featureCode);
      if (!permission) return false;

      const actionMap = {
        'view': permission.canView,
        'create': permission.canCreate,
        'edit': permission.canEdit,
        'delete': permission.canDelete,
        'approve': permission.canApprove,
        'export': permission.canExport
      };

      return actionMap[action] || false;
    }
  }
};
```

### 4.2 権限ディレクティブ

#### permission.directive.ts
```typescript
import { DirectiveBinding } from 'vue';
import store from '@/store';

interface PermissionBinding {
  feature: string;
  action: string;
}

export const permissionDirective = {
  mounted(el: HTMLElement, binding: DirectiveBinding<PermissionBinding>) {
    const { feature, action } = binding.value;

    if (!store.getters['permission/hasPermission'](feature, action)) {
      el.style.display = 'none';
      el.setAttribute('disabled', 'true');
    }
  },

  updated(el: HTMLElement, binding: DirectiveBinding<PermissionBinding>) {
    const { feature, action } = binding.value;

    if (!store.getters['permission/hasPermission'](feature, action)) {
      el.style.display = 'none';
      el.setAttribute('disabled', 'true');
    } else {
      el.style.display = '';
      el.removeAttribute('disabled');
    }
  }
};

// 使用例
// <el-button v-permission="{ feature: 'USER_MGMT', action: 'create' }">
//   ユーザー作成
// </el-button>
```

### 4.3 権限管理画面コンポーネント

#### PermissionMatrix.vue
```vue
<template>
  <div class="permission-matrix">
    <el-table
      :data="features"
      border
      style="width: 100%"
      max-height="600"
    >
      <el-table-column
        prop="category"
        label="カテゴリ"
        width="150"
        fixed
      />
      <el-table-column
        prop="name"
        label="機能名"
        width="200"
        fixed
      />
      <el-table-column label="権限" align="center">
        <el-table-column label="閲覧" width="80" align="center">
          <template #default="scope">
            <el-checkbox
              v-model="scope.row.permissions.canView"
              @change="updatePermission(scope.row)"
            />
          </template>
        </el-table-column>
        <el-table-column label="作成" width="80" align="center">
          <template #default="scope">
            <el-checkbox
              v-model="scope.row.permissions.canCreate"
              @change="updatePermission(scope.row)"
              :disabled="!scope.row.permissions.canView"
            />
          </template>
        </el-table-column>
        <el-table-column label="編集" width="80" align="center">
          <template #default="scope">
            <el-checkbox
              v-model="scope.row.permissions.canEdit"
              @change="updatePermission(scope.row)"
              :disabled="!scope.row.permissions.canView"
            />
          </template>
        </el-table-column>
        <el-table-column label="削除" width="80" align="center">
          <template #default="scope">
            <el-checkbox
              v-model="scope.row.permissions.canDelete"
              @change="updatePermission(scope.row)"
              :disabled="!scope.row.permissions.canView"
            />
          </template>
        </el-table-column>
        <el-table-column label="承認" width="80" align="center">
          <template #default="scope">
            <el-checkbox
              v-model="scope.row.permissions.canApprove"
              @change="updatePermission(scope.row)"
              :disabled="!scope.row.permissions.canView"
            />
          </template>
        </el-table-column>
        <el-table-column label="出力" width="80" align="center">
          <template #default="scope">
            <el-checkbox
              v-model="scope.row.permissions.canExport"
              @change="updatePermission(scope.row)"
              :disabled="!scope.row.permissions.canView"
            />
          </template>
        </el-table-column>
      </el-table-column>
    </el-table>

    <div class="button-group">
      <el-button @click="applyTemplate">テンプレート適用</el-button>
      <el-button type="primary" @click="savePermissions">保存</el-button>
      <el-button @click="resetPermissions">リセット</el-button>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { ElMessage } from 'element-plus';
import { usePermissionApi } from '@/api/permission';

const props = defineProps<{
  departmentId: number;
}>();

const features = ref<FeatureWithPermission[]>([]);
const {
  getDepartmentPermissions,
  updateDepartmentPermissions
} = usePermissionApi();

onMounted(async () => {
  await loadPermissions();
});

const loadPermissions = async () => {
  try {
    const data = await getDepartmentPermissions(props.departmentId);
    features.value = data;
  } catch (error) {
    ElMessage.error('権限情報の取得に失敗しました');
  }
};

const updatePermission = (feature: FeatureWithPermission) => {
  // 閲覧権限がない場合、他の権限も無効化
  if (!feature.permissions.canView) {
    feature.permissions.canCreate = false;
    feature.permissions.canEdit = false;
    feature.permissions.canDelete = false;
    feature.permissions.canApprove = false;
    feature.permissions.canExport = false;
  }
};

const savePermissions = async () => {
  try {
    const permissions = features.value.map(f => ({
      featureId: f.id,
      ...f.permissions
    }));

    await updateDepartmentPermissions(props.departmentId, permissions);
    ElMessage.success('権限を保存しました');
  } catch (error) {
    ElMessage.error('権限の保存に失敗しました');
  }
};
</script>
```

## 5. セキュリティ実装

### 5.1 権限昇格防止
```typescript
// 権限チェックの多層防御
class SecurityLayer {
  // レイヤー1: JWT検証
  async verifyJWT(token: string): Promise<JWTPayload> {
    return jwt.verify(token, process.env.JWT_SECRET);
  }

  // レイヤー2: セッション検証
  async verifySession(sessionId: string): Promise<boolean> {
    const session = await redis.get(`session:${sessionId}`);
    return session !== null;
  }

  // レイヤー3: 権限検証
  async verifyPermission(userId: number, feature: string, action: string): Promise<boolean> {
    const permissions = await permissionService.getEffectivePermissions(userId);
    return permissionService.hasPermission(permissions, feature, action);
  }

  // レイヤー4: レート制限
  async checkRateLimit(userId: number, endpoint: string): Promise<boolean> {
    const key = `rate:${userId}:${endpoint}`;
    const count = await redis.incr(key);
    if (count === 1) {
      await redis.expire(key, 60); // 1分間
    }
    return count <= 100; // 1分間に100リクエストまで
  }
}
```

### 5.2 監査ログ実装
```typescript
class AuditLogger {
  async log(params: AuditLogParams): Promise<void> {
    await db.permissionAuditLogs.create({
      data: {
        userId: params.userId,
        action: params.action,
        targetType: params.targetType,
        targetId: params.targetId,
        featureId: params.featureId,
        oldPermissions: params.oldPermissions,
        newPermissions: params.newPermissions,
        reason: params.reason,
        ipAddress: params.ipAddress,
        userAgent: params.userAgent,
        createdAt: new Date()
      }
    });

    // 重要な変更はアラート送信
    if (this.isCriticalChange(params)) {
      await this.sendAlert(params);
    }
  }

  private isCriticalChange(params: AuditLogParams): boolean {
    // 管理者権限の付与・削除
    // システム機能への権限変更
    // 大量の権限変更
    return params.action === 'GRANT' &&
           params.targetType === 'ADMIN_FEATURE';
  }
}
```

## 6. パフォーマンス最適化

### 6.1 キャッシュ戦略
```typescript
class PermissionCache {
  private redis: Redis;
  private localCache: Map<string, any> = new Map();

  // 多層キャッシュ
  async get(key: string): Promise<any> {
    // L1: ローカルメモリキャッシュ
    if (this.localCache.has(key)) {
      return this.localCache.get(key);
    }

    // L2: Redisキャッシュ
    const redisValue = await this.redis.get(key);
    if (redisValue) {
      const value = JSON.parse(redisValue);
      this.localCache.set(key, value);
      return value;
    }

    return null;
  }

  async set(key: string, value: any, ttl: number = 300): Promise<void> {
    // L1キャッシュに保存
    this.localCache.set(key, value);

    // L2キャッシュに保存
    await this.redis.setex(key, ttl, JSON.stringify(value));

    // L1キャッシュの自動削除
    setTimeout(() => this.localCache.delete(key), ttl * 1000);
  }

  async invalidate(pattern: string): Promise<void> {
    // パターンマッチでキャッシュクリア
    const keys = await this.redis.keys(pattern);
    if (keys.length > 0) {
      await this.redis.del(...keys);
    }

    // ローカルキャッシュもクリア
    for (const [key] of this.localCache) {
      if (key.includes(pattern)) {
        this.localCache.delete(key);
      }
    }
  }
}
```

### 6.2 データベースインデックス最適化
```sql
-- 権限チェック用の複合インデックス
CREATE INDEX idx_dept_perm_lookup
ON department_feature_permissions(department_id, feature_id)
INCLUDE (can_view, can_create, can_edit, can_delete);

-- ユーザー部署検索用
CREATE INDEX idx_user_dept_lookup
ON user_departments(user_id, is_primary)
WHERE expired_date IS NULL;

-- 監査ログ検索用
CREATE INDEX idx_audit_search
ON permission_audit_logs(created_at DESC, user_id, action);
```

## 7. テスト戦略

### 7.1 単体テスト
```typescript
describe('PermissionService', () => {
  describe('getEffectivePermissions', () => {
    it('should return merged permissions from all departments', async () => {
      const userId = 1;
      const permissions = await permissionService.getEffectivePermissions(userId);

      expect(permissions).toHaveProperty('USER_MGMT');
      expect(permissions.USER_MGMT.canView).toBe(true);
    });

    it('should inherit permissions from parent department', async () => {
      // 親部署の権限が子部署に継承されることを確認
    });

    it('should cache permissions for performance', async () => {
      // キャッシュが正しく動作することを確認
    });
  });
});
```

### 7.2 統合テスト
```typescript
describe('Permission API Integration', () => {
  it('should deny access without proper permissions', async () => {
    const response = await request(app)
      .get('/api/users')
      .set('Authorization', 'Bearer ' + limitedUserToken);

    expect(response.status).toBe(403);
  });

  it('should allow access with proper permissions', async () => {
    const response = await request(app)
      .get('/api/users')
      .set('Authorization', 'Bearer ' + adminToken);

    expect(response.status).toBe(200);
  });
});
```

## 8. 移行計画

### 8.1 データ移行スクリプト
```typescript
async function migrateExistingData() {
  // 1. デフォルト会社作成
  const defaultCompany = await db.companies.create({
    data: {
      code: 'DEFAULT',
      name: 'デフォルト会社',
      isActive: true
    }
  });

  // 2. デフォルト部署作成
  const defaultDept = await db.departments.create({
    data: {
      companyId: defaultCompany.id,
      code: 'DEFAULT',
      name: '全社',
      level: 1,
      isActive: true
    }
  });

  // 3. 既存ユーザーの移行
  await db.users.updateMany({
    where: { companyId: null },
    data: {
      companyId: defaultCompany.id,
      primaryDepartmentId: defaultDept.id
    }
  });

  // 4. 機能マスタの初期データ投入
  const features = [
    { code: 'USER_MGMT', name: 'ユーザー管理', category: 'SYSTEM' },
    { code: 'LOG_MGMT', name: 'ログ管理', category: 'SYSTEM' },
    { code: 'PERMISSION_MGMT', name: '権限管理', category: 'SYSTEM' }
  ];

  await db.features.createMany({ data: features });

  // 5. デフォルト権限設定
  // 管理者には全権限を付与
  const adminDept = await db.departments.findFirst({
    where: { code: 'ADMIN' }
  });

  if (adminDept) {
    const allFeatures = await db.features.findMany();
    const permissions = allFeatures.map(f => ({
      departmentId: adminDept.id,
      featureId: f.id,
      canView: true,
      canCreate: true,
      canEdit: true,
      canDelete: true,
      canApprove: true,
      canExport: true
    }));

    await db.departmentFeaturePermissions.createMany({ data: permissions });
  }
}
```

## 9. 運用・保守

### 9.1 監視項目
- 権限チェックのレスポンスタイム
- キャッシュヒット率
- 権限変更の頻度
- 不正アクセス試行回数

### 9.2 定期メンテナンス
- 月次：権限棚卸レポート生成
- 四半期：未使用権限の洗い出し
- 年次：権限体系の見直し