# ç”³è«‹ãƒ»æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ›¸

**æ–‡æ›¸ç•ªå·**: DD-006
**ä½œæˆæ—¥**: 2025-09-27
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0
**ä½œæˆè€…**: ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºãƒãƒ¼ãƒ 
**é–¢é€£æ–‡æ›¸**: [ç”³è«‹æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ©Ÿèƒ½è¨­è¨ˆæ›¸](./ç”³è«‹æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ©Ÿèƒ½è¨­è¨ˆæ›¸.md)

---

## ğŸ“‹ ç›®æ¬¡

1. [æ¦‚è¦](#1-æ¦‚è¦)
2. [ERå›³](#2-erå›³)
3. [ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ](#3-ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ)
4. [ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆ](#4-ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆ)
5. [åˆ¶ç´„è¨­è¨ˆ](#5-åˆ¶ç´„è¨­è¨ˆ)
6. [ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨­è¨ˆ](#6-ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨­è¨ˆ)
7. [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è€ƒæ…®](#7-ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è€ƒæ…®)

---

## 1. æ¦‚è¦

### 1.1 è¨­è¨ˆæ–¹é‡
- æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¨ã®æ•´åˆæ€§ç¶­æŒ
- æ‹¡å¼µæ€§ã‚’è€ƒæ…®ã—ãŸæ­£è¦åŒ–è¨­è¨ˆ
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’é‡è¦–ã—ãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆ
- ç›£æŸ»è¦ä»¶ã‚’æº€ãŸã™ãƒ­ã‚°è¨­è¨ˆ

### 1.2 æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«é€£æº
```sql
-- æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã®é–¢é€£
users (id, username, email, name, company_id, department_id, role)
companies (id, name, code)
departments (id, name, company_id, parent_id)
features (id, name, code, category)
```

### 1.3 æ–°è¦è¿½åŠ ãƒ†ãƒ¼ãƒ–ãƒ«
1. `workflow_types` - ç”³è«‹ç¨®åˆ¥ãƒã‚¹ã‚¿
2. `approval_routes` - æ‰¿èªãƒ«ãƒ¼ãƒˆãƒã‚¹ã‚¿
3. `workflow_requests` - ç”³è«‹æ›¸
4. `approval_history` - æ‰¿èªå±¥æ­´
5. `approval_delegates` - ä»£ç†æ‰¿èªè¨­å®š
6. `workflow_notifications` - é€šçŸ¥ç®¡ç†
7. `workflow_attachments` - æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†

---

## 2. ERå›³

```sql
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   users     â”‚
                    â”‚   (æ—¢å­˜)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚                 â”‚
        â–¼                 â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ companies   â”‚   â”‚departments  â”‚   â”‚  features   â”‚
â”‚   (æ—¢å­˜)    â”‚   â”‚   (æ—¢å­˜)    â”‚   â”‚   (æ—¢å­˜)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                 â”‚
       â”‚                 â”‚
       â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               workflow_types                    â”‚
â”‚  - id, name, form_schema                       â”‚
â”‚  - company_id, created_by                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              approval_routes                    â”‚
â”‚  - id, workflow_type_id                        â”‚
â”‚  - department_id, route_definition             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             workflow_requests                   â”‚
â”‚  - id, workflow_type_id, requester_id          â”‚
â”‚  - form_data, status, current_step             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚             â”‚             â”‚
        â–¼             â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚approval_    â”‚ â”‚workflow_    â”‚ â”‚workflow_    â”‚
â”‚history      â”‚ â”‚attachments  â”‚ â”‚notificationsâ”‚
â”‚             â”‚ â”‚             â”‚ â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚         approval_delegates          â”‚
        â”‚  - user_id, delegate_id             â”‚
        â”‚  - start_date, end_date             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ

### 3.1 workflow_typesï¼ˆç”³è«‹ç¨®åˆ¥ãƒã‚¹ã‚¿ï¼‰

**ç›®çš„**: ç”³è«‹ç¨®åˆ¥ã¨å‹•çš„ãƒ•ã‚©ãƒ¼ãƒ å®šç¾©ã‚’ç®¡ç†

```sql
CREATE TABLE workflow_types (
  -- åŸºæœ¬é …ç›®
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) NOT NULL,                    -- ç”³è«‹ç¨®åˆ¥åï¼ˆå†…éƒ¨ç”¨ï¼‰
  display_name VARCHAR(100) NOT NULL,            -- è¡¨ç¤ºåï¼ˆUIç”¨ï¼‰
  description TEXT,                              -- èª¬æ˜
  category VARCHAR(50) DEFAULT 'GENERAL',        -- ã‚«ãƒ†ã‚´ãƒª

  -- ãƒ•ã‚©ãƒ¼ãƒ å®šç¾©
  form_schema JSONB NOT NULL,                    -- å‹•çš„ãƒ•ã‚©ãƒ¼ãƒ å®šç¾©
  validation_rules JSONB,                        -- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ«

  -- UIè¨­å®š
  icon VARCHAR(50) DEFAULT 'Document',           -- ã‚¢ã‚¤ã‚³ãƒ³å
  color VARCHAR(20) DEFAULT '#409EFF',           -- ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼
  sort_order INTEGER DEFAULT 0,                 -- è¡¨ç¤ºé †åº

  -- ãƒ•ã‚¡ã‚¤ãƒ«è¨­å®š
  is_file_required BOOLEAN DEFAULT false,        -- ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜å¿…é ˆ
  max_file_size INTEGER DEFAULT 10485760,       -- æœ€å¤§ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º(10MB)
  allowed_file_types TEXT DEFAULT 'pdf,doc,docx,xls,xlsx,jpg,png', -- è¨±å¯ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼
  max_file_count INTEGER DEFAULT 5,             -- æœ€å¤§ãƒ•ã‚¡ã‚¤ãƒ«æ•°

  -- æ¥­å‹™è¨­å®š
  auto_approval_enabled BOOLEAN DEFAULT false,   -- è‡ªå‹•æ‰¿èªæœ‰åŠ¹
  auto_approval_conditions JSONB,               -- è‡ªå‹•æ‰¿èªæ¡ä»¶
  estimated_processing_days INTEGER DEFAULT 3,   -- æ¨™æº–å‡¦ç†æ—¥æ•°
  urgent_processing_days INTEGER DEFAULT 1,      -- ç·Šæ€¥æ™‚å‡¦ç†æ—¥æ•°

  -- é€šçŸ¥è¨­å®š
  notification_template JSONB,                  -- é€šçŸ¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
  reminder_days INTEGER[] DEFAULT '{1,3,5}',    -- ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼æ—¥æ•°

  -- ã‚·ã‚¹ãƒ†ãƒ é …ç›®
  is_active BOOLEAN DEFAULT true,
  company_id INTEGER NOT NULL REFERENCES companies(id),
  created_by INTEGER REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),

  -- åˆ¶ç´„
  CONSTRAINT workflow_types_company_name_unique
    UNIQUE(company_id, name),
  CONSTRAINT workflow_types_name_check
    CHECK (LENGTH(name) >= 1),
  CONSTRAINT workflow_types_file_size_check
    CHECK (max_file_size > 0 AND max_file_size <= 104857600), -- æœ€å¤§100MB
  CONSTRAINT workflow_types_file_count_check
    CHECK (max_file_count > 0 AND max_file_count <= 20)
);

-- ã‚³ãƒ¡ãƒ³ãƒˆ
COMMENT ON TABLE workflow_types IS 'ç”³è«‹ç¨®åˆ¥ãƒã‚¹ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«';
COMMENT ON COLUMN workflow_types.form_schema IS 'å‹•çš„ãƒ•ã‚©ãƒ¼ãƒ å®šç¾©ï¼ˆJSONå½¢å¼ï¼‰';
COMMENT ON COLUMN workflow_types.validation_rules IS 'ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ«ï¼ˆJSONå½¢å¼ï¼‰';
COMMENT ON COLUMN workflow_types.auto_approval_conditions IS 'è‡ªå‹•æ‰¿èªæ¡ä»¶ï¼ˆJSONå½¢å¼ï¼‰';
```

**form_schemaä¾‹**:
```json
{
  "fields": [
    {
      "name": "startDate",
      "type": "date",
      "label": "é–‹å§‹æ—¥",
      "required": true,
      "validation": {
        "min": "today",
        "max": "today+365"
      }
    },
    {
      "name": "endDate",
      "type": "date",
      "label": "çµ‚äº†æ—¥",
      "required": true,
      "validation": {
        "min": "{startDate}",
        "max": "today+365"
      }
    },
    {
      "name": "reason",
      "type": "textarea",
      "label": "ç†ç”±",
      "required": true,
      "validation": {
        "maxLength": 1000
      }
    },
    {
      "name": "amount",
      "type": "number",
      "label": "é‡‘é¡",
      "required": false,
      "validation": {
        "min": 0,
        "max": 1000000
      }
    }
  ]
}
```

### 3.2 approval_routesï¼ˆæ‰¿èªãƒ«ãƒ¼ãƒˆãƒã‚¹ã‚¿ï¼‰

**ç›®çš„**: ç”³è«‹ç¨®åˆ¥ãƒ»éƒ¨ç½²åˆ¥ã®æ‰¿èªãƒ«ãƒ¼ãƒˆã‚’å®šç¾©

```sql
CREATE TABLE approval_routes (
  -- åŸºæœ¬é …ç›®
  id SERIAL PRIMARY KEY,
  workflow_type_id INTEGER NOT NULL REFERENCES workflow_types(id),
  department_id INTEGER REFERENCES departments(id), -- NULL = å…¨éƒ¨ç½²å…±é€š
  route_name VARCHAR(100) NOT NULL,                 -- ãƒ«ãƒ¼ãƒˆå

  -- ãƒ«ãƒ¼ãƒˆå®šç¾©
  route_definition JSONB NOT NULL,                  -- æ‰¿èªãƒ«ãƒ¼ãƒˆå®šç¾©
  condition_rules JSONB,                            -- æ¡ä»¶åˆ†å²ãƒ«ãƒ¼ãƒ«

  -- è¨­å®š
  is_default BOOLEAN DEFAULT false,                 -- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ãƒˆ
  priority INTEGER DEFAULT 0,                      -- å„ªå…ˆåº¦ï¼ˆé«˜ã„é †ã«é©ç”¨ï¼‰

  -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  description TEXT,                                 -- ãƒ«ãƒ¼ãƒˆèª¬æ˜
  estimated_days INTEGER DEFAULT 3,                -- äºˆæƒ³å‡¦ç†æ—¥æ•°

  -- ã‚·ã‚¹ãƒ†ãƒ é …ç›®
  is_active BOOLEAN DEFAULT true,
  created_by INTEGER REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),

  -- åˆ¶ç´„
  CONSTRAINT approval_routes_type_dept_name_unique
    UNIQUE(workflow_type_id, department_id, route_name),
  CONSTRAINT approval_routes_priority_check
    CHECK (priority >= 0)
);

-- ã‚³ãƒ¡ãƒ³ãƒˆ
COMMENT ON TABLE approval_routes IS 'æ‰¿èªãƒ«ãƒ¼ãƒˆãƒã‚¹ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«';
COMMENT ON COLUMN approval_routes.route_definition IS 'æ‰¿èªãƒ«ãƒ¼ãƒˆå®šç¾©ï¼ˆJSONå½¢å¼ï¼‰';
COMMENT ON COLUMN approval_routes.condition_rules IS 'æ¡ä»¶åˆ†å²ãƒ«ãƒ¼ãƒ«ï¼ˆJSONå½¢å¼ï¼‰';
```

**route_definitionä¾‹**:
```json
{
  "steps": [
    {
      "stepNumber": 1,
      "stepName": "ç›´å±ä¸Šå¸æ‰¿èª",
      "approverType": "DIRECT_MANAGER",
      "approverIds": [],
      "isParallel": false,
      "timeoutDays": 3,
      "isSkippable": false,
      "skipConditions": []
    },
    {
      "stepNumber": 2,
      "stepName": "éƒ¨é–€é•·æ‰¿èª",
      "approverType": "DEPARTMENT_MANAGER",
      "approverIds": [],
      "isParallel": false,
      "timeoutDays": 3,
      "isSkippable": true,
      "skipConditions": [
        {
          "field": "amount",
          "operator": "<=",
          "value": 50000
        }
      ]
    },
    {
      "stepNumber": 3,
      "stepName": "å½¹å“¡æ‰¿èª",
      "approverType": "EXECUTIVE",
      "approverIds": [101, 102],
      "isParallel": true,
      "timeoutDays": 5,
      "isSkippable": true,
      "skipConditions": [
        {
          "field": "amount",
          "operator": "<=",
          "value": 100000
        }
      ]
    }
  ]
}
```

### 3.3 workflow_requestsï¼ˆç”³è«‹æ›¸ï¼‰

**ç›®çš„**: ç”³è«‹æ›¸ã®è©³ç´°æƒ…å ±ã‚’ç®¡ç†

```sql
CREATE TABLE workflow_requests (
  -- åŸºæœ¬é …ç›®
  id SERIAL PRIMARY KEY,
  request_number VARCHAR(50) UNIQUE NOT NULL,       -- ç”³è«‹ç•ªå·
  workflow_type_id INTEGER NOT NULL REFERENCES workflow_types(id),
  requester_id INTEGER NOT NULL REFERENCES users(id),

  -- ç”³è«‹å†…å®¹
  title VARCHAR(200) NOT NULL,                      -- ç”³è«‹ã‚¿ã‚¤ãƒˆãƒ«
  description TEXT,                                 -- ç”³è«‹æ¦‚è¦
  form_data JSONB NOT NULL,                         -- ç”³è«‹ãƒ‡ãƒ¼ã‚¿

  -- ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼çŠ¶æ…‹
  current_step INTEGER DEFAULT 0,                   -- ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆ0=ä¸‹æ›¸ãï¼‰
  total_steps INTEGER DEFAULT 0,                    -- ç·ã‚¹ãƒ†ãƒƒãƒ—æ•°
  status VARCHAR(20) DEFAULT 'DRAFT',               -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  applied_route_id INTEGER REFERENCES approval_routes(id), -- é©ç”¨ã•ã‚ŒãŸæ‰¿èªãƒ«ãƒ¼ãƒˆ

  -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  urgency VARCHAR(10) DEFAULT 'NORMAL',             -- ç·Šæ€¥åº¦
  priority_score INTEGER DEFAULT 0,                -- å„ªå…ˆåº¦ã‚¹ã‚³ã‚¢
  estimated_amount DECIMAL(15,2),                   -- æ¦‚ç®—é‡‘é¡
  currency_code VARCHAR(3) DEFAULT 'JPY',           -- é€šè²¨ã‚³ãƒ¼ãƒ‰

  -- æ—¥ä»˜ç®¡ç†
  due_date DATE,                                    -- å¸Œæœ›å®Œäº†æ—¥
  submitted_at TIMESTAMP,                           -- ç”³è«‹æå‡ºæ—¥æ™‚
  started_at TIMESTAMP,                             -- æ‰¿èªé–‹å§‹æ—¥æ™‚
  completed_at TIMESTAMP,                           -- æ‰¿èªå®Œäº†æ—¥æ™‚
  cancelled_at TIMESTAMP,                           -- ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ—¥æ™‚

  -- å‡¦ç†çµæœ
  final_status VARCHAR(20),                         -- æœ€çµ‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  final_comment TEXT,                               -- æœ€çµ‚ã‚³ãƒ¡ãƒ³ãƒˆ
  final_approver_id INTEGER REFERENCES users(id),   -- æœ€çµ‚æ‰¿èªè€…

  -- è¿½åŠ æƒ…å ±
  tags VARCHAR(500),                                -- ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰
  reference_numbers VARCHAR(500),                   -- é–¢é€£ç•ªå·
  cancel_reason TEXT,                               -- ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±

  -- è¨ˆç®—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  processing_time INTERVAL,                         -- å‡¦ç†æ™‚é–“
  sla_deadline TIMESTAMP,                           -- SLAæœŸé™
  is_overdue BOOLEAN GENERATED ALWAYS AS (
    sla_deadline IS NOT NULL AND
    sla_deadline < NOW() AND
    status IN ('SUBMITTED', 'IN_PROGRESS')
  ) STORED,                                         -- æœŸé™è¶…éãƒ•ãƒ©ã‚°

  -- ã‚·ã‚¹ãƒ†ãƒ é …ç›®
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),

  -- åˆ¶ç´„
  CONSTRAINT workflow_requests_status_check
    CHECK (status IN ('DRAFT', 'SUBMITTED', 'IN_PROGRESS', 'APPROVED', 'REJECTED', 'CANCELLED', 'WITHDRAWN')),
  CONSTRAINT workflow_requests_urgency_check
    CHECK (urgency IN ('LOW', 'NORMAL', 'HIGH', 'URGENT')),
  CONSTRAINT workflow_requests_final_status_check
    CHECK (final_status IS NULL OR final_status IN ('APPROVED', 'REJECTED', 'CANCELLED', 'WITHDRAWN')),
  CONSTRAINT workflow_requests_step_check
    CHECK (current_step >= 0 AND current_step <= total_steps),
  CONSTRAINT workflow_requests_amount_check
    CHECK (estimated_amount IS NULL OR estimated_amount >= 0),
  CONSTRAINT workflow_requests_date_check
    CHECK (due_date IS NULL OR due_date >= CURRENT_DATE)
);

-- ã‚³ãƒ¡ãƒ³ãƒˆ
COMMENT ON TABLE workflow_requests IS 'ç”³è«‹æ›¸ãƒ†ãƒ¼ãƒ–ãƒ«';
COMMENT ON COLUMN workflow_requests.form_data IS 'ç”³è«‹ãƒ‡ãƒ¼ã‚¿ï¼ˆJSONå½¢å¼ï¼‰';
COMMENT ON COLUMN workflow_requests.priority_score IS 'ç·Šæ€¥åº¦ãƒ»é‡‘é¡ç­‰ã‹ã‚‰ç®—å‡ºã•ã‚Œã‚‹å„ªå…ˆåº¦';
COMMENT ON COLUMN workflow_requests.is_overdue IS 'SLAæœŸé™è¶…éãƒ•ãƒ©ã‚°ï¼ˆè¨ˆç®—åˆ—ï¼‰';
```

### 3.4 approval_historyï¼ˆæ‰¿èªå±¥æ­´ï¼‰

**ç›®çš„**: æ‰¿èªãƒ—ãƒ­ã‚»ã‚¹ã®å®Œå…¨ãªå±¥æ­´ã‚’è¨˜éŒ²

```sql
CREATE TABLE approval_history (
  -- åŸºæœ¬é …ç›®
  id SERIAL PRIMARY KEY,
  request_id INTEGER NOT NULL REFERENCES workflow_requests(id),
  step_number INTEGER NOT NULL,                     -- ã‚¹ãƒ†ãƒƒãƒ—ç•ªå·
  step_name VARCHAR(100) NOT NULL,                  -- ã‚¹ãƒ†ãƒƒãƒ—å

  -- æ‰¿èªè€…æƒ…å ±
  approver_id INTEGER NOT NULL REFERENCES users(id),
  original_approver_id INTEGER REFERENCES users(id), -- å…ƒã®æ‰¿èªè€…ï¼ˆä»£ç†ã®å ´åˆï¼‰
  approver_department_id INTEGER REFERENCES departments(id), -- æ‰¿èªè€…æ‰€å±éƒ¨ç½²

  -- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
  action VARCHAR(20) NOT NULL,                      -- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
  decision_reason TEXT,                             -- åˆ¤æ–­ç†ç”±
  comment TEXT,                                     -- ã‚³ãƒ¡ãƒ³ãƒˆ
  recommendations TEXT,                             -- æ¨å¥¨äº‹é …

  -- è¿½åŠ ãƒ‡ãƒ¼ã‚¿
  additional_data JSONB,                            -- è¿½åŠ ãƒ‡ãƒ¼ã‚¿
  attachments JSONB,                                -- æ‰¿èªæ™‚æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«

  -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  processing_duration INTERVAL,                     -- å‡¦ç†æ™‚é–“
  decision_confidence INTEGER CHECK (decision_confidence BETWEEN 1 AND 5), -- åˆ¤æ–­ç¢ºä¿¡åº¦
  risk_assessment TEXT,                             -- ãƒªã‚¹ã‚¯è©•ä¾¡

  -- ç›£æŸ»æƒ…å ±
  ip_address INET,                                  -- IPã‚¢ãƒ‰ãƒ¬ã‚¹
  user_agent TEXT,                                  -- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
  session_id VARCHAR(100),                          -- ã‚»ãƒƒã‚·ãƒ§ãƒ³ID
  device_info JSONB,                                -- ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±
  location_info JSONB,                              -- ä½ç½®æƒ…å ±

  -- ã‚·ã‚¹ãƒ†ãƒ é …ç›®
  created_at TIMESTAMP DEFAULT NOW(),               -- æ‰¿èªæ—¥æ™‚

  -- åˆ¶ç´„
  CONSTRAINT approval_history_action_check
    CHECK (action IN ('APPROVE', 'REJECT', 'RETURN', 'DELEGATE', 'CANCEL', 'TIMEOUT', 'WITHDRAW')),
  CONSTRAINT approval_history_step_check
    CHECK (step_number > 0)
);

-- ã‚³ãƒ¡ãƒ³ãƒˆ
COMMENT ON TABLE approval_history IS 'æ‰¿èªå±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«';
COMMENT ON COLUMN approval_history.additional_data IS 'æ‰¿èªæ™‚ã®è¿½åŠ ãƒ‡ãƒ¼ã‚¿ï¼ˆJSONå½¢å¼ï¼‰';
COMMENT ON COLUMN approval_history.decision_confidence IS 'åˆ¤æ–­ã®ç¢ºä¿¡åº¦ï¼ˆ1-5ï¼‰';
```

### 3.5 approval_delegatesï¼ˆä»£ç†æ‰¿èªè¨­å®šï¼‰

**ç›®çš„**: ä»£ç†æ‰¿èªã®è¨­å®šã‚’ç®¡ç†

```sql
CREATE TABLE approval_delegates (
  -- åŸºæœ¬é …ç›®
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL REFERENCES users(id),        -- æœ¬äºº
  delegate_id INTEGER NOT NULL REFERENCES users(id),    -- ä»£ç†äºº

  -- ä»£ç†æ¡ä»¶
  workflow_type_ids INTEGER[] DEFAULT '{}',             -- å¯¾è±¡ç”³è«‹ç¨®åˆ¥IDé…åˆ—
  department_ids INTEGER[] DEFAULT '{}',                -- å¯¾è±¡éƒ¨ç½²IDé…åˆ—
  max_amount DECIMAL(15,2),                             -- ä»£ç†æ‰¿èªä¸Šé™é‡‘é¡
  urgency_levels VARCHAR(50)[] DEFAULT '{NORMAL,HIGH,URGENT}', -- å¯¾è±¡ç·Šæ€¥åº¦

  -- æœŸé–“è¨­å®š
  start_date DATE NOT NULL,                             -- é–‹å§‹æ—¥
  end_date DATE NOT NULL,                               -- çµ‚äº†æ—¥
  effective_hours JSONB,                                -- æœ‰åŠ¹æ™‚é–“å¸¯

  -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  reason TEXT NOT NULL,                                 -- ä»£ç†ç†ç”±
  emergency_contact VARCHAR(200),                       -- ç·Šæ€¥é€£çµ¡å…ˆ
  special_instructions TEXT,                            -- ç‰¹åˆ¥æŒ‡ç¤º

  -- åˆ¶é™è¨­å®š
  max_approvals_per_day INTEGER DEFAULT 50,            -- 1æ—¥æœ€å¤§æ‰¿èªæ•°
  requires_notification BOOLEAN DEFAULT true,           -- æœ¬äººé€šçŸ¥å¿…è¦
  auto_delegation BOOLEAN DEFAULT false,                -- è‡ªå‹•ä»£ç†å®Ÿè¡Œ

  -- ã‚·ã‚¹ãƒ†ãƒ é …ç›®
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),

  -- åˆ¶ç´„
  CONSTRAINT approval_delegates_date_check
    CHECK (end_date >= start_date),
  CONSTRAINT approval_delegates_different_users
    CHECK (user_id != delegate_id),
  CONSTRAINT approval_delegates_amount_check
    CHECK (max_amount IS NULL OR max_amount >= 0),
  CONSTRAINT approval_delegates_max_approvals_check
    CHECK (max_approvals_per_day > 0)
);

-- ã‚³ãƒ¡ãƒ³ãƒˆ
COMMENT ON TABLE approval_delegates IS 'ä»£ç†æ‰¿èªè¨­å®šãƒ†ãƒ¼ãƒ–ãƒ«';
COMMENT ON COLUMN approval_delegates.workflow_type_ids IS 'å¯¾è±¡ç”³è«‹ç¨®åˆ¥IDé…åˆ—ï¼ˆç©ºé…åˆ—=å…¨ç¨®åˆ¥ï¼‰';
COMMENT ON COLUMN approval_delegates.effective_hours IS 'æœ‰åŠ¹æ™‚é–“å¸¯è¨­å®šï¼ˆJSONå½¢å¼ï¼‰';
```

### 3.6 workflow_notificationsï¼ˆé€šçŸ¥ç®¡ç†ï¼‰

**ç›®çš„**: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼é–¢é€£ã®é€šçŸ¥ã‚’ç®¡ç†

```sql
CREATE TABLE workflow_notifications (
  -- åŸºæœ¬é …ç›®
  id SERIAL PRIMARY KEY,
  request_id INTEGER NOT NULL REFERENCES workflow_requests(id),
  user_id INTEGER NOT NULL REFERENCES users(id),

  -- é€šçŸ¥å†…å®¹
  notification_type VARCHAR(30) NOT NULL,              -- é€šçŸ¥ç¨®åˆ¥
  title VARCHAR(200) NOT NULL,                         -- é€šçŸ¥ã‚¿ã‚¤ãƒˆãƒ«
  message TEXT NOT NULL,                               -- é€šçŸ¥å†…å®¹
  action_url VARCHAR(500),                             -- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³URL

  -- è¡¨ç¤ºè¨­å®š
  priority_level INTEGER DEFAULT 3,                    -- å„ªå…ˆåº¦ï¼ˆ1-5ï¼‰
  display_duration INTEGER DEFAULT 5000,               -- è¡¨ç¤ºæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
  icon VARCHAR(50),                                    -- ã‚¢ã‚¤ã‚³ãƒ³
  color VARCHAR(20),                                   -- ã‚«ãƒ©ãƒ¼

  -- çŠ¶æ…‹ç®¡ç†
  is_read BOOLEAN DEFAULT false,                       -- æ—¢èª­ãƒ•ãƒ©ã‚°
  read_at TIMESTAMP,                                   -- æ—¢èª­æ—¥æ™‚
  is_actionable BOOLEAN DEFAULT false,                 -- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¯èƒ½
  action_taken BOOLEAN DEFAULT false,                  -- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ¸ˆã¿
  action_taken_at TIMESTAMP,                           -- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ—¥æ™‚

  -- é…ä¿¡ãƒãƒ£ãƒãƒ«
  sent_in_app BOOLEAN DEFAULT true,                    -- ã‚¢ãƒ—ãƒªå†…é€šçŸ¥æ¸ˆã¿
  sent_email BOOLEAN DEFAULT false,                    -- ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ¸ˆã¿
  sent_sms BOOLEAN DEFAULT false,                      -- SMSé€ä¿¡æ¸ˆã¿
  sent_push BOOLEAN DEFAULT false,                     -- ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥æ¸ˆã¿

  -- é…ä¿¡æ—¥æ™‚
  in_app_sent_at TIMESTAMP,                           -- ã‚¢ãƒ—ãƒªå†…é€šçŸ¥æ—¥æ™‚
  email_sent_at TIMESTAMP,                             -- ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ—¥æ™‚
  sms_sent_at TIMESTAMP,                               -- SMSé€ä¿¡æ—¥æ™‚
  push_sent_at TIMESTAMP,                              -- ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥æ—¥æ™‚

  -- ã‚¨ãƒ©ãƒ¼ç®¡ç†
  delivery_errors JSONB,                               -- é…ä¿¡ã‚¨ãƒ©ãƒ¼æƒ…å ±
  retry_count INTEGER DEFAULT 0,                      -- å†é€å›æ•°
  max_retries INTEGER DEFAULT 3,                      -- æœ€å¤§å†é€å›æ•°

  -- æœŸé™ç®¡ç†
  expires_at TIMESTAMP,                                -- é€šçŸ¥æœŸé™
  is_expired BOOLEAN GENERATED ALWAYS AS (
    expires_at IS NOT NULL AND expires_at < NOW()
  ) STORED,                                           -- æœŸé™åˆ‡ã‚Œãƒ•ãƒ©ã‚°

  -- ã‚·ã‚¹ãƒ†ãƒ é …ç›®
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),

  -- åˆ¶ç´„
  CONSTRAINT workflow_notifications_type_check
    CHECK (notification_type IN (
      'SUBMITTED', 'APPROVAL_REQUIRED', 'APPROVED', 'REJECTED',
      'RETURNED', 'CANCELLED', 'REMINDER', 'OVERDUE', 'DELEGATE_ASSIGNED'
    )),
  CONSTRAINT workflow_notifications_priority_check
    CHECK (priority_level BETWEEN 1 AND 5),
  CONSTRAINT workflow_notifications_retry_check
    CHECK (retry_count >= 0 AND retry_count <= max_retries)
);

-- ã‚³ãƒ¡ãƒ³ãƒˆ
COMMENT ON TABLE workflow_notifications IS 'ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼é€šçŸ¥ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«';
COMMENT ON COLUMN workflow_notifications.delivery_errors IS 'é…ä¿¡ã‚¨ãƒ©ãƒ¼æƒ…å ±ï¼ˆJSONå½¢å¼ï¼‰';
COMMENT ON COLUMN workflow_notifications.is_expired IS 'é€šçŸ¥æœŸé™åˆ‡ã‚Œãƒ•ãƒ©ã‚°ï¼ˆè¨ˆç®—åˆ—ï¼‰';
```

### 3.7 workflow_attachmentsï¼ˆæ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ï¼‰

**ç›®çš„**: ç”³è«‹ãƒ»æ‰¿èªæ™‚ã®æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç®¡ç†

```sql
CREATE TABLE workflow_attachments (
  -- åŸºæœ¬é …ç›®
  id SERIAL PRIMARY KEY,
  request_id INTEGER NOT NULL REFERENCES workflow_requests(id),
  approval_history_id INTEGER REFERENCES approval_history(id), -- æ‰¿èªæ™‚æ·»ä»˜ã®å ´åˆ

  -- ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±
  original_filename VARCHAR(255) NOT NULL,             -- å…ƒãƒ•ã‚¡ã‚¤ãƒ«å
  stored_filename VARCHAR(255) NOT NULL,               -- ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«å
  file_path VARCHAR(500) NOT NULL,                     -- ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
  file_size BIGINT NOT NULL,                           -- ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºï¼ˆãƒã‚¤ãƒˆï¼‰
  mime_type VARCHAR(100) NOT NULL,                     -- MIMEã‚¿ã‚¤ãƒ—
  file_extension VARCHAR(10),                          -- ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­

  -- ãƒ•ã‚¡ã‚¤ãƒ«å±æ€§
  file_category VARCHAR(50) DEFAULT 'DOCUMENT',        -- ãƒ•ã‚¡ã‚¤ãƒ«ã‚«ãƒ†ã‚´ãƒª
  file_description TEXT,                               -- ãƒ•ã‚¡ã‚¤ãƒ«èª¬æ˜
  is_confidential BOOLEAN DEFAULT false,               -- æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«
  access_level INTEGER DEFAULT 1,                     -- ã‚¢ã‚¯ã‚»ã‚¹ãƒ¬ãƒ™ãƒ«ï¼ˆ1-5ï¼‰

  -- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
  checksum VARCHAR(64) NOT NULL,                       -- ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯ã‚µãƒ 
  encryption_key VARCHAR(100),                         -- æš—å·åŒ–ã‚­ãƒ¼
  is_encrypted BOOLEAN DEFAULT false,                  -- æš—å·åŒ–æ¸ˆã¿
  virus_scan_status VARCHAR(20) DEFAULT 'PENDING',     -- ã‚¦ã‚¤ãƒ«ã‚¹ã‚¹ã‚­ãƒ£ãƒ³çŠ¶æ…‹
  virus_scan_result JSONB,                             -- ã‚¹ã‚­ãƒ£ãƒ³çµæœè©³ç´°

  -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  uploaded_by INTEGER NOT NULL REFERENCES users(id),   -- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰è€…
  upload_ip INET,                                      -- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å…ƒIP
  upload_user_agent TEXT,                              -- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ

  -- ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†
  version_number INTEGER DEFAULT 1,                    -- ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·
  parent_attachment_id INTEGER REFERENCES workflow_attachments(id), -- è¦ªãƒ•ã‚¡ã‚¤ãƒ«
  is_latest_version BOOLEAN DEFAULT true,              -- æœ€æ–°ç‰ˆãƒ•ãƒ©ã‚°

  -- ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
  download_count INTEGER DEFAULT 0,                    -- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å›æ•°
  last_accessed_at TIMESTAMP,                          -- æœ€çµ‚ã‚¢ã‚¯ã‚»ã‚¹æ—¥æ™‚
  last_accessed_by INTEGER REFERENCES users(id),       -- æœ€çµ‚ã‚¢ã‚¯ã‚»ã‚¹è€…
  access_log JSONB,                                    -- ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°

  -- ä¿å­˜æœŸé–“
  retention_period INTEGER,                            -- ä¿å­˜æœŸé–“ï¼ˆæ—¥ï¼‰
  archive_date DATE,                                   -- ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–äºˆå®šæ—¥
  deletion_date DATE,                                  -- å‰Šé™¤äºˆå®šæ—¥
  is_archived BOOLEAN DEFAULT false,                  -- ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ¸ˆã¿

  -- ã‚·ã‚¹ãƒ†ãƒ é …ç›®
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),

  -- åˆ¶ç´„
  CONSTRAINT workflow_attachments_file_size_check
    CHECK (file_size > 0 AND file_size <= 104857600), -- æœ€å¤§100MB
  CONSTRAINT workflow_attachments_access_level_check
    CHECK (access_level BETWEEN 1 AND 5),
  CONSTRAINT workflow_attachments_virus_scan_check
    CHECK (virus_scan_status IN ('PENDING', 'CLEAN', 'INFECTED', 'ERROR')),
  CONSTRAINT workflow_attachments_version_check
    CHECK (version_number > 0)
);

-- ã‚³ãƒ¡ãƒ³ãƒˆ
COMMENT ON TABLE workflow_attachments IS 'ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«';
COMMENT ON COLUMN workflow_attachments.checksum IS 'ãƒ•ã‚¡ã‚¤ãƒ«æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ç”¨ãƒãƒƒã‚·ãƒ¥å€¤';
COMMENT ON COLUMN workflow_attachments.access_log IS 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ï¼ˆJSONå½¢å¼ï¼‰';
```

---

## 4. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆ

### 4.1 ä¸»è¦æ¤œç´¢ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¥ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

```sql
-- workflow_typesé–¢é€£
CREATE INDEX idx_workflow_types_company_active
  ON workflow_types(company_id, is_active);
CREATE INDEX idx_workflow_types_category
  ON workflow_types(category, sort_order);

-- approval_routesé–¢é€£
CREATE INDEX idx_approval_routes_workflow_dept
  ON approval_routes(workflow_type_id, department_id, is_active);
CREATE INDEX idx_approval_routes_default
  ON approval_routes(workflow_type_id, is_default)
  WHERE is_active = true;

-- workflow_requestsé–¢é€£ï¼ˆæœ€é‡è¦ï¼‰
CREATE INDEX idx_workflow_requests_requester_status
  ON workflow_requests(requester_id, status, created_at DESC);
CREATE INDEX idx_workflow_requests_status_created
  ON workflow_requests(status, created_at DESC)
  WHERE status IN ('SUBMITTED', 'IN_PROGRESS');
CREATE INDEX idx_workflow_requests_type_status
  ON workflow_requests(workflow_type_id, status, created_at DESC);
CREATE INDEX idx_workflow_requests_overdue
  ON workflow_requests(sla_deadline, status)
  WHERE is_overdue = true;
CREATE INDEX idx_workflow_requests_approval_waiting
  ON workflow_requests(current_step, status)
  WHERE status = 'IN_PROGRESS';

-- approval_historyé–¢é€£
CREATE INDEX idx_approval_history_request_step
  ON approval_history(request_id, step_number, created_at DESC);
CREATE INDEX idx_approval_history_approver_date
  ON approval_history(approver_id, created_at DESC);
CREATE INDEX idx_approval_history_action_date
  ON approval_history(action, created_at DESC);

-- approval_delegatesé–¢é€£
CREATE INDEX idx_approval_delegates_user_period
  ON approval_delegates(user_id, start_date, end_date)
  WHERE is_active = true;
CREATE INDEX idx_approval_delegates_delegate_active
  ON approval_delegates(delegate_id, start_date, end_date)
  WHERE is_active = true;

-- workflow_notificationsé–¢é€£
CREATE INDEX idx_workflow_notifications_user_unread
  ON workflow_notifications(user_id, is_read, created_at DESC);
CREATE INDEX idx_workflow_notifications_request
  ON workflow_notifications(request_id, created_at DESC);
CREATE INDEX idx_workflow_notifications_expired
  ON workflow_notifications(expires_at)
  WHERE is_expired = false;

-- workflow_attachmentsé–¢é€£
CREATE INDEX idx_workflow_attachments_request
  ON workflow_attachments(request_id, created_at DESC);
CREATE INDEX idx_workflow_attachments_approval
  ON workflow_attachments(approval_history_id)
  WHERE approval_history_id IS NOT NULL;
CREATE INDEX idx_workflow_attachments_checksum
  ON workflow_attachments(checksum);
```

### 4.2 è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆæ€§èƒ½é‡è¦–ï¼‰

```sql
-- æ‰¿èªå¾…ã¡æ¤œç´¢ç”¨ï¼ˆæœ€é‡è¦ï¼‰
CREATE INDEX idx_approval_waiting_complex
  ON workflow_requests(status, current_step, urgency, created_at DESC)
  WHERE status = 'IN_PROGRESS';

-- çµ±è¨ˆãƒ»ãƒ¬ãƒãƒ¼ãƒˆç”¨
CREATE INDEX idx_requests_stats
  ON workflow_requests(workflow_type_id, status, DATE(created_at));

-- æœŸé™ç®¡ç†ç”¨
CREATE INDEX idx_requests_sla
  ON workflow_requests(sla_deadline, status, urgency)
  WHERE status IN ('SUBMITTED', 'IN_PROGRESS');

-- ä»£ç†æ‰¿èªåˆ¤å®šç”¨
CREATE INDEX idx_delegates_lookup
  ON approval_delegates(delegate_id, start_date, end_date, is_active)
  WHERE is_active = true;
```

### 4.3 JSONåˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆGINï¼‰

```sql
-- ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿æ¤œç´¢ç”¨
CREATE INDEX idx_workflow_types_form_schema_gin
  ON workflow_types USING gin(form_schema);

-- ç”³è«‹ãƒ‡ãƒ¼ã‚¿æ¤œç´¢ç”¨
CREATE INDEX idx_workflow_requests_form_data_gin
  ON workflow_requests USING gin(form_data);

-- æ‰¿èªãƒ«ãƒ¼ãƒˆæ¤œç´¢ç”¨
CREATE INDEX idx_approval_routes_definition_gin
  ON approval_routes USING gin(route_definition);
```

---

## 5. åˆ¶ç´„è¨­è¨ˆ

### 5.1 å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„

```sql
-- workflow_types
ALTER TABLE workflow_types
  ADD CONSTRAINT fk_workflow_types_company
  FOREIGN KEY (company_id) REFERENCES companies(id) ON DELETE CASCADE;

ALTER TABLE workflow_types
  ADD CONSTRAINT fk_workflow_types_creator
  FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL;

-- approval_routes
ALTER TABLE approval_routes
  ADD CONSTRAINT fk_approval_routes_workflow_type
  FOREIGN KEY (workflow_type_id) REFERENCES workflow_types(id) ON DELETE CASCADE;

ALTER TABLE approval_routes
  ADD CONSTRAINT fk_approval_routes_department
  FOREIGN KEY (department_id) REFERENCES departments(id) ON DELETE CASCADE;

-- workflow_requests
ALTER TABLE workflow_requests
  ADD CONSTRAINT fk_workflow_requests_type
  FOREIGN KEY (workflow_type_id) REFERENCES workflow_types(id) ON DELETE RESTRICT;

ALTER TABLE workflow_requests
  ADD CONSTRAINT fk_workflow_requests_requester
  FOREIGN KEY (requester_id) REFERENCES users(id) ON DELETE RESTRICT;

ALTER TABLE workflow_requests
  ADD CONSTRAINT fk_workflow_requests_route
  FOREIGN KEY (applied_route_id) REFERENCES approval_routes(id) ON DELETE SET NULL;

-- approval_history
ALTER TABLE approval_history
  ADD CONSTRAINT fk_approval_history_request
  FOREIGN KEY (request_id) REFERENCES workflow_requests(id) ON DELETE CASCADE;

ALTER TABLE approval_history
  ADD CONSTRAINT fk_approval_history_approver
  FOREIGN KEY (approver_id) REFERENCES users(id) ON DELETE RESTRICT;
```

### 5.2 ãƒã‚§ãƒƒã‚¯åˆ¶ç´„

```sql
-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»åˆ¶ç´„
CREATE OR REPLACE FUNCTION check_status_transition()
RETURNS TRIGGER AS $$
BEGIN
  -- æ‰¿èªæ¸ˆã¿ãƒ»å´ä¸‹ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾Œã®å¤‰æ›´ç¦æ­¢
  IF OLD.status IN ('APPROVED', 'REJECTED', 'CANCELLED')
     AND NEW.status != OLD.status THEN
    RAISE EXCEPTION 'Cannot change status from % to %', OLD.status, NEW.status;
  END IF;

  -- ä¸‹æ›¸ãã‹ã‚‰ç›´æ¥å®Œäº†çŠ¶æ…‹ã¸ã®é·ç§»ç¦æ­¢
  IF OLD.status = 'DRAFT' AND NEW.status IN ('APPROVED', 'REJECTED') THEN
    RAISE EXCEPTION 'Cannot transition directly from DRAFT to %', NEW.status;
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_workflow_requests_status_transition
  BEFORE UPDATE ON workflow_requests
  FOR EACH ROW
  EXECUTE FUNCTION check_status_transition();
```

### 5.3 ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§åˆ¶ç´„

```sql
-- ä»£ç†æ‰¿èªæœŸé–“é‡è¤‡ãƒã‚§ãƒƒã‚¯
CREATE OR REPLACE FUNCTION check_delegate_overlap()
RETURNS TRIGGER AS $$
BEGIN
  IF EXISTS (
    SELECT 1 FROM approval_delegates
    WHERE user_id = NEW.user_id
      AND id != COALESCE(NEW.id, -1)
      AND is_active = true
      AND (start_date, end_date) OVERLAPS (NEW.start_date, NEW.end_date)
  ) THEN
    RAISE EXCEPTION 'Delegate period overlaps with existing delegation';
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_approval_delegates_overlap
  BEFORE INSERT OR UPDATE ON approval_delegates
  FOR EACH ROW
  EXECUTE FUNCTION check_delegate_overlap();
```

---

## 6. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨­è¨ˆ

### 6.1 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œé †åº

```sql
-- 001_create_workflow_types.sql
-- 002_create_approval_routes.sql
-- 003_create_workflow_requests.sql
-- 004_create_approval_history.sql
-- 005_create_approval_delegates.sql
-- 006_create_workflow_notifications.sql
-- 007_create_workflow_attachments.sql
-- 008_create_indexes.sql
-- 009_create_constraints.sql
-- 010_create_triggers.sql
-- 011_insert_initial_data.sql
```

### 6.2 åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥

```sql
-- åŸºæœ¬çš„ãªç”³è«‹ç¨®åˆ¥
INSERT INTO workflow_types (
  name, display_name, description, form_schema,
  company_id, created_by, is_active
) VALUES
-- æœ‰çµ¦ç”³è«‹
(
  'paid_leave', 'æœ‰çµ¦ç”³è«‹', 'æœ‰çµ¦ä¼‘æš‡ã®ç”³è«‹',
  '{
    "fields": [
      {
        "name": "startDate",
        "type": "date",
        "label": "é–‹å§‹æ—¥",
        "required": true
      },
      {
        "name": "endDate",
        "type": "date",
        "label": "çµ‚äº†æ—¥",
        "required": true
      },
      {
        "name": "reason",
        "type": "textarea",
        "label": "ç†ç”±",
        "required": true
      }
    ]
  }',
  1, 1, true
),
-- å‡ºå¼µç”³è«‹
(
  'business_trip', 'å‡ºå¼µç”³è«‹', 'å‡ºå¼µã®ç”³è«‹',
  '{
    "fields": [
      {
        "name": "destination",
        "type": "text",
        "label": "å‡ºå¼µå…ˆ",
        "required": true
      },
      {
        "name": "purpose",
        "type": "textarea",
        "label": "ç›®çš„",
        "required": true
      },
      {
        "name": "estimatedCost",
        "type": "number",
        "label": "æ¦‚ç®—è²»ç”¨",
        "required": true
      }
    ]
  }',
  1, 1, true
);

-- åŸºæœ¬çš„ãªæ‰¿èªãƒ«ãƒ¼ãƒˆ
INSERT INTO approval_routes (
  workflow_type_id, route_name, route_definition,
  is_default, created_by
) VALUES
(
  1, 'æœ‰çµ¦ç”³è«‹_æ¨™æº–ãƒ«ãƒ¼ãƒˆ',
  '{
    "steps": [
      {
        "stepNumber": 1,
        "stepName": "ç›´å±ä¸Šå¸æ‰¿èª",
        "approverType": "DIRECT_MANAGER",
        "timeoutDays": 3
      }
    ]
  }',
  true, 1
),
(
  2, 'å‡ºå¼µç”³è«‹_æ¨™æº–ãƒ«ãƒ¼ãƒˆ',
  '{
    "steps": [
      {
        "stepNumber": 1,
        "stepName": "ç›´å±ä¸Šå¸æ‰¿èª",
        "approverType": "DIRECT_MANAGER",
        "timeoutDays": 3
      },
      {
        "stepNumber": 2,
        "stepName": "éƒ¨é–€é•·æ‰¿èª",
        "approverType": "DEPARTMENT_MANAGER",
        "timeoutDays": 3
      }
    ]
  }',
  true, 1
);
```

---

## 7. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è€ƒæ…®

### 7.1 ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³è¨­è¨ˆ

```sql
-- å¤§é‡ãƒ‡ãƒ¼ã‚¿å¯¾å¿œï¼šæ—¥ä»˜ãƒ™ãƒ¼ã‚¹ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³
CREATE TABLE workflow_requests_partitioned (
  LIKE workflow_requests INCLUDING ALL
) PARTITION BY RANGE (created_at);

-- æœˆåˆ¥ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³
CREATE TABLE workflow_requests_2025_01 PARTITION OF workflow_requests_partitioned
  FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

CREATE TABLE workflow_requests_2025_02 PARTITION OF workflow_requests_partitioned
  FOR VALUES FROM ('2025-02-01') TO ('2025-03-01');
```

### 7.2 çµ±è¨ˆæƒ…å ±æ›´æ–°

```sql
-- å®šæœŸçš„ãªçµ±è¨ˆæƒ…å ±æ›´æ–°
CREATE OR REPLACE FUNCTION update_workflow_statistics()
RETURNS void AS $$
BEGIN
  -- ãƒ†ãƒ¼ãƒ–ãƒ«çµ±è¨ˆæ›´æ–°
  ANALYZE workflow_requests;
  ANALYZE approval_history;
  ANALYZE workflow_notifications;

  -- ã‚«ã‚¹ã‚¿ãƒ çµ±è¨ˆã®æ›´æ–°
  REFRESH MATERIALIZED VIEW IF EXISTS workflow_summary_stats;
END;
$$ LANGUAGE plpgsql;

-- å®šæœŸå®Ÿè¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆcronç­‰ã§å®Ÿè¡Œï¼‰
-- 0 2 * * * psql -d database -c "SELECT update_workflow_statistics();"
```

### 7.3 ã‚¯ã‚¨ãƒªæœ€é©åŒ–

```sql
-- ã‚ˆãä½¿ç”¨ã•ã‚Œã‚‹ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–
-- æ‰¿èªå¾…ã¡ä¸€è¦§ï¼ˆæœ€é‡è¦ï¼‰
EXPLAIN (ANALYZE, BUFFERS)
SELECT
  wr.id, wr.request_number, wr.title, wr.urgency,
  wt.display_name, wt.icon,
  u.name as requester_name,
  wr.created_at
FROM workflow_requests wr
JOIN workflow_types wt ON wr.workflow_type_id = wt.id
JOIN users u ON wr.requester_id = u.id
WHERE wr.status = 'IN_PROGRESS'
  AND wr.current_step = 2
ORDER BY
  CASE wr.urgency
    WHEN 'URGENT' THEN 1
    WHEN 'HIGH' THEN 2
    WHEN 'NORMAL' THEN 3
    WHEN 'LOW' THEN 4
  END,
  wr.created_at
LIMIT 50;
```

---

## ğŸ“‹ æ‰¿èªå±¥æ­´

| ç‰ˆæ•° | æ—¥ä»˜ | å¤‰æ›´å†…å®¹ | ä½œæˆè€… | æ‰¿èªè€… |
|------|------|----------|--------|--------|
| 1.0 | 2025-09-27 | åˆç‰ˆä½œæˆ | ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºãƒãƒ¼ãƒ  | - |

---

## ğŸ“š é–¢é€£æ–‡æ›¸

- [ç”³è«‹æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ©Ÿèƒ½è¨­è¨ˆæ›¸](./ç”³è«‹æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ©Ÿèƒ½è¨­è¨ˆæ›¸.md)
- [æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ›¸](../ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ›¸.md)
- [Prismaã‚¹ã‚­ãƒ¼ãƒè¨­è¨ˆæ›¸](../../02_æŠ€è¡“è¨­è¨ˆæ›¸/Prismaã‚¹ã‚­ãƒ¼ãƒè¨­è¨ˆæ›¸.md)

---

**æ–‡æ›¸ã®æ©Ÿå¯†ãƒ¬ãƒ™ãƒ«**: ç¤¾å†…é™ã‚Š
**æ¬¡å›ãƒ¬ãƒ“ãƒ¥ãƒ¼äºˆå®š**: 2025-10-27