# ç´°ã‹ã„æ‰¿èªåˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆæ›¸

## 1. æ¦‚è¦

æ©Ÿèƒ½ã”ã¨ã€ã•ã‚‰ã«æ“ä½œãƒ¬ãƒ™ãƒ«ï¼ˆç™»éŒ²ãƒ»æ›´æ–°ãƒ»å‰Šé™¤ãƒ»é–²è¦§ãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç­‰ï¼‰ã”ã¨ã«å€‹åˆ¥ã«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆå¯èƒ½ãªã€ãã‚ç´°ã‹ã„æ‰¿èªåˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ ã‚’è¨­è¨ˆã—ã¾ã™ã€‚

## 2. è¨­è¨ˆã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

### 2.1 åˆ¶å¾¡ã®ç²’åº¦

```
ä¼æ¥­
â”œâ”€â”€ æ©Ÿèƒ½ï¼ˆä¾‹ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ï¼‰
    â”œâ”€â”€ æ“ä½œï¼šCREATEï¼ˆç™»éŒ²ï¼‰â†’ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼A
    â”œâ”€â”€ æ“ä½œï¼šUPDATEï¼ˆæ›´æ–°ï¼‰â†’ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼B
    â”œâ”€â”€ æ“ä½œï¼šDELETEï¼ˆå‰Šé™¤ï¼‰â†’ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼C
    â”œâ”€â”€ æ“ä½œï¼šVIEWï¼ˆé–²è¦§ï¼‰â†’ æ‰¿èªä¸è¦
    â””â”€â”€ æ“ä½œï¼šEXPORTï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰â†’ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼D
```

### 2.2 ç®¡ç†å¯¾è±¡æ©Ÿèƒ½ãƒ»æ“ä½œã®ä¾‹

| æ©Ÿèƒ½ã‚«ãƒ†ã‚´ãƒª | æ©Ÿèƒ½å | CREATE | UPDATE | DELETE | VIEW | EXPORT | ãã®ä»– |
|-------------|--------|--------|--------|--------|------|--------|-------|
| **ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†** | ãƒ¦ãƒ¼ã‚¶ãƒ¼ | âœ… | âœ… | âœ… | - | âœ… | PASSWORD_RESET |
| **çµ„ç¹”ç®¡ç†** | éƒ¨ç½² | âœ… | âœ… | âœ… | - | âœ… | RESTRUCTURE |
| **æ¨©é™ç®¡ç†** | æ¨©é™ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ | âœ… | âœ… | âœ… | - | - | APPLY |
| **ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†** | ä¼šç¤¾è¨­å®š | - | âœ… | - | - | - | BACKUP |
| **ãƒ‡ãƒ¼ã‚¿ç®¡ç†** | ãƒ­ã‚° | - | - | âœ… | - | âœ… | CLEANUP |

## 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 3.1 æ©Ÿèƒ½ãƒ»æ“ä½œãƒã‚¹ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
-- æ©Ÿèƒ½ãƒ»æ“ä½œå®šç¾©ãƒã‚¹ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE feature_operations (
    id SERIAL PRIMARY KEY,
    feature_code VARCHAR(50) NOT NULL,        -- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã€éƒ¨ç½²ç®¡ç†ç­‰
    feature_name VARCHAR(100) NOT NULL,
    operation_code VARCHAR(50) NOT NULL,      -- CREATE, UPDATE, DELETEç­‰
    operation_name VARCHAR(100) NOT NULL,
    description TEXT,
    is_available BOOLEAN DEFAULT true,        -- ãã®æ©Ÿèƒ½ã§åˆ©ç”¨å¯èƒ½ãªæ“ä½œã‹
    display_order INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    UNIQUE(feature_code, operation_code)
);

-- åˆæœŸãƒ‡ãƒ¼ã‚¿ä¾‹
INSERT INTO feature_operations (feature_code, feature_name, operation_code, operation_name, description) VALUES
('USER_MANAGEMENT', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†', 'CREATE', 'ç™»éŒ²', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ–°è¦ç™»éŒ²'),
('USER_MANAGEMENT', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†', 'UPDATE', 'æ›´æ–°', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®æ›´æ–°'),
('USER_MANAGEMENT', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†', 'DELETE', 'å‰Šé™¤', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‰Šé™¤'),
('USER_MANAGEMENT', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†', 'EXPORT', 'ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ'),
('USER_MANAGEMENT', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†', 'PASSWORD_RESET', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ', 'ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ'),

('DEPARTMENT_MANAGEMENT', 'éƒ¨ç½²ç®¡ç†', 'CREATE', 'ç™»éŒ²', 'éƒ¨ç½²ã®æ–°è¦ä½œæˆ'),
('DEPARTMENT_MANAGEMENT', 'éƒ¨ç½²ç®¡ç†', 'UPDATE', 'æ›´æ–°', 'éƒ¨ç½²æƒ…å ±ã®æ›´æ–°'),
('DEPARTMENT_MANAGEMENT', 'éƒ¨ç½²ç®¡ç†', 'DELETE', 'å‰Šé™¤', 'éƒ¨ç½²ã®å‰Šé™¤'),
('DEPARTMENT_MANAGEMENT', 'éƒ¨ç½²ç®¡ç†', 'RESTRUCTURE', 'çµ„ç¹”å¤‰æ›´', 'éƒ¨ç½²æ§‹é€ ã®å¤§å¹…å¤‰æ›´'),

('PERMISSION_MANAGEMENT', 'æ¨©é™ç®¡ç†', 'CREATE', 'ç™»éŒ²', 'æ¨©é™ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ä½œæˆ'),
('PERMISSION_MANAGEMENT', 'æ¨©é™ç®¡ç†', 'UPDATE', 'æ›´æ–°', 'æ¨©é™ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®æ›´æ–°'),
('PERMISSION_MANAGEMENT', 'æ¨©é™ç®¡ç†', 'DELETE', 'å‰Šé™¤', 'æ¨©é™ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å‰Šé™¤'),
('PERMISSION_MANAGEMENT', 'æ¨©é™ç®¡ç†', 'APPLY', 'é©ç”¨', 'æ¨©é™ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®é©ç”¨');
```

### 3.2 æ‰¿èªè¨­å®šãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ›´æ–°ç‰ˆï¼‰

```sql
-- æ‰¿èªåˆ¶å¾¡è¨­å®šãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE approval_control_settings (
    id SERIAL PRIMARY KEY,
    company_id INT NOT NULL,
    feature_code VARCHAR(50) NOT NULL,
    operation_code VARCHAR(50) NOT NULL,
    is_approval_enabled BOOLEAN DEFAULT false,   -- æ‰¿èªã®æœ‰åŠ¹/ç„¡åŠ¹
    workflow_type_id INT,                        -- å‰²ã‚Šå½“ã¦ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
    conditions JSON,                             -- æ‰¿èªãŒå¿…è¦ãªè©³ç´°æ¡ä»¶
    bypass_roles JSON,                           -- æ‰¿èªã‚’ãƒã‚¤ãƒ‘ã‚¹ã§ãã‚‹å½¹å‰²
    auto_approve_conditions JSON,                -- è‡ªå‹•æ‰¿èªæ¡ä»¶
    priority INT DEFAULT 0,                      -- è¤‡æ•°æ¡ä»¶ãŒã‚ã‚‹å ´åˆã®å„ªå…ˆåº¦
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by INT,
    updated_by INT,

    FOREIGN KEY (company_id) REFERENCES companies(id),
    FOREIGN KEY (workflow_type_id) REFERENCES workflow_types(id),
    FOREIGN KEY (feature_code, operation_code) REFERENCES feature_operations(feature_code, operation_code),
    UNIQUE(company_id, feature_code, operation_code, priority)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_approval_control_company_feature ON approval_control_settings(company_id, feature_code, operation_code);
CREATE INDEX idx_approval_control_workflow ON approval_control_settings(workflow_type_id);
CREATE INDEX idx_approval_control_active ON approval_control_settings(is_active);
```

### 3.3 è¨­å®šä¾‹ãƒ‡ãƒ¼ã‚¿

```sql
-- æ‰¿èªåˆ¶å¾¡è¨­å®šä¾‹
INSERT INTO approval_control_settings (
    company_id, feature_code, operation_code,
    is_approval_enabled, workflow_type_id, conditions, bypass_roles
) VALUES
-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ï¼šç™»éŒ²ã¯å¸¸ã«æ‰¿èªå¿…è¦
(1, 'USER_MANAGEMENT', 'CREATE', true, 1, '{}', '["SUPER_ADMIN"]'),

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ï¼šæ›´æ–°ã¯æ¨©é™æ˜‡æ ¼æ™‚ã®ã¿æ‰¿èª
(1, 'USER_MANAGEMENT', 'UPDATE', true, 1,
 '{"require_approval_when": [{"field": "role", "change_type": "upgrade"}]}',
 '["ADMIN"]'),

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ï¼šå‰Šé™¤ã¯å¸¸ã«æ‰¿èªå¿…è¦
(1, 'USER_MANAGEMENT', 'DELETE', true, 2, '{}', '["SUPER_ADMIN"]'),

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ï¼šã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã¯100äººä»¥ä¸Šã§æ‰¿èª
(1, 'USER_MANAGEMENT', 'EXPORT', true, 3,
 '{"require_approval_when": [{"field": "record_count", "operator": "greater_than", "value": 100}]}',
 '["ADMIN"]'),

-- éƒ¨ç½²ç®¡ç†ï¼šå‰Šé™¤ã¯æ‰€å±è€…ãŒã„ã‚‹å ´åˆã®ã¿æ‰¿èª
(1, 'DEPARTMENT_MANAGEMENT', 'DELETE', true, 2,
 '{"require_approval_when": [{"field": "has_members", "operator": "equals", "value": true}]}',
 '["SUPER_ADMIN"]');
```

## 4. æ‰¿èªåˆ¶å¾¡ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆæ›´æ–°ç‰ˆï¼‰

### 4.1 æ‰¿èªåˆ¤å®šã‚µãƒ¼ãƒ“ã‚¹

```typescript
export class DetailedApprovalControlService {

  /**
   * æŒ‡å®šã•ã‚ŒãŸæ©Ÿèƒ½ãƒ»æ“ä½œã«å¯¾ã™ã‚‹æ‰¿èªè¦å¦ã‚’åˆ¤å®š
   */
  async requiresApproval(
    companyId: number,
    featureCode: string,
    operationCode: string,
    operationData: any,
    currentUser: User
  ): Promise<ApprovalRequirement> {

    // 1. æ‰¿èªåˆ¶å¾¡è¨­å®šã‚’å–å¾—
    const settings = await prisma.approval_control_settings.findMany({
      where: {
        company_id: companyId,
        feature_code: featureCode,
        operation_code: operationCode,
        is_active: true
      },
      include: {
        workflow_types: true
      },
      orderBy: {
        priority: 'desc'  // å„ªå…ˆåº¦ã®é«˜ã„é †
      }
    });

    if (!settings.length) {
      return { required: false, reason: 'NO_APPROVAL_POLICY' };
    }

    // 2. å„è¨­å®šã‚’å„ªå…ˆåº¦é †ã«ãƒã‚§ãƒƒã‚¯
    for (const setting of settings) {

      // 2.1 æ‰¿èªãŒç„¡åŠ¹ãªå ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
      if (!setting.is_approval_enabled) {
        continue;
      }

      // 2.2 ãƒã‚¤ãƒ‘ã‚¹æ¨©é™ãƒã‚§ãƒƒã‚¯
      if (this.canBypassApproval(currentUser, setting.bypass_roles)) {
        return { required: false, reason: 'BYPASSED_BY_ROLE', setting };
      }

      // 2.3 è‡ªå‹•æ‰¿èªæ¡ä»¶ãƒã‚§ãƒƒã‚¯
      if (await this.meetsAutoApprovalConditions(setting.auto_approve_conditions, operationData, currentUser)) {
        return { required: false, reason: 'AUTO_APPROVED', setting };
      }

      // 2.4 æ‰¿èªæ¡ä»¶ãƒã‚§ãƒƒã‚¯
      if (await this.meetsApprovalConditions(setting.conditions, operationData, currentUser)) {
        return {
          required: true,
          setting: setting,
          workflowType: setting.workflow_types,
          estimatedDuration: await this.estimateApprovalDuration(setting.workflow_type_id)
        };
      }
    }

    return { required: false, reason: 'CONDITIONS_NOT_MET' };
  }

  /**
   * è‡ªå‹•æ‰¿èªæ¡ä»¶ã®è©•ä¾¡
   */
  private async meetsAutoApprovalConditions(
    conditions: any,
    operationData: any,
    currentUser: User
  ): Promise<boolean> {

    if (!conditions?.auto_approve_when) {
      return false;
    }

    for (const condition of conditions.auto_approve_when) {
      if (await this.evaluateCondition(condition, operationData, currentUser)) {
        return true;
      }
    }

    return false;
  }

  /**
   * æ‰¿èªå¿…è¦æ¡ä»¶ã®è©•ä¾¡
   */
  private async meetsApprovalConditions(
    conditions: any,
    operationData: any,
    currentUser: User
  ): Promise<boolean> {

    if (!conditions?.require_approval_when) {
      return true; // æ¡ä»¶æœªæŒ‡å®šã®å ´åˆã¯æ‰¿èªå¿…è¦
    }

    for (const condition of conditions.require_approval_when) {
      if (await this.evaluateCondition(condition, operationData, currentUser)) {
        return true;
      }
    }

    return false;
  }
}

interface ApprovalRequirement {
  required: boolean;
  reason?: string;
  setting?: any;
  workflowType?: any;
  estimatedDuration?: number;
}
```

### 4.2 æ“ä½œã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ã‚¿ãƒ¼

```typescript
/**
 * æ“ä½œå‰ã®æ‰¿èªãƒã‚§ãƒƒã‚¯ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼
 */
export function RequiresDetailedApproval(featureCode: string, operationCode: string) {
  return function (target: any, propertyName: string, descriptor: PropertyDescriptor) {
    const method = descriptor.value;

    descriptor.value = async function (...args: any[]) {
      const [operationData, currentUser] = args;

      // 1. æ‰¿èªè¦å¦åˆ¤å®š
      const requirement = await detailedApprovalControlService.requiresApproval(
        currentUser.companyId,
        featureCode,
        operationCode,
        operationData,
        currentUser
      );

      if (!requirement.required) {
        // æ‰¿èªä¸è¦ - ç›´æ¥å®Ÿè¡Œ
        return await method.apply(this, args);
      }

      // 2. æ‰¿èªãƒ—ãƒ­ã‚»ã‚¹é–‹å§‹
      const approvalRequest = await this.startDetailedApprovalProcess(
        requirement,
        featureCode,
        operationCode,
        operationData,
        currentUser
      );

      return {
        status: 'PENDING_APPROVAL',
        approvalRequestId: approvalRequest.id,
        workflowName: requirement.workflowType.name,
        estimatedDuration: requirement.estimatedDuration,
        message: `${requirement.workflowType.name}ã«ã‚ˆã‚‹æ‰¿èªãŒå¿…è¦ã§ã™`
      };
    };
  };
}

// ä½¿ç”¨ä¾‹
export class UserService {

  @RequiresDetailedApproval('USER_MANAGEMENT', 'CREATE')
  async createUser(userData: CreateUserRequest, currentUser: User) {
    return await prisma.users.create({
      data: userData
    });
  }

  @RequiresDetailedApproval('USER_MANAGEMENT', 'UPDATE')
  async updateUser(userId: number, updateData: UpdateUserRequest, currentUser: User) {
    return await prisma.users.update({
      where: { id: userId },
      data: updateData
    });
  }

  @RequiresDetailedApproval('USER_MANAGEMENT', 'DELETE')
  async deleteUser(userId: number, currentUser: User) {
    return await prisma.users.update({
      where: { id: userId },
      data: { isActive: false }
    });
  }

  @RequiresDetailedApproval('USER_MANAGEMENT', 'EXPORT')
  async exportUsers(filters: ExportFilters, currentUser: User) {
    // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå‡¦ç†
  }
}
```

## 5. ç®¡ç†ç”»é¢è¨­è¨ˆ

### 5.1 æ‰¿èªåˆ¶å¾¡è¨­å®šç”»é¢

```vue
<template>
  <div class="approval-control-settings">
    <el-card header="æ‰¿èªåˆ¶å¾¡è¨­å®š">

      <!-- æ©Ÿèƒ½é¸æŠ -->
      <el-row class="mb-4">
        <el-col :span="8">
          <el-select v-model="selectedFeature" placeholder="æ©Ÿèƒ½ã‚’é¸æŠ" @change="loadOperations">
            <el-option
              v-for="feature in features"
              :key="feature.code"
              :label="feature.name"
              :value="feature.code"
            />
          </el-select>
        </el-col>
      </el-row>

      <!-- æ“ä½œã”ã¨ã®è¨­å®š -->
      <el-table :data="operationSettings" style="width: 100%">
        <el-table-column prop="operation_name" label="æ“ä½œ" width="150" />

        <!-- æ‰¿èªæœ‰åŠ¹/ç„¡åŠ¹ -->
        <el-table-column label="æ‰¿èªåˆ¶å¾¡" width="120">
          <template #default="{ row }">
            <el-switch
              v-model="row.is_approval_enabled"
              @change="updateApprovalSetting(row)"
            />
          </template>
        </el-table-column>

        <!-- ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼é¸æŠ -->
        <el-table-column label="ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼" width="200">
          <template #default="{ row }">
            <el-select
              v-model="row.workflow_type_id"
              :disabled="!row.is_approval_enabled"
              placeholder="ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’é¸æŠ"
              @change="updateApprovalSetting(row)"
            >
              <el-option
                v-for="workflow in workflowTypes"
                :key="workflow.id"
                :label="workflow.name"
                :value="workflow.id"
              />
            </el-select>
          </template>
        </el-table-column>

        <!-- æ¡ä»¶è¨­å®š -->
        <el-table-column label="æ¡ä»¶è¨­å®š" width="150">
          <template #default="{ row }">
            <el-button
              @click="editConditions(row)"
              :disabled="!row.is_approval_enabled"
              size="small"
            >
              æ¡ä»¶è¨­å®š
            </el-button>
          </template>
        </el-table-column>

        <!-- ãƒã‚¤ãƒ‘ã‚¹æ¨©é™ -->
        <el-table-column label="ãƒã‚¤ãƒ‘ã‚¹æ¨©é™" width="200">
          <template #default="{ row }">
            <el-select
              v-model="row.bypass_roles"
              multiple
              :disabled="!row.is_approval_enabled"
              placeholder="æ¨©é™ã‚’é¸æŠ"
              @change="updateApprovalSetting(row)"
            >
              <el-option label="ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…" value="ADMIN" />
              <el-option label="ã‚¹ãƒ¼ãƒ‘ãƒ¼ç®¡ç†è€…" value="SUPER_ADMIN" />
              <el-option label="ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼" value="MANAGER" />
            </el-select>
          </template>
        </el-table-column>

        <!-- è¨­å®šçŠ¶æ³ -->
        <el-table-column label="çŠ¶æ³" width="120">
          <template #default="{ row }">
            <el-tag v-if="row.is_approval_enabled" type="success">æ‰¿èªã‚ã‚Š</el-tag>
            <el-tag v-else type="info">æ‰¿èªãªã—</el-tag>
          </template>
        </el-table-column>
      </el-table>
    </el-card>

    <!-- æ¡ä»¶è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
    <el-dialog v-model="showConditionDialog" title="æ‰¿èªæ¡ä»¶è¨­å®š" width="800px">
      <div class="condition-editor">
        <h4>æ‰¿èªãŒå¿…è¦ãªæ¡ä»¶</h4>
        <approval-condition-builder
          v-model="currentConditions.require_approval_when"
          :feature-code="selectedFeature"
          :operation-code="currentOperation.operation_code"
        />

        <h4 class="mt-4">è‡ªå‹•æ‰¿èªæ¡ä»¶</h4>
        <approval-condition-builder
          v-model="currentConditions.auto_approve_when"
          :feature-code="selectedFeature"
          :operation-code="currentOperation.operation_code"
          type="auto-approve"
        />
      </div>

      <template #footer>
        <el-button @click="showConditionDialog = false">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</el-button>
        <el-button type="primary" @click="saveConditions">ä¿å­˜</el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'

const selectedFeature = ref('')
const features = ref([])
const operationSettings = ref([])
const workflowTypes = ref([])
const showConditionDialog = ref(false)
const currentOperation = ref({})
const currentConditions = ref({
  require_approval_when: [],
  auto_approve_when: []
})

// æ©Ÿèƒ½ä¸€è¦§ã‚’å–å¾—
const loadFeatures = async () => {
  const response = await fetch('/api/features/operations')
  features.value = await response.json()
}

// æ“ä½œä¸€è¦§ã¨ç¾åœ¨ã®è¨­å®šã‚’å–å¾—
const loadOperations = async () => {
  if (!selectedFeature.value) return

  const response = await fetch(`/api/approval-control-settings/${selectedFeature.value}`)
  operationSettings.value = await response.json()
}

// ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¿ã‚¤ãƒ—ä¸€è¦§ã‚’å–å¾—
const loadWorkflowTypes = async () => {
  const response = await fetch('/api/workflow-types')
  workflowTypes.value = await response.json()
}

// æ‰¿èªè¨­å®šã‚’æ›´æ–°
const updateApprovalSetting = async (row: any) => {
  await fetch('/api/approval-control-settings', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      feature_code: selectedFeature.value,
      operation_code: row.operation_code,
      is_approval_enabled: row.is_approval_enabled,
      workflow_type_id: row.workflow_type_id,
      bypass_roles: row.bypass_roles
    })
  })
}

// æ¡ä»¶è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
const editConditions = (row: any) => {
  currentOperation.value = row
  currentConditions.value = {
    require_approval_when: row.conditions?.require_approval_when || [],
    auto_approve_when: row.conditions?.auto_approve_when || []
  }
  showConditionDialog.value = true
}

// æ¡ä»¶ã‚’ä¿å­˜
const saveConditions = async () => {
  await fetch('/api/approval-control-settings/conditions', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      feature_code: selectedFeature.value,
      operation_code: currentOperation.value.operation_code,
      conditions: currentConditions.value
    })
  })

  showConditionDialog.value = false
  await loadOperations() // è¨­å®šã‚’å†èª­ã¿è¾¼ã¿
}

onMounted(() => {
  loadFeatures()
  loadWorkflowTypes()
})
</script>
```

### 5.2 è¨­å®šæ¦‚è¦ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

```vue
<template>
  <div class="approval-overview-dashboard">
    <el-row :gutter="20">
      <!-- çµ±è¨ˆæƒ…å ± -->
      <el-col :span="6" v-for="stat in statistics" :key="stat.label">
        <el-card class="stat-card">
          <div class="stat-content">
            <div class="stat-number">{{ stat.value }}</div>
            <div class="stat-label">{{ stat.label }}</div>
          </div>
        </el-card>
      </el-col>
    </el-row>

    <!-- æ©Ÿèƒ½åˆ¥æ‰¿èªè¨­å®šä¸€è¦§ -->
    <el-card header="æ©Ÿèƒ½åˆ¥æ‰¿èªè¨­å®šçŠ¶æ³" class="mt-4">
      <el-table :data="featureOverview" style="width: 100%">
        <el-table-column prop="feature_name" label="æ©Ÿèƒ½" width="200" />
        <el-table-column label="æ“ä½œåˆ¥è¨­å®š">
          <template #default="{ row }">
            <div class="operation-badges">
              <el-tag
                v-for="op in row.operations"
                :key="op.operation_code"
                :type="op.approval_enabled ? 'success' : 'info'"
                class="mr-1 mb-1"
                size="small"
              >
                {{ op.operation_name }}
                <span v-if="op.approval_enabled">({{ op.workflow_name }})</span>
              </el-tag>
            </div>
          </template>
        </el-table-column>
        <el-table-column label="æ‰¿èªç‡" width="120">
          <template #default="{ row }">
            <el-progress
              :percentage="row.approval_percentage"
              :color="getProgressColor(row.approval_percentage)"
              :show-text="false"
            />
            <span class="ml-2">{{ row.approval_percentage }}%</span>
          </template>
        </el-table-column>
        <el-table-column label="æ“ä½œ" width="100">
          <template #default="{ row }">
            <el-button size="small" @click="editFeatureSettings(row.feature_code)">
              è¨­å®š
            </el-button>
          </template>
        </el-table-column>
      </el-table>
    </el-card>
  </div>
</template>
```

## 6. APIè¨­è¨ˆ

### 6.1 æ‰¿èªåˆ¶å¾¡è¨­å®šAPI

```typescript
// GET /api/approval-control-settings/:featureCode
// æŒ‡å®šæ©Ÿèƒ½ã®æ‰¿èªè¨­å®šä¸€è¦§å–å¾—
export async function getApprovalControlSettings(req: Request, res: Response) {
  const { featureCode } = req.params
  const { companyId } = req.user

  const settings = await prisma.approval_control_settings.findMany({
    where: {
      company_id: companyId,
      feature_code: featureCode
    },
    include: {
      workflow_types: {
        select: { id: true, name: true }
      }
    }
  })

  // åˆ©ç”¨å¯èƒ½ãªæ“ä½œä¸€è¦§ã¨è¨­å®šã‚’ãƒãƒ¼ã‚¸
  const operations = await prisma.feature_operations.findMany({
    where: { feature_code: featureCode, is_available: true }
  })

  const result = operations.map(op => {
    const setting = settings.find(s => s.operation_code === op.operation_code)
    return {
      ...op,
      is_approval_enabled: setting?.is_approval_enabled || false,
      workflow_type_id: setting?.workflow_type_id,
      workflow_name: setting?.workflow_types?.name,
      conditions: setting?.conditions,
      bypass_roles: setting?.bypass_roles
    }
  })

  res.json(result)
}

// PUT /api/approval-control-settings
// æ‰¿èªè¨­å®šæ›´æ–°
export async function updateApprovalControlSetting(req: Request, res: Response) {
  const { feature_code, operation_code, is_approval_enabled, workflow_type_id, bypass_roles } = req.body
  const { companyId, userId } = req.user

  await prisma.approval_control_settings.upsert({
    where: {
      company_id_feature_code_operation_code_priority: {
        company_id: companyId,
        feature_code,
        operation_code,
        priority: 0
      }
    },
    update: {
      is_approval_enabled,
      workflow_type_id,
      bypass_roles,
      updated_by: userId,
      updated_at: new Date()
    },
    create: {
      company_id: companyId,
      feature_code,
      operation_code,
      is_approval_enabled,
      workflow_type_id,
      bypass_roles,
      created_by: userId
    }
  })

  res.json({ success: true })
}

// GET /api/approval-control-settings/overview
// æ‰¿èªè¨­å®šæ¦‚è¦å–å¾—
export async function getApprovalControlOverview(req: Request, res: Response) {
  const { companyId } = req.user

  // æ©Ÿèƒ½åˆ¥ã®è¨­å®šçŠ¶æ³ã‚’é›†è¨ˆ
  const overview = await prisma.$queryRaw`
    SELECT
      fo.feature_code,
      fo.feature_name,
      COUNT(fo.operation_code) as total_operations,
      COUNT(CASE WHEN acs.is_approval_enabled = true THEN 1 END) as enabled_operations,
      ROUND(
        COUNT(CASE WHEN acs.is_approval_enabled = true THEN 1 END) * 100.0 / COUNT(fo.operation_code),
        1
      ) as approval_percentage
    FROM feature_operations fo
    LEFT JOIN approval_control_settings acs ON (
      fo.feature_code = acs.feature_code
      AND fo.operation_code = acs.operation_code
      AND acs.company_id = ${companyId}
    )
    WHERE fo.is_available = true
    GROUP BY fo.feature_code, fo.feature_name
    ORDER BY fo.feature_name
  `

  res.json(overview)
}
```

## 7. åˆ©ç”¨ã‚·ãƒŠãƒªã‚ªä¾‹

### 7.1 æ®µéšçš„å°å…¥ã‚·ãƒŠãƒªã‚ª

**ãƒ•ã‚§ãƒ¼ã‚º1: é‡è¦æ“ä½œã®ã¿**
```javascript
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã® DELETE ã®ã¿æ‰¿èªã‚’æœ‰åŠ¹åŒ–
await updateApprovalSetting('USER_MANAGEMENT', 'DELETE', {
  enabled: true,
  workflowTypeId: 1, // é«˜åº¦æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
  bypassRoles: ['SUPER_ADMIN']
})
```

**ãƒ•ã‚§ãƒ¼ã‚º2: ä¸­ç¨‹åº¦ãƒªã‚¹ã‚¯ã®æ“ä½œè¿½åŠ **
```javascript
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã® CREATE ã¨æ¨©é™æ˜‡æ ¼ UPDATE ã‚’è¿½åŠ 
await updateApprovalSetting('USER_MANAGEMENT', 'CREATE', {
  enabled: true,
  workflowTypeId: 2, // æ¨™æº–æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
})

await updateApprovalSetting('USER_MANAGEMENT', 'UPDATE', {
  enabled: true,
  workflowTypeId: 2,
  conditions: {
    require_approval_when: [
      { field: 'role', change_type: 'upgrade' }
    ]
  }
})
```

### 7.2 éƒ¨ç½²åˆ¥è¨­å®šã‚·ãƒŠãƒªã‚ª

```javascript
// äººäº‹éƒ¨ï¼šã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã«æ‰¿èªå¿…è¦
await updateApprovalSetting('USER_MANAGEMENT', 'CREATE', {
  enabled: true,
  conditions: {
    require_approval_when: [
      { field: 'requester_department', operator: 'equals', value: 'HR' }
    ]
  }
})

// å–¶æ¥­éƒ¨ï¼šå¤§é‡ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã®ã¿æ‰¿èª
await updateApprovalSetting('USER_MANAGEMENT', 'EXPORT', {
  enabled: true,
  conditions: {
    require_approval_when: [
      {
        field: 'requester_department',
        operator: 'equals',
        value: 'SALES'
      },
      {
        field: 'record_count',
        operator: 'greater_than',
        value: 50
      }
    ]
  }
})
```

## 8. ã¾ã¨ã‚

ã“ã®è¨­è¨ˆã«ã‚ˆã‚Šå®Ÿç¾ã•ã‚Œã‚‹æ©Ÿèƒ½ï¼š

### âœ… ä¸»è¦æ©Ÿèƒ½
- **æ©Ÿèƒ½Ã—æ“ä½œã®ç´°ã‹ã„åˆ¶å¾¡**: 50ç¨®é¡ä»¥ä¸Šã®æ©Ÿèƒ½ã«å¯¾å¿œ
- **å€‹åˆ¥ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å‰²ã‚Šå½“ã¦**: æ“ä½œã”ã¨ã«æœ€é©ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¨­å®š
- **æŸ”è»Ÿãªæœ‰åŠ¹/ç„¡åŠ¹åˆ‡æ›¿**: æ®µéšçš„å°å…¥ã¨é‹ç”¨èª¿æ•´ãŒå¯èƒ½
- **æ¡ä»¶ãƒ™ãƒ¼ã‚¹åˆ¶å¾¡**: è¤‡é›‘ãªãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã«å¯¾å¿œ
- **ç›´æ„Ÿçš„ãªç®¡ç†ç”»é¢**: è¨­å®šçŠ¶æ³ã®ä¸€è¦§æ€§ã¨æ“ä½œæ€§

### ğŸš€ å°å…¥åŠ¹æœ
- **æ®µéšçš„å°å…¥**: ãƒªã‚¹ã‚¯ã‚’æŠ‘ãˆãŸæ®µéšçš„ãªæ‰¿èªåˆ¶å¾¡å°å…¥
- **é‹ç”¨åŠ¹ç‡**: å¿…è¦ãªç®‡æ‰€ã®ã¿ã®æ‰¿èªã§æ¥­å‹™åŠ¹ç‡ç¶­æŒ
- **ã‚¬ãƒãƒŠãƒ³ã‚¹**: ãã‚ç´°ã‹ã„åˆ¶å¾¡ã«ã‚ˆã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Š
- **æŸ”è»Ÿæ€§**: çµ„ç¹”ã®æˆé•·ã‚„å¤‰åŒ–ã«å¿œã˜ãŸè¨­å®šå¤‰æ›´

ã“ã®è¨­è¨ˆã§ã€è¦æ±‚ã•ã‚ŒãŸã€Œæ©Ÿèƒ½ã”ã¨ã€æ“ä½œã”ã¨ã®å€‹åˆ¥æ‰¿èªåˆ¶å¾¡ã€ãŒå®Ÿç¾ã§ãã¾ã™ã€‚

<function_calls>
<invoke name="TodoWrite">
<parameter name="todos">[{"content": "\u7533\u8acb\u30fb\u627f\u8a8d\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u6a5f\u80fd\u306e\u8a2d\u8a08", "status": "completed", "activeForm": "\u7533\u8acb\u30fb\u627f\u8a8d\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u6a5f\u80fd\u3092\u8a2d\u8a08\u4e2d"}, {"content": "\u6a5f\u80fd\u8a2d\u8a08\u66f8\u306e\u4f5c\u6210", "status": "completed", "activeForm": "\u6a5f\u80fd\u8a2d\u8a08\u66f8\u3092\u4f5c\u6210\u4e2d"}, {"content": "\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u8a2d\u8a08\uff08\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u95a2\u9023\u30c6\u30fc\u30d6\u30eb\uff09", "status": "completed", "activeForm": "\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u8a2d\u8a08\u4e2d"}, {"content": "Prisma\u30b9\u30ad\u30fc\u30de\u4f5c\u6210\uff08\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u95a2\u9023\u30c6\u30fc\u30d6\u30eb\uff09", "status": "completed", "activeForm": "Prisma\u30b9\u30ad\u30fc\u30de\u3092\u4f5c\u6210\u4e2d"}, {"content": "\u30e6\u30fc\u30b6\u30fc\u8ffd\u52a0\u627f\u8a8d\u30d5\u30ed\u30fc\u8a2d\u8a08", "status": "completed", "activeForm": "\u30e6\u30fc\u30b6\u30fc\u8ffd\u52a0\u627f\u8a8d\u30d5\u30ed\u30fc\u3092\u8a2d\u8a08\u4e2d"}, {"content": "\u6a5f\u80fd\u9593\u9023\u643a\u627f\u8a8d\u30b7\u30b9\u30c6\u30e0\u8a2d\u8a08", "status": "completed", "activeForm": "\u6a5f\u80fd\u9593\u9023\u643a\u627f\u8a8d\u30b7\u30b9\u30c6\u30e0\u3092\u8a2d\u8a08\u4e2d"}, {"content": "\u8981\u4ef6\u5b9a\u7fa9\u30fb\u8a2d\u8a08\u9f6c\u9f6c\u78ba\u8a8d", "status": "completed", "activeForm": "\u8981\u4ef6\u5b9a\u7fa9\u30fb\u8a2d\u8a08\u9f6c\u9f6c\u3092\u78ba\u8a8d\u4e2d"}, {"content": "\u7d30\u304b\u3044\u627f\u8a8d\u5236\u5fa1\u30b7\u30b9\u30c6\u30e0\u8a2d\u8a08", "status": "completed", "activeForm": "\u7d30\u304b\u3044\u627f\u8a8d\u5236\u5fa1\u30b7\u30b9\u30c6\u30e0\u3092\u8a2d\u8a08\u4e2d"}, {"content": "\u30d0\u30c3\u30af\u30a8\u30f3\u30c9API\u5b9f\u88c5", "status": "pending", "activeForm": "\u30d0\u30c3\u30af\u30a8\u30f3\u30c9API\u3092\u5b9f\u88c5\u4e2d"}, {"content": "\u30d5\u30ed\u30f3\u30c8\u30a8\u30f3\u30c9\u753b\u9762\u5b9f\u88c5", "status": "pending", "activeForm": "\u30d5\u30ed\u30f3\u30c8\u30a8\u30f3\u30c9\u753b\u9762\u3092\u5b9f\u88c5\u4e2d"}, {"content": "\u5358\u4f53\u8a66\u9a13\u5b9f\u88c5", "status": "pending", "activeForm": "\u5358\u4f53\u8a66\u9a13\u3092\u5b9f\u88c5\u4e2d"}]