# データ取得エラー頻発対策案

## 📊 問題分析結果

### 発生頻度分析（全30件のBUGより）

| 原因カテゴリ | 発生件数 | 割合 | 代表的BUG |
|------------|---------|------|-----------|
| **Prismaモデル名不一致** | 12件 | 40% | BUG-001, 003, 004, 005, 006, 007 |
| **環境設定不一致** | 5件 | 17% | BUG-028, 021, 023 |
| **欠落ファイル・未実装** | 4件 | 13% | BUG-018, 019, 020, 028 |
| **templates/workspace同期** | 3件 | 10% | BUG-024, 025, 027 |
| **ブラウザキャッシュ** | 2件 | 7% | BUG-027 |
| その他 | 4件 | 13% | - |

### 🔴 最頻発問題: Prismaモデル名不一致（40%）

**典型的なパターン:**
```typescript
// ❌ 間違い（単数形・キャメルケース）
prisma.user.findMany()
prisma.company.findMany()
prisma.log.findMany()
prisma.alertRule.findMany()

// ✅ 正しい（複数形・スネークケース）
prisma.users.findMany()
prisma.companies.findMany()
prisma.logs.findMany()
prisma.alert_rules.findMany()
```

**リレーション名の不一致:**
```typescript
// ❌ 間違い
include: { user: true, company: true }

// ✅ 正しい
include: { users: true, companies: true }
```

---

## 🛡️ 包括的対策案

### 対策1: 自動チェックスクリプト実装 ⭐⭐⭐

#### 1-1. Prismaモデル名チェッカー
```bash
#!/bin/bash
# scripts/check-prisma-usage.sh

echo "🔍 Prismaモデル名使用チェック..."

# よくある間違いパターン
ERRORS=0

# 単数形の誤用チェック
if grep -r "prisma\.user\." workspace/backend/src/ --include="*.ts" | grep -v "users"; then
  echo "❌ エラー: prisma.user を使用している箇所があります（正: prisma.users）"
  ERRORS=$((ERRORS + 1))
fi

if grep -r "prisma\.company\." workspace/backend/src/ --include="*.ts" | grep -v "companies"; then
  echo "❌ エラー: prisma.company を使用している箇所があります（正: prisma.companies）"
  ERRORS=$((ERRORS + 1))
fi

if grep -r "prisma\.department\." workspace/backend/src/ --include="*.ts" | grep -v "departments"; then
  echo "❌ エラー: prisma.department を使用している箇所があります（正: prisma.departments）"
  ERRORS=$((ERRORS + 1))
fi

if grep -r "prisma\.log\." workspace/backend/src/ --include="*.ts" | grep -v "logs"; then
  echo "❌ エラー: prisma.log を使用している箇所があります（正: prisma.logs）"
  ERRORS=$((ERRORS + 1))
fi

if grep -r "prisma\.feature\." workspace/backend/src/ --include="*.ts" | grep -v "features"; then
  echo "❌ エラー: prisma.feature を使用している箇所があります（正: prisma.features）"
  ERRORS=$((ERRORS + 1))
fi

# キャメルケースの誤用チェック
if grep -r "prisma\.alertRule" workspace/backend/src/ --include="*.ts"; then
  echo "❌ エラー: prisma.alertRule を使用している箇所があります（正: prisma.alert_rules）"
  ERRORS=$((ERRORS + 1))
fi

if grep -r "prisma\.logStatistics" workspace/backend/src/ --include="*.ts"; then
  echo "❌ エラー: prisma.logStatistics を使用している箇所があります（正: prisma.log_statistics）"
  ERRORS=$((ERRORS + 1))
fi

if [ $ERRORS -eq 0 ]; then
  echo "✅ Prismaモデル名チェック: 問題なし"
  exit 0
else
  echo "❌ Prismaモデル名チェック: $ERRORS 件のエラー"
  exit 1
fi
```

#### 1-2. 環境設定チェッカー
```bash
#!/bin/bash
# scripts/check-environment.sh

echo "🔍 環境設定チェック..."

ERRORS=0

# プロキシ設定チェック
if grep -q "websys_backend_dev" workspace/frontend/vite.config.ts; then
  echo "⚠️  警告: vite.config.tsにDocker専用設定が残っています"
  echo "   → 環境変数対応に変更してください: process.env.VITE_API_URL || 'http://localhost:8000'"
  ERRORS=$((ERRORS + 1))
fi

# 必須ユーティリティファイルチェック
if [ ! -f "workspace/frontend/src/utils/auth.ts" ]; then
  echo "❌ エラー: workspace/frontend/src/utils/auth.ts が存在しません"
  ERRORS=$((ERRORS + 1))
fi

if [ ! -f "workspace/frontend/src/utils/date.ts" ]; then
  echo "❌ エラー: workspace/frontend/src/utils/date.ts が存在しません"
  ERRORS=$((ERRORS + 1))
fi

# 環境変数チェック
if [ ! -f "workspace/backend/.env" ]; then
  echo "❌ エラー: workspace/backend/.env が存在しません"
  ERRORS=$((ERRORS + 1))
fi

if [ $ERRORS -eq 0 ]; then
  echo "✅ 環境設定チェック: 問題なし"
  exit 0
else
  echo "❌ 環境設定チェック: $ERRORS 件のエラー"
  exit 1
fi
```

#### 1-3. 統合チェックスクリプト
```bash
#!/bin/bash
# scripts/pre-start-check.sh

echo "🚀 サーバー起動前チェック開始..."
echo ""

# Prismaモデル名チェック
./scripts/check-prisma-usage.sh
PRISMA_CHECK=$?

echo ""

# 環境設定チェック
./scripts/check-environment.sh
ENV_CHECK=$?

echo ""

if [ $PRISMA_CHECK -eq 0 ] && [ $ENV_CHECK -eq 0 ]; then
  echo "✅ 全チェック完了: 問題なし"
  echo "🚀 サーバーを起動できます"
  exit 0
else
  echo "❌ チェックに失敗しました"
  echo "⚠️  上記のエラーを修正してから起動してください"
  exit 1
fi
```

**実行方法:**
```bash
# 起動前に必ず実行
chmod +x scripts/*.sh
./scripts/pre-start-check.sh

# 問題なければサーバー起動
cd workspace/backend && npm run dev
cd workspace/frontend && npm run dev
```

---

### 対策2: package.jsonスクリプトへの統合 ⭐⭐⭐

**workspace/backend/package.json:**
```json
{
  "scripts": {
    "dev": "npm run check && tsx watch src/index.ts",
    "check": "bash ../../scripts/check-prisma-usage.sh",
    "start": "npm run check && node dist/index.js"
  }
}
```

**workspace/frontend/package.json:**
```json
{
  "scripts": {
    "dev": "npm run check && vite --host 0.0.0.0 --port 3000",
    "check": "bash ../../scripts/check-environment.sh",
    "build": "npm run check && vite build"
  }
}
```

**効果:**
- サーバー起動前に自動チェック
- 問題があれば起動前にエラー表示
- 手動チェック忘れを防止

---

### 対策3: ESLintルールの追加 ⭐⭐

**workspace/backend/.eslintrc.json:**
```json
{
  "rules": {
    "no-restricted-syntax": [
      "error",
      {
        "selector": "MemberExpression[object.name='prisma'][property.name=/^(user|company|department|log|feature|notification)$/]",
        "message": "Prismaモデル名は複数形を使用してください (例: prisma.users)"
      },
      {
        "selector": "MemberExpression[object.name='prisma'][property.name=/[A-Z]/]",
        "message": "Prismaモデル名はスネークケースを使用してください (例: alert_rules)"
      }
    ]
  }
}
```

**効果:**
- コーディング時にリアルタイムでエラー表示
- VSCodeなどのエディタで即座に検出
- コミット前にlintで自動チェック可能

---

### 対策4: TypeScript型定義の活用 ⭐⭐

**workspace/backend/src/types/prisma-safe.ts:**
```typescript
import { PrismaClient } from '@prisma/client'

// 型安全なPrismaラッパー
export type SafePrismaModels = {
  users: PrismaClient['users']
  companies: PrismaClient['companies']
  departments: PrismaClient['departments']
  logs: PrismaClient['logs']
  features: PrismaClient['features']
  alert_rules: PrismaClient['alert_rules']
  log_statistics: PrismaClient['log_statistics']
  // ... 他のモデル
}

// 使用例
export function createSafePrisma(prisma: PrismaClient): SafePrismaModels {
  return {
    users: prisma.users,
    companies: prisma.companies,
    departments: prisma.departments,
    logs: prisma.logs,
    features: prisma.features,
    alert_rules: prisma.alert_rules,
    log_statistics: prisma.log_statistics,
  }
}
```

**使用方法:**
```typescript
import { prisma } from '@/lib/prisma'
import { createSafePrisma } from '@/types/prisma-safe'

const db = createSafePrisma(prisma)

// ✅ 型補完で正しいモデル名のみ表示される
const users = await db.users.findMany()
const companies = await db.companies.findMany()

// ❌ 存在しないモデル名はTypeScriptエラーになる
// const user = await db.user.findMany() // コンパイルエラー
```

---

### 対策5: Git pre-commitフックの設定 ⭐⭐

**.git/hooks/pre-commit:**
```bash
#!/bin/bash

echo "🔍 コミット前チェック実行中..."

# Prismaチェック
./scripts/check-prisma-usage.sh
if [ $? -ne 0 ]; then
  echo "❌ Prismaモデル名チェックに失敗しました"
  echo "コミットを中止します"
  exit 1
fi

# 環境設定チェック
./scripts/check-environment.sh
if [ $? -ne 0 ]; then
  echo "⚠️  環境設定に問題がありますが、コミットは続行します"
fi

echo "✅ チェック完了"
exit 0
```

**設定方法:**
```bash
chmod +x .git/hooks/pre-commit
```

**効果:**
- 問題のあるコードをコミット前に検出
- チーム全体で品質維持
- レビュー時の負担軽減

---

### 対策6: templates/workspace同期チェッカー ⭐

**scripts/check-template-sync.sh:**
```bash
#!/bin/bash

echo "🔍 templates/workspace 同期チェック..."

DIFFS=0

# 重要ファイルの差分チェック
CRITICAL_FILES=(
  "backend/src/core/lib/prisma.ts"
  "backend/src/core/middleware/auth.ts"
  "frontend/vite.config.ts"
)

for file in "${CRITICAL_FILES[@]}"; do
  if ! diff -q "templates/$file" "workspace/$file" > /dev/null 2>&1; then
    echo "⚠️  差分あり: $file"
    DIFFS=$((DIFFS + 1))
  fi
done

if [ $DIFFS -eq 0 ]; then
  echo "✅ 同期チェック: 問題なし"
else
  echo "⚠️  $DIFFS 件のファイルに差分があります"
  echo "   必要に応じてtemplatesから更新してください"
fi
```

---

### 対策7: ブラウザキャッシュクリア手順の自動化 ⭐

**scripts/clear-cache.sh:**
```bash
#!/bin/bash

echo "🧹 キャッシュクリア実行中..."

# フロントエンドビルドキャッシュ
rm -rf workspace/frontend/dist
rm -rf workspace/frontend/node_modules/.vite

# バックエンドビルドキャッシュ
rm -rf workspace/backend/dist

echo "✅ キャッシュクリア完了"
echo "ℹ️  ブラウザキャッシュもクリアしてください:"
echo "   Chrome: Ctrl+Shift+Delete → 「キャッシュされた画像とファイル」にチェック → クリア"
echo "   Firefox: Ctrl+Shift+Delete → 「キャッシュ」にチェック → 今すぐ消去"
```

---

## 📋 運用フロー

### 開発開始時
```bash
# 1. チェック実行
./scripts/pre-start-check.sh

# 2. 問題なければ起動
cd workspace/backend && npm run dev &
cd workspace/frontend && npm run dev &
```

### コード変更時
```bash
# 自動: package.json scriptsで起動前チェック
npm run dev  # 内部でcheck実行

# 手動: エラー時
./scripts/clear-cache.sh  # キャッシュクリア
```

### デバッグ時
```bash
# Prismaモデル確認
./scripts/check-prisma-usage.sh

# 環境設定確認
./scripts/check-environment.sh

# templates同期確認
./scripts/check-template-sync.sh
```

---

## 🎯 期待効果

| 対策 | 効果 | 実装難易度 | 優先度 |
|------|------|----------|--------|
| 自動チェックスクリプト | データ取得エラー 80%削減 | 低 | ⭐⭐⭐ |
| package.json統合 | 手動チェック忘れ 100%防止 | 低 | ⭐⭐⭐ |
| ESLintルール | コーディング時検出 | 中 | ⭐⭐ |
| TypeScript型定義 | コンパイル時検出 | 中 | ⭐⭐ |
| Git pre-commit | コミット前検出 | 低 | ⭐⭐ |
| 同期チェッカー | templates/workspace不整合検出 | 低 | ⭐ |
| キャッシュクリア | ブラウザキャッシュ問題解消 | 低 | ⭐ |

**総合効果予測:**
- データ取得エラー発生率: 40% → **5%以下** (92%削減)
- デバッグ時間: 平均30分 → **5分以下** (83%削減)
- システム安定性: 大幅向上

---

## 📝 実装優先順位

### Phase 1: 即時実装（今日中）⭐⭐⭐
1. ✅ 自動チェックスクリプト作成
2. ✅ package.json統合
3. ✅ 運用フロー確立

### Phase 2: 1週間以内 ⭐⭐
4. ESLintルール追加
5. Git pre-commitフック設定

### Phase 3: 余裕があれば ⭐
6. TypeScript型定義実装
7. templates同期チェッカー

---

## 🔄 継続的改善

### 月次レビュー
- BUG発生パターンの再分析
- チェックスクリプトの更新
- 新規パターンの追加

### チーム教育
- Prismaモデル命名規則の共有
- チェックツール使用方法のドキュメント化
- ベストプラクティスの定期更新
