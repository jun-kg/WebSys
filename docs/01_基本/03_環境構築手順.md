# 環境構築手順

**最終更新**: 2025-10-03
**対応環境**: Docker 20.10+ / Docker Compose 2.0+

---

## 🚀 クイックスタート

### 1. 前提条件

**必須**:
- Docker 20.10+
- Docker Compose 2.0+
- Git

**推奨**:
- メモリ: 8GB以上
- ディスク空き容量: 20GB以上
- OS: Linux / macOS / Windows (WSL2)

### 2. 環境構築（ワンコマンド）

```bash
# 1. リポジトリをクローン
git clone https://github.com/jun-kg/WebSys.git
cd websys

# 2. 初回セットアップ（テンプレートコピー + 環境起動）
./setup.sh

# 3. アクセス確認
# Frontend: http://localhost:3000
# Backend:  http://localhost:8000
```

### 3. ログイン

**管理者アカウント**:
- ユーザー名: `admin`
- パスワード: `admin123`

**一般ユーザーアカウント**:
- ユーザー名: `user`
- パスワード: `user123`

---

## 📁 ディレクトリ構造

### プロジェクト全体

```
websys/
├── 📋 templates/                    # 共通ライブラリテンプレート（配布用・変更禁止）
│   ├── frontend/                   # フロントエンド共通コード
│   │   └── src/
│   │       ├── core/               # ✅ 共通コアモジュール
│   │       ├── extensions/         # 🔌 拡張ポイント
│   │       └── custom/             # 🏢 企業固有機能
│   └── backend/                    # バックエンド共通コード
│       └── src/
│           ├── core/               # ✅ 共通コアモジュール
│           ├── extensions/         # 🔌 拡張ポイント
│           └── custom/             # 🏢 企業固有機能
│
├── 👨‍💻 workspace/                    # 実装プロジェクト（開発対象・Git独立管理）
│   ├── frontend/                   # フロントエンド開発
│   │   └── src/
│   │       ├── core/               # templatesからコピー（参照のみ・変更禁止）
│   │       ├── extensions/         # 拡張機能実装
│   │       └── custom/             # 企業固有機能実装
│   └── backend/                    # バックエンド開発
│       └── src/
│           ├── core/               # templatesからコピー（参照のみ・変更禁止）
│           ├── extensions/         # 拡張機能実装
│           └── custom/             # 企業固有機能実装
│
├── 🐳 docker-compose.yml            # Docker環境設定
├── 📚 docs/                        # ドキュメント
├── ⚙️ setup.sh                      # 初回セットアップスクリプト
└── 🔄 init.sh                       # テンプレート再コピースクリプト
```

### 3層分離アーキテクチャ

| レイヤー | 変更可否 | 影響範囲 | 用途 |
|---------|---------|---------|------|
| **core/** | ❌ 変更禁止 | 全プロジェクト | 共通基盤機能（認証・権限・ログ監視） |
| **extensions/** | ✅ 拡張可能 | 個別プロジェクト | 共通機能の拡張 |
| **custom/** | ✅ 自由実装 | 個別プロジェクト | 企業固有ロジック |

---

## 🔧 セットアップ詳細

### 初回セットアップ（./setup.sh）

**実施内容**:
1. workspace/ディレクトリ作成
2. templatesからworkspaceへコピー
3. Docker環境起動（3コンテナ）
   - `websys_frontend_dev`: フロントエンド（Vue.js + Vite）
   - `websys_backend_dev`: バックエンド（Express + Prisma）
   - `websys_postgres_dev`: データベース（PostgreSQL 15）
4. データベースマイグレーション実行
5. 初期データシード投入

**所要時間**: 約5〜10分

### 手動セットアップ（詳細手順）

```bash
# 1. テンプレートコピー
./init.sh

# 2. Docker環境起動
docker-compose up -d

# 3. データベースマイグレーション
docker exec websys_backend_dev npx prisma migrate deploy

# 4. 初期データシード
docker exec websys_backend_dev npx prisma db seed

# 5. 動作確認
curl http://localhost:8000/health
```

---

## 🐳 Docker環境詳細

### コンテナ構成

| コンテナ名 | サービス | ポート | 役割 |
|-----------|---------|--------|------|
| websys_frontend_dev | Frontend | 3000 | Vue.js + Vite開発サーバー |
| websys_backend_dev | Backend | 8000 | Express APIサーバー |
| websys_postgres_dev | Database | 5432 | PostgreSQL 15 |

### ポート設定

- **3000**: フロントエンドアプリケーション
- **8000**: バックエンドAPI
- **5432**: PostgreSQLデータベース

### ホットリロード

**フロントエンド**:
- `workspace/frontend/src/` のファイル変更を自動検知
- ブラウザ自動リロード

**バックエンド**:
- `workspace/backend/src/` のファイル変更を自動検知
- nodemon自動再起動

### ボリュームマウント

```yaml
Frontend:
  - ./workspace/frontend:/app
  - /app/node_modules

Backend:
  - ./workspace/backend:/app
  - /app/node_modules

Database:
  - postgres_data:/var/lib/postgresql/data
```

---

## 🔄 開発フロー

### 日常の開発

```bash
# workspace/で開発（Git管理対象）
cd workspace/frontend    # フロントエンド開発
cd workspace/backend     # バックエンド開発

# ファイル変更はホットリロードで即座反映
```

### 環境操作コマンド

```bash
# 環境起動
docker-compose up -d

# 環境停止
docker-compose down

# 環境再起動
docker-compose restart

# ログ確認（全サービス）
docker-compose logs -f

# ログ確認（特定サービス）
docker logs websys_frontend_dev -f
docker logs websys_backend_dev -f
docker logs websys_postgres_dev -f

# サービス個別操作
docker-compose restart frontend    # フロントエンド再起動
docker-compose restart backend     # バックエンド再起動
docker-compose restart postgres    # データベース再起動

# コンテナ内シェル接続
docker exec -it websys_frontend_dev sh
docker exec -it websys_backend_dev sh
docker exec -it websys_postgres_dev psql -U postgres -d websys_dev
```

### データベース操作

```bash
# マイグレーション生成
docker exec websys_backend_dev npx prisma migrate dev --name [migration_name]

# マイグレーション適用
docker exec websys_backend_dev npx prisma migrate deploy

# Prismaクライアント再生成
docker exec websys_backend_dev npx prisma generate

# Prisma Studio起動（データベース管理画面）
docker exec websys_backend_dev npx prisma studio

# データベースリセット（開発環境のみ）
docker exec websys_backend_dev npx prisma migrate reset --force

# シード再実行
docker exec websys_backend_dev npx prisma db seed
```

---

## 🎨 環境変数設定

### フロントエンド (.env)

```bash
# workspace/frontend/.env

# APIベースURL（Docker内部）
VITE_API_BASE_URL=http://websys_backend_dev:8000

# APIプロキシターゲット（Vite開発サーバー用）
VITE_API_PROXY_TARGET=http://websys_backend_dev:8000

# WebSocketベースURL
VITE_WS_BASE_URL=ws://websys_backend_dev:8000
```

### バックエンド (.env)

```bash
# workspace/backend/.env

# データベース接続（Docker内部）
DATABASE_URL="postgresql://postgres:postgres@websys_postgres_dev:5432/websys_dev"

# JWT認証シークレット（本番環境では必ず変更）
JWT_ACCESS_SECRET="your-access-secret-key-change-in-production"
JWT_REFRESH_SECRET="your-refresh-secret-key-change-in-production"

# セッション設定
SESSION_SECRET="your-session-secret-change-in-production"

# CORS設定
CORS_ORIGIN="http://localhost:3000"

# サーバー設定
PORT=8000
NODE_ENV=development
```

---

## 🧪 動作確認

### ヘルスチェック

```bash
# バックエンドヘルスチェック
curl http://localhost:8000/health

# 期待される応答
{
  "success": true,
  "data": {
    "status": "healthy",
    "timestamp": "2025-10-03T...",
    "database": "connected",
    "uptime": 1234
  }
}
```

### ログイン確認

```bash
# ログインAPI
curl -X POST "http://localhost:8000/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "admin123"
  }'

# 期待される応答
{
  "success": true,
  "data": {
    "accessToken": "eyJhbGciOi...",
    "refreshToken": "eyJhbGciOi...",
    "user": {
      "id": 1,
      "username": "admin",
      "role": "ADMIN"
    }
  }
}
```

### フロントエンド確認

```bash
# ブラウザでアクセス
http://localhost:3000

# ログイン後、以下の画面が表示されること
- ダッシュボード
- ユーザー管理
- 組織管理
- 権限管理
- ログ監視
- ワークフロー
```

---

## 🔌 データベーススキーマ管理

### 3層分離ルール

```prisma
// workspace/backend/prisma/schema.prisma

// ============================================
// 🔒 CORE MODELS (共通コア - 変更禁止)
// ============================================
// 22モデル: 認証・権限・ログ・セキュリティ

model users { ... }
model companies { ... }
model departments { ... }
...

// ============================================
// 🔌 EXTENSION MODELS (拡張可能)
// ============================================
// 0モデル: 今後の拡張用

// ============================================
// 🏢 CUSTOM MODELS (企業固有)
// ============================================
// 9モデル: ワークフロー管理

model workflow_types { ... }
model workflow_requests { ... }
...
```

**詳細**: [データベーススキーマ分離ガイドライン](../02_設計/データベーススキーマ分離ガイドライン.md)

---

## 🛠️ カスタマイズ

### 企業固有機能の追加

```bash
# 1. フロントエンド
cd workspace/frontend/src/custom/

# 2. 新規画面作成
mkdir views/MyCustomView
touch views/MyCustomView/MyCustomView.vue

# 3. APIクライアント作成
touch api/myCustomApi.ts

# 4. ルーター登録
# src/custom/router/index.ts に追加
```

```bash
# 5. バックエンド
cd workspace/backend/src/custom/

# 6. ルート作成
mkdir routes/my-custom
touch routes/my-custom/index.ts

# 7. サービス作成
touch services/MyCustomService.ts

# 8. モデル追加
# prisma/schema.prisma の CUSTOM MODELS セクションに追加
```

### 共通機能の拡張

```bash
# extensions/配下で拡張機能を実装
cd workspace/frontend/src/extensions/
cd workspace/backend/src/extensions/

# 拡張例: カスタムログフィルター
touch frontend/src/extensions/components/CustomLogFilter.vue
touch backend/src/extensions/middleware/customLogMiddleware.ts
```

---

## ❓ トラブルシューティング

### コンテナ起動失敗

```bash
# ポート競合確認
sudo lsof -i :3000
sudo lsof -i :8000
sudo lsof -i :5432

# 競合プロセス停止後、再起動
docker-compose down
docker-compose up -d
```

### データベース接続エラー

```bash
# データベースコンテナ確認
docker ps | grep postgres

# データベースログ確認
docker logs websys_postgres_dev -f

# データベース再起動
docker-compose restart postgres

# 接続テスト
docker exec websys_postgres_dev psql -U postgres -d websys_dev -c "SELECT 1;"
```

### ホットリロード動作しない

```bash
# フロントエンド: Viteキャッシュクリア
docker exec websys_frontend_dev rm -rf /app/node_modules/.vite

# バックエンド: nodemon再起動
docker-compose restart backend

# ボリュームマウント確認
docker exec websys_frontend_dev ls -la /app/src
docker exec websys_backend_dev ls -la /app/src
```

### Prismaクライアント生成エラー

```bash
# Prismaクライアント再生成
docker exec websys_backend_dev npx prisma generate

# schema.prisma 検証
docker exec websys_backend_dev npx prisma validate

# マイグレーション状態確認
docker exec websys_backend_dev npx prisma migrate status
```

### 環境完全リセット

```bash
# 全コンテナ停止・削除
docker-compose down -v

# イメージ削除
docker rmi websys_frontend_dev websys_backend_dev

# workspace削除（注意: 開発中のコードも削除）
rm -rf workspace/

# 再セットアップ
./setup.sh
```

---

## 📚 関連ドキュメント

- [CLAUDE.md](../../CLAUDE.md) - プロジェクトルール・3層分離アーキテクチャ
- [データベーススキーマ分離ガイドライン](../02_設計/データベーススキーマ分離ガイドライン.md)
- [プロジェクト総合サマリー](../08_報告/11_プロジェクト総合サマリー.md)
- [トラブルシューティング](./05_トラブルシューティング.md)

---

## 🎓 ベストプラクティス

### 開発時の推奨事項

1. **core/は変更禁止**
   - 共通ライブラリ更新時のみtemplatesから再コピー

2. **Git管理の分離**
   - Docker環境: websys/.git
   - 開発ソース: workspace/.git

3. **環境変数の管理**
   - 本番環境では必ずシークレット変更
   - .envファイルはGit管理対象外

4. **Dockerサービス名の使用**
   - localhost → websys_backend_dev
   - IPv6問題の回避

5. **定期的なPrismaクライアント再生成**
   - schema.prisma変更時は必ず実行

---

*最終更新: 2025-10-03*
*次回レビュー予定: 2025-10-10*
