# 役職・権限体系設計書

**作成日**: 2025-10-05
**対象システム**: WebSys 社内システム基盤
**対象Phase**: Phase 3 - 役職・権限体系の再設計
**関連タスク**: T014, T015, T016

---

## 📋 目次

1. [概要](#概要)
2. [現状分析](#現状分析)
3. [T014: MANAGER権限の再定義](#t014-manager権限の再定義)
4. [T015: 部署別権限テンプレート](#t015-部署別権限テンプレート)
5. [T016: ゲストユーザー機能](#t016-ゲストユーザー機能)
6. [データベース設計](#データベース設計)
7. [API仕様](#api仕様)
8. [セキュリティ対策](#セキュリティ対策)
9. [実装計画](#実装計画)

---

## 概要

### 目的
現行の役職・権限体系を再設計し、以下の課題を解決します：

1. **MANAGER権限の曖昧性**: 現在のMANAGER権限の具体的な権限範囲が不明確
2. **部署別権限設定の非効率性**: 部署ごとに個別設定が必要で管理が煩雑
3. **外部ユーザー対応の欠如**: ゲストユーザー機能が未実装

### 対象範囲
- **T014**: MANAGER権限の明確な定義・権限マトリクス作成
- **T015**: 部署別デフォルト権限テンプレート作成・自動適用
- **T016**: ゲストユーザー機能実装・セキュリティ制約

### 期待効果
- ✅ 権限管理の明確化・属人化排除
- ✅ 新規部署・ユーザー追加の効率化（80%時間削減）
- ✅ 外部協力者・監査対応の実現
- ✅ セキュリティリスク低減

---

## 現状分析

### 現行役職体系（UserRole enum）
```prisma
enum UserRole {
  ADMIN    // システム管理者
  USER     // 一般ユーザー
  GUEST    // ゲストユーザー（未実装）
  MANAGER  // マネージャー（権限不明確）
}
```

### 現状の問題点

#### 1. MANAGER権限の曖昧性
| 項目 | 現状 | 問題 |
|------|------|------|
| **定義** | 「マネージャー」のみ | 具体的権限が不明 |
| **使用箇所** | seed.ts、ApprovalService.ts等 | 実装がバラバラ |
| **権限範囲** | 暗黙的に「部署管理者」扱い | 明文化されていない |
| **ADMINとの違い** | 不明確 | 権限重複の可能性 |

**具体例（現行コード）**:
```typescript
// ApprovalService.ts:185
if (user.role === 'MANAGER') {
  // 暗黙的に「部署の承認者」として扱われる
  // 具体的にどの権限があるかは不明
}

// EmergencyApprovalService.ts:40
if (admin.role !== 'ADMIN') {
  // MANAGERは緊急承認不可
  // しかし「部署内の緊急操作は可能」等の定義がない
}
```

#### 2. 部署別権限設定の非効率性
| 項目 | 現状 | 問題 |
|------|------|------|
| **新規部署作成時** | 手動で権限設定 | 設定漏れリスク |
| **権限テンプレート** | あり（permission_templates） | 自動適用なし |
| **デフォルト権限** | なし | 毎回個別設定 |
| **一貫性** | 部署間でバラつき | 標準化困難 |

**現状フロー**:
```
1. 部署作成
2. 手動で permission_templates 選択
3. 手動で features 一つずつ設定
4. ユーザー追加時も同様に手動設定
→ 時間がかかり、設定ミスの温床
```

#### 3. ゲストユーザー機能の未実装
| 項目 | 現状 | 問題 |
|------|------|------|
| **GUEST enum** | 定義のみ存在 | 実装なし |
| **外部ユーザー** | 対応不可 | 監査・協力者招待不可 |
| **セキュリティ制約** | なし | リスク管理不可 |
| **有効期限** | なし | アカウント放置リスク |

---

## T014: MANAGER権限の再定義

### 設計方針

#### 1. MANAGER権限の明確な定義
MANAGERは「部署管理者」として以下の権限を持ちます：

| 権限カテゴリ | 権限内容 | ADMIN | MANAGER | USER |
|-------------|---------|-------|---------|------|
| **システム全体管理** | 全社設定・ユーザー管理 | ✅ | ❌ | ❌ |
| **部署管理** | 自部署メンバー管理 | ✅ | ✅ | ❌ |
| **部署権限設定** | 自部署権限変更 | ✅ | ✅ | ❌ |
| **承認管理** | 自部署承認ルート設定 | ✅ | ✅ | ❌ |
| **レポート閲覧** | 自部署レポート | ✅ | ✅ | ❌ |
| **全社レポート** | 全部署統計 | ✅ | ❌ | ❌ |
| **緊急承認** | 緊急時直接操作 | ✅ | ⚠️ 自部署のみ | ❌ |
| **監査ログ** | 全ログ閲覧 | ✅ | ⚠️ 自部署のみ | ❌ |
| **システム設定** | 全体設定変更 | ✅ | ❌ | ❌ |

**凡例**:
- ✅: 権限あり（全範囲）
- ⚠️: 条件付き権限（スコープ制限）
- ❌: 権限なし

#### 2. スコープ制限の実装

**部署スコープ制御**:
```typescript
// 新規実装: RolePermissionService.ts
export class RolePermissionService {
  /**
   * ユーザーの権限スコープを取得
   */
  async getUserPermissionScope(userId: number): Promise<{
    role: UserRole
    scope: 'GLOBAL' | 'DEPARTMENT' | 'SELF'
    departmentIds: number[]
  }> {
    // ✅ N+1クエリ対策: includeでuser_departmentsを1クエリで取得
    // 　 複数部署所属の場合でもJOINで一度に取得し、N+1問題を防止
    const user = await prisma.users.findUnique({
      where: { id: userId },
      include: { user_departments: true }
    })

    if (user.role === 'ADMIN') {
      return {
        role: 'ADMIN',
        scope: 'GLOBAL',
        departmentIds: [] // 全部署アクセス可
      }
    }

    if (user.role === 'MANAGER') {
      return {
        role: 'MANAGER',
        scope: 'DEPARTMENT',
        departmentIds: user.user_departments.map(ud => ud.departmentId)
      }
    }

    return {
      role: 'USER',
      scope: 'SELF',
      departmentIds: []
    }
  }

  /**
   * 権限チェック（スコープ考慮）
   */
  async checkPermission(
    userId: number,
    action: string,
    targetDepartmentId?: number
  ): Promise<boolean> {
    const scope = await this.getUserPermissionScope(userId)

    // ADMIN: 全権限
    if (scope.role === 'ADMIN') {
      return true
    }

    // MANAGER: 自部署のみ
    if (scope.role === 'MANAGER') {
      if (!targetDepartmentId) {
        return false // 部署指定なしは拒否
      }
      return scope.departmentIds.includes(targetDepartmentId)
    }

    // USER: 自分のみ
    return false
  }
}
```

#### 3. 機能別権限マトリクス

**ユーザー管理**:
| 機能 | ADMIN | MANAGER | USER |
|------|-------|---------|------|
| ユーザー作成 | 全社 | 自部署 | 不可 |
| ユーザー編集 | 全社 | 自部署 | 自分のみ |
| ユーザー削除 | 全社 | 自部署 | 不可 |
| パスワードリセット | 全社 | 自部署 | 自分のみ |
| 役職変更 | 全社 | 不可 | 不可 |

**ワークフロー管理**:
| 機能 | ADMIN | MANAGER | USER |
|------|-------|---------|------|
| ワークフロー作成 | 全社 | 自部署 | 不可 |
| 承認ルート設定 | 全社 | 自部署 | 不可 |
| 緊急承認実行 | 全社 | 自部署 | 不可 |
| 委任設定閲覧 | 全社 | 自部署 | 自分のみ |
| 自動承認ルール | 全社 | 自部署 | 不可 |

**レポート・監査**:
| 機能 | ADMIN | MANAGER | USER |
|------|-------|---------|------|
| 監査ログ閲覧 | 全社 | 自部署 | 不可 |
| 統計レポート | 全社 | 自部署 | 不可 |
| ログエクスポート | 全社 | 自部署 | 不可 |
| アラート設定 | 全社 | 自部署 | 不可 |

#### 4. API実装例

**権限チェックミドルウェア拡張**:
```typescript
// 新規: middleware/roleScope.ts
import { Request, Response, NextFunction } from 'express'
import { RolePermissionService } from '../services/RolePermissionService'

const roleService = new RolePermissionService()

/**
 * 部署スコープチェックミドルウェア
 */
export const checkDepartmentScope = (action: string) => {
  return async (req: Request, res: Response, next: NextFunction) => {
    try {
      const userId = (req as any).user.id
      const targetDepartmentId = req.params.departmentId
        ? parseInt(req.params.departmentId)
        : req.body.departmentId

      const hasPermission = await roleService.checkPermission(
        userId,
        action,
        targetDepartmentId
      )

      if (!hasPermission) {
        return res.status(403).json({
          success: false,
          error: {
            code: 'DEPARTMENT_SCOPE_DENIED',
            message: '指定された部署へのアクセス権限がありません'
          }
        })
      }

      next()
    } catch (error) {
      next(error)
    }
  }
}

/**
 * 使用例
 */
router.post(
  '/users',
  authenticate,
  checkDepartmentScope('USER_CREATE'),
  UserController.create
)

router.put(
  '/departments/:departmentId/permissions',
  authenticate,
  checkDepartmentScope('PERMISSION_UPDATE'),
  PermissionController.update
)
```

---

## T015: 部署別権限テンプレート

### 設計方針

#### 1. デフォルト権限テンプレート体系

**プリセットテンプレート（5種類）**:

| テンプレート名 | 対象部署 | 権限レベル | 主要機能 |
|--------------|---------|-----------|---------|
| **ADMIN_DEPT** | 情報システム部 | 最高 | 全機能アクセス・システム設定 |
| **SALES_DEPT** | 営業部 | 高 | 顧客管理・見積・受注・レポート |
| **HR_DEPT** | 人事部 | 高 | ユーザー管理・権限設定・監査 |
| **FINANCE_DEPT** | 経理部 | 中 | 財務レポート・承認・監査ログ |
| **GENERAL_DEPT** | 一般部署 | 低 | 基本機能のみ |

#### 2. テンプレート詳細設計

**ADMIN_DEPT（情報システム部）**:
```json
{
  "name": "情報システム部権限",
  "category": "PRESET",
  "description": "システム管理部署向けの全権限テンプレート",
  "features": [
    { "featureCode": "USER_MGMT", "canView": true, "canCreate": true, "canEdit": true, "canDelete": true },
    { "featureCode": "DEPT_MGMT", "canView": true, "canCreate": true, "canEdit": true, "canDelete": true },
    { "featureCode": "PERMISSION", "canView": true, "canCreate": true, "canEdit": true, "canDelete": true },
    { "featureCode": "WORKFLOW", "canView": true, "canCreate": true, "canEdit": true, "canDelete": true },
    { "featureCode": "AUDIT", "canView": true, "canCreate": false, "canEdit": false, "canDelete": false },
    { "featureCode": "LOG", "canView": true, "canCreate": false, "canEdit": false, "canDelete": true },
    { "featureCode": "REPORT", "canView": true, "canCreate": true, "canEdit": true, "canDelete": true },
    { "featureCode": "SYSTEM", "canView": true, "canCreate": true, "canEdit": true, "canDelete": true }
  ]
}
```

**SALES_DEPT（営業部）**:
```json
{
  "name": "営業部権限",
  "category": "PRESET",
  "description": "営業部門向けの標準権限テンプレート",
  "features": [
    { "featureCode": "USER_MGMT", "canView": true, "canCreate": false, "canEdit": false, "canDelete": false },
    { "featureCode": "CUSTOMER", "canView": true, "canCreate": true, "canEdit": true, "canDelete": false },
    { "featureCode": "QUOTATION", "canView": true, "canCreate": true, "canEdit": true, "canDelete": false },
    { "featureCode": "ORDER", "canView": true, "canCreate": true, "canEdit": true, "canDelete": false },
    { "featureCode": "WORKFLOW", "canView": true, "canCreate": true, "canEdit": false, "canDelete": false },
    { "featureCode": "REPORT", "canView": true, "canCreate": true, "canEdit": false, "canDelete": false }
  ]
}
```

**HR_DEPT（人事部）**:
```json
{
  "name": "人事部権限",
  "category": "PRESET",
  "description": "人事部門向けの権限テンプレート",
  "features": [
    { "featureCode": "USER_MGMT", "canView": true, "canCreate": true, "canEdit": true, "canDelete": true },
    { "featureCode": "DEPT_MGMT", "canView": true, "canCreate": true, "canEdit": true, "canDelete": false },
    { "featureCode": "PERMISSION", "canView": true, "canCreate": true, "canEdit": true, "canDelete": false },
    { "featureCode": "AUDIT", "canView": true, "canCreate": false, "canEdit": false, "canDelete": false },
    { "featureCode": "REPORT", "canView": true, "canCreate": true, "canEdit": false, "canDelete": false }
  ]
}
```

**FINANCE_DEPT（経理部）**:
```json
{
  "name": "経理部権限",
  "category": "PRESET",
  "description": "経理部門向けの権限テンプレート",
  "features": [
    { "featureCode": "FINANCIAL", "canView": true, "canCreate": true, "canEdit": true, "canDelete": false },
    { "featureCode": "WORKFLOW", "canView": true, "canCreate": true, "canEdit": false, "canDelete": false },
    { "featureCode": "AUDIT", "canView": true, "canCreate": false, "canEdit": false, "canDelete": false },
    { "featureCode": "REPORT", "canView": true, "canCreate": true, "canEdit": false, "canDelete": false }
  ]
}
```

**GENERAL_DEPT（一般部署）**:
```json
{
  "name": "一般部署権限",
  "category": "PRESET",
  "description": "一般部署向けの最小権限テンプレート",
  "features": [
    { "featureCode": "WORKFLOW", "canView": true, "canCreate": true, "canEdit": false, "canDelete": false },
    { "featureCode": "REPORT", "canView": true, "canCreate": false, "canEdit": false, "canDelete": false }
  ]
}
```

#### 3. 自動適用ロジック

**新規部署作成時の自動テンプレート適用**:
```typescript
// 新規実装: services/DepartmentTemplateService.ts
export class DepartmentTemplateService {
  /**
   * 部署名からテンプレートを自動推定
   */
  private detectTemplateByName(departmentName: string): string {
    const mappings = {
      'ADMIN_DEPT': ['情報システム', 'IT', 'システム', 'インフラ'],
      'SALES_DEPT': ['営業', 'セールス', '販売'],
      'HR_DEPT': ['人事', '総務', '労務'],
      'FINANCE_DEPT': ['経理', '財務', '会計'],
      'GENERAL_DEPT': [] // デフォルト
    }

    for (const [template, keywords] of Object.entries(mappings)) {
      for (const keyword of keywords) {
        if (departmentName.includes(keyword)) {
          return template
        }
      }
    }

    return 'GENERAL_DEPT' // デフォルト
  }

  /**
   * 新規部署作成時の自動権限設定
   */
  async createDepartmentWithTemplate(data: {
    companyId: number
    name: string
    code: string
    parentId?: number
    autoApplyTemplate?: boolean
    templateOverride?: string
  }): Promise<Department> {
    const { companyId, name, code, parentId, autoApplyTemplate = true, templateOverride } = data

    // 1. 部署作成
    const department = await prisma.departments.create({
      data: {
        companyId,
        name,
        code,
        parentId,
        isActive: true
      }
    })

    // 2. テンプレート自動適用
    if (autoApplyTemplate) {
      const templateName = templateOverride || this.detectTemplateByName(name)
      const template = await prisma.permission_templates.findFirst({
        where: {
          companyId,
          category: 'PRESET',
          name: { contains: templateName }
        },
        include: { permission_template_features: true }
      })

      if (template) {
        // 権限自動設定
        await this.applyTemplateToD部署(department.id, template.id)

        console.log(`✅ 部署「${name}」にテンプレート「${template.name}」を自動適用しました`)
      } else {
        console.warn(`⚠️ テンプレート「${templateName}」が見つかりません。デフォルトテンプレートを適用します。`)
        await this.applyDefaultTemplate(department.id, companyId)
      }
    }

    return department
  }

  /**
   * デフォルトテンプレート適用
   */
  private async applyDefaultTemplate(departmentId: number, companyId: number): Promise<void> {
    const defaultTemplate = await prisma.permission_templates.findFirst({
      where: {
        companyId,
        category: 'PRESET',
        name: { contains: 'GENERAL' }
      },
      include: { permission_template_features: true }
    })

    if (defaultTemplate) {
      await this.applyTemplateToDepartment(departmentId, defaultTemplate.id)
    }
  }

  /**
   * テンプレート適用実行
   */
  private async applyTemplateToDepartment(
    departmentId: number,
    templateId: number
  ): Promise<void> {
    const template = await prisma.permission_templates.findUnique({
      where: { id: templateId },
      include: {
        permission_template_features: {
          include: { features: true }
        }
      }
    })

    if (!template) {
      throw new Error('テンプレートが見つかりません')
    }

    // 既存権限削除
    await prisma.department_feature_permissions.deleteMany({
      where: { departmentId }
    })

    // 新規権限作成
    const permissions = template.permission_template_features.map(ptf => ({
      departmentId,
      featureId: ptf.featureId,
      canView: ptf.canView,
      canCreate: ptf.canCreate,
      canEdit: ptf.canEdit,
      canDelete: ptf.canDelete,
      createdAt: new Date(),
      updatedAt: new Date()
    }))

    await prisma.department_feature_permissions.createMany({
      data: permissions
    })

    // 監査ログ記録
    await prisma.audit_logs.create({
      data: {
        action: 'TEMPLATE_APPLIED',
        targetType: 'DEPARTMENT',
        targetId: departmentId,
        details: {
          templateId,
          templateName: template.name,
          permissionsCount: permissions.length
        }
      }
    })
  }
}
```

#### 4. 管理UI設計

**部署作成画面の改善**:
```vue
<!-- 新規実装: components/DepartmentCreateDialog.vue -->
<template>
  <el-dialog title="新規部署作成" v-model="visible">
    <el-form :model="form" label-width="150px">
      <el-form-item label="部署名" required>
        <el-input v-model="form.name" @input="onNameChange" />
      </el-form-item>

      <el-form-item label="部署コード" required>
        <el-input v-model="form.code" />
      </el-form-item>

      <el-form-item label="親部署">
        <el-select v-model="form.parentId" clearable>
          <el-option
            v-for="dept in departments"
            :key="dept.id"
            :label="dept.name"
            :value="dept.id"
          />
        </el-select>
      </el-form-item>

      <el-divider />

      <el-form-item label="権限テンプレート">
        <el-radio-group v-model="templateMode">
          <el-radio label="auto">自動推定</el-radio>
          <el-radio label="manual">手動選択</el-radio>
          <el-radio label="none">後で設定</el-radio>
        </el-radio-group>
      </el-form-item>

      <!-- 自動推定時 -->
      <el-alert
        v-if="templateMode === 'auto' && detectedTemplate"
        type="info"
        :closable="false"
        show-icon
      >
        <template #title>
          推定されたテンプレート: {{ detectedTemplate.name }}
        </template>
        <div>{{ detectedTemplate.description }}</div>
        <div class="mt-2">
          <el-tag
            v-for="feature in detectedTemplate.features"
            :key="feature.code"
            size="small"
            class="mr-1"
          >
            {{ feature.name }}
          </el-tag>
        </div>
      </el-alert>

      <!-- 手動選択時 -->
      <el-form-item v-if="templateMode === 'manual'" label="テンプレート選択">
        <el-select v-model="form.templateId">
          <el-option
            v-for="template in templates"
            :key="template.id"
            :label="template.name"
            :value="template.id"
          >
            <div>{{ template.name }}</div>
            <div class="text-xs text-gray-500">{{ template.description }}</div>
          </el-option>
        </el-select>
      </el-form-item>
    </el-form>

    <template #footer>
      <el-button @click="visible = false">キャンセル</el-button>
      <el-button type="primary" @click="handleSubmit">作成</el-button>
    </template>
  </el-dialog>
</template>

<script setup lang="ts">
import { ref, computed, watch } from 'vue'

const templateMode = ref<'auto' | 'manual' | 'none'>('auto')
const form = ref({
  name: '',
  code: '',
  parentId: null,
  templateId: null
})

const detectedTemplate = ref(null)

const onNameChange = () => {
  if (templateMode.value === 'auto') {
    // テンプレート自動推定
    detectTemplate(form.value.name)
  }
}

const detectTemplate = async (name: string) => {
  const response = await fetch('/api/templates/detect', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ departmentName: name })
  })
  detectedTemplate.value = await response.json()
}

const handleSubmit = async () => {
  const data = {
    ...form.value,
    autoApplyTemplate: templateMode.value !== 'none',
    templateOverride: templateMode.value === 'manual' ? form.value.templateId : null
  }

  await fetch('/api/departments', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })

  ElMessage.success('部署を作成し、権限テンプレートを適用しました')
  visible.value = false
}
</script>
```

---

## T016: ゲストユーザー機能

### 設計方針

#### 1. ゲストユーザーの定義

**ゲストユーザー（GUEST）の特性**:
| 項目 | 内容 |
|------|------|
| **目的** | 外部協力者・監査法人・一時的なアクセス提供 |
| **権限レベル** | 最小権限（読み取り専用が基本） |
| **有効期限** | 必須（最大90日） |
| **セキュリティ** | 厳格な制約・監査ログ完全記録 |
| **部署所属** | 不可（ゲスト専用グループ） |
| **承認権限** | なし |
| **データ作成** | 原則不可 |

#### 2. セキュリティ制約

**ゲストユーザー制約一覧**:
```typescript
// 新規実装: middleware/guestRestrictions.ts
export const GUEST_RESTRICTIONS = {
  // 禁止操作
  FORBIDDEN_ACTIONS: [
    'USER_CREATE',
    'USER_DELETE',
    'DEPT_CREATE',
    'DEPT_DELETE',
    'PERMISSION_EDIT',
    'SYSTEM_SETTING',
    'WORKFLOW_APPROVE',
    'DATA_DELETE',
    'DATA_EXPORT_ALL'
  ],

  // 許可操作（明示的ホワイトリスト）
  ALLOWED_ACTIONS: [
    'DATA_VIEW',
    'REPORT_VIEW',
    'AUDIT_VIEW_LIMITED', // 自分のログのみ
    'PROFILE_EDIT_SELF'
  ],

  // セキュリティ設定
  SECURITY: {
    MAX_VALIDITY_DAYS: 90,        // 最大有効期限
    SESSION_TIMEOUT_MINUTES: 30,  // セッションタイムアウト（通常60分）
    MFA_REQUIRED: true,            // 多要素認証必須
    IP_WHITELIST_REQUIRED: false,  // IP制限（オプション）
    AUDIT_LOG_DETAIL: 'FULL',      // 監査ログ詳細度（最大）
    PASSWORD_RESET_FORBIDDEN: true // パスワードリセット不可（管理者のみ）
  },

  // アクセス制限
  ACCESS_LIMITS: {
    MAX_LOGIN_ATTEMPTS: 3,         // 最大ログイン試行回数
    LOCKOUT_DURATION_MINUTES: 60,  // ロックアウト時間
    MAX_CONCURRENT_SESSIONS: 1,    // 同時セッション数
    DOWNLOAD_SIZE_LIMIT_MB: 10     // ダウンロード上限
  }
}
```

#### 3. データベース設計拡張

**ゲストユーザー専用テーブル**:
```prisma
// 追加: schema.prisma
model guest_users {
  id                  Int       @id @default(autoincrement())
  userId              Int       @unique
  invitedBy           Int       // 招待者
  organization        String?   // 所属組織
  purpose             String    // 利用目的
  validFrom           DateTime  @default(now())
  validUntil          DateTime  // 有効期限（必須）
  ipWhitelist         String[]  // IP制限（オプション）
  allowedFeatures     String[]  // 許可機能コード
  isActive            Boolean   @default(true)
  lastAccessAt        DateTime?
  accessCount         Int       @default(0)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  users               users     @relation(fields: [userId], references: [id])
  inviter             users     @relation("guest_inviter", fields: [invitedBy], references: [id])

  @@index([userId])
  @@index([validUntil])
  @@index([isActive])
}

// セキュリティイベントログ（既存拡張）
model security_events {
  id         Int      @id @default(autoincrement())
  userId     Int
  eventType  String   // LOGIN_ATTEMPT, ACCESS_DENIED, etc.
  severity   String   // LOW, MEDIUM, HIGH, CRITICAL
  ipAddress  String?
  userAgent  String?
  details    Json?
  createdAt  DateTime @default(now())

  users      users    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([eventType])
  @@index([severity])
  @@index([createdAt])
}
```

#### 4. ゲストユーザー招待フロー

**実装: GuestUserService.ts**:
```typescript
export class GuestUserService {
  /**
   * ゲストユーザー招待
   */
  async inviteGuest(data: {
    email: string
    name: string
    organization?: string
    purpose: string
    validDays: number // 1-90日
    allowedFeatures: string[]
    invitedBy: number
  }): Promise<GuestInvitation> {
    const { email, name, organization, purpose, validDays, allowedFeatures, invitedBy } = data

    // バリデーション
    if (validDays < 1 || validDays > GUEST_RESTRICTIONS.SECURITY.MAX_VALIDITY_DAYS) {
      throw new Error(`有効期限は1〜${GUEST_RESTRICTIONS.SECURITY.MAX_VALIDITY_DAYS}日以内で設定してください`)
    }

    // 招待者権限チェック
    const inviter = await prisma.users.findUnique({
      where: { id: invitedBy }
    })

    if (!inviter || !['ADMIN', 'MANAGER'].includes(inviter.role)) {
      throw new Error('ゲストユーザーの招待はADMINまたはMANAGER権限が必要です')
    }

    // 1. 一時パスワード生成
    const tempPassword = this.generateSecurePassword(16)
    const hashedPassword = await bcrypt.hash(tempPassword, 10)

    // 2. ユーザー作成
    const user = await prisma.users.create({
      data: {
        username: `guest_${Date.now()}`,
        email,
        name,
        password: hashedPassword,
        role: 'GUEST',
        isActive: true,
        isFirstLogin: true,
        companyId: inviter.companyId
      }
    })

    // 3. ゲスト情報作成
    const validUntil = new Date()
    validUntil.setDate(validUntil.getDate() + validDays)

    const guestUser = await prisma.guest_users.create({
      data: {
        userId: user.id,
        invitedBy,
        organization,
        purpose,
        validUntil,
        allowedFeatures,
        isActive: true
      }
    })

    // 4. 招待メール送信
    await this.sendInvitationEmail({
      email,
      name,
      tempPassword,
      validUntil,
      inviterName: inviter.name
    })

    // 5. 監査ログ記録
    await prisma.audit_logs.create({
      data: {
        userId: invitedBy,
        action: 'GUEST_USER_INVITED',
        targetType: 'USER',
        targetId: user.id,
        details: {
          guestEmail: email,
          validUntil,
          allowedFeatures
        }
      }
    })

    return {
      guestUser,
      user,
      tempPassword // 管理者にのみ返す（メール送信後は保存しない）
    }
  }

  /**
   * ゲストユーザーアクセス制御
   */
  async checkGuestAccess(userId: number, action: string): Promise<boolean> {
    const guestUser = await prisma.guest_users.findUnique({
      where: { userId }
    })

    if (!guestUser || !guestUser.isActive) {
      return false
    }

    // 有効期限チェック
    if (new Date() > guestUser.validUntil) {
      await this.expireGuestUser(userId)
      return false
    }

    // 禁止操作チェック
    if (GUEST_RESTRICTIONS.FORBIDDEN_ACTIONS.includes(action)) {
      await this.logSecurityEvent(userId, 'ACCESS_DENIED', 'MEDIUM', {
        action,
        reason: 'FORBIDDEN_ACTION'
      })
      return false
    }

    // 許可機能チェック
    if (!guestUser.allowedFeatures.includes(action)) {
      await this.logSecurityEvent(userId, 'ACCESS_DENIED', 'LOW', {
        action,
        reason: 'NOT_IN_ALLOWED_FEATURES'
      })
      return false
    }

    // アクセスカウント更新
    await prisma.guest_users.update({
      where: { userId },
      data: {
        lastAccessAt: new Date(),
        accessCount: { increment: 1 }
      }
    })

    return true
  }

  /**
   * ゲストユーザー有効期限切れ処理
   */
  async expireGuestUser(userId: number): Promise<void> {
    await prisma.$transaction([
      prisma.guest_users.update({
        where: { userId },
        data: { isActive: false }
      }),
      prisma.users.update({
        where: { id: userId },
        data: { isActive: false }
      }),
      prisma.audit_logs.create({
        data: {
          userId,
          action: 'GUEST_USER_EXPIRED',
          targetType: 'USER',
          targetId: userId,
          details: { reason: 'VALIDITY_PERIOD_EXCEEDED' }
        }
      })
    ])
  }

  /**
   * セキュリティパスワード生成
   */
  private generateSecurePassword(length: number): string {
    const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*'
    let password = ''
    const crypto = require('crypto')
    for (let i = 0; i < length; i++) {
      password += charset[crypto.randomInt(charset.length)]
    }
    return password
  }

  /**
   * セキュリティイベントログ記録
   */
  private async logSecurityEvent(
    userId: number,
    eventType: string,
    severity: string,
    details: any
  ): Promise<void> {
    await prisma.security_events.create({
      data: {
        userId,
        eventType,
        severity,
        details
      }
    })
  }
}
```

#### 5. ゲストユーザー管理UI

**ゲスト招待画面**:
```vue
<!-- 新規実装: components/GuestUserInviteDialog.vue -->
<template>
  <el-dialog title="ゲストユーザー招待" v-model="visible" width="600px">
    <el-form :model="form" label-width="150px">
      <el-form-item label="メールアドレス" required>
        <el-input v-model="form.email" type="email" />
      </el-form-item>

      <el-form-item label="氏名" required>
        <el-input v-model="form.name" />
      </el-form-item>

      <el-form-item label="所属組織">
        <el-input v-model="form.organization" placeholder="例: ABC監査法人" />
      </el-form-item>

      <el-form-item label="利用目的" required>
        <el-input
          v-model="form.purpose"
          type="textarea"
          :rows="3"
          placeholder="例: 2025年度決算監査のため"
        />
      </el-form-item>

      <el-form-item label="有効期限" required>
        <el-select v-model="form.validDays">
          <el-option label="7日間" :value="7" />
          <el-option label="14日間" :value="14" />
          <el-option label="30日間" :value="30" />
          <el-option label="60日間" :value="60" />
          <el-option label="90日間（最大）" :value="90" />
        </el-select>
        <div class="text-xs text-gray-500 mt-1">
          有効期限: {{ expirationDate }}
        </div>
      </el-form-item>

      <el-form-item label="許可機能" required>
        <el-checkbox-group v-model="form.allowedFeatures">
          <el-checkbox label="DATA_VIEW">データ閲覧</el-checkbox>
          <el-checkbox label="REPORT_VIEW">レポート閲覧</el-checkbox>
          <el-checkbox label="AUDIT_VIEW_LIMITED">監査ログ閲覧（制限付き）</el-checkbox>
        </el-checkbox-group>
      </el-form-item>

      <el-alert type="warning" :closable="false" show-icon class="mb-4">
        <template #title>セキュリティ設定</template>
        <ul class="text-sm">
          <li>✅ 多要素認証（MFA）必須</li>
          <li>✅ セッションタイムアウト: 30分</li>
          <li>✅ 同時ログイン: 1セッションのみ</li>
          <li>✅ 全操作を監査ログに記録</li>
        </ul>
      </el-alert>
    </el-form>

    <template #footer>
      <el-button @click="visible = false">キャンセル</el-button>
      <el-button type="primary" @click="handleInvite">招待を送信</el-button>
    </template>
  </el-dialog>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue'
import { ElMessage } from 'element-plus'

const form = ref({
  email: '',
  name: '',
  organization: '',
  purpose: '',
  validDays: 30,
  allowedFeatures: ['DATA_VIEW', 'REPORT_VIEW']
})

const expirationDate = computed(() => {
  const date = new Date()
  date.setDate(date.getDate() + form.value.validDays)
  return date.toLocaleDateString('ja-JP')
})

const handleInvite = async () => {
  try {
    const response = await fetch('/api/guest/invite', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(form.value)
    })

    if (!response.ok) throw new Error('招待に失敗しました')

    ElMessage.success('ゲストユーザーを招待しました。招待メールを送信しました。')
    visible.value = false
  } catch (error) {
    ElMessage.error(error.message)
  }
}
</script>
```

---

## データベース設計

### テーブル追加・変更

**1. guest_users（新規）**:
```sql
CREATE TABLE guest_users (
  id SERIAL PRIMARY KEY,
  user_id INTEGER UNIQUE NOT NULL REFERENCES users(id),
  invited_by INTEGER NOT NULL REFERENCES users(id),
  organization VARCHAR(255),
  purpose TEXT NOT NULL,
  valid_from TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  valid_until TIMESTAMP NOT NULL,
  ip_whitelist TEXT[],
  allowed_features TEXT[] NOT NULL,
  is_active BOOLEAN DEFAULT TRUE,
  last_access_at TIMESTAMP,
  access_count INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_guest_users_user_id ON guest_users(user_id);
CREATE INDEX idx_guest_users_valid_until ON guest_users(valid_until);
CREATE INDEX idx_guest_users_is_active ON guest_users(is_active);
```

**2. security_events（新規）**:
```sql
CREATE TABLE security_events (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL REFERENCES users(id),
  event_type VARCHAR(50) NOT NULL,
  severity VARCHAR(20) NOT NULL,
  ip_address VARCHAR(45),
  user_agent TEXT,
  details JSONB,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_security_events_user_id ON security_events(user_id);
CREATE INDEX idx_security_events_event_type ON security_events(event_type);
CREATE INDEX idx_security_events_severity ON security_events(severity);
CREATE INDEX idx_security_events_created_at ON security_events(created_at);
```

**3. role_permissions（新規）**:
```sql
CREATE TABLE role_permissions (
  id SERIAL PRIMARY KEY,
  role VARCHAR(20) NOT NULL,
  action VARCHAR(100) NOT NULL,
  scope VARCHAR(20) NOT NULL, -- GLOBAL, DEPARTMENT, SELF
  description TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(role, action)
);

-- 初期データ投入
INSERT INTO role_permissions (role, action, scope, description) VALUES
-- ADMIN権限
('ADMIN', 'USER_CREATE', 'GLOBAL', 'ユーザー作成（全社）'),
('ADMIN', 'USER_EDIT', 'GLOBAL', 'ユーザー編集（全社）'),
('ADMIN', 'USER_DELETE', 'GLOBAL', 'ユーザー削除（全社）'),
('ADMIN', 'EMERGENCY_APPROVAL', 'GLOBAL', '緊急承認実行（全社）'),
('ADMIN', 'AUDIT_LOG_VIEW', 'GLOBAL', '監査ログ閲覧（全社）'),
('ADMIN', 'SYSTEM_SETTING', 'GLOBAL', 'システム設定変更'),

-- MANAGER権限
('MANAGER', 'USER_CREATE', 'DEPARTMENT', 'ユーザー作成（自部署）'),
('MANAGER', 'USER_EDIT', 'DEPARTMENT', 'ユーザー編集（自部署）'),
('MANAGER', 'PERMISSION_EDIT', 'DEPARTMENT', '権限編集（自部署）'),
('MANAGER', 'EMERGENCY_APPROVAL', 'DEPARTMENT', '緊急承認実行（自部署）'),
('MANAGER', 'AUDIT_LOG_VIEW', 'DEPARTMENT', '監査ログ閲覧（自部署）'),
('MANAGER', 'WORKFLOW_CREATE', 'DEPARTMENT', 'ワークフロー作成（自部署）'),

-- USER権限
('USER', 'USER_EDIT', 'SELF', 'ユーザー編集（自分のみ）'),
('USER', 'PASSWORD_RESET', 'SELF', 'パスワードリセット（自分のみ）'),
('USER', 'WORKFLOW_CREATE', 'SELF', 'ワークフロー作成（自分のみ）'),

-- GUEST権限
('GUEST', 'DATA_VIEW', 'SELF', 'データ閲覧（許可範囲のみ）'),
('GUEST', 'REPORT_VIEW', 'SELF', 'レポート閲覧（許可範囲のみ）'),
('GUEST', 'AUDIT_VIEW_LIMITED', 'SELF', '監査ログ閲覧（自分のみ）');
```

---

## API仕様

### 新規エンドポイント

#### 1. 役職権限管理

**GET /api/roles/permissions**
- 役職別権限一覧取得
- レスポンス:
```json
{
  "success": true,
  "data": {
    "ADMIN": [
      { "action": "USER_CREATE", "scope": "GLOBAL", "description": "..." },
      ...
    ],
    "MANAGER": [...],
    "USER": [...],
    "GUEST": [...]
  }
}
```

**GET /api/roles/:role/scope**
- 指定役職のスコープ情報取得
- パラメータ: `role` (ADMIN/MANAGER/USER/GUEST)

**POST /api/roles/check-permission**
- 権限チェック
- リクエスト:
```json
{
  "userId": 1,
  "action": "USER_CREATE",
  "targetDepartmentId": 2
}
```

#### 2. 部署テンプレート管理

**POST /api/templates/detect**
- 部署名からテンプレート自動推定
- リクエスト: `{ "departmentName": "営業部" }`
- レスポンス: `{ "templateName": "SALES_DEPT", ... }`

**GET /api/templates/presets**
- プリセットテンプレート一覧

**POST /api/departments/with-template**
- テンプレート自動適用で部署作成
- リクエスト:
```json
{
  "name": "営業第一部",
  "code": "SALES01",
  "autoApplyTemplate": true,
  "templateOverride": null
}
```

#### 3. ゲストユーザー管理

**POST /api/guest/invite**
- ゲストユーザー招待
- リクエスト:
```json
{
  "email": "auditor@example.com",
  "name": "監査 太郎",
  "organization": "ABC監査法人",
  "purpose": "2025年度決算監査",
  "validDays": 30,
  "allowedFeatures": ["DATA_VIEW", "REPORT_VIEW"]
}
```

**GET /api/guest/list**
- ゲストユーザー一覧（ADMIN/MANAGER のみ）

**DELETE /api/guest/:userId**
- ゲストユーザー無効化

**POST /api/guest/:userId/extend**
- 有効期限延長

**GET /api/guest/:userId/access-log**
- ゲストユーザーアクセスログ

---

## セキュリティ対策

### 1. 役職権限制御

| 対策項目 | 内容 |
|---------|------|
| **スコープ制限** | MANAGER権限は自部署のみアクセス可 |
| **権限エスカレーション防止** | 役職変更はADMINのみ実行可 |
| **監査ログ** | 全権限変更を記録 |
| **アクセス制御** | ミドルウェアによる自動チェック |

### 2. ゲストユーザーセキュリティ

| 対策項目 | 内容 |
|---------|------|
| **有効期限必須** | 最大90日、自動無効化 |
| **多要素認証** | MFA強制 |
| **セッション制限** | 30分タイムアウト、1セッションのみ |
| **操作制限** | ホワイトリスト方式 |
| **監査ログ詳細** | 全操作をFULL記録 |
| **アクセス回数制限** | 異常検知・自動ロック |

### 3. 部署テンプレート保護

| 対策項目 | 内容 |
|---------|------|
| **プリセット保護** | PRESET カテゴリは削除不可 |
| **変更履歴** | テンプレート適用を監査ログに記録 |
| **権限チェック** | ADMIN/MANAGER のみ適用可 |

---

## 性能要件

### 1. レスポンスタイム目標

| 処理 | 目標レスポンスタイム | 最大許容時間 | 備考 |
|------|---------------------|-------------|------|
| **getUserPermissionScope** | 10ms以内 | 50ms | キャッシュ活用・セッション中保持 |
| **checkPermission** | 10ms以内 | 50ms | ミドルウェア高速化・インデックス活用 |
| **権限マトリクス取得** | 100ms以内 | 300ms | 全役職×全機能のマトリクス |
| **テンプレート自動推定** | 50ms以内 | 100ms | 部署名からのパターンマッチ |
| **テンプレート自動適用** | 500ms以内 | 1,000ms | バックグラウンド実行可能 |
| **ゲスト招待処理** | 1,000ms以内 | 2,000ms | メール送信含む非同期処理 |
| **ゲストアクセスチェック** | 20ms以内 | 100ms | セッションごとにキャッシュ |

### 2. スループット目標

| 処理 | 目標スループット | 備考 |
|------|-----------------|------|
| **権限チェック（同時）** | 1,000 req/sec | ミドルウェアで高頻度実行 |
| **部署作成（同時）** | 10 req/sec | 通常は低頻度 |
| **ゲスト招待（同時）** | 5 req/sec | 管理者のみ実行 |

### 3. リソース使用量目標

| リソース | 目標値 | 最大許容値 | 備考 |
|---------|--------|-----------|------|
| **メモリ使用量** | +10MB | +50MB | 権限キャッシュ・セッション管理 |
| **CPU使用率** | +5% | +15% | 権限チェック処理 |
| **データベース接続** | +0 | +2 | 既存接続プールを使用 |
| **ストレージ増加** | +100MB/年 | +500MB/年 | ゲストユーザー・監査ログ |

### 4. パフォーマンス最適化戦略

#### 権限チェック最適化
```typescript
// キャッシュ戦略
const permissionCache = new Map<number, {
  scope: PermissionScope
  expiry: number
}>()

async getUserPermissionScope(userId: number) {
  // セッション中はキャッシュ使用（5分間有効）
  const cached = permissionCache.get(userId)
  if (cached && cached.expiry > Date.now()) {
    return cached.scope
  }

  // ✅ N+1対策: includeで user_departments を1クエリで取得
  const user = await prisma.users.findUnique({
    where: { id: userId },
    include: { user_departments: true }
  })

  const scope = this.calculateScope(user)

  // キャッシュ保存（5分間）
  permissionCache.set(userId, {
    scope,
    expiry: Date.now() + 5 * 60 * 1000
  })

  return scope
}
```

#### データベースクエリ最適化
```typescript
// テンプレート適用時の一括処理
async applyTemplateToDepartment(departmentId: number, templateId: number) {
  // ✅ 一括削除・一括挿入でクエリ数削減
  await prisma.$transaction([
    prisma.department_feature_permissions.deleteMany({
      where: { departmentId }
    }),
    prisma.department_feature_permissions.createMany({
      data: permissions  // 一括挿入
    })
  ])
}
```

#### インデックス活用
```sql
-- 性能向上のためのインデックス
CREATE INDEX idx_role_permissions_role_action ON role_permissions(role, action);
CREATE INDEX idx_guest_users_valid_until ON guest_users(valid_until);
CREATE INDEX idx_security_events_user_created ON security_events(user_id, created_at);
```

### 5. 性能試験項目

| 試験項目 | 合格基準 | 試験方法 |
|---------|---------|---------|
| **権限チェック負荷試験** | 1,000 req/sec で平均10ms以内 | Apache Bench (ab) |
| **同時ゲスト招待** | 5並列で全て1秒以内完了 | 並列実行スクリプト |
| **権限マトリクス取得** | 100ms以内 | ブラウザDevTools計測 |
| **メモリリーク検証** | 24時間稼働でメモリ増加+50MB以内 | メモリプロファイラ |

### 6. 性能劣化時の対応

| 閾値 | アラート | 対応 |
|------|---------|------|
| **権限チェック > 50ms** | WARNING | キャッシュ設定見直し |
| **権限チェック > 100ms** | ERROR | インデックス確認・クエリ最適化 |
| **メモリ使用量 > 50MB** | WARNING | キャッシュサイズ削減 |
| **CPU使用率 > 15%** | ERROR | 処理の並列化・最適化 |

---

## 実装計画

### Phase 3-1: T014実装（1週間）
- [ ] RolePermissionService実装
- [ ] role_permissions テーブル作成
- [ ] スコープチェックミドルウェア実装
- [ ] 権限マトリクスUI作成
- [ ] 単体試験実施

### Phase 3-2: T015実装（1週間）
- [ ] DepartmentTemplateService実装
- [ ] プリセットテンプレート5種類作成
- [ ] 自動適用ロジック実装
- [ ] 部署作成UI改善
- [ ] 単体試験実施

### Phase 3-3: T016実装（2週間）
- [ ] guest_users テーブル作成
- [ ] security_events テーブル作成
- [ ] GuestUserService実装
- [ ] ゲスト制約ミドルウェア実装
- [ ] 招待UI・管理UI実装
- [ ] セキュリティ試験実施

### Phase 3-4: 統合試験（1週間）
- [ ] 権限マトリクス動作確認
- [ ] 部署テンプレート自動適用確認
- [ ] ゲストユーザーセキュリティ確認
- [ ] 性能試験
- [ ] ドキュメント整備

**総所要期間**: 5週間

---

## 付録

### A. 関連ドキュメント
- [改善実装タスク管理表](../../legacy/numbered-docs/51-改善実装タスク管理表.md)
- [Phase 2完了総合報告](../../08_報告/46_Phase2完了総合報告.md)
- [権限テンプレート単体試験仕様書](../../04_試験/04_権限テンプレート単体試験仕様書.md)

### B. 用語集
- **RBAC**: Role-Based Access Control（役職ベースアクセス制御）
- **スコープ**: 権限の適用範囲（GLOBAL/DEPARTMENT/SELF）
- **プリセットテンプレート**: システム標準の権限設定
- **ゲストユーザー**: 一時的な外部アクセスユーザー

---

**作成日**: 2025-10-05
**バージョン**: 1.0
**承認状態**: 設計中
