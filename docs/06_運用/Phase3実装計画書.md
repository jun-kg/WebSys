# Phase 3実装計画書

**作成日**: 2025-10-05
**対象期間**: 2025年10月第2週 ～ 2025年11月第2週（5週間）
**対象タスク**: T014, T015, T016, T017, T018, T021, T022, T023
**プロジェクト**: WebSys 社内システム基盤 Phase 3実装

---

## 📋 目次

1. [実装概要](#実装概要)
2. [タスク優先順位](#タスク優先順位)
3. [詳細実装スケジュール](#詳細実装スケジュール)
4. [リソース計画](#リソース計画)
5. [リスク管理](#リスク管理)
6. [品質保証](#品質保証)
7. [成果物](#成果物)

---

## 実装概要

### Phase 3の目標
システム完成度を99.5%から**100%**に到達させ、長期的な運用基盤を確立します。

### 対象タスク（8タスク）

| カテゴリ | タスク数 | 優先度 | 期間 |
|---------|---------|--------|------|
| **役職・権限体系** | 3タスク | HIGH～MEDIUM | 3週間 |
| **ユーザー体験統一** | 2タスク | MEDIUM | 2週間 |
| **高度な管理機能** | 3タスク | LOW | 将来検討 |

### 完了基準
- ✅ 全HIGH・MEDIUM優先度タスク完了（5タスク）
- ✅ 設計書・仕様書完備
- ✅ 単体試験・統合試験完了
- ✅ システム完成度100%達成

---

## タスク優先順位

### 優先度A（即時実装）

#### T014: MANAGER権限の再定義
- **優先度**: HIGH
- **期間**: 1週間
- **理由**: 権限体系の基盤となる重要タスク
- **依存関係**: T015の前提条件

#### T015: 部署別権限テンプレート作成
- **優先度**: MEDIUM（高）
- **期間**: 1週間
- **理由**: 運用効率化に直結
- **依存関係**: T014完了後

#### T016: ゲストユーザー機能実装
- **優先度**: MEDIUM（高）
- **期間**: 2週間
- **理由**: 外部監査・協力者対応に必要
- **依存関係**: なし（並行実装可）

### 優先度B（早期実装推奨）

#### T017: デモ機能の環境分離
- **優先度**: MEDIUM
- **期間**: 1週間
- **理由**: 本番環境の信頼性向上
- **依存関係**: なし（並行実装可）

#### T018: ナビゲーション設計統一
- **優先度**: MEDIUM
- **期間**: 1週間
- **理由**: ユーザビリティ向上
- **依存関係**: なし（並行実装可）

### 優先度C（将来検討）

#### T021: 一括ユーザー操作機能
- **優先度**: MEDIUM（低）
- **期間**: 2週間
- **理由**: 運用効率化（必須ではない）
- **依存関係**: Phase 3完了後

#### T022: 管理ダッシュボード強化
- **優先度**: LOW
- **期間**: 2週間
- **理由**: 可視化強化（任意）
- **依存関係**: Phase 3完了後

#### T023: 承認ルートビジュアル設計
- **優先度**: LOW
- **期間**: 3週間
- **理由**: UI改善（任意）
- **依存関係**: Phase 3完了後

---

## 詳細実装スケジュール

### 第1週（10/7 ～ 10/13）: T014実装

#### Day 1-2: 設計・準備
- [ ] **依存ライブラリ確認**
  - [ ] bcrypt (v5.1.0以上) - パスワードハッシュ化
  - [ ] @types/bcrypt - TypeScript型定義
  - [ ] 既存ライブラリとのバージョン互換性確認
- [ ] role_permissions テーブル設計確定
- [ ] RolePermissionService 詳細設計
- [ ] スコープ制御ロジック設計
- [ ] API仕様確定

#### Day 3-4: 実装
- [ ] role_permissions テーブル作成・マイグレーション
- [ ] RolePermissionService実装
- [ ] checkDepartmentScope ミドルウェア実装
- [ ] 権限マトリクスAPI実装

#### Day 5: テスト・ドキュメント
- [ ] 単体試験実施（Jest）
- [ ] 権限チェック動作確認
- [ ] API試験実施
- [ ] 実装ドキュメント更新

**成果物**:
- RolePermissionService.ts
- middleware/roleScope.ts
- role_permissions テーブル
- 権限マトリクスAPI
- 単体試験コード

---

### 第2週（10/14 ～ 10/20）: T015実装

#### Day 1-2: 設計・準備
- [ ] 5種類のプリセットテンプレート詳細設計
- [ ] 自動適用ロジック設計
- [ ] テンプレート推定アルゴリズム設計
- [ ] UI/UX設計

#### Day 3-4: 実装
- [ ] DepartmentTemplateService実装
- [ ] プリセットテンプレート5種類作成
- [ ] 自動適用ロジック実装
- [ ] 部署作成UI改善（Vue）

#### Day 5: テスト・ドキュメント
- [ ] 単体試験実施
- [ ] テンプレート自動適用確認
- [ ] UI動作確認
- [ ] 実装ドキュメント更新

**成果物**:
- DepartmentTemplateService.ts
- プリセットテンプレート5種類
- DepartmentCreateDialog.vue
- テンプレート推定API
- 単体試験コード

---

### 第3-4週（10/21 ～ 11/3）: T016実装

#### Week 3 Day 1-2: データベース設計
- [ ] guest_users テーブル設計
- [ ] security_events テーブル設計
- [ ] マイグレーション実装

#### Week 3 Day 3-5: バックエンド実装
- [ ] GuestUserService実装
- [ ] ゲスト招待機能実装
- [ ] ゲスト制約ミドルウェア実装
- [ ] セキュリティイベントログ実装

#### Week 4 Day 1-3: フロントエンド実装
- [ ] GuestUserInviteDialog.vue実装
- [ ] ゲスト管理画面実装
- [ ] アクセスログ画面実装

#### Week 4 Day 4-5: テスト・セキュリティ確認
- [ ] 単体試験実施
- [ ] セキュリティ試験実施
- [ ] 有効期限自動無効化確認
- [ ] 監査ログ記録確認
- [ ] 実装ドキュメント更新

**成果物**:
- guest_users テーブル
- security_events テーブル
- GuestUserService.ts
- guestRestrictions ミドルウェア
- GuestUserInviteDialog.vue
- ゲスト管理UI
- セキュリティ試験レポート

---

### 第5週（11/4 ～ 11/10）: T017・T018並行実装

#### T017: デモ機能の環境分離（3日間）

**Day 1-2: 実装**
- [ ] 環境変数設定（.env）
- [ ] isDemo カラム追加（マイグレーション）
- [ ] seed.ts 分離実装
- [ ] デモデータフィルタリングミドルウェア
- [ ] デモバナーコンポーネント実装

**Day 3: テスト**
- [ ] 環境別動作確認
- [ ] デモデータ除外確認
- [ ] クリーンアップスクリプト動作確認

**成果物**:
- 環境変数設定
- seed.ts（分離版）
- DemoBanner.vue
- excludeDemoData ミドルウェア
- cleanupDemoData.ts

#### T018: ナビゲーション設計統一（2日間）

**Day 1: 実装**
- [ ] Breadcrumb.vue実装
- [ ] useNavigation composable実装
- [ ] メニュー定義ファイル作成
- [ ] Navigation.vue実装

**Day 2: 適用・テスト**
- [ ] 全画面へのパンくずリスト適用
- [ ] ショートカット実装
- [ ] 動作確認

**成果物**:
- Breadcrumb.vue
- useNavigation.ts
- menu.ts（メニュー定義）
- Navigation.vue
- useShortcuts.ts

---

## リソース計画

### 人員配置

| 役割 | 担当者 | 稼働率 | 期間 |
|------|--------|--------|------|
| **技術リード** | Claude | 100% | 5週間 |
| **バックエンド開発** | Claude | 100% | 5週間 |
| **フロントエンド開発** | Claude | 100% | 5週間 |
| **テスト担当** | Claude | 100% | 5週間 |
| **レビュー担当** | [未定] | 20% | 5週間 |

### 工数見積もり

| タスク | 設計 | 実装 | テスト | ドキュメント | 合計 |
|-------|------|------|--------|-------------|------|
| T014 | 2日 | 2日 | 1日 | 0.5日 | 5.5日 |
| T015 | 2日 | 2日 | 1日 | 0.5日 | 5.5日 |
| T016 | 2日 | 5日 | 2日 | 1日 | 10日 |
| T017 | 0.5日 | 2日 | 0.5日 | 0.5日 | 3.5日 |
| T018 | 0.5日 | 1日 | 0.5日 | 0.5日 | 2.5日 |
| **合計** | **7日** | **12日** | **5日** | **3日** | **27日** |

**バッファ**: 3日（総工数の10%）
**総所要期間**: 30日（6週間）→ **実施期間: 5週間**（並行実装により短縮）

---

## リスク管理

### リスク一覧

| リスク項目 | 影響度 | 発生確率 | 対策 |
|-----------|--------|---------|------|
| **既存機能への影響** | HIGH | MEDIUM | 詳細な影響調査・段階的リリース |
| **権限チェック漏れ** | HIGH | LOW | コードレビュー・試験強化 |
| **ゲストセキュリティ脆弱性** | CRITICAL | LOW | セキュリティ試験・ペネトレーションテスト |
| **環境分離の不完全性** | MEDIUM | MEDIUM | 環境別動作確認・自動試験 |
| **ナビゲーション変更への抵抗** | LOW | MEDIUM | ユーザーフィードバック・段階的適用 |
| **スケジュール遅延** | MEDIUM | MEDIUM | バッファ確保・優先度調整 |

### リスク対策

#### 1. 既存機能への影響対策
- **影響範囲調査**: 変更箇所の依存関係を完全マッピング
- **段階的リリース**: 機能ごとに分割してリリース
- **ロールバック計画**: 問題発生時の即座復旧手順

#### 2. セキュリティ対策
- **コードレビュー**: 全セキュリティ関連コードを重点レビュー
- **ペネトレーションテスト**: ゲストユーザー機能の脆弱性診断
- **監査ログ確認**: 全操作の記録確認

#### 3. スケジュール遅延対策
- **週次進捗確認**: 毎週金曜日に進捗レビュー
- **優先度調整**: 遅延発生時はLOW優先度タスクを延期
- **バッファ活用**: 3日間のバッファで吸収

---

## 品質保証

### テスト戦略

#### 1. 単体試験（Unit Test）
- **対象**: 全サービス・ミドルウェア・composable
- **ツール**: Jest (バックエンド)、Vitest (フロントエンド)
- **カバレッジ目標**: 90%以上

#### 2. 統合試験（Integration Test）
- **対象**: API ～ データベース ～ フロントエンド
- **シナリオ**:
  - MANAGER権限での部署管理操作
  - ゲストユーザー招待・ログイン・制限確認
  - デモ環境でのデータ分離確認
  - ナビゲーション遷移確認

#### 3. セキュリティ試験
- **ゲストユーザー**:
  - 禁止操作の実行拒否確認
  - 有効期限切れ自動無効化確認
  - セッションタイムアウト確認
  - 監査ログ記録確認
- **権限チェック**:
  - MANAGERのスコープ制限確認
  - 部署外アクセス拒否確認
  - 権限エスカレーション防止確認

#### 4. パフォーマンス試験
- **権限チェック**: 1リクエスト50ms以内
- **メニュー生成**: 初回100ms以内
- **パンくずリスト**: 再レンダリング10ms以内

### 品質指標

| 指標 | 目標値 | 測定方法 |
|------|--------|---------|
| **テストカバレッジ** | 90%以上 | Jest/Vitest coverage |
| **バグ密度** | 5件/1000行以下 | 試験結果集計 |
| **セキュリティ脆弱性** | 0件（HIGH以上） | セキュリティスキャン |
| **レスポンスタイム** | 95%ile < 200ms | パフォーマンス計測 |

---

## 成果物

### 実装成果物

#### バックエンド
- [ ] RolePermissionService.ts
- [ ] DepartmentTemplateService.ts
- [ ] GuestUserService.ts
- [ ] middleware/roleScope.ts
- [ ] middleware/guestRestrictions.ts
- [ ] middleware/demoFilter.ts
- [ ] マイグレーションファイル（3件）

#### フロントエンド
- [ ] Breadcrumb.vue
- [ ] Navigation.vue
- [ ] DemoBanner.vue
- [ ] DepartmentCreateDialog.vue
- [ ] GuestUserInviteDialog.vue
- [ ] useNavigation.ts
- [ ] useShortcuts.ts
- [ ] menu.ts（メニュー定義）

#### データベース
- [ ] role_permissions テーブル
- [ ] guest_users テーブル
- [ ] security_events テーブル
- [ ] isDemo カラム追加（4テーブル）

#### スクリプト
- [ ] cleanupDemoData.ts
- [ ] seed.ts（分離版）

### ドキュメント成果物
- [ ] 役職権限体系設計書（完成）
- [ ] ユーザー体験統一設計書（完成）
- [ ] Phase 3実装計画書（本書）
- [ ] Phase 3実装完了報告書
- [ ] API仕様書更新
- [ ] 単体試験仕様書（5件）
- [ ] セキュリティ試験レポート

---

## マイルストーン

### M1: 第1週完了（10/13）
- ✅ T014完了
- ✅ MANAGER権限明確化
- ✅ スコープ制御実装

### M2: 第2週完了（10/20）
- ✅ T015完了
- ✅ 部署テンプレート5種類実装
- ✅ 自動適用機能実装

### M3: 第4週完了（11/3）
- ✅ T016完了
- ✅ ゲストユーザー機能実装
- ✅ セキュリティ試験完了

### M4: 第5週完了（11/10）
- ✅ T017・T018完了
- ✅ デモ環境分離完了
- ✅ ナビゲーション統一完了
- ✅ Phase 3完了

### M5: Phase 3完了（11/17）
- ✅ 全タスク完了
- ✅ 統合試験完了
- ✅ ドキュメント整備完了
- ✅ **システム完成度100%達成** 🎉

---

## コミュニケーション計画

### 定例会議
- **週次進捗会議**: 毎週金曜日 15:00-16:00
- **デイリースタンドアップ**: 毎日 10:00-10:15（任意）

### 報告フロー
- **週次報告**: 毎週金曜日に進捗報告
- **問題報告**: 重大問題発生時は即座報告
- **完了報告**: 各タスク完了時に完了報告

### レビュープロセス
1. 実装完了
2. セルフレビュー
3. コードレビュー依頼
4. レビュー指摘対応
5. 承認・マージ

---

## 承認

| 役割 | 氏名 | 承認日 | 署名 |
|------|------|--------|------|
| **作成者** | Claude | 2025-10-05 | - |
| **技術リード** | [未定] | | |
| **プロジェクトマネージャー** | [未定] | | |
| **最終承認者** | システム管理責任者 | | |

---

## 付録

### A. 関連ドキュメント
- [役職権限体系設計書](../03_機能/06_機能設計書/02_権限管理/役職権限体系設計書.md)
- [ユーザー体験統一設計書](../03_機能/06_機能設計書/08_UX・UI/ユーザー体験統一設計書.md)
- [改善実装タスク管理表](../legacy/numbered-docs/51-改善実装タスク管理表.md)
- [Phase 2完了総合報告](../08_報告/46_Phase2完了総合報告.md)

### B. 依存ライブラリ一覧

#### バックエンド
| ライブラリ | バージョン | 用途 | 備考 |
|-----------|-----------|------|------|
| **bcrypt** | ^5.1.0 | パスワードハッシュ化 | ゲストユーザー招待時の一時パスワード生成 |
| **@types/bcrypt** | ^5.0.0 | TypeScript型定義 | bcryptの型定義 |
| **@prisma/client** | 既存 | データベースORM | 既存使用中 |
| **express** | 既存 | Webフレームワーク | 既存使用中 |
| **jsonwebtoken** | 既存 | JWT認証 | 既存使用中 |

#### フロントエンド
| ライブラリ | バージョン | 用途 | 備考 |
|-----------|-----------|------|------|
| **vue** | 既存 | UIフレームワーク | 既存使用中 |
| **vue-router** | 既存 | ルーティング | 既存使用中 |
| **element-plus** | 既存 | UIコンポーネント | 既存使用中 |
| **pinia** | 既存 | 状態管理 | 既存使用中 |
| **axios** | 既存 | HTTP通信 | 既存使用中 |

#### 新規追加必要なライブラリ
```json
// backend/package.json に追加
{
  "dependencies": {
    "bcrypt": "^5.1.0"
  },
  "devDependencies": {
    "@types/bcrypt": "^5.0.0"
  }
}
```

### C. 用語集
- **RBAC**: Role-Based Access Control（役職ベースアクセス制御）
- **スコープ**: 権限の適用範囲（GLOBAL/DEPARTMENT/SELF）
- **プリセットテンプレート**: システム標準の権限設定
- **ゲストユーザー**: 一時的な外部アクセスユーザー
- **デモモード**: デモ専用機能・データの表示モード

---

**作成日**: 2025-10-05
**バージョン**: 1.0
**次回更新予定**: 週次進捗報告時
