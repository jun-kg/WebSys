# WebSys マスタードキュメント
## 技術情報統一リファレンス（単一真実源）

**最終更新**: 2025-10-03
**バージョン**: 2.0
**管理者**: システム設計チーム

---

## 🚀 システム概要

WebSysは**共通ライブラリ型社内システム開発環境**です。Vue.js 3 + Element Plus + Express + PostgreSQLを使用し、企業固有機能と共通機能を完全分離した3層アーキテクチャを採用しています。

### 主要特徴
- **3層分離アーキテクチャ**: core（変更禁止）/ extensions（拡張可能）/ custom（自由実装）
- **完全型安全**: TypeScriptフルスタック実装（フロントエンド〜バックエンド〜データベース）
- **企業レベルセキュリティ**: JWT双代トークン + RBAC + 権限テンプレート + 監査ログ
- **高性能**: 95%テストカバレッジ、マイクロフロントエンド対応、89%初回読み込み削減
- **実用性**: 27件BUG完全解決、285%水平展開効果、机上チェック導入

---

## 💻 技術スタック（確定版）

### フロントエンド
```json
{
  "vue": "3.4.29",
  "element-plus": "2.8.0",
  "typescript": "5.4.5",
  "vite": "5.1.4",
  "pinia": "2.1.7",
  "vue-router": "4.2.5",
  "socket.io-client": "4.7.5"
}
```

**主要機能:**
- Vue 3 Composition API
- Element Plus 自動インポート
- Pinia状態管理
- Vue Router 4ナビゲーション
- WebSocketリアルタイム通信

### バックエンド
```json
{
  "express": "4.19.2",
  "typescript": "5.4.5",
  "prisma": "5.10.2",
  "jsonwebtoken": "9.0.2",
  "bcryptjs": "2.4.3",
  "cors": "2.8.5",
  "socket.io": "4.7.5",
  "express-validator": "7.0.1"
}
```

**主要機能:**
- Express RESTful API
- Prisma ORM統一データベース管理
- JWT双代トークン認証
- Socket.io WebSocketサーバー
- 入力バリデーション

### データベース・インフラ
```yaml
database: "PostgreSQL 15-alpine"
orm: "Prisma ORM 5.10.2"
container: "Docker + Docker Compose"
testing: "Jest (Backend) + Vitest (Frontend)"
deployment: "Docker環境 + 水平スケーリング対応"
models: "31モデル（CORE: 22, CUSTOM: 9）"
```

**Docker構成:**
- `websys_frontend_dev`: Vue.js開発サーバー（ポート3000）
- `websys_backend_dev`: Express APIサーバー（ポート8000）
- `websys_postgres_dev`: PostgreSQLデータベース（ポート5432）

### 開発ツール
```yaml
code_quality: "ESLint + Prettier"
testing: "Jest + Vitest + Supertest"
coverage: "Jest Coverage (Backend) + Vitest Coverage (Frontend)"
documentation: "Markdown + 自動生成"
ci_cd: "GitHub Actions対応可能"
version_control: "Git + GitHub"
```

---

## 🏗️ 3層分離アーキテクチャ

### 設計原則
共通ライブラリとして他プロジェクトに提供される構成。共通機能更新時に企業固有機能への影響ゼロ、逆も同様に影響ゼロを実現。

### ディレクトリ構造
```
websys/
├── templates/                    # 共通テンプレート（配布用）
│   ├── frontend/src/
│   │   ├── core/                # ✅ 共通コア（変更禁止）
│   │   ├── extensions/          # 🔌 拡張ポイント（カスタマイズ可能）
│   │   └── custom/              # 🏢 企業固有機能（完全独立）
│   └── backend/src/
│       ├── core/                # ✅ 共通コア（変更禁止）
│       ├── extensions/          # 🔌 拡張ポイント（カスタマイズ可能）
│       └── custom/              # 🏢 企業固有機能（完全独立）
└── workspace/                   # 実装プロジェクト（企業固有）
    ├── frontend/
    └── backend/
```

### 分離原則と影響範囲

| レイヤー | 変更可否 | 影響範囲 | 用途 | 具体例 |
|---------|---------|---------|------|--------|
| **core/** | ❌ 変更禁止 | 全プロジェクト | 共通基盤機能 | ログ監視・認証・権限管理・RBAC |
| **extensions/** | ✅ 拡張可能 | 個別プロジェクト | 共通機能の拡張 | カスタム認証・追加バリデーション |
| **custom/** | ✅ 自由実装 | 個別プロジェクト | 企業固有ロジック | 営業管理・在庫管理・顧客管理 |

### パスエイリアス設定

**フロントエンド vite.config.ts:**
```typescript
resolve: {
  alias: {
    '@core': path.resolve(__dirname, 'src/core'),           // 共通コア
    '@extensions': path.resolve(__dirname, 'src/extensions'), // 拡張機能
    '@custom': path.resolve(__dirname, 'src/custom'),       // 企業固有
    '@': path.resolve(__dirname, 'src')                     // ルート
  }
}
```

**バックエンド tsconfig.json:**
```json
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@core/*": ["src/core/*"],
      "@extensions/*": ["src/extensions/*"],
      "@custom/*": ["src/custom/*"],
      "@/*": ["src/*"]
    }
  }
}
```

### データベース3層分離

**schema.prisma構成:**
```prisma
// ============================================
// 🔒 CORE MODELS (共通コア - 変更禁止)
// ============================================
// 22モデル: 認証・権限・監査・セキュリティ・ログ

// ============================================
// 🔌 EXTENSION MODELS (拡張可能)
// ============================================
// 企業がカスタマイズ可能なモデル（現在0モデル）

// ============================================
// 🏢 CUSTOM MODELS (企業固有)
// ============================================
// 9モデル: ワークフロー・承認・通知
```

**詳細**: [データベーススキーマ分離ガイドライン](データベーススキーマ分離ガイドライン.md)

---

## 🔒 セキュリティアーキテクチャ

### JWT双代トークン認証
```yaml
access_token:
  secret: "JWT_ACCESS_SECRET"
  expiry: "15分"
  usage: "API認証"

refresh_token:
  secret: "JWT_REFRESH_SECRET"
  expiry: "7日間"
  usage: "トークン更新"
```

### RBAC権限管理
```yaml
roles:
  - ADMIN: "全機能アクセス可能"
  - USER: "一般ユーザー"
  - READONLY: "参照のみ"

permission_templates:
  - ADMIN: "管理者権限テンプレート（変更不可）"
  - GENERAL: "一般権限テンプレート（変更不可）"
  - READONLY: "参照権限テンプレート（変更不可）"
  - CUSTOM: "カスタム権限テンプレート（作成可能）"
```

### 監査ログ
```yaml
audit_categories:
  - AUTH: "認証関連"
  - API: "API呼び出し"
  - DB: "データベース操作"
  - SEC: "セキュリティ"
  - USER: "ユーザー操作"

log_levels:
  - FATAL: 60 (保存1年)
  - ERROR: 50 (保存1年)
  - WARN: 40 (保存6ヶ月)
  - INFO: 30 (保存3ヶ月)
  - DEBUG: 20 (保存1ヶ月)
  - TRACE: 10 (保存1ヶ月)
```

---

## 📊 プロジェクト指標

### 品質指標（2025-10-03時点）
```yaml
project_completion: "99%"
bug_resolution: "100% (27/27件完了)"
horizontal_expansion: "285%効果 (74件予防 / 26件発生)"
api_uptime: "100% (全エンドポイント正常)"
test_coverage: "95%以上"
implementation_features: "16機能完全実装"
```

### 性能指標
```yaml
log_monitoring:
  initial_load: "36KB → 4KB (89%削減)"
  memory_usage: "50%削減 (未使用コンポーネント解放)"
  re_rendering: "90%削減 (局所的更新)"

build_performance:
  build_time: "3分以内"
  hot_reload: "1秒以内"
  docker_startup: "30秒以内"
```

### テストカバレッジ
```yaml
backend:
  unit_tests: "30項目"
  coverage: "100%"
  framework: "Jest + Supertest"

frontend:
  component_tests: "18項目"
  coverage: "95%"
  framework: "Vitest + Vue Test Utils"

integration:
  tests: "15項目"
  areas: "性能・セキュリティ・統合"
```

---

## 🎯 主要機能一覧

### 完全実装済み（16機能）

| 機能 | 完成度 | 最終更新 | 説明 |
|------|--------|---------|------|
| 🔐 認証・認可システム | 100% | 2025-09-25 | JWT双代トークン・ログイン・ログアウト |
| 👥 ユーザー管理 | 100% | 2025-09-25 | CRUD・検索・フィルタ・ページネーション |
| 🏢 組織管理 | 100% | 2025-09-25 | 企業・部署階層管理 |
| 🔑 RBAC権限管理 | 100% | 2025-09-26 | 役割ベース・細粒度権限制御 |
| 📋 権限テンプレート | 100% | 2025-09-26 | 一括適用・権限マトリクス・監査ログ |
| 📝 ログ監視システム | 100% | 2025-09-27 | 8コンポーネント分割・リアルタイム監視 |
| 🔔 ワークフローシステム | 100% | 2025-09-28 | 9マイクロサービス・承認フロー |
| 🌐 WebSocketリアルタイム | 100% | 2025-09-29 | Socket.io・自動再接続・JWT認証 |
| 📊 ダッシュボード統計 | 100% | 2025-09-29 | リアルタイム統計・グラフ表示 |
| 🗂️ データベース設計 | 100% | 2025-10-03 | 31モデル・3層分離・Prisma ORM |
| 🧪 単体試験システム | 100% | 2025-09-29 | 63項目・95%カバレッジ |
| 📱 レスポンシブUI | 100% | 2025-09-25 | Element Plus・全ブレークポイント |
| 🐳 Docker環境 | 100% | 2025-09-24 | 3コンテナ・ホットリロード |
| 🔍 検索・フィルタ | 100% | 2025-09-25 | 全画面対応・高度検索 |
| 📄 ページネーション | 100% | 2025-09-25 | 統一実装・カスタマイズ可能 |
| 🎨 BIZ UDゴシック | 100% | 2025-09-25 | アクセシビリティ対応 |

---

## 🔗 主要リンク

### 🚀 はじめに
- [プロジェクト総合サマリー](../08_報告/11_プロジェクト総合サマリー.md)
- [プロジェクトステータスボード](../08_報告/10_プロジェクトステータスボード.md)
- [環境構築手順](../01_基本/03_環境構築手順.md)
- [クイックスタートガイド](../01_基本/01_クイックスタートガイド.md)

### 👨‍💻 開発者向け
- [開発ガイド](../01_基本/02_開発ガイド.md)
- [API仕様書](04_API仕様書.md)
- [コンポーネント仕様書](05_コンポーネント仕様書.md)
- [データベーススキーマ分離ガイドライン](データベーススキーマ分離ガイドライン.md)

### 🔧 運用・保守
- [デプロイ手順](02_デプロイ手順.md)
- [運用手順書](03_運用手順書.md)
- [トラブルシューティング](../01_基本/04_トラブルシューティング.md)
- [ログ監視システム設計書](../04_機能設計/12_ログ監視システム設計書.md)

### 🏗️ アーキテクチャ・設計
- [システム設計概要](01_システム設計概要.md)
- [データベース設計書](../03_データベース設計/統合データベース設計書.md)
- [3層分離アーキテクチャ](データベーススキーマ分離ガイドライン.md#3層分離原則)
- [共通機能保護戦略](../07_継続的改善/70_共通機能保護戦略設計書.md)

### 📋 品質管理・報告
- [不具合管理表](../08_報告/31_不具合管理表.md)
- [改善実装タスク管理表](../07_継続的改善/51_改善実装タスク管理表.md)
- [単体試験報告書](../08_報告/23_単体試験報告書.md)
- [ドキュメント総合再精査レポート](../08_報告/40_ドキュメント総合再精査レポート_2025-10-03.md)

---

## 🛡️ 必須ルール・ベストプラクティス

### Prismaクライアント使用ルール（違反厳禁）

**✅ 正しい使用方法:**
```typescript
// 必ず統一Prismaシングルトンを使用
import { prisma } from '../lib/prisma';

const users = await prisma.users.findMany();
```

**❌ 絶対禁止事項:**
```typescript
// 個別インスタンス作成は絶対禁止
import { PrismaClient } from '@prisma/client';
const prisma = new PrismaClient(); // これは使用不可
```

**理由:**
- 複数インスタンス作成による接続プール枯渇防止
- メモリリーク防止とリソース効率化
- 水平展開での安定動作確保

### コーディング規約

**TypeScript:**
```typescript
// インターフェース定義（PascalCase）
interface UserData {
  id: number;
  username: string;
}

// 関数定義（camelCase）
async function getUserById(id: number): Promise<UserData> {
  return await prisma.users.findUnique({ where: { id } });
}

// コンポーネント名（PascalCase）
export default defineComponent({
  name: 'UserManagement'
});
```

**ファイル命名:**
```yaml
components: "PascalCase (UserList.vue)"
services: "PascalCase (UserService.ts)"
utilities: "camelCase (formatDate.ts)"
routes: "camelCase (userRoutes.ts)"
```

### Git コミットメッセージ規約
```
<type>: <subject>

<body>

🤖 Generated with Claude Code
Co-Authored-By: Claude <noreply@anthropic.com>
```

**Type:**
- `feat`: 新機能
- `fix`: バグ修正
- `docs`: ドキュメント更新
- `refactor`: リファクタリング
- `test`: テスト追加・修正
- `chore`: ビルド・設定変更

---

## 🔄 バージョン管理

### 現在バージョン
```yaml
websys_core: "1.0.0"
documentation: "2.0 (2025-10-03)"
database_schema: "v1.0 (31モデル・3層分離)"
```

### 更新履歴
```yaml
v2.0.0:
  date: "2025-10-03"
  changes:
    - "3層分離アーキテクチャ完成"
    - "データベーススキーマ3層分離実装"
    - "BUG完全解決（27/27件）"
    - "プロジェクト完成度99%達成"
    - "ドキュメント総合再精査完了"

v1.0.0:
  date: "2025-09-30"
  changes:
    - "初回リリース版"
    - "全16機能実装完了"
    - "95%テストカバレッジ達成"
    - "BUG修正19件完了"
```

### 互換性
```yaml
minimum_node: "18.0.0"
minimum_npm: "9.0.0"
minimum_postgresql: "15.0"
minimum_docker: "24.0.0"
browser_support: "Chrome 90+, Firefox 88+, Safari 14+"
prisma_version: "5.10.2+"
```

---

## 🎯 利用開始ガイド

### 新規開発者（初回30分）
1. **[環境構築手順](../01_基本/03_環境構築手順.md)** → Docker環境セットアップ（`./setup.sh`実行）
2. **[クイックスタート](../01_基本/01_クイックスタートガイド.md)** → 基本操作確認（ログイン・ユーザー管理）
3. **[開発ガイド](../01_基本/02_開発ガイド.md)** → コーディング開始（3層分離理解）

### システム管理者（初回60分）
1. **[デプロイ手順](02_デプロイ手順.md)** → 本番環境構築（Docker Compose本番設定）
2. **[運用手順書](03_運用手順書.md)** → 日常運用（バックアップ・監視）
3. **[ログ監視設定](../04_機能設計/12_ログ監視システム設計書.md)** → アラート設定

### プロジェクトマネージャー（初回45分）
1. **[プロジェクト総合サマリー](../08_報告/11_プロジェクト総合サマリー.md)** → 全体理解（完成度・機能）
2. **[プロジェクトステータスボード](../08_報告/10_プロジェクトステータスボード.md)** → 進捗確認
3. **[改善タスク管理表](../07_継続的改善/51_改善実装タスク管理表.md)** → 改善計画

---

## 📞 サポート・連絡先

### 技術サポート
- **GitHub Issues**: [プロジェクトリポジトリ](https://github.com/jun-kg/WebSys)
- **ドキュメント**: このリポジトリの `docs/` 配下
- **BUG報告**: [不具合管理表](../08_報告/31_不具合管理表.md) 参照

### 貢献・フィードバック
- **改善提案**: [改善実装タスク管理表](../07_継続的改善/51_改善実装タスク管理表.md)
- **機能要望**: GitHub Issues
- **ドキュメント改善**: Pull Request歓迎

---

## 🔍 継続的改善プロセス

### 必須実施事項
機能の追加・改善を行う際は、必ず以下のプロセスを実施：

1. **事前チェック**: [53-機能追加改善チェックリスト.md](../07_継続的改善/53_機能追加改善チェックリスト.md)
2. **問題記録**: [52-継続的改善プロセス運用ガイドライン.md](../07_継続的改善/52_継続的改善プロセス運用ガイドライン.md)
3. **タスク管理**: [51-改善実装タスク管理表.md](../07_継続的改善/51_改善実装タスク管理表.md)
4. **品質確保**: ユーザビリティ・セキュリティ・パフォーマンス総合評価

### 水平展開チェック
BUG修正時は以下を必ずチェック：
- Prismaモデル名統一性
- テーブル名・リレーション名整合性
- 認証・権限チェック統一性
- エラーハンドリング統一性
- TypeScript型定義整合性
- APIルーティング順序
- フロントエンドAPIコール正確性

### 机上チェック（Desk Check）
エラー報告時の確認プロセス：
1. バックエンドログ確認（実際のエンドポイント動作）
2. フロントエンドコード確認（APIコール正確性）
3. ルーティング定義確認（エンドポイント存在確認）
4. 原因特定（実際のエラー vs ブラウザキャッシュ）

---

**🔄 このドキュメントは技術情報の単一真実源です**
**すべての技術仕様はこの文書を参照してください**
**矛盾を発見した場合は即座にご報告ください**
