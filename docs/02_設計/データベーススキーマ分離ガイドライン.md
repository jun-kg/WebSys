# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒåˆ†é›¢ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

## ğŸ“‹ ç›®æ¬¡
- [åŸºæœ¬æ–¹é‡](#åŸºæœ¬æ–¹é‡)
- [ã‚¹ã‚­ãƒ¼ãƒæ§‹é€ ](#ã‚¹ã‚­ãƒ¼ãƒæ§‹é€ )
- [ãƒ¢ãƒ‡ãƒ«åˆ†é¡ãƒ«ãƒ¼ãƒ«](#ãƒ¢ãƒ‡ãƒ«åˆ†é¡ãƒ«ãƒ¼ãƒ«)
- [ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†](#ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†)
- [äº’æ›æ€§ç¢ºèª](#äº’æ›æ€§ç¢ºèª)
- [ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹](#ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹)

---

## ğŸ—„ï¸ åŸºæœ¬æ–¹é‡

### ãªãœã‚³ãƒ¡ãƒ³ãƒˆãƒ™ãƒ¼ã‚¹åˆ†é›¢ã‹

Prismaã¯ç¾åœ¨ã€å˜ä¸€`schema.prisma`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹è¨­è¨ˆã§ã™ã€‚
è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®åˆ†å‰²ã¯å®Ÿé¨“çš„æ©Ÿèƒ½ã§ã‚ã‚Šã€å®‰å®šæ€§ã«æ¬ ã‘ã¾ã™ã€‚

ãã®ãŸã‚ã€æ¥­ç•Œæ¨™æº–ã®**ã‚³ãƒ¡ãƒ³ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã«ã‚ˆã‚‹è«–ç†çš„åˆ†é›¢**ã‚’æ¡ç”¨ã—ã¾ã™ã€‚

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… Prismaã®æ¨™æº–æ©Ÿèƒ½ã®ã¿ä½¿ç”¨ï¼ˆå®‰å®šæ€§ï¼‰
- âœ… è¦–è¦šçš„ã«æ˜ç¢ºãªåˆ†é›¢
- âœ… ãƒ„ãƒ¼ãƒ«ã«ã‚ˆã‚‹è‡ªå‹•å‡¦ç†ãŒå®¹æ˜“
- âœ… æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¸ã®é©ç”¨ãŒç°¡å˜

---

## ğŸ“‹ ã‚¹ã‚­ãƒ¼ãƒæ§‹é€ 

### æ¨å¥¨æ§‹é€ 

```prisma
// ============================================
// Prisma Configuration
// ============================================
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ğŸ”’ CORE MODELS (å…±é€šã‚³ã‚¢ - å¤‰æ›´ç¦æ­¢)
// ============================================
// ã‚·ã‚¹ãƒ†ãƒ åŸºç›¤ã¨ãªã‚‹ãƒ¢ãƒ‡ãƒ«ã€‚å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§å…±æœ‰ã€‚
// å¤‰æ›´ã¯å…±é€šãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ›´æ–°ã¨ã—ã¦æ‰±ã†ã€‚
//
// å¤‰æ›´æ™‚ã®å½±éŸ¿ç¯„å›²: å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
// å¤‰æ›´æ‰‹ç¶šã: ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»æ‰¿èªå¿…é ˆ

// --- Authentication & Authorization ---
model users {
  id                    Int       @id @default(autoincrement())
  username              String    @unique
  email                 String    @unique
  password              String
  name                  String
  companyId             Int
  primaryDepartmentId   Int?
  employeeCode          String?
  joinDate              DateTime?
  leaveDate             DateTime?
  role                  UserRole  @default(USER)
  isActive              Boolean   @default(true)
  lastLoginAt           DateTime?
  isFirstLogin          Boolean   @default(true)
  passwordResetToken    String?
  passwordResetExpiry   DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime

  // Relations
  companies             companies @relation(fields: [companyId], references: [id])
  departments           departments? @relation("PrimaryDepartment", fields: [primaryDepartmentId], references: [id])

  @@index([companyId])
  @@index([username])
  @@index([email])
}

model companies {
  id          Int       @id @default(autoincrement())
  name        String
  code        String    @unique
  address     String?
  phone       String?
  email       String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime

  // Relations
  users       users[]
  departments departments[]
}

// --- Audit & Logging ---
model audit_logs {
  id             Int       @id @default(autoincrement())
  userId         Int
  action         String
  targetType     String
  targetId       Int
  featureId      Int?
  oldPermissions Json?
  newPermissions Json?
  reason         String?
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime  @default(now())

  users          users     @relation(fields: [userId], references: [id])
  features       features? @relation(fields: [featureId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([createdAt(sort: Desc)])
}

model logs {
  id          Int       @id @default(autoincrement())
  timestamp   DateTime  @default(now())
  level       Int
  category    String
  source      String
  message     String
  userId      Int?
  companyId   Int?
  environment String    @default("development")
  metadata    Json?
  stackTrace  String?
  createdAt   DateTime  @default(now())

  users       users?    @relation(fields: [userId], references: [id])

  @@index([timestamp(sort: Desc)])
  @@index([level])
  @@index([category])
  @@index([userId])
}

// ============================================
// ğŸ”Œ EXTENSION MODELS (æ‹¡å¼µå¯èƒ½)
// ============================================
// ä¼æ¥­ãŒã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ãªãƒ¢ãƒ‡ãƒ«ã€‚
// ã‚«ãƒ©ãƒ è¿½åŠ ãƒ»ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ ã¯è¨±å¯ã€‚
// æ—¢å­˜ã‚«ãƒ©ãƒ ã®å¤‰æ›´ãƒ»å‰Šé™¤ã¯ç¦æ­¢ã€‚
//
// å¤‰æ›´æ™‚ã®å½±éŸ¿ç¯„å›²: å€‹åˆ¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã¿
// å¤‰æ›´æ‰‹ç¶šã: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã§è‡ªç”±

// æ‹¡å¼µãƒ¢ãƒ‡ãƒ«ã®ä¾‹ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
// --- Extended User Profiles ---
// model ext_user_profiles {
//   id                Int       @id @default(autoincrement())
//   userId            Int       @unique
//   birthDate         DateTime?
//   phoneNumber       String?
//   emergencyContact  String?
//   skills            String[]
//   certifications    Json?
//   createdAt         DateTime  @default(now())
//   updatedAt         DateTime
//
//   users             users     @relation(fields: [userId], references: [id])
// }

// ============================================
// ğŸ¢ CUSTOM MODELS (ä¼æ¥­å›ºæœ‰)
// ============================================
// å®Œå…¨ã«ä¼æ¥­ç‹¬è‡ªã®ãƒ¢ãƒ‡ãƒ«ã€‚è‡ªç”±ã«è¿½åŠ ãƒ»å¤‰æ›´å¯èƒ½ã€‚
//
// å¤‰æ›´æ™‚ã®å½±éŸ¿ç¯„å›²: å€‹åˆ¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã¿
// å¤‰æ›´æ‰‹ç¶šã: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã§è‡ªç”±

// --- Workflow Management ---
model workflow_types {
  id                    Int       @id @default(autoincrement())
  companyId             Int
  code                  String
  name                  String
  description           String?
  category              String
  formSchema            Json?
  validationRules       Json?
  autoApproveRules      Json?
  escalationRules       Json?
  notificationSettings  Json?
  maxAmount             Decimal?  @db.Decimal(15, 2)
  requireAttachment     Boolean   @default(false)
  allowBulk             Boolean   @default(false)
  isActive              Boolean   @default(true)
  displayOrder          Int       @default(0)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime
  createdBy             Int?
  updatedBy             Int?

  companies             companies @relation(fields: [companyId], references: [id])

  @@unique([companyId, code])
  @@index([companyId])
  @@index([category])
}

model workflow_requests {
  id                Int       @id @default(autoincrement())
  companyId         Int
  workflowTypeId    Int
  requesterId       Int
  requestNumber     String    @unique
  title             String
  description       String?
  formData          Json?
  status            String    @default("DRAFT")
  priority          String    @default("MEDIUM")
  currentStepNumber Int       @default(1)
  dueDate           DateTime?
  submittedAt       DateTime?
  completedAt       DateTime?
  cancelledAt       DateTime?
  cancelReason      String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime

  companies         companies @relation(fields: [companyId], references: [id])
  workflow_types    workflow_types @relation(fields: [workflowTypeId], references: [id])
  requester         users     @relation("WorkflowRequester", fields: [requesterId], references: [id])

  @@index([companyId])
  @@index([workflowTypeId])
  @@index([requesterId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
}

// --- Business Specific Models ---
// ä¼æ¥­å›ºæœ‰ã®æ¥­å‹™ãƒ¢ãƒ‡ãƒ«ã‚’ã“ã“ã«è¿½åŠ 
// ä¾‹:
// - å–¶æ¥­ç®¡ç†: sales_orders, sales_items, customers
// - åœ¨åº«ç®¡ç†: inventory_items, warehouses, stock_movements
// - é¡§å®¢ç®¡ç†: customers, customer_contacts, customer_notes
```

---

## ğŸ·ï¸ ãƒ¢ãƒ‡ãƒ«åˆ†é¡ãƒ«ãƒ¼ãƒ«

### ğŸ”’ å…±é€šã‚³ã‚¢ãƒ¢ãƒ‡ãƒ«ï¼ˆCORE MODELSï¼‰

**è­˜åˆ¥æ–¹æ³•**: ã‚³ãƒ¡ãƒ³ãƒˆåŒºç”» `// ğŸ”’ CORE MODELS` å†…ã«é…ç½®

**å¯¾è±¡ãƒ†ãƒ¼ãƒ–ãƒ«**:

| ã‚«ãƒ†ã‚´ãƒª | ãƒ†ãƒ¼ãƒ–ãƒ« |
|---------|---------|
| èªè¨¼ãƒ»æ¨©é™ | users, companies, departments, user_departments, user_sessions |
| æ¨©é™ç®¡ç† | features, department_permissions, permission_templates, permission_template_features, permission_inheritance_rules |
| ç›£æŸ» | audit_logs |
| ãƒ­ã‚°ç›£è¦– | logs, log_statistics, alert_rules |
| é€šçŸ¥ | notifications |

**å¤‰æ›´ãƒ«ãƒ¼ãƒ«**:

| æ“ä½œ | å¯å¦ | èª¬æ˜ |
|-----|------|------|
| ã‚«ãƒ©ãƒ å‰Šé™¤ | âŒ ç¦æ­¢ | æ—¢å­˜æ©Ÿèƒ½ãŒå‹•ä½œã—ãªããªã‚‹ |
| ã‚«ãƒ©ãƒ å‹å¤‰æ›´ | âŒ ç¦æ­¢ | ãƒ‡ãƒ¼ã‚¿äº’æ›æ€§ãŒå¤±ã‚ã‚Œã‚‹ |
| ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‰Šé™¤ | âŒ ç¦æ­¢ | æ—¢å­˜æ©Ÿèƒ½ãŒå‹•ä½œã—ãªããªã‚‹ |
| NOT NULLè¿½åŠ  | âŒ ç¦æ­¢ | æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«å½±éŸ¿ |
| ã‚«ãƒ©ãƒ è¿½åŠ ï¼ˆOptionalï¼‰ | âœ… è¨±å¯ | æ—¢å­˜æ©Ÿèƒ½ã«å½±éŸ¿ãªã— |
| ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ  | âœ… è¨±å¯ | ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ |
| ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ  | âœ… è¨±å¯ | ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ”¹å–„ |

**å¤‰æ›´æ‰‹ç¶šã**:
1. ææ¡ˆ â†’ ãƒãƒ¼ãƒ ãƒ¬ãƒ“ãƒ¥ãƒ¼ â†’ æ‰¿èª
2. `templates/backend/prisma/schema.prisma` æ›´æ–°
3. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆãƒ»ãƒ†ã‚¹ãƒˆ
4. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°
5. å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¸ã®é€šçŸ¥ãƒ»é©ç”¨ã‚¬ã‚¤ãƒ‰ä½œæˆ

### ğŸ”Œ æ‹¡å¼µå¯èƒ½ãƒ¢ãƒ‡ãƒ«ï¼ˆEXTENSION MODELSï¼‰

**è­˜åˆ¥æ–¹æ³•**: ã‚³ãƒ¡ãƒ³ãƒˆåŒºç”» `// ğŸ”Œ EXTENSION MODELS` å†…ã«é…ç½®

**æ¨å¥¨ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹**: `ext_` ï¼ˆä»»æ„ã ãŒæ¨å¥¨ï¼‰

**å¤‰æ›´ãƒ«ãƒ¼ãƒ«**:
- âœ… æ–°è¦ãƒ¢ãƒ‡ãƒ«è¿½åŠ è‡ªç”±
- âœ… ã‚«ãƒ©ãƒ è¿½åŠ è‡ªç”±
- âœ… å…±é€šã‚³ã‚¢ãƒ¢ãƒ‡ãƒ«ã¸ã®ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ å¯èƒ½
- âŒ å…±é€šã‚³ã‚¢ãƒ¢ãƒ‡ãƒ«ã®æ—¢å­˜ã‚«ãƒ©ãƒ å¤‰æ›´ç¦æ­¢

**ä½¿ç”¨ä¾‹**:
```prisma
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ‹¡å¼µ
model ext_user_profiles {
  id                Int       @id @default(autoincrement())
  userId            Int       @unique
  birthDate         DateTime?
  skills            String[]
  users             users     @relation(fields: [userId], references: [id])
}

// éƒ¨ç½²æ‹¡å¼µ
model ext_department_budgets {
  id                Int       @id @default(autoincrement())
  departmentId      Int       @unique
  annualBudget      Decimal   @db.Decimal(15, 2)
  departments       departments @relation(fields: [departmentId], references: [id])
}
```

### ğŸ¢ ä¼æ¥­å›ºæœ‰ãƒ¢ãƒ‡ãƒ«ï¼ˆCUSTOM MODELSï¼‰

**è­˜åˆ¥æ–¹æ³•**: ã‚³ãƒ¡ãƒ³ãƒˆåŒºç”» `// ğŸ¢ CUSTOM MODELS` å†…ã«é…ç½®

**å¤‰æ›´ãƒ«ãƒ¼ãƒ«**:
- âœ… å®Œå…¨ã«è‡ªç”±
- âœ… ãƒ¢ãƒ‡ãƒ«è¿½åŠ ãƒ»å‰Šé™¤ãƒ»å¤‰æ›´ã™ã¹ã¦å¯èƒ½
- âœ… å‘½åè¦å‰‡ã‚‚ä¼æ¥­ã®è‡ªç”±ï¼ˆãŸã ã—Prismaè¦ç´„ã¯æ¨å¥¨ï¼‰

**ä½¿ç”¨ä¾‹**:
```prisma
// ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç®¡ç†
model workflow_types { ... }
model workflow_requests { ... }
model approval_routes { ... }

// å–¶æ¥­ç®¡ç†
model sales_orders { ... }
model sales_items { ... }
model customers { ... }
```

---

## ğŸ”„ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†

### å…±é€šã‚³ã‚¢ãƒ¢ãƒ‡ãƒ«å¤‰æ›´æ™‚

```bash
# 1. templates ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§å®Ÿæ–½
cd /path/to/websys/backend
npx prisma migrate dev --name core_update_users_add_column

# 2. å¤‰æ›´å†…å®¹ã‚’ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–
echo "Added optional 'nickname' column to users table" >> CHANGELOG.md

# 3. å„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«é©ç”¨æ‰‹é †ã‚’é€šçŸ¥
# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹ã‹ã€ä»¥ä¸‹ã‚’å®Ÿè¡Œ
cd /path/to/project/backend
npx prisma migrate deploy
```

### ä¼æ¥­å›ºæœ‰ãƒ¢ãƒ‡ãƒ«å¤‰æ›´æ™‚

```bash
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ç›´æ¥å®Ÿæ–½
cd /path/to/project/backend
npx prisma migrate dev --name custom_add_workflow_feature

# ãƒãƒ¼ãƒ å†…ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾Œã«ãƒ‡ãƒ—ãƒ­ã‚¤
npx prisma migrate deploy
```

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‘½åè¦å‰‡

| å¤‰æ›´ã‚¿ã‚¤ãƒ— | ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ | ä¾‹ |
|----------|--------------|---|
| å…±é€šã‚³ã‚¢ | `core_` | `core_add_users_nickname` |
| æ‹¡å¼µ | `ext_` | `ext_add_user_profiles` |
| ä¼æ¥­å›ºæœ‰ | `custom_` | `custom_add_workflow_types` |
| ãƒã‚°ä¿®æ­£ | `fix_` | `fix_users_email_constraint` |

---

## ğŸ” äº’æ›æ€§ç¢ºèª

### å…±é€šãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ›´æ–°æ™‚ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

#### å¿…é ˆãƒã‚§ãƒƒã‚¯é …ç›®

- [ ] **ã‚«ãƒ©ãƒ å‰Šé™¤ãƒã‚§ãƒƒã‚¯**: æ—¢å­˜ã‚«ãƒ©ãƒ ãŒå‰Šé™¤ã•ã‚Œã¦ã„ãªã„ã‹
  ```bash
  git diff HEAD^ HEAD -- prisma/schema.prisma | grep "^-" | grep -v "^---"
  ```

- [ ] **å‹å¤‰æ›´ãƒã‚§ãƒƒã‚¯**: æ—¢å­˜ã‚«ãƒ©ãƒ ã®å‹ãŒå¤‰æ›´ã•ã‚Œã¦ã„ãªã„ã‹
  ```bash
  git diff HEAD^ HEAD -- prisma/schema.prisma | grep -E "^\+.*: .* @|^-.*: .* @"
  ```

- [ ] **ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‰Šé™¤ãƒã‚§ãƒƒã‚¯**: æ—¢å­˜ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå‰Šé™¤ã•ã‚Œã¦ã„ãªã„ã‹

- [ ] **NOT NULLåˆ¶ç´„ãƒã‚§ãƒƒã‚¯**: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«å½±éŸ¿ã™ã‚‹NOT NULLåˆ¶ç´„ãŒè¿½åŠ ã•ã‚Œã¦ã„ãªã„ã‹
  ```bash
  git diff HEAD^ HEAD -- prisma/schema.prisma | grep "^\+" | grep -v "?" | grep -v "@default"
  ```

- [ ] **ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ãƒã‚§ãƒƒã‚¯**: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«å½±éŸ¿ã™ã‚‹ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ãŒè¿½åŠ ã•ã‚Œã¦ã„ãªã„ã‹

- [ ] **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãƒã‚§ãƒƒã‚¯**: æ—¢å­˜ã‚«ãƒ©ãƒ ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒå¤‰æ›´ã•ã‚Œã¦ã„ãªã„ã‹

#### æ¨å¥¨ãƒã‚§ãƒƒã‚¯é …ç›®

- [ ] **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ **: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒé©åˆ‡ã‹
- [ ] **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ**: ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§æ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‹
- [ ] **ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ**: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå¯èƒ½ã‹
- [ ] **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°**: å¤‰æ›´å†…å®¹ãŒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«åæ˜ ã•ã‚Œã¦ã„ã‚‹ã‹

### è‡ªå‹•ãƒã‚§ãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```bash
#!/bin/bash
# schema-compatibility-check.sh

echo "=== Prisma Schema äº’æ›æ€§ãƒã‚§ãƒƒã‚¯ ==="

# ã‚«ãƒ©ãƒ å‰Šé™¤ãƒã‚§ãƒƒã‚¯
DELETED_COLUMNS=$(git diff HEAD^ HEAD -- prisma/schema.prisma | grep "^-" | grep -v "^---" | grep -v "^-//" | wc -l)
if [ $DELETED_COLUMNS -gt 0 ]; then
  echo "âš ï¸  è­¦å‘Š: ã‚«ãƒ©ãƒ ã¾ãŸã¯ãƒ¢ãƒ‡ãƒ«ã®å‰Šé™¤ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
  git diff HEAD^ HEAD -- prisma/schema.prisma | grep "^-" | grep -v "^---" | grep -v "^-//"
fi

# NOT NULLåˆ¶ç´„ãƒã‚§ãƒƒã‚¯
NOT_NULL_ADDITIONS=$(git diff HEAD^ HEAD -- prisma/schema.prisma | grep "^\+" | grep -v "?" | grep -v "@default" | grep -v "^+++" | grep -v "^+//" | wc -l)
if [ $NOT_NULL_ADDITIONS -gt 0 ]; then
  echo "âš ï¸  è­¦å‘Š: NOT NULLåˆ¶ç´„ã®è¿½åŠ ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
fi

echo "âœ… ãƒã‚§ãƒƒã‚¯å®Œäº†"
```

---

## ğŸ›¡ï¸ ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### âœ… æ¨å¥¨

1. **æ˜ç¢ºãªã‚³ãƒ¡ãƒ³ãƒˆåŒºç”»**
   ```prisma
   // ============================================
   // ğŸ”’ CORE MODELS (å…±é€šã‚³ã‚¢ - å¤‰æ›´ç¦æ­¢)
   // ============================================
   ```

2. **èª¬æ˜ã‚³ãƒ¡ãƒ³ãƒˆ**
   ```prisma
   // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’ç®¡ç†
   // å…¨ã‚·ã‚¹ãƒ†ãƒ ã®èªè¨¼åŸºç›¤ã¨ãªã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«
   model users {
     // ...
   }
   ```

3. **å‘½åè¦å‰‡çµ±ä¸€**
   - ãƒ†ãƒ¼ãƒ–ãƒ«å: è¤‡æ•°å½¢ãƒ»å°æ–‡å­—ãƒ»ã‚¹ãƒãƒ¼ã‚¯ã‚±ãƒ¼ã‚¹ï¼ˆ`users`, `workflow_types`ï¼‰
   - ã‚«ãƒ©ãƒ å: ã‚­ãƒ£ãƒ¡ãƒ«ã‚±ãƒ¼ã‚¹ï¼ˆ`firstName`, `createdAt`ï¼‰
   - ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å: æ˜ç¤ºçš„ã«æŒ‡å®šï¼ˆ`@relation("WorkflowRequester")`ï¼‰

4. **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆ**
   ```prisma
   model users {
     // ...
     @@index([companyId])          // ä¼æ¥­åˆ¥æ¤œç´¢
     @@index([email])              // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ¤œç´¢
     @@index([createdAt(sort: Desc)]) // æœ€æ–°é †ã‚½ãƒ¼ãƒˆ
   }
   ```

### âŒ é¿ã‘ã‚‹ã¹ã

1. **ã‚»ã‚¯ã‚·ãƒ§ãƒ³åŒºç”»ã‚’ç„¡è¦–ã—ãŸé…ç½®**
   ```prisma
   // ğŸ”’ CORE MODELS
   model users { ... }

   model sales_orders { ... }  // âŒ ä¼æ¥­å›ºæœ‰ãƒ¢ãƒ‡ãƒ«ãŒæ··åœ¨

   model companies { ... }
   ```

2. **æœªä½¿ç”¨ãƒ¢ãƒ‡ãƒ«ã®æ”¾ç½®**
   ```prisma
   // âŒ ä½¿ç”¨ã—ã¦ã„ãªã„ãƒ¢ãƒ‡ãƒ«ã¯å‰Šé™¤ã™ã¹ã
   model deprecated_old_users { ... }
   ```

3. **ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åã®çœç•¥**
   ```prisma
   // âŒ é¿ã‘ã‚‹ã¹ã
   model workflow_requests {
     requesterId Int
     users       users @relation(fields: [requesterId], references: [id])
   }

   // âœ… æ¨å¥¨
   model workflow_requests {
     requesterId Int
     requester   users @relation("WorkflowRequester", fields: [requesterId], references: [id])
   }
   ```

---

## ğŸ“– å®Ÿä¾‹

### è‰¯ã„ä¾‹: ä¼æ¥­å›ºæœ‰ãƒ¢ãƒ‡ãƒ«ã®è¿½åŠ 

```prisma
// ============================================
// ğŸ¢ CUSTOM MODELS (ä¼æ¥­å›ºæœ‰)
// ============================================

// --- Sales Management ---
// å–¶æ¥­æ¡ˆä»¶ç®¡ç†
model sales_opportunities {
  id                Int       @id @default(autoincrement())
  companyId         Int
  salesRepId        Int       // æ‹…å½“å–¶æ¥­
  customerName      String
  estimatedAmount   Decimal   @db.Decimal(15, 2)
  probability       Int       // æˆç´„ç¢ºåº¦ (0-100%)
  stage             String    // å•†è«‡ã‚¹ãƒ†ãƒ¼ã‚¸
  expectedCloseDate DateTime?
  actualCloseDate   DateTime?
  status            String    @default("OPEN")
  createdAt         DateTime  @default(now())
  updatedAt         DateTime

  // Relations
  companies         companies @relation(fields: [companyId], references: [id])
  salesRep          users     @relation("SalesRepresentative", fields: [salesRepId], references: [id])

  @@index([companyId])
  @@index([salesRepId])
  @@index([status])
  @@index([expectedCloseDate])
}
```

**è‰¯ã„ç‚¹**:
- âœ… é©åˆ‡ãªã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆCUSTOM MODELSï¼‰ã«é…ç½®
- âœ… èª¬æ˜ã‚³ãƒ¡ãƒ³ãƒˆã‚ã‚Š
- âœ… æ˜ç¤ºçš„ãªãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åï¼ˆ`"SalesRepresentative"`ï¼‰
- âœ… é©åˆ‡ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆ
- âœ… å…±é€šã‚³ã‚¢ãƒ¢ãƒ‡ãƒ«ï¼ˆcompanies, usersï¼‰ã‚’æ´»ç”¨

### æ‚ªã„ä¾‹: å…±é€šã‚³ã‚¢ãƒ¢ãƒ‡ãƒ«ã®ç ´å£Šçš„å¤‰æ›´

```prisma
// ============================================
// ğŸ”’ CORE MODELS (å…±é€šã‚³ã‚¢ - å¤‰æ›´ç¦æ­¢)
// ============================================

model users {
  id        Int      @id @default(autoincrement())
  username  String   // âŒ @unique ã‚’å‰Šé™¤ â†’ æ—¢å­˜æ©Ÿèƒ½ã«å½±éŸ¿
  email     String   // âŒ @unique ã‚’å‰Šé™¤ â†’ ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãŒå´©ã‚Œã‚‹
  name      String   // âŒ String â†’ String? ã«å¤‰æ›´ â†’ æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã§ã‚¨ãƒ©ãƒ¼
  role      UserRole // âŒ å‹ã‚’å‰Šé™¤
  // âŒ password ã‚«ãƒ©ãƒ ã‚’å‰Šé™¤ â†’ èªè¨¼æ©Ÿèƒ½ãŒå‹•ä½œã—ãªããªã‚‹
}
```

**å•é¡Œç‚¹**:
- âŒ æ—¢å­˜ã‚«ãƒ©ãƒ ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ã‚’å‰Šé™¤
- âŒ æ—¢å­˜ã‚«ãƒ©ãƒ ã‚’ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ã«å¤‰æ›´
- âŒ å¿…é ˆã‚«ãƒ©ãƒ ã‚’å‰Šé™¤
- âŒ å‹å®šç¾©ã‚’å‰Šé™¤

---

## ğŸ“ å¤‰æ›´ç®¡ç†ãƒ•ãƒ­ãƒ¼

### å…±é€šã‚³ã‚¢ãƒ¢ãƒ‡ãƒ«å¤‰æ›´ãƒ•ãƒ­ãƒ¼

```mermaid
graph TD
    A[å¤‰æ›´ææ¡ˆ] --> B{å½±éŸ¿ç¯„å›²ç¢ºèª}
    B -->|äº’æ›æ€§ã‚ã‚Š| C[ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼]
    B -->|äº’æ›æ€§ãªã—| D[å†è¨­è¨ˆ]
    C --> E{æ‰¿èª}
    E -->|æ‰¿èª| F[templatesæ›´æ–°]
    E -->|å·®ã—æˆ»ã—| D
    F --> G[ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆ]
    G --> H[ãƒ†ã‚¹ãƒˆç’°å¢ƒæ¤œè¨¼]
    H --> I[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°]
    I --> J[å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé€šçŸ¥]
    J --> K[é©ç”¨ã‚¬ã‚¤ãƒ‰ä½œæˆ]
```

### ä¼æ¥­å›ºæœ‰ãƒ¢ãƒ‡ãƒ«å¤‰æ›´ãƒ•ãƒ­ãƒ¼

```mermaid
graph TD
    A[å¤‰æ›´å®Ÿæ–½] --> B[ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆ]
    B --> C[ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ]
    C --> D{å•é¡Œãªã—?}
    D -->|ã¯ã„| E[ãƒãƒ¼ãƒ å†…ãƒ¬ãƒ“ãƒ¥ãƒ¼]
    D -->|ã„ã„ãˆ| F[ä¿®æ­£]
    F --> B
    E --> G[æœ¬ç•ªé©ç”¨]
```

---

## ğŸ”— é–¢é€£ãƒªãƒ³ã‚¯

- [Prismaå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://www.prisma.io/docs)
- [Prismaãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¬ã‚¤ãƒ‰](https://www.prisma.io/docs/concepts/components/prisma-migrate)
- [PostgreSQLå‘½åè¦å‰‡](https://www.postgresql.org/docs/current/sql-syntax-lexical.html#SQL-SYNTAX-IDENTIFIERS)

---

## ğŸ“Š å®Ÿæ–½çŠ¶æ³

### workspace/backend/prisma/schema.prisma

**å®Ÿæ–½æ—¥**: 2025-10-03

**å®Ÿæ–½å†…å®¹**:
- âœ… 31ãƒ¢ãƒ‡ãƒ«ã‚’3å±¤ã«åˆ†é¡ãƒ»æ•´ç†å®Œäº†
- âœ… ã‚³ãƒ¡ãƒ³ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã«ã‚ˆã‚‹è«–ç†çš„åˆ†é›¢å®Ÿè£…
- âœ… Prismaæ¤œè¨¼å®Œäº†ï¼ˆ`npx prisma validate`ï¼‰

**åˆ†é¡çµæœ**:

| å±¤ | ãƒ¢ãƒ‡ãƒ«æ•° | ä¸»è¦ãƒ¢ãƒ‡ãƒ« |
|---|---------|----------|
| ğŸ”’ CORE MODELS | 22ãƒ¢ãƒ‡ãƒ« | users, companies, departments, features, audit_logs, logs, refresh_tokens |
| ğŸ”Œ EXTENSION MODELS | 0ãƒ¢ãƒ‡ãƒ« | ï¼ˆä»Šå¾Œã®æ‹¡å¼µç”¨ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼‰ |
| ğŸ¢ CUSTOM MODELS | 9ãƒ¢ãƒ‡ãƒ« | workflow_types, workflow_requests, approval_routes, approval_history |

**ã‚»ã‚¯ã‚·ãƒ§ãƒ³æ§‹æˆ**:

```
ğŸ”’ CORE MODELS
â”œâ”€â”€ Authentication & Authorization (5ãƒ¢ãƒ‡ãƒ«)
â”‚   â””â”€â”€ users, companies, departments, user_departments, user_sessions
â”œâ”€â”€ Permission Management (RBAC) (6ãƒ¢ãƒ‡ãƒ«)
â”‚   â””â”€â”€ features, department_feature_permissions, permission_templates, etc.
â”œâ”€â”€ Audit & Logging (4ãƒ¢ãƒ‡ãƒ«)
â”‚   â””â”€â”€ audit_logs, logs, log_categories, log_statistics, alert_rules
â”œâ”€â”€ Messaging & Notifications (2ãƒ¢ãƒ‡ãƒ«)
â”‚   â””â”€â”€ message_definitions, system_messages
â””â”€â”€ Security (4ãƒ¢ãƒ‡ãƒ«)
    â””â”€â”€ refresh_tokens, security_events, login_attempts, security_settings

ğŸ”Œ EXTENSION MODELS
â””â”€â”€ ï¼ˆç©º - ä»Šå¾Œã®æ‹¡å¼µç”¨ï¼‰

ğŸ¢ CUSTOM MODELS
â””â”€â”€ Workflow Management (9ãƒ¢ãƒ‡ãƒ«)
    â””â”€â”€ workflow_types, workflow_requests, approval_routes, approval_history,
        approval_delegates, workflow_notifications, workflow_attachments,
        auto_approval_rules, auto_approval_logs
```

**åŠ¹æœ**:
- âœ… ã‚¹ã‚­ãƒ¼ãƒã®å¯èª­æ€§å‘ä¸Š
- âœ… å…±é€šæ©Ÿèƒ½ã¨ä¼æ¥­å›ºæœ‰æ©Ÿèƒ½ã®æ˜ç¢ºãªåˆ†é›¢
- âœ… å°†æ¥ã®æ‹¡å¼µæ€§ç¢ºä¿
- âœ… ãƒãƒ¼ãƒ é–“ã§ã®ç†è§£çµ±ä¸€

---

*æœ€çµ‚æ›´æ–°: 2025-10-03*
