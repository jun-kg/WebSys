# 企業向けフォルダ構成実装サンプル

## 実装例: Company-A向けカスタマイズ

### フォルダ構成
```
websys-enterprise-company-a/
├── 📦 packages/
│   ├── websys-core/               # 🔒 コア機能（変更不可）
│   │   ├── auth/
│   │   │   ├── jwt.service.ts
│   │   │   ├── session.manager.ts
│   │   │   └── security.middleware.ts
│   │   ├── audit/
│   │   │   ├── audit.logger.ts
│   │   │   └── compliance.service.ts
│   │   └── package.json           # readonly: true
│   ├── websys-platform/           # 🔧 プラットフォーム（拡張可能）
│   │   ├── workflow/
│   │   │   ├── base.workflow.ts   # 基盤クラス
│   │   │   └── interfaces.ts      # 拡張インターフェース
│   │   ├── permissions/
│   │   │   ├── rbac.service.ts
│   │   │   └── extensions/        # 拡張ポイント
│   │   └── package.json
│   ├── websys-ui/                 # 🎨 UI（テーマ可能）
│   │   ├── components/
│   │   │   ├── base/
│   │   │   └── themes/
│   │   ├── layouts/
│   │   └── package.json
│   └── company-a-custom/          # ✨ 企業カスタマイズ
│       ├── workflows/
│       │   ├── approval.workflow.ts
│       │   └── purchase.workflow.ts
│       ├── components/
│       │   ├── CompanyHeader.vue
│       │   └── CustomDashboard.vue
│       ├── integrations/
│       │   ├── erp-connector.ts
│       │   └── hr-system.ts
│       ├── themes/
│       │   ├── company-a.scss
│       │   └── variables.scss
│       ├── config/
│       │   ├── features.json
│       │   └── branding.json
│       └── package.json
├── 🔧 tools/
│   ├── build-guardian.ts          # ビルド制御
│   ├── permission-checker.ts      # 権限チェック
│   └── deployment.scripts/
└── 📋 config/
    ├── base.config.json
    ├── company-a.config.json
    └── production.config.json
```

### 実装サンプル

#### 1. 企業カスタムワークフロー
```typescript
// packages/company-a-custom/workflows/approval.workflow.ts
import { BaseWorkflow, WorkflowStep } from '@websys/platform/workflow';

export class CompanyAApprovalWorkflow extends BaseWorkflow {
  constructor() {
    super('company-a-approval', '1.0.0');
  }

  protected defineSteps(): WorkflowStep[] {
    return [
      {
        id: 'department-approval',
        name: '部署承認',
        handler: this.departmentApproval.bind(this),
        condition: (context) => context.amount > 10000
      },
      {
        id: 'executive-approval',
        name: '役員承認',
        handler: this.executiveApproval.bind(this),
        condition: (context) => context.amount > 100000
      }
    ];
  }

  private async departmentApproval(context: any) {
    // Company-A固有の部署承認ロジック
    await this.notifyDepartmentManager(context);
  }

  private async executiveApproval(context: any) {
    // Company-A固有の役員承認ロジック
    await this.escalateToExecutive(context);
  }
}
```

#### 2. 企業ブランディング設定
```json
// packages/company-a-custom/config/branding.json
{
  "companyId": "company-a",
  "name": "Company A Corporation",
  "branding": {
    "logo": {
      "main": "/assets/company-a/logo-main.svg",
      "icon": "/assets/company-a/logo-icon.svg",
      "white": "/assets/company-a/logo-white.svg"
    },
    "colors": {
      "primary": "#2B5D8C",
      "secondary": "#4A90B8",
      "accent": "#F0A500",
      "background": "#F8F9FA"
    },
    "fonts": {
      "primary": "Noto Sans JP",
      "secondary": "Arial"
    }
  },
  "customization": {
    "header": {
      "showCompanyName": true,
      "showLogo": true,
      "customLinks": [
        { "name": "社内ポータル", "url": "https://portal.company-a.com" },
        { "name": "ヘルプデスク", "url": "https://help.company-a.com" }
      ]
    }
  }
}
```

#### 3. 機能有効化設定
```json
// packages/company-a-custom/config/features.json
{
  "core": {
    "auth": {
      "enabled": true,
      "readonly": true,
      "sso": {
        "provider": "okta",
        "domain": "company-a.okta.com"
      }
    },
    "audit": {
      "enabled": true,
      "readonly": true,
      "retention": "7years"
    }
  },
  "platform": {
    "workflow": {
      "enabled": true,
      "customizations": [
        "company-a-approval",
        "purchase-approval"
      ]
    },
    "notifications": {
      "enabled": true,
      "channels": ["email", "slack", "teams"]
    }
  },
  "custom": {
    "erp-integration": {
      "enabled": true,
      "system": "SAP",
      "endpoint": "https://erp.company-a.com/api"
    },
    "custom-dashboard": {
      "enabled": true,
      "widgets": ["sales", "hr", "finance"]
    }
  }
}
```

#### 4. ビルド制御スクリプト
```typescript
// tools/build-guardian.ts
import { ProtectionLevel, BuildConfig } from '@websys/core';

export class BuildGuardian {
  private readonly protectedPaths = [
    'packages/websys-core/**/*',
    'packages/websys-platform/auth/**/*',
    'packages/websys-platform/audit/**/*'
  ];

  validateBuild(config: BuildConfig): void {
    this.checkCoreIntegrity();
    this.validateCustomizations(config);
    this.verifyPermissions(config);
  }

  private checkCoreIntegrity(): void {
    // コアファイルの改ざんチェック
    for (const path of this.protectedPaths) {
      if (this.isModified(path)) {
        throw new Error(`Core file modification detected: ${path}`);
      }
    }
  }

  private validateCustomizations(config: BuildConfig): void {
    // カスタマイズの妥当性チェック
    const customizations = config.custom;
    for (const [key, value] of Object.entries(customizations)) {
      if (!this.isAllowedCustomization(key, value)) {
        throw new Error(`Invalid customization: ${key}`);
      }
    }
  }
}
```

#### 5. デプロイメント設定
```yaml
# config/deployment.yml
apiVersion: v1
kind: ConfigMap
metadata:
  name: websys-enterprise-company-a
data:
  # 企業固有の環境変数
  COMPANY_ID: "company-a"
  BRANDING_CONFIG: "company-a-branding"
  CUSTOM_FEATURES: "company-a-features"

  # 保護されたコア設定
  CORE_AUTH_READONLY: "true"
  CORE_AUDIT_READONLY: "true"

  # カスタマイズ可能な設定
  WORKFLOW_CUSTOM_PATH: "/custom/workflows"
  UI_THEME_PATH: "/custom/themes"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: websys-enterprise-company-a
spec:
  replicas: 3
  template:
    spec:
      containers:
      - name: websys-app
        image: websys/enterprise:company-a-v1.0.0
        env:
        - name: COMPANY_CONFIG
          valueFrom:
            configMapKeyRef:
              name: websys-enterprise-company-a
              key: COMPANY_ID
```

### 開発フロー

#### 1. 企業カスタマイズ開発
```bash
# 企業プロジェクトのセットアップ
npm create @websys/enterprise company-a

# 開発環境起動
cd websys-enterprise-company-a
npm run dev:custom

# カスタムコンポーネント作成
npm run generate:component CustomDashboard --company company-a

# ビルド（保護チェック付き）
npm run build:protected

# デプロイ
npm run deploy:company-a
```

#### 2. 保護機能の検証
```bash
# コア機能の変更を試行（エラーになる）
npm run test:protection

# カスタマイズ範囲の確認
npm run validate:customization

# 企業固有設定の検証
npm run test:company-config
```

### 運用フロー

#### 1. アップデート
```bash
# コア機能のアップデート（自動）
npm run update:core  # 1.0.0 -> 1.0.1

# プラットフォーム機能のアップデート（選択可能）
npm run update:platform --version 1.2.0

# カスタマイズの互換性チェック
npm run check:compatibility
```

#### 2. 監視
```bash
# 保護機能の監視
npm run monitor:protection

# カスタマイズの健全性チェック
npm run health:custom

# 企業設定の整合性確認
npm run verify:config
```

## 利点

### ✅ **明確な責任分界**
- **開発者**: どこを変更できるか一目で分かる
- **運用者**: 何が保護されているか把握できる
- **企業**: カスタマイズ範囲が明確

### ✅ **安全性**
- コア機能の意図しない変更を防止
- ビルド時に自動チェック
- デプロイ時に整合性確認

### ✅ **保守性**
- アップデート時の影響範囲が明確
- カスタマイズの切り分けが容易
- 問題発生時の切り分けが迅速

### ✅ **拡張性**
- 企業固有機能の追加が容易
- 既存機能への影響なし
- 段階的なカスタマイズが可能