# システムアーキテクチャ

## 概要

WebSys開発プラットフォームは、モダンな3層アーキテクチャを採用した社内システム開発基盤です。Docker化により一貫した開発・デプロイ体験を提供し、複数環境での運用を支援します。

## 全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                    WebSys Development Platform              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │  Frontend   │────│   Backend   │────│  PostgreSQL │     │
│  │  (Vue.js)   │    │  (Express)  │    │     DB      │     │
│  │  Port: 3000 │    │  Port: 8000 │    │  Port: 5432 │     │
│  └─────────────┘    └─────────────┘    └─────────────┘     │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                    Docker Network Layer                     │
├─────────────────────────────────────────────────────────────┤
│                     Host Environment                        │
└─────────────────────────────────────────────────────────────┘
```

## 技術スタック

### フロントエンド層
- **フレームワーク**: Vue.js 3.4+ (Composition API)
- **UIライブラリ**: Element Plus 2.5+
- **言語**: TypeScript 5.3+
- **ビルドツール**: Vite 5.0+
- **状態管理**: Pinia 2.1+
- **ルーティング**: Vue Router 4.2+
- **HTTPクライアント**: Axios 1.6+

### バックエンド層
- **ランタイム**: Node.js 18+ (Alpine Linux)
- **フレームワーク**: Express 4.18+
- **言語**: TypeScript 5.3+
- **ORM**: Prisma 5.8+
- **認証**: JWT (jsonwebtoken 9.0+)
- **バリデーション**: express-validator 7.0+
- **セキュリティ**: bcryptjs 2.4+
- **ログ**: morgan 1.10+

### データベース層
- **RDBMS**: PostgreSQL 15 (Alpine)
- **接続プール**: Prisma Connection Pool
- **マイグレーション**: Prisma Migrate
- **バックアップ**: Docker Volume

### インフラ層
- **コンテナ**: Docker 20.10+
- **オーケストレーション**: Docker Compose 2.0+
- **ネットワーク**: Bridge Network
- **ストレージ**: Named Volumes
- **環境管理**: Environment-specific configs

## コンポーネント詳細

### Frontend (Vue.js + Element Plus)

#### 構成
```
frontend/
├── src/
│   ├── main.ts              # アプリケーションエントリーポイント
│   ├── App.vue              # ルートコンポーネント
│   ├── components/          # 再利用可能コンポーネント
│   ├── views/               # ページコンポーネント
│   │   ├── Layout.vue       # レイアウトコンポーネント
│   │   ├── Login.vue        # ログイン画面
│   │   ├── Dashboard.vue    # ダッシュボード
│   │   └── Users.vue        # ユーザー管理
│   ├── router/              # ルーティング設定
│   ├── stores/              # 状態管理 (Pinia)
│   ├── api/                 # API通信層
│   └── assets/              # 静的資源
├── public/                  # 公開ファイル
├── package.json             # 依存関係定義
├── vite.config.ts           # Vite設定
├── tsconfig.json            # TypeScript設定
└── index.html               # HTMLテンプレート
```

#### 特徴
- **自動インポート**: Element Plus コンポーネントの自動インポート
- **TypeScript**: 完全な型安全性
- **ホットリロード**: 開発時の高速リロード
- **プロキシ設定**: API呼び出しの透過的プロキシ
- **レスポンシブ**: モバイル対応UI

### Backend (Express + Prisma)

#### 構成
```
backend/
├── src/
│   ├── index.ts             # サーバーエントリーポイント
│   ├── routes/              # APIルート定義
│   │   ├── auth.ts          # 認証関連API
│   │   └── users.ts         # ユーザー管理API
│   ├── middleware/          # ミドルウェア
│   │   ├── auth.ts          # 認証ミドルウェア
│   │   └── errorHandler.ts # エラーハンドリング
│   ├── controllers/         # コントローラー層
│   ├── services/            # ビジネスロジック層
│   └── utils/               # ユーティリティ
├── prisma/
│   └── schema.prisma        # データベーススキーマ
├── package.json             # 依存関係定義
└── tsconfig.json            # TypeScript設定
```

#### 特徴
- **RESTful API**: 標準的なREST API設計
- **JWT認証**: トークンベース認証
- **型安全ORM**: Prismaによる型安全なDB操作
- **バリデーション**: 入力データの厳密な検証
- **エラーハンドリング**: 統一されたエラー処理
- **セキュリティ**: CORS, Rate Limiting対応

### Database (PostgreSQL)

#### 構成
```
PostgreSQL 15
├── データベース: websys_db_{environment}
├── ユーザー: admin
├── 接続プール: Prisma管理
├── マイグレーション: Prisma Migrate
└── バックアップ: Docker Volume
```

#### スキーマ
```sql
-- ユーザーテーブル
User {
  id: int (PK, Auto Increment)
  username: string (Unique)
  email: string (Unique)
  password: string (bcrypt)
  name: string
  department: string (Optional)
  role: UserRole (ADMIN|USER|GUEST)
  isActive: boolean (Default: true)
  createdAt: DateTime
  updatedAt: DateTime
}
```

## データフロー

### 認証フロー
```
1. Client → POST /api/auth/login (username, password)
2. Backend → bcrypt.compare(password, hashedPassword)
3. Backend → jwt.sign({userId, username, role})
4. Backend → Response {token, user}
5. Client → localStorage.setItem('token', token)
6. Client → All requests include Authorization: Bearer <token>
```

### API通信フロー
```
1. Frontend (axios) → API Request with JWT
2. Backend Middleware → JWT Verification
3. Backend Controller → Request Processing
4. Backend Service → Business Logic
5. Prisma ORM → Database Query
6. Database → Query Result
7. Backend → JSON Response
8. Frontend → UI Update
```

## セキュリティ

### 認証・認可
- **JWT認証**: ステートレス認証
- **Role-based Access**: 役割ベースアクセス制御
- **Token Expiration**: トークン有効期限管理
- **Password Hashing**: bcrypt (rounds: 12)

### データ保護
- **Input Validation**: express-validator
- **SQL Injection Prevention**: Prisma ORM
- **XSS Protection**: Vue.js Template Escaping
- **CORS**: Cross-Origin Resource Sharing設定

### 運用セキュリティ
- **Environment Variables**: 機密情報の分離
- **Non-root User**: コンテナ内での非特権実行
- **Network Isolation**: Docker Bridge Network
- **Health Checks**: サービス監視

## パフォーマンス

### フロントエンド最適化
- **Code Splitting**: Vite による動的インポート
- **Tree Shaking**: 未使用コードの除去
- **Hot Module Replacement**: 開発時の高速リロード
- **Production Build**: 最適化されたビルド

### バックエンド最適化
- **Connection Pooling**: Prisma 接続プール
- **Query Optimization**: Prisma クエリ最適化
- **Caching Strategy**: アプリケーションレベルキャッシュ
- **Health Checks**: ヘルスチェック機能

### インフラ最適化
- **Docker Layer Caching**: ビルド時間短縮
- **Volume Management**: データ永続化
- **Network Optimization**: 内部ネットワーク通信
- **Resource Limits**: リソース制限設定

## 監視・ログ

### ログ戦略
- **Application Logs**: morgan ミドルウェア
- **Error Logs**: 構造化エラーログ
- **Access Logs**: HTTP アクセスログ
- **Docker Logs**: コンテナログ集約

### ヘルスチェック
- **Frontend**: HTTP GET /
- **Backend**: HTTP GET /health
- **Database**: pg_isready コマンド
- **Container**: Docker Healthcheck

## 拡張性

### 水平スケーリング
- **Frontend**: CDN + Load Balancer
- **Backend**: Multiple Instances + Load Balancer
- **Database**: Read Replicas + Connection Pooling

### 垂直スケーリング
- **Resource Limits**: CPU/Memory 制限調整
- **Connection Pool**: データベース接続数調整
- **Cache Layer**: Redis 等のキャッシュ追加

### マイクロサービス化
- **Service Separation**: 機能別サービス分離
- **API Gateway**: 統一エントリーポイント
- **Event-Driven**: 非同期メッセージング
- **Container Orchestration**: Kubernetes 移行