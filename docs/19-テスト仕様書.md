# 機能管理システム テスト仕様書

## 📋 ドキュメント概要

**文書名**: 機能管理システム テスト仕様書
**作成日**: 2025-09-23
**作成者**: Claude Code Assistant
**対象バージョン**: 1.0.0
**テスト対象**: 機能管理システム（Feature Management System）

## 🎯 テスト目的

設計書で定義された機能管理システムの要件を満たし、品質基準に適合していることを確認する。

### テスト観点
1. **機能要件の適合性**: 設計書通りの機能が実装されているか
2. **API仕様の準拠性**: API設計書に基づいた正しい動作をしているか
3. **データ整合性**: データベース設計に沿った適切なデータ処理がされているか
4. **セキュリティ**: 権限制御が適切に機能しているか
5. **パフォーマンス**: 非機能要件を満たしているか

## 🏗️ テスト対象システム

### システム構成
- **フロントエンド**: Vue.js 3 + Element Plus + TypeScript
- **バックエンド**: Express + TypeScript + Prisma ORM
- **データベース**: PostgreSQL
- **認証**: JWT認証
- **環境**: Docker開発環境

### 対象機能
1. 機能マスタ管理
2. 部署-機能権限マトリクス
3. 権限テンプレート機能
4. 権限チェック機能
5. 監査ログ機能

## 📊 テストレベル分類

### L1: 単体テスト（Unit Test）
- APIエンドポイント単体の動作確認
- バリデーション機能の確認
- データベース操作の確認

### L2: 結合テスト（Integration Test）
- フロントエンド-バックエンド間の連携確認
- データベース連携の確認
- 認証連携の確認

### L3: システムテスト（System Test）
- エンドツーエンドの業務フロー確認
- 画面操作を含む総合的な動作確認

### L4: 受入テスト（Acceptance Test）
- 要件定義書との適合性確認
- ユーザビリティの確認

## 🧪 詳細テストケース

## 1. 機能マスタ管理機能

### 1.1 機能一覧取得 (GET /api/features)

| テストID | TC_F001 |
|----------|---------|
| **機能** | 機能一覧取得API |
| **目的** | システム機能の一覧を正しく取得できること |
| **前提条件** | - 認証済みユーザー<br>- データベースに機能データが存在 |
| **実行手順** | 1. 認証済みトークンでGET /api/features をコール |
| **期待結果** | - ステータスコード: 200<br>- レスポンス形式: `{"success": true, "data": {"features": [...]}}`<br>- 全ての有効な機能が返される<br>- 各機能に必須フィールドが含まれる |
| **テストレベル** | L1 |

| テストID | TC_F002 |
|----------|---------|
| **機能** | 機能一覧取得API（認証エラー） |
| **目的** | 認証なしでアクセスした場合の適切なエラーレスポンス |
| **前提条件** | - 認証トークンなし |
| **実行手順** | 1. 認証トークンなしでGET /api/features をコール |
| **期待結果** | - ステータスコード: 401<br>- エラーコード: AUTH_001<br>- エラーメッセージ: "Authorization header missing" |
| **テストレベル** | L1 |

### 1.2 機能作成 (POST /api/features)

| テストID | TC_F003 |
|----------|---------|
| **機能** | 機能作成API（正常系） |
| **目的** | 新しい機能を正しく作成できること |
| **前提条件** | - 管理者権限のユーザーで認証済み |
| **実行手順** | 1. 有効な機能データでPOST /api/features をコール<br>```json<br>{"code": "TEST_FUNC", "name": "テスト機能", "category": "TEST", "displayOrder": 10}``` |
| **期待結果** | - ステータスコード: 201<br>- 作成された機能のIDが返される<br>- データベースに機能が保存される |
| **テストレベル** | L1 |

| テストID | TC_F004 |
|----------|---------|
| **機能** | 機能作成API（バリデーションエラー） |
| **目的** | 必須項目不足時の適切なエラーレスポンス |
| **前提条件** | - 管理者権限のユーザーで認証済み |
| **実行手順** | 1. 必須項目を欠いたデータでPOST /api/features をコール<br>```json<br>{"name": "テスト機能"}``` |
| **期待結果** | - ステータスコード: 400<br>- バリデーションエラーメッセージが返される |
| **テストレベル** | L1 |

| テストID | TC_F005 |
|----------|---------|
| **機能** | 機能作成API（重複エラー） |
| **目的** | 機能コード重複時の適切なエラーレスポンス |
| **前提条件** | - 管理者権限のユーザーで認証済み<br>- "USER_MGMT"コードの機能が既存 |
| **実行手順** | 1. 既存と同じ機能コードでPOST /api/features をコール<br>```json<br>{"code": "USER_MGMT", "name": "重複機能", "category": "TEST"}``` |
| **期待結果** | - ステータスコード: 409<br>- 重複エラーメッセージが返される |
| **テストレベル** | L1 |

### 1.3 機能更新 (PUT /api/features/:id)

| テストID | TC_F006 |
|----------|---------|
| **機能** | 機能更新API（正常系） |
| **目的** | 既存機能を正しく更新できること |
| **前提条件** | - 管理者権限のユーザーで認証済み<br>- 更新対象の機能が存在 |
| **実行手順** | 1. 有効な更新データでPUT /api/features/:id をコール |
| **期待結果** | - ステータスコード: 200<br>- 更新された機能データが返される<br>- データベースが更新される |
| **テストレベル** | L1 |

### 1.4 機能削除 (DELETE /api/features/:id)

| テストID | TC_F007 |
|----------|---------|
| **機能** | 機能削除API（論理削除） |
| **目的** | 機能を論理削除できること |
| **前提条件** | - 管理者権限のユーザーで認証済み<br>- 削除対象の機能が存在 |
| **実行手順** | 1. DELETE /api/features/:id をコール |
| **期待結果** | - ステータスコード: 200<br>- isActiveがfalseに設定される<br>- 物理削除はされない |
| **テストレベル** | L1 |

## 2. 権限マトリクス管理機能

### 2.1 権限マトリクス取得 (GET /api/permissions/matrix)

| テストID | TC_P001 |
|----------|---------|
| **機能** | 権限マトリクス取得API |
| **目的** | 部署×機能の権限マトリクスを正しく取得できること |
| **前提条件** | - 認証済みユーザー<br>- 部署と機能が存在<br>- 権限設定が存在 |
| **実行手順** | 1. GET /api/permissions/matrix?companyId=1 をコール |
| **期待結果** | - ステータスコード: 200<br>- 部署×機能のマトリクスデータが返される<br>- 権限凡例（V,C,E,D,A,X）が含まれる |
| **テストレベル** | L1 |

### 2.2 部署権限取得 (GET /api/permissions/department/:departmentId)

| テストID | TC_P002 |
|----------|---------|
| **機能** | 部署権限取得API |
| **目的** | 特定部署の機能権限を取得できること |
| **前提条件** | - 認証済みユーザー<br>- 対象部署が存在 |
| **実行手順** | 1. GET /api/permissions/department/1 をコール |
| **期待結果** | - ステータスコード: 200<br>- 部署の全機能に対する権限設定が返される<br>- 未設定機能はデフォルト値で返される |
| **テストレベル** | L1 |

### 2.3 部署権限更新 (POST /api/permissions/department/:departmentId)

| テストID | TC_P003 |
|----------|---------|
| **機能** | 部署権限更新API |
| **目的** | 部署の機能権限を更新できること |
| **前提条件** | - 権限管理者で認証済み<br>- 対象部署が存在 |
| **実行手順** | 1. 権限データでPOST /api/permissions/department/1 をコール<br>```json<br>{"permissions": [{"featureId": 1, "canView": true, "canEdit": false}]}``` |
| **期待結果** | - ステータスコード: 200<br>- 権限が更新される<br>- 監査ログが記録される |
| **テストレベル** | L1 |

## 3. 権限テンプレート機能

### 3.1 テンプレート一覧取得 (GET /api/permissions/templates)

| テストID | TC_T001 |
|----------|---------|
| **機能** | 権限テンプレート一覧取得API |
| **目的** | 会社の権限テンプレート一覧を取得できること |
| **前提条件** | - 認証済みユーザー<br>- テンプレートが存在 |
| **実行手順** | 1. GET /api/permissions/templates?companyId=1 をコール |
| **期待結果** | - ステータスコード: 200<br>- テンプレート一覧が返される<br>- 各テンプレートに機能権限詳細が含まれる |
| **テストレベル** | L1 |
| **現状** | ❌ **BUG #002により失敗** |

### 3.2 テンプレート作成 (POST /api/permissions/templates)

| テストID | TC_T002 |
|----------|---------|
| **機能** | 権限テンプレート作成API |
| **目的** | 新しい権限テンプレートを作成できること |
| **前提条件** | - 管理者権限で認証済み |
| **実行手順** | 1. テンプレートデータでPOST /api/permissions/templates をコール |
| **期待結果** | - ステータスコード: 201<br>- テンプレートが作成される<br>- 機能権限詳細も同時に作成される |
| **テストレベル** | L1 |
| **現状** | ❌ **BUG #002により失敗** |

### 3.3 テンプレート適用 (POST /api/permissions/templates/:templateId/apply)

| テストID | TC_T003 |
|----------|---------|
| **機能** | 権限テンプレート適用API |
| **目的** | テンプレートを複数部署に一括適用できること |
| **前提条件** | - 管理者権限で認証済み<br>- 適用対象テンプレートが存在<br>- 適用対象部署が存在 |
| **実行手順** | 1. POST /api/permissions/templates/1/apply をコール<br>```json<br>{"departmentIds": [1, 2, 3]}``` |
| **期待結果** | - ステータスコード: 200<br>- 指定部署にテンプレート権限が適用される<br>- 監査ログが記録される |
| **テストレベル** | L1 |
| **現状** | ❌ **BUG #002により失敗** |

## 4. 権限チェック機能

### 4.1 権限チェック (POST /api/permissions/check)

| テストID | TC_C001 |
|----------|---------|
| **機能** | 権限チェックAPI |
| **目的** | ユーザーの特定機能に対する権限を確認できること |
| **前提条件** | - 認証済みユーザー<br>- チェック対象機能が存在 |
| **実行手順** | 1. POST /api/permissions/check をコール<br>```json<br>{"featureCode": "USER_MGMT", "action": "VIEW"}``` |
| **期待結果** | - ステータスコード: 200<br>- hasPermission: true/false が返される<br>- 権限ソース情報が含まれる |
| **テストレベル** | L1 |

### 4.2 一括権限チェック (POST /api/permissions/check-bulk)

| テストID | TC_C002 |
|----------|---------|
| **機能** | 一括権限チェックAPI |
| **目的** | 複数の機能・操作の権限を一括確認できること |
| **前提条件** | - 認証済みユーザー |
| **実行手順** | 1. 複数チェック項目でPOST /api/permissions/check-bulk をコール |
| **期待結果** | - ステータスコード: 200<br>- 各項目の権限結果が配列で返される |
| **テストレベル** | L1 |

## 5. フロントエンド機能テスト

### 5.1 機能管理画面

| テストID | TC_UI001 |
|----------|---------|
| **機能** | 機能管理画面表示 |
| **目的** | 機能管理画面が正しく表示されること |
| **前提条件** | - 管理者でログイン済み |
| **実行手順** | 1. /feature-management にアクセス |
| **期待結果** | - 機能一覧が表示される<br>- 新規作成ボタンが表示される<br>- 検索・フィルタ機能が動作する |
| **テストレベル** | L3 |

| テストID | TC_UI002 |
|----------|---------|
| **機能** | 機能作成フォーム |
| **目的** | 機能作成フォームが正しく動作すること |
| **前提条件** | - 管理者でログイン済み<br>- 機能管理画面にアクセス済み |
| **実行手順** | 1. 新規作成ボタンをクリック<br>2. フォームに入力<br>3. 保存ボタンをクリック |
| **期待結果** | - フォームが表示される<br>- バリデーションが動作する<br>- 成功時に一覧に反映される |
| **テストレベル** | L3 |

### 5.2 権限マトリクス画面

| テストID | TC_UI003 |
|----------|---------|
| **機能** | 権限マトリクス画面表示 |
| **目的** | 権限マトリクス画面が正しく表示されること |
| **前提条件** | - 管理者でログイン済み |
| **実行手順** | 1. /permission-matrix にアクセス |
| **期待結果** | - 部署×機能のマトリクスが表示される<br>- 権限凡例が表示される<br>- フィルタ機能が動作する |
| **テストレベル** | L3 |

| テストID | TC_UI004 |
|----------|---------|
| **機能** | 権限編集ダイアログ |
| **目的** | 権限編集ダイアログが正しく動作すること |
| **前提条件** | - 権限マトリクス画面にアクセス済み |
| **実行手順** | 1. マトリクスのセルをクリック<br>2. 権限チェックボックスを変更<br>3. 保存ボタンをクリック |
| **期待結果** | - ダイアログが表示される<br>- 現在の権限状態が表示される<br>- 変更が保存される |
| **テストレベル** | L3 |

| テストID | TC_UI005 |
|----------|---------|
| **機能** | 権限テンプレート管理 |
| **目的** | 権限テンプレート管理機能が正しく動作すること |
| **前提条件** | - 権限マトリクス画面にアクセス済み |
| **実行手順** | 1. テンプレート管理ボタンをクリック<br>2. テンプレート作成または適用を実行 |
| **期待結果** | - テンプレート管理ダイアログが表示される<br>- テンプレート一覧が表示される<br>- 作成・適用機能が動作する |
| **テストレベル** | L3 |
| **現状** | ❌ **BUG #002により失敗予想** |

## 6. セキュリティテスト

### 6.1 認証テスト

| テストID | TC_S001 |
|----------|---------|
| **機能** | 認証なしアクセス制御 |
| **目的** | 認証なしでAPIにアクセスした場合の適切な制御 |
| **前提条件** | - 認証トークンなし |
| **実行手順** | 1. 各保護されたAPIエンドポイントにアクセス |
| **期待結果** | - すべて401エラーが返される<br>- エラーメッセージが統一されている |
| **テストレベル** | L2 |

### 6.2 権限制御テスト

| テストID | TC_S002 |
|----------|---------|
| **機能** | 権限レベル制御 |
| **目的** | 権限レベルに応じた適切なアクセス制御 |
| **前提条件** | - 一般ユーザーで認証済み |
| **実行手順** | 1. 管理者専用APIにアクセス |
| **期待結果** | - 403エラーが返される<br>- 権限不足メッセージが表示される |
| **テストレベル** | L2 |

## 7. パフォーマンステスト

### 7.1 レスポンス時間テスト

| テストID | TC_P101 |
|----------|---------|
| **機能** | API応答時間 |
| **目的** | 権限チェックAPIの応答時間が要件を満たすこと |
| **前提条件** | - 本番相当のデータ量 |
| **実行手順** | 1. 権限チェックAPIを100回実行<br>2. 応答時間を測定 |
| **期待結果** | - 平均応答時間 < 100ms<br>- 95%タイル応答時間 < 200ms |
| **テストレベル** | L2 |

## 8. データ整合性テスト

### 8.1 トランザクション整合性

| テストID | TC_D001 |
|----------|---------|
| **機能** | 権限更新のトランザクション制御 |
| **目的** | 権限更新時のデータ整合性が保たれること |
| **前提条件** | - 複数機能の権限更新 |
| **実行手順** | 1. 複数機能の権限を一括更新<br>2. 途中でエラーが発生する状況を作る |
| **期待結果** | - 全件成功またはロールバック<br>- 部分的な更新は発生しない |
| **テストレベル** | L2 |

## 📋 テスト実行結果サマリー

### 実行予定テストケース数
- **L1 (Unit)**: 15ケース
- **L2 (Integration)**: 5ケース
- **L3 (System)**: 5ケース
- **L4 (Acceptance)**: 設計書適合性確認

### 既知の問題
- **BUG #002**: 権限テンプレート機能のPrismaスキーマ不整合
  - 影響テストケース: TC_T001, TC_T002, TC_T003, TC_UI005
  - 修正後に再テスト実施予定

### テスト環境
- **URL**: http://localhost:3000 (Frontend), http://localhost:8000 (Backend)
- **データベース**: PostgreSQL (localhost:5433)
- **テストデータ**: シードデータを使用

### 前提条件
- Docker開発環境が起動済み
- データベースシードが実行済み
- 以下のテストユーザーが利用可能:
  - 管理者: admin / admin123
  - マネージャー: manager / manager123
  - 一般ユーザー: demo_user / demo123

## 🚀 テスト実行手順

### 1. 環境準備
```bash
cd /home/typho/src/elementplus/websys/infrastructure/docker/development
docker compose up -d
docker exec websys_backend_dev npm run prisma:seed
```

### 2. APIテスト実行
```bash
# 認証トークン取得
TOKEN=$(curl -s -X POST "http://localhost:8000/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"username": "admin", "password": "admin123"}' | jq -r '.data.token')

# 各APIエンドポイントのテスト実行
curl -H "Authorization: Bearer $TOKEN" "http://localhost:8000/api/features"
curl -H "Authorization: Bearer $TOKEN" "http://localhost:8000/api/permissions/matrix?companyId=1"
```

### 3. フロントエンドテスト実行
1. http://localhost:3000 にアクセス
2. admin / admin123 でログイン
3. 各画面の動作確認

### 4. 結果記録
- 各テストケースの実行結果を記録
- 発見された不具合をBUG_MANAGEMENT_TABLE.mdに追記
- 修正が必要な項目の優先度を設定

---

**作成日**: 2025-09-23
**最終更新**: 2025-09-23
**次回レビュー予定**: BUG #002修正後