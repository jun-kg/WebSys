# 申請・承認ワークフロー データベース設計書

**文書番号**: DD-006
**作成日**: 2025-09-27
**バージョン**: 1.0
**作成者**: システム開発チーム
**関連文書**: [申請承認ワークフロー機能設計書](./申請承認ワークフロー機能設計書.md)

---

## 📋 目次

1. [概要](#1-概要)
2. [ER図](#2-er図)
3. [テーブル設計](#3-テーブル設計)
4. [インデックス設計](#4-インデックス設計)
5. [制約設計](#5-制約設計)
6. [マイグレーション設計](#6-マイグレーション設計)
7. [パフォーマンス考慮](#7-パフォーマンス考慮)

---

## 1. 概要

### 1.1 設計方針
- 既存システムとの整合性維持
- 拡張性を考慮した正規化設計
- パフォーマンスを重視したインデックス設計
- 監査要件を満たすログ設計

### 1.2 既存テーブル連携
```sql
-- 既存テーブルとの関連
users (id, username, email, name, company_id, department_id, role)
companies (id, name, code)
departments (id, name, company_id, parent_id)
features (id, name, code, category)
```

### 1.3 新規追加テーブル
1. `workflow_types` - 申請種別マスタ
2. `approval_routes` - 承認ルートマスタ
3. `workflow_requests` - 申請書
4. `approval_history` - 承認履歴
5. `approval_delegates` - 代理承認設定
6. `workflow_notifications` - 通知管理
7. `workflow_attachments` - 添付ファイル管理

---

## 2. ER図

```sql
                    ┌─────────────┐
                    │   users     │
                    │   (既存)    │
                    └──────┬──────┘
                           │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
        ▼                 ▼                 ▼
┌─────────────┐   ┌─────────────┐   ┌─────────────┐
│ companies   │   │departments  │   │  features   │
│   (既存)    │   │   (既存)    │   │   (既存)    │
└──────┬──────┘   └──────┬──────┘   └─────────────┘
       │                 │
       │                 │
       ▼                 ▼
┌─────────────────────────────────────────────────┐
│               workflow_types                    │
│  - id, name, form_schema                       │
│  - company_id, created_by                      │
└─────────────────────┬───────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────┐
│              approval_routes                    │
│  - id, workflow_type_id                        │
│  - department_id, route_definition             │
└─────────────────────┬───────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────┐
│             workflow_requests                   │
│  - id, workflow_type_id, requester_id          │
│  - form_data, status, current_step             │
└─────────────────────┬───────────────────────────┘
                      │
        ┌─────────────┼─────────────┐
        │             │             │
        ▼             ▼             ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│approval_    │ │workflow_    │ │workflow_    │
│history      │ │attachments  │ │notifications│
│             │ │             │ │             │
└─────────────┘ └─────────────┘ └─────────────┘

        ┌─────────────────────────────────────┐
        │         approval_delegates          │
        │  - user_id, delegate_id             │
        │  - start_date, end_date             │
        └─────────────────────────────────────┘
```

---

## 3. テーブル設計

### 3.1 workflow_types（申請種別マスタ）

**目的**: 申請種別と動的フォーム定義を管理

```sql
CREATE TABLE workflow_types (
  -- 基本項目
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) NOT NULL,                    -- 申請種別名（内部用）
  display_name VARCHAR(100) NOT NULL,            -- 表示名（UI用）
  description TEXT,                              -- 説明
  category VARCHAR(50) DEFAULT 'GENERAL',        -- カテゴリ

  -- フォーム定義
  form_schema JSONB NOT NULL,                    -- 動的フォーム定義
  validation_rules JSONB,                        -- バリデーションルール

  -- UI設定
  icon VARCHAR(50) DEFAULT 'Document',           -- アイコン名
  color VARCHAR(20) DEFAULT '#409EFF',           -- テーマカラー
  sort_order INTEGER DEFAULT 0,                 -- 表示順序

  -- ファイル設定
  is_file_required BOOLEAN DEFAULT false,        -- ファイル添付必須
  max_file_size INTEGER DEFAULT 10485760,       -- 最大ファイルサイズ(10MB)
  allowed_file_types TEXT DEFAULT 'pdf,doc,docx,xls,xlsx,jpg,png', -- 許可ファイル形式
  max_file_count INTEGER DEFAULT 5,             -- 最大ファイル数

  -- 業務設定
  auto_approval_enabled BOOLEAN DEFAULT false,   -- 自動承認有効
  auto_approval_conditions JSONB,               -- 自動承認条件
  estimated_processing_days INTEGER DEFAULT 3,   -- 標準処理日数
  urgent_processing_days INTEGER DEFAULT 1,      -- 緊急時処理日数

  -- 通知設定
  notification_template JSONB,                  -- 通知テンプレート
  reminder_days INTEGER[] DEFAULT '{1,3,5}',    -- リマインダー日数

  -- システム項目
  is_active BOOLEAN DEFAULT true,
  company_id INTEGER NOT NULL REFERENCES companies(id),
  created_by INTEGER REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),

  -- 制約
  CONSTRAINT workflow_types_company_name_unique
    UNIQUE(company_id, name),
  CONSTRAINT workflow_types_name_check
    CHECK (LENGTH(name) >= 1),
  CONSTRAINT workflow_types_file_size_check
    CHECK (max_file_size > 0 AND max_file_size <= 104857600), -- 最大100MB
  CONSTRAINT workflow_types_file_count_check
    CHECK (max_file_count > 0 AND max_file_count <= 20)
);

-- コメント
COMMENT ON TABLE workflow_types IS '申請種別マスタテーブル';
COMMENT ON COLUMN workflow_types.form_schema IS '動的フォーム定義（JSON形式）';
COMMENT ON COLUMN workflow_types.validation_rules IS 'バリデーションルール（JSON形式）';
COMMENT ON COLUMN workflow_types.auto_approval_conditions IS '自動承認条件（JSON形式）';
```

**form_schema例**:
```json
{
  "fields": [
    {
      "name": "startDate",
      "type": "date",
      "label": "開始日",
      "required": true,
      "validation": {
        "min": "today",
        "max": "today+365"
      }
    },
    {
      "name": "endDate",
      "type": "date",
      "label": "終了日",
      "required": true,
      "validation": {
        "min": "{startDate}",
        "max": "today+365"
      }
    },
    {
      "name": "reason",
      "type": "textarea",
      "label": "理由",
      "required": true,
      "validation": {
        "maxLength": 1000
      }
    },
    {
      "name": "amount",
      "type": "number",
      "label": "金額",
      "required": false,
      "validation": {
        "min": 0,
        "max": 1000000
      }
    }
  ]
}
```

### 3.2 approval_routes（承認ルートマスタ）

**目的**: 申請種別・部署別の承認ルートを定義

```sql
CREATE TABLE approval_routes (
  -- 基本項目
  id SERIAL PRIMARY KEY,
  workflow_type_id INTEGER NOT NULL REFERENCES workflow_types(id),
  department_id INTEGER REFERENCES departments(id), -- NULL = 全部署共通
  route_name VARCHAR(100) NOT NULL,                 -- ルート名

  -- ルート定義
  route_definition JSONB NOT NULL,                  -- 承認ルート定義
  condition_rules JSONB,                            -- 条件分岐ルール

  -- 設定
  is_default BOOLEAN DEFAULT false,                 -- デフォルトルート
  priority INTEGER DEFAULT 0,                      -- 優先度（高い順に適用）

  -- メタデータ
  description TEXT,                                 -- ルート説明
  estimated_days INTEGER DEFAULT 3,                -- 予想処理日数

  -- システム項目
  is_active BOOLEAN DEFAULT true,
  created_by INTEGER REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),

  -- 制約
  CONSTRAINT approval_routes_type_dept_name_unique
    UNIQUE(workflow_type_id, department_id, route_name),
  CONSTRAINT approval_routes_priority_check
    CHECK (priority >= 0)
);

-- コメント
COMMENT ON TABLE approval_routes IS '承認ルートマスタテーブル';
COMMENT ON COLUMN approval_routes.route_definition IS '承認ルート定義（JSON形式）';
COMMENT ON COLUMN approval_routes.condition_rules IS '条件分岐ルール（JSON形式）';
```

**route_definition例**:
```json
{
  "steps": [
    {
      "stepNumber": 1,
      "stepName": "直属上司承認",
      "approverType": "DIRECT_MANAGER",
      "approverIds": [],
      "isParallel": false,
      "timeoutDays": 3,
      "isSkippable": false,
      "skipConditions": []
    },
    {
      "stepNumber": 2,
      "stepName": "部門長承認",
      "approverType": "DEPARTMENT_MANAGER",
      "approverIds": [],
      "isParallel": false,
      "timeoutDays": 3,
      "isSkippable": true,
      "skipConditions": [
        {
          "field": "amount",
          "operator": "<=",
          "value": 50000
        }
      ]
    },
    {
      "stepNumber": 3,
      "stepName": "役員承認",
      "approverType": "EXECUTIVE",
      "approverIds": [101, 102],
      "isParallel": true,
      "timeoutDays": 5,
      "isSkippable": true,
      "skipConditions": [
        {
          "field": "amount",
          "operator": "<=",
          "value": 100000
        }
      ]
    }
  ]
}
```

### 3.3 workflow_requests（申請書）

**目的**: 申請書の詳細情報を管理

```sql
CREATE TABLE workflow_requests (
  -- 基本項目
  id SERIAL PRIMARY KEY,
  request_number VARCHAR(50) UNIQUE NOT NULL,       -- 申請番号
  workflow_type_id INTEGER NOT NULL REFERENCES workflow_types(id),
  requester_id INTEGER NOT NULL REFERENCES users(id),

  -- 申請内容
  title VARCHAR(200) NOT NULL,                      -- 申請タイトル
  description TEXT,                                 -- 申請概要
  form_data JSONB NOT NULL,                         -- 申請データ

  -- ワークフロー状態
  current_step INTEGER DEFAULT 0,                   -- 現在のステップ（0=下書き）
  total_steps INTEGER DEFAULT 0,                    -- 総ステップ数
  status VARCHAR(20) DEFAULT 'DRAFT',               -- ステータス
  applied_route_id INTEGER REFERENCES approval_routes(id), -- 適用された承認ルート

  -- メタデータ
  urgency VARCHAR(10) DEFAULT 'NORMAL',             -- 緊急度
  priority_score INTEGER DEFAULT 0,                -- 優先度スコア
  estimated_amount DECIMAL(15,2),                   -- 概算金額
  currency_code VARCHAR(3) DEFAULT 'JPY',           -- 通貨コード

  -- 日付管理
  due_date DATE,                                    -- 希望完了日
  submitted_at TIMESTAMP,                           -- 申請提出日時
  started_at TIMESTAMP,                             -- 承認開始日時
  completed_at TIMESTAMP,                           -- 承認完了日時
  cancelled_at TIMESTAMP,                           -- キャンセル日時

  -- 処理結果
  final_status VARCHAR(20),                         -- 最終ステータス
  final_comment TEXT,                               -- 最終コメント
  final_approver_id INTEGER REFERENCES users(id),   -- 最終承認者

  -- 追加情報
  tags VARCHAR(500),                                -- タグ（カンマ区切り）
  reference_numbers VARCHAR(500),                   -- 関連番号
  cancel_reason TEXT,                               -- キャンセル理由

  -- 計算フィールド
  processing_time INTERVAL,                         -- 処理時間
  sla_deadline TIMESTAMP,                           -- SLA期限
  is_overdue BOOLEAN GENERATED ALWAYS AS (
    sla_deadline IS NOT NULL AND
    sla_deadline < NOW() AND
    status IN ('SUBMITTED', 'IN_PROGRESS')
  ) STORED,                                         -- 期限超過フラグ

  -- システム項目
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),

  -- 制約
  CONSTRAINT workflow_requests_status_check
    CHECK (status IN ('DRAFT', 'SUBMITTED', 'IN_PROGRESS', 'APPROVED', 'REJECTED', 'CANCELLED', 'WITHDRAWN')),
  CONSTRAINT workflow_requests_urgency_check
    CHECK (urgency IN ('LOW', 'NORMAL', 'HIGH', 'URGENT')),
  CONSTRAINT workflow_requests_final_status_check
    CHECK (final_status IS NULL OR final_status IN ('APPROVED', 'REJECTED', 'CANCELLED', 'WITHDRAWN')),
  CONSTRAINT workflow_requests_step_check
    CHECK (current_step >= 0 AND current_step <= total_steps),
  CONSTRAINT workflow_requests_amount_check
    CHECK (estimated_amount IS NULL OR estimated_amount >= 0),
  CONSTRAINT workflow_requests_date_check
    CHECK (due_date IS NULL OR due_date >= CURRENT_DATE)
);

-- コメント
COMMENT ON TABLE workflow_requests IS '申請書テーブル';
COMMENT ON COLUMN workflow_requests.form_data IS '申請データ（JSON形式）';
COMMENT ON COLUMN workflow_requests.priority_score IS '緊急度・金額等から算出される優先度';
COMMENT ON COLUMN workflow_requests.is_overdue IS 'SLA期限超過フラグ（計算列）';
```

### 3.4 approval_history（承認履歴）

**目的**: 承認プロセスの完全な履歴を記録

```sql
CREATE TABLE approval_history (
  -- 基本項目
  id SERIAL PRIMARY KEY,
  request_id INTEGER NOT NULL REFERENCES workflow_requests(id),
  step_number INTEGER NOT NULL,                     -- ステップ番号
  step_name VARCHAR(100) NOT NULL,                  -- ステップ名

  -- 承認者情報
  approver_id INTEGER NOT NULL REFERENCES users(id),
  original_approver_id INTEGER REFERENCES users(id), -- 元の承認者（代理の場合）
  approver_department_id INTEGER REFERENCES departments(id), -- 承認者所属部署

  -- アクション
  action VARCHAR(20) NOT NULL,                      -- アクション
  decision_reason TEXT,                             -- 判断理由
  comment TEXT,                                     -- コメント
  recommendations TEXT,                             -- 推奨事項

  -- 追加データ
  additional_data JSONB,                            -- 追加データ
  attachments JSONB,                                -- 承認時添付ファイル

  -- メタデータ
  processing_duration INTERVAL,                     -- 処理時間
  decision_confidence INTEGER CHECK (decision_confidence BETWEEN 1 AND 5), -- 判断確信度
  risk_assessment TEXT,                             -- リスク評価

  -- 監査情報
  ip_address INET,                                  -- IPアドレス
  user_agent TEXT,                                  -- ユーザーエージェント
  session_id VARCHAR(100),                          -- セッションID
  device_info JSONB,                                -- デバイス情報
  location_info JSONB,                              -- 位置情報

  -- システム項目
  created_at TIMESTAMP DEFAULT NOW(),               -- 承認日時

  -- 制約
  CONSTRAINT approval_history_action_check
    CHECK (action IN ('APPROVE', 'REJECT', 'RETURN', 'DELEGATE', 'CANCEL', 'TIMEOUT', 'WITHDRAW')),
  CONSTRAINT approval_history_step_check
    CHECK (step_number > 0)
);

-- コメント
COMMENT ON TABLE approval_history IS '承認履歴テーブル';
COMMENT ON COLUMN approval_history.additional_data IS '承認時の追加データ（JSON形式）';
COMMENT ON COLUMN approval_history.decision_confidence IS '判断の確信度（1-5）';
```

### 3.5 approval_delegates（代理承認設定）

**目的**: 代理承認の設定を管理

```sql
CREATE TABLE approval_delegates (
  -- 基本項目
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL REFERENCES users(id),        -- 本人
  delegate_id INTEGER NOT NULL REFERENCES users(id),    -- 代理人

  -- 代理条件
  workflow_type_ids INTEGER[] DEFAULT '{}',             -- 対象申請種別ID配列
  department_ids INTEGER[] DEFAULT '{}',                -- 対象部署ID配列
  max_amount DECIMAL(15,2),                             -- 代理承認上限金額
  urgency_levels VARCHAR(50)[] DEFAULT '{NORMAL,HIGH,URGENT}', -- 対象緊急度

  -- 期間設定
  start_date DATE NOT NULL,                             -- 開始日
  end_date DATE NOT NULL,                               -- 終了日
  effective_hours JSONB,                                -- 有効時間帯

  -- メタデータ
  reason TEXT NOT NULL,                                 -- 代理理由
  emergency_contact VARCHAR(200),                       -- 緊急連絡先
  special_instructions TEXT,                            -- 特別指示

  -- 制限設定
  max_approvals_per_day INTEGER DEFAULT 50,            -- 1日最大承認数
  requires_notification BOOLEAN DEFAULT true,           -- 本人通知必要
  auto_delegation BOOLEAN DEFAULT false,                -- 自動代理実行

  -- システム項目
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),

  -- 制約
  CONSTRAINT approval_delegates_date_check
    CHECK (end_date >= start_date),
  CONSTRAINT approval_delegates_different_users
    CHECK (user_id != delegate_id),
  CONSTRAINT approval_delegates_amount_check
    CHECK (max_amount IS NULL OR max_amount >= 0),
  CONSTRAINT approval_delegates_max_approvals_check
    CHECK (max_approvals_per_day > 0)
);

-- コメント
COMMENT ON TABLE approval_delegates IS '代理承認設定テーブル';
COMMENT ON COLUMN approval_delegates.workflow_type_ids IS '対象申請種別ID配列（空配列=全種別）';
COMMENT ON COLUMN approval_delegates.effective_hours IS '有効時間帯設定（JSON形式）';
```

### 3.6 workflow_notifications（通知管理）

**目的**: ワークフロー関連の通知を管理

```sql
CREATE TABLE workflow_notifications (
  -- 基本項目
  id SERIAL PRIMARY KEY,
  request_id INTEGER NOT NULL REFERENCES workflow_requests(id),
  user_id INTEGER NOT NULL REFERENCES users(id),

  -- 通知内容
  notification_type VARCHAR(30) NOT NULL,              -- 通知種別
  title VARCHAR(200) NOT NULL,                         -- 通知タイトル
  message TEXT NOT NULL,                               -- 通知内容
  action_url VARCHAR(500),                             -- アクションURL

  -- 表示設定
  priority_level INTEGER DEFAULT 3,                    -- 優先度（1-5）
  display_duration INTEGER DEFAULT 5000,               -- 表示時間（ミリ秒）
  icon VARCHAR(50),                                    -- アイコン
  color VARCHAR(20),                                   -- カラー

  -- 状態管理
  is_read BOOLEAN DEFAULT false,                       -- 既読フラグ
  read_at TIMESTAMP,                                   -- 既読日時
  is_actionable BOOLEAN DEFAULT false,                 -- アクション可能
  action_taken BOOLEAN DEFAULT false,                  -- アクション実行済み
  action_taken_at TIMESTAMP,                           -- アクション実行日時

  -- 配信チャネル
  sent_in_app BOOLEAN DEFAULT true,                    -- アプリ内通知済み
  sent_email BOOLEAN DEFAULT false,                    -- メール送信済み
  sent_sms BOOLEAN DEFAULT false,                      -- SMS送信済み
  sent_push BOOLEAN DEFAULT false,                     -- プッシュ通知済み

  -- 配信日時
  in_app_sent_at TIMESTAMP,                           -- アプリ内通知日時
  email_sent_at TIMESTAMP,                             -- メール送信日時
  sms_sent_at TIMESTAMP,                               -- SMS送信日時
  push_sent_at TIMESTAMP,                              -- プッシュ通知日時

  -- エラー管理
  delivery_errors JSONB,                               -- 配信エラー情報
  retry_count INTEGER DEFAULT 0,                      -- 再送回数
  max_retries INTEGER DEFAULT 3,                      -- 最大再送回数

  -- 期限管理
  expires_at TIMESTAMP,                                -- 通知期限
  is_expired BOOLEAN GENERATED ALWAYS AS (
    expires_at IS NOT NULL AND expires_at < NOW()
  ) STORED,                                           -- 期限切れフラグ

  -- システム項目
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),

  -- 制約
  CONSTRAINT workflow_notifications_type_check
    CHECK (notification_type IN (
      'SUBMITTED', 'APPROVAL_REQUIRED', 'APPROVED', 'REJECTED',
      'RETURNED', 'CANCELLED', 'REMINDER', 'OVERDUE', 'DELEGATE_ASSIGNED'
    )),
  CONSTRAINT workflow_notifications_priority_check
    CHECK (priority_level BETWEEN 1 AND 5),
  CONSTRAINT workflow_notifications_retry_check
    CHECK (retry_count >= 0 AND retry_count <= max_retries)
);

-- コメント
COMMENT ON TABLE workflow_notifications IS 'ワークフロー通知管理テーブル';
COMMENT ON COLUMN workflow_notifications.delivery_errors IS '配信エラー情報（JSON形式）';
COMMENT ON COLUMN workflow_notifications.is_expired IS '通知期限切れフラグ（計算列）';
```

### 3.7 workflow_attachments（添付ファイル管理）

**目的**: 申請・承認時の添付ファイルを管理

```sql
CREATE TABLE workflow_attachments (
  -- 基本項目
  id SERIAL PRIMARY KEY,
  request_id INTEGER NOT NULL REFERENCES workflow_requests(id),
  approval_history_id INTEGER REFERENCES approval_history(id), -- 承認時添付の場合

  -- ファイル情報
  original_filename VARCHAR(255) NOT NULL,             -- 元ファイル名
  stored_filename VARCHAR(255) NOT NULL,               -- 保存ファイル名
  file_path VARCHAR(500) NOT NULL,                     -- ファイルパス
  file_size BIGINT NOT NULL,                           -- ファイルサイズ（バイト）
  mime_type VARCHAR(100) NOT NULL,                     -- MIMEタイプ
  file_extension VARCHAR(10),                          -- ファイル拡張子

  -- ファイル属性
  file_category VARCHAR(50) DEFAULT 'DOCUMENT',        -- ファイルカテゴリ
  file_description TEXT,                               -- ファイル説明
  is_confidential BOOLEAN DEFAULT false,               -- 機密ファイル
  access_level INTEGER DEFAULT 1,                     -- アクセスレベル（1-5）

  -- セキュリティ
  checksum VARCHAR(64) NOT NULL,                       -- ファイルチェックサム
  encryption_key VARCHAR(100),                         -- 暗号化キー
  is_encrypted BOOLEAN DEFAULT false,                  -- 暗号化済み
  virus_scan_status VARCHAR(20) DEFAULT 'PENDING',     -- ウイルススキャン状態
  virus_scan_result JSONB,                             -- スキャン結果詳細

  -- メタデータ
  uploaded_by INTEGER NOT NULL REFERENCES users(id),   -- アップロード者
  upload_ip INET,                                      -- アップロード元IP
  upload_user_agent TEXT,                              -- ユーザーエージェント

  -- バージョン管理
  version_number INTEGER DEFAULT 1,                    -- バージョン番号
  parent_attachment_id INTEGER REFERENCES workflow_attachments(id), -- 親ファイル
  is_latest_version BOOLEAN DEFAULT true,              -- 最新版フラグ

  -- アクセス制御
  download_count INTEGER DEFAULT 0,                    -- ダウンロード回数
  last_accessed_at TIMESTAMP,                          -- 最終アクセス日時
  last_accessed_by INTEGER REFERENCES users(id),       -- 最終アクセス者
  access_log JSONB,                                    -- アクセスログ

  -- 保存期間
  retention_period INTEGER,                            -- 保存期間（日）
  archive_date DATE,                                   -- アーカイブ予定日
  deletion_date DATE,                                  -- 削除予定日
  is_archived BOOLEAN DEFAULT false,                  -- アーカイブ済み

  -- システム項目
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),

  -- 制約
  CONSTRAINT workflow_attachments_file_size_check
    CHECK (file_size > 0 AND file_size <= 104857600), -- 最大100MB
  CONSTRAINT workflow_attachments_access_level_check
    CHECK (access_level BETWEEN 1 AND 5),
  CONSTRAINT workflow_attachments_virus_scan_check
    CHECK (virus_scan_status IN ('PENDING', 'CLEAN', 'INFECTED', 'ERROR')),
  CONSTRAINT workflow_attachments_version_check
    CHECK (version_number > 0)
);

-- コメント
COMMENT ON TABLE workflow_attachments IS 'ワークフロー添付ファイル管理テーブル';
COMMENT ON COLUMN workflow_attachments.checksum IS 'ファイル整合性チェック用ハッシュ値';
COMMENT ON COLUMN workflow_attachments.access_log IS 'ファイルアクセスログ（JSON形式）';
```

---

## 4. インデックス設計

### 4.1 主要検索パターン別インデックス

```sql
-- workflow_types関連
CREATE INDEX idx_workflow_types_company_active
  ON workflow_types(company_id, is_active);
CREATE INDEX idx_workflow_types_category
  ON workflow_types(category, sort_order);

-- approval_routes関連
CREATE INDEX idx_approval_routes_workflow_dept
  ON approval_routes(workflow_type_id, department_id, is_active);
CREATE INDEX idx_approval_routes_default
  ON approval_routes(workflow_type_id, is_default)
  WHERE is_active = true;

-- workflow_requests関連（最重要）
CREATE INDEX idx_workflow_requests_requester_status
  ON workflow_requests(requester_id, status, created_at DESC);
CREATE INDEX idx_workflow_requests_status_created
  ON workflow_requests(status, created_at DESC)
  WHERE status IN ('SUBMITTED', 'IN_PROGRESS');
CREATE INDEX idx_workflow_requests_type_status
  ON workflow_requests(workflow_type_id, status, created_at DESC);
CREATE INDEX idx_workflow_requests_overdue
  ON workflow_requests(sla_deadline, status)
  WHERE is_overdue = true;
CREATE INDEX idx_workflow_requests_approval_waiting
  ON workflow_requests(current_step, status)
  WHERE status = 'IN_PROGRESS';

-- approval_history関連
CREATE INDEX idx_approval_history_request_step
  ON approval_history(request_id, step_number, created_at DESC);
CREATE INDEX idx_approval_history_approver_date
  ON approval_history(approver_id, created_at DESC);
CREATE INDEX idx_approval_history_action_date
  ON approval_history(action, created_at DESC);

-- approval_delegates関連
CREATE INDEX idx_approval_delegates_user_period
  ON approval_delegates(user_id, start_date, end_date)
  WHERE is_active = true;
CREATE INDEX idx_approval_delegates_delegate_active
  ON approval_delegates(delegate_id, start_date, end_date)
  WHERE is_active = true;

-- workflow_notifications関連
CREATE INDEX idx_workflow_notifications_user_unread
  ON workflow_notifications(user_id, is_read, created_at DESC);
CREATE INDEX idx_workflow_notifications_request
  ON workflow_notifications(request_id, created_at DESC);
CREATE INDEX idx_workflow_notifications_expired
  ON workflow_notifications(expires_at)
  WHERE is_expired = false;

-- workflow_attachments関連
CREATE INDEX idx_workflow_attachments_request
  ON workflow_attachments(request_id, created_at DESC);
CREATE INDEX idx_workflow_attachments_approval
  ON workflow_attachments(approval_history_id)
  WHERE approval_history_id IS NOT NULL;
CREATE INDEX idx_workflow_attachments_checksum
  ON workflow_attachments(checksum);
```

### 4.2 複合インデックス（性能重視）

```sql
-- 承認待ち検索用（最重要）
CREATE INDEX idx_approval_waiting_complex
  ON workflow_requests(status, current_step, urgency, created_at DESC)
  WHERE status = 'IN_PROGRESS';

-- 統計・レポート用
CREATE INDEX idx_requests_stats
  ON workflow_requests(workflow_type_id, status, DATE(created_at));

-- 期限管理用
CREATE INDEX idx_requests_sla
  ON workflow_requests(sla_deadline, status, urgency)
  WHERE status IN ('SUBMITTED', 'IN_PROGRESS');

-- 代理承認判定用
CREATE INDEX idx_delegates_lookup
  ON approval_delegates(delegate_id, start_date, end_date, is_active)
  WHERE is_active = true;
```

### 4.3 JSON列インデックス（GIN）

```sql
-- フォームデータ検索用
CREATE INDEX idx_workflow_types_form_schema_gin
  ON workflow_types USING gin(form_schema);

-- 申請データ検索用
CREATE INDEX idx_workflow_requests_form_data_gin
  ON workflow_requests USING gin(form_data);

-- 承認ルート検索用
CREATE INDEX idx_approval_routes_definition_gin
  ON approval_routes USING gin(route_definition);
```

---

## 5. 制約設計

### 5.1 外部キー制約

```sql
-- workflow_types
ALTER TABLE workflow_types
  ADD CONSTRAINT fk_workflow_types_company
  FOREIGN KEY (company_id) REFERENCES companies(id) ON DELETE CASCADE;

ALTER TABLE workflow_types
  ADD CONSTRAINT fk_workflow_types_creator
  FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL;

-- approval_routes
ALTER TABLE approval_routes
  ADD CONSTRAINT fk_approval_routes_workflow_type
  FOREIGN KEY (workflow_type_id) REFERENCES workflow_types(id) ON DELETE CASCADE;

ALTER TABLE approval_routes
  ADD CONSTRAINT fk_approval_routes_department
  FOREIGN KEY (department_id) REFERENCES departments(id) ON DELETE CASCADE;

-- workflow_requests
ALTER TABLE workflow_requests
  ADD CONSTRAINT fk_workflow_requests_type
  FOREIGN KEY (workflow_type_id) REFERENCES workflow_types(id) ON DELETE RESTRICT;

ALTER TABLE workflow_requests
  ADD CONSTRAINT fk_workflow_requests_requester
  FOREIGN KEY (requester_id) REFERENCES users(id) ON DELETE RESTRICT;

ALTER TABLE workflow_requests
  ADD CONSTRAINT fk_workflow_requests_route
  FOREIGN KEY (applied_route_id) REFERENCES approval_routes(id) ON DELETE SET NULL;

-- approval_history
ALTER TABLE approval_history
  ADD CONSTRAINT fk_approval_history_request
  FOREIGN KEY (request_id) REFERENCES workflow_requests(id) ON DELETE CASCADE;

ALTER TABLE approval_history
  ADD CONSTRAINT fk_approval_history_approver
  FOREIGN KEY (approver_id) REFERENCES users(id) ON DELETE RESTRICT;
```

### 5.2 チェック制約

```sql
-- ステータス遷移制約
CREATE OR REPLACE FUNCTION check_status_transition()
RETURNS TRIGGER AS $$
BEGIN
  -- 承認済み・却下・キャンセル後の変更禁止
  IF OLD.status IN ('APPROVED', 'REJECTED', 'CANCELLED')
     AND NEW.status != OLD.status THEN
    RAISE EXCEPTION 'Cannot change status from % to %', OLD.status, NEW.status;
  END IF;

  -- 下書きから直接完了状態への遷移禁止
  IF OLD.status = 'DRAFT' AND NEW.status IN ('APPROVED', 'REJECTED') THEN
    RAISE EXCEPTION 'Cannot transition directly from DRAFT to %', NEW.status;
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_workflow_requests_status_transition
  BEFORE UPDATE ON workflow_requests
  FOR EACH ROW
  EXECUTE FUNCTION check_status_transition();
```

### 5.3 データ整合性制約

```sql
-- 代理承認期間重複チェック
CREATE OR REPLACE FUNCTION check_delegate_overlap()
RETURNS TRIGGER AS $$
BEGIN
  IF EXISTS (
    SELECT 1 FROM approval_delegates
    WHERE user_id = NEW.user_id
      AND id != COALESCE(NEW.id, -1)
      AND is_active = true
      AND (start_date, end_date) OVERLAPS (NEW.start_date, NEW.end_date)
  ) THEN
    RAISE EXCEPTION 'Delegate period overlaps with existing delegation';
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_approval_delegates_overlap
  BEFORE INSERT OR UPDATE ON approval_delegates
  FOR EACH ROW
  EXECUTE FUNCTION check_delegate_overlap();
```

---

## 6. マイグレーション設計

### 6.1 マイグレーション実行順序

```sql
-- 001_create_workflow_types.sql
-- 002_create_approval_routes.sql
-- 003_create_workflow_requests.sql
-- 004_create_approval_history.sql
-- 005_create_approval_delegates.sql
-- 006_create_workflow_notifications.sql
-- 007_create_workflow_attachments.sql
-- 008_create_indexes.sql
-- 009_create_constraints.sql
-- 010_create_triggers.sql
-- 011_insert_initial_data.sql
```

### 6.2 初期データ投入

```sql
-- 基本的な申請種別
INSERT INTO workflow_types (
  name, display_name, description, form_schema,
  company_id, created_by, is_active
) VALUES
-- 有給申請
(
  'paid_leave', '有給申請', '有給休暇の申請',
  '{
    "fields": [
      {
        "name": "startDate",
        "type": "date",
        "label": "開始日",
        "required": true
      },
      {
        "name": "endDate",
        "type": "date",
        "label": "終了日",
        "required": true
      },
      {
        "name": "reason",
        "type": "textarea",
        "label": "理由",
        "required": true
      }
    ]
  }',
  1, 1, true
),
-- 出張申請
(
  'business_trip', '出張申請', '出張の申請',
  '{
    "fields": [
      {
        "name": "destination",
        "type": "text",
        "label": "出張先",
        "required": true
      },
      {
        "name": "purpose",
        "type": "textarea",
        "label": "目的",
        "required": true
      },
      {
        "name": "estimatedCost",
        "type": "number",
        "label": "概算費用",
        "required": true
      }
    ]
  }',
  1, 1, true
);

-- 基本的な承認ルート
INSERT INTO approval_routes (
  workflow_type_id, route_name, route_definition,
  is_default, created_by
) VALUES
(
  1, '有給申請_標準ルート',
  '{
    "steps": [
      {
        "stepNumber": 1,
        "stepName": "直属上司承認",
        "approverType": "DIRECT_MANAGER",
        "timeoutDays": 3
      }
    ]
  }',
  true, 1
),
(
  2, '出張申請_標準ルート',
  '{
    "steps": [
      {
        "stepNumber": 1,
        "stepName": "直属上司承認",
        "approverType": "DIRECT_MANAGER",
        "timeoutDays": 3
      },
      {
        "stepNumber": 2,
        "stepName": "部門長承認",
        "approverType": "DEPARTMENT_MANAGER",
        "timeoutDays": 3
      }
    ]
  }',
  true, 1
);
```

---

## 7. パフォーマンス考慮

### 7.1 パーティション設計

```sql
-- 大量データ対応：日付ベースパーティション
CREATE TABLE workflow_requests_partitioned (
  LIKE workflow_requests INCLUDING ALL
) PARTITION BY RANGE (created_at);

-- 月別パーティション
CREATE TABLE workflow_requests_2025_01 PARTITION OF workflow_requests_partitioned
  FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

CREATE TABLE workflow_requests_2025_02 PARTITION OF workflow_requests_partitioned
  FOR VALUES FROM ('2025-02-01') TO ('2025-03-01');
```

### 7.2 統計情報更新

```sql
-- 定期的な統計情報更新
CREATE OR REPLACE FUNCTION update_workflow_statistics()
RETURNS void AS $$
BEGIN
  -- テーブル統計更新
  ANALYZE workflow_requests;
  ANALYZE approval_history;
  ANALYZE workflow_notifications;

  -- カスタム統計の更新
  REFRESH MATERIALIZED VIEW IF EXISTS workflow_summary_stats;
END;
$$ LANGUAGE plpgsql;

-- 定期実行スケジュール（cron等で実行）
-- 0 2 * * * psql -d database -c "SELECT update_workflow_statistics();"
```

### 7.3 クエリ最適化

```sql
-- よく使用されるクエリの最適化
-- 承認待ち一覧（最重要）
EXPLAIN (ANALYZE, BUFFERS)
SELECT
  wr.id, wr.request_number, wr.title, wr.urgency,
  wt.display_name, wt.icon,
  u.name as requester_name,
  wr.created_at
FROM workflow_requests wr
JOIN workflow_types wt ON wr.workflow_type_id = wt.id
JOIN users u ON wr.requester_id = u.id
WHERE wr.status = 'IN_PROGRESS'
  AND wr.current_step = 2
ORDER BY
  CASE wr.urgency
    WHEN 'URGENT' THEN 1
    WHEN 'HIGH' THEN 2
    WHEN 'NORMAL' THEN 3
    WHEN 'LOW' THEN 4
  END,
  wr.created_at
LIMIT 50;
```

---

## 📋 承認履歴

| 版数 | 日付 | 変更内容 | 作成者 | 承認者 |
|------|------|----------|--------|--------|
| 1.0 | 2025-09-27 | 初版作成 | システム開発チーム | - |

---

## 📚 関連文書

- [申請承認ワークフロー機能設計書](./申請承認ワークフロー機能設計書.md)
- [既存データベース設計書](../データベース設計書.md)
- [Prismaスキーマ設計書](../../02_技術設計書/Prismaスキーマ設計書.md)

---

**文書の機密レベル**: 社内限り
**次回レビュー予定**: 2025-10-27