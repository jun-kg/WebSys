# システム基盤設計書

## 📋 システム概要

### 目的
- 社内システム開発・運用基盤の設計
- Docker化によるポータブルな開発環境
- CI/CD パイプラインの構築
- スケーラブルなアーキテクチャの実現

### 技術スタック
- **コンテナ**: Docker + Docker Compose
- **フロントエンド**: Vue 3 + TypeScript + Vite
- **バックエンド**: Express + Prisma + PostgreSQL
- **インフラ**: WSL2 + GitHub Actions（予定）

## 🏗️ アーキテクチャ設計

### システム構成図
```
┌─────────────────────────────────────────────────┐
│                  Browser                        │
└─────────────────┬───────────────────────────────┘
                  │ HTTP/HTTPS
┌─────────────────▼───────────────────────────────┐
│           Frontend Container                    │
│  ┌─────────────────────────────────────────┐   │
│  │ Vue 3 + TypeScript + Element Plus      │   │
│  │ Vite Dev Server (Port: 3000)           │   │
│  └─────────────────────────────────────────┘   │
└─────────────────┬───────────────────────────────┘
                  │ API Calls
┌─────────────────▼───────────────────────────────┐
│            Backend Container                    │
│  ┌─────────────────────────────────────────┐   │
│  │ Express + Prisma ORM                   │   │
│  │ Node.js Server (Port: 8000)            │   │
│  └─────────────────────────────────────────┘   │
└─────────────────┬───────────────────────────────┘
                  │ Database Connection
┌─────────────────▼───────────────────────────────┐
│          Database Container                     │
│  ┌─────────────────────────────────────────┐   │
│  │ PostgreSQL 15                          │   │
│  │ Database Server (Port: 5432)           │   │
│  └─────────────────────────────────────────┘   │
└─────────────────────────────────────────────────┘
```

### ディレクトリ構造
```
websys/                          # Docker環境管理
├── templates/                   # ソースコードテンプレート
│   ├── frontend/               # Vue.js テンプレート
│   └── backend/                # Express テンプレート
├── workspace/                  # 開発用ソースコード
│   ├── frontend/              # 実際のフロントエンド開発
│   └── backend/               # 実際のバックエンド開発
├── docker/                    # Dockerビルド設定
│   ├── frontend.Dockerfile
│   ├── backend.Dockerfile
│   └── postgres.Dockerfile
├── docker-compose.yml         # サービス構成定義
├── setup.sh                   # 初回セットアップ
└── init.sh                    # テンプレート再コピー
```

## 🐳 Docker設計

### docker-compose.yml
```yaml
version: '3.8'

services:
  frontend:
    build:
      context: ./workspace/frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    volumes:
      - ./workspace/frontend:/app
      - /app/node_modules
    depends_on:
      - backend
    environment:
      - VITE_API_URL=http://localhost:8000
    command: npm run dev

  backend:
    build:
      context: ./workspace/backend
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    volumes:
      - ./workspace/backend:/app
      - /app/node_modules
    depends_on:
      - postgres
    environment:
      - DATABASE_URL=postgresql://user:password@postgres:5432/websys
      - NODE_ENV=development
    command: npm run dev

  postgres:
    image: postgres:15-alpine
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=websys
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/init.sql:/docker-entrypoint-initdb.d/init.sql

volumes:
  postgres_data:
```

### Dockerfile設計

#### Frontend Dockerfile
```dockerfile
FROM node:18-alpine

WORKDIR /app

# package.json コピーして依存関係インストール
COPY package*.json ./
RUN npm ci

# ソースコードコピー
COPY . .

# 開発サーバー起動
EXPOSE 3000
CMD ["npm", "run", "dev"]
```

#### Backend Dockerfile
```dockerfile
FROM node:18-alpine

WORKDIR /app

# package.json コピーして依存関係インストール
COPY package*.json ./
RUN npm ci

# Prisma クライアント生成
COPY prisma ./prisma/
RUN npx prisma generate

# ソースコードコピー
COPY . .

# サーバー起動
EXPOSE 8000
CMD ["npm", "run", "dev"]
```

## ⚙️ 開発環境セットアップ

### 初回セットアップ (setup.sh)
```bash
#!/bin/bash
set -e

echo "🚀 社内システム開発環境セットアップ開始"

# 1. workspace ディレクトリ作成
mkdir -p workspace

# 2. テンプレートから workspace にコピー
echo "📁 テンプレートコピー中..."
cp -r templates/* workspace/

# 3. workspace 内で Git 初期化
cd workspace
git init
git add .
git commit -m "初期プロジェクト構成"

# 4. Docker 環境起動
echo "🐳 Docker環境起動中..."
cd ../
docker-compose up -d

echo "✅ セットアップ完了！"
echo "🌐 フロントエンド: http://localhost:3000"
echo "🔧 バックエンド: http://localhost:8000"
echo "🗄️ データベース: localhost:5432"
```

### テンプレート更新 (init.sh)
```bash
#!/bin/bash
set -e

echo "🔄 テンプレート再コピー開始"

# 確認プロンプト
read -p "workspace の内容を上書きしますか？ (y/N): " confirm
if [[ $confirm != [yY] ]]; then
  echo "キャンセルしました"
  exit 0
fi

# テンプレートコピー
echo "📁 テンプレートコピー中..."
rm -rf workspace/*
cp -r templates/* workspace/

echo "✅ テンプレート更新完了"
```

## 🔧 開発ツール設定

### package.json (frontend)
```json
{
  "name": "websys-frontend",
  "scripts": {
    "dev": "vite --host 0.0.0.0 --port 3000",
    "build": "vue-tsc && vite build",
    "preview": "vite preview",
    "lint": "eslint . --ext .vue,.js,.jsx,.cjs,.mjs,.ts,.tsx,.cts,.mts",
    "lint:fix": "eslint . --ext .vue,.js,.jsx,.cjs,.mjs,.ts,.tsx,.cts,.mts --fix",
    "type-check": "vue-tsc --noEmit"
  },
  "dependencies": {
    "vue": "^3.4.0",
    "vue-router": "^4.2.0",
    "pinia": "^2.1.0",
    "element-plus": "^2.4.0",
    "@fontsource/biz-udgothic": "^5.2.7",
    "@fontsource/biz-udpgothic": "^5.2.8"
  },
  "devDependencies": {
    "typescript": "^5.0.0",
    "vite": "^5.0.0",
    "@vitejs/plugin-vue": "^4.5.0",
    "vue-tsc": "^1.8.0",
    "eslint": "^8.57.0",
    "@typescript-eslint/eslint-plugin": "^6.0.0"
  }
}
```

### vite.config.ts
```typescript
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import { resolve } from 'path'

export default defineConfig({
  plugins: [vue()],
  resolve: {
    alias: {
      '@': resolve(__dirname, 'src')
    }
  },
  server: {
    host: '0.0.0.0',
    port: 3000,
    proxy: {
      '/api': {
        target: 'http://backend:8000',
        changeOrigin: true
      }
    }
  },
  build: {
    outDir: 'dist',
    sourcemap: true,
    rollupOptions: {
      output: {
        manualChunks: {
          'element-plus': ['element-plus'],
          'vue-vendor': ['vue', 'vue-router', 'pinia']
        }
      }
    }
  }
})
```

## 📊 モニタリング・ログ設計

### ログ設計
```typescript
// ログレベル定義
enum LogLevel {
  ERROR = 'error',
  WARN = 'warn',
  INFO = 'info',
  DEBUG = 'debug'
}

// ログ構造
interface LogEntry {
  timestamp: string
  level: LogLevel
  message: string
  context?: Record<string, any>
  userId?: string
  sessionId?: string
}
```

### ヘルスチェック
```typescript
// /api/health エンドポイント
interface HealthStatus {
  status: 'healthy' | 'unhealthy'
  timestamp: string
  services: {
    database: 'up' | 'down'
    redis: 'up' | 'down'
    external_api: 'up' | 'down'
  }
  metrics: {
    memory_usage: number
    cpu_usage: number
    uptime: number
  }
}
```

## 🔒 セキュリティ設計

### 環境変数管理
```bash
# .env.example
NODE_ENV=development
DATABASE_URL=postgresql://user:password@localhost:5432/websys
JWT_SECRET=your-secret-key
API_PORT=8000
CORS_ORIGIN=http://localhost:3000
```

### セキュリティヘッダー
```typescript
// Express セキュリティ設定
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'", "fonts.googleapis.com"],
      fontSrc: ["'self'", "fonts.gstatic.com"],
      imgSrc: ["'self'", "data:", "https:"],
      scriptSrc: ["'self'"]
    }
  },
  hsts: {
    maxAge: 31536000,
    includeSubDomains: true,
    preload: true
  }
}))
```

## 🧪 テスト環境

### テスト構成
```yaml
# docker-compose.test.yml
version: '3.8'

services:
  frontend-test:
    build:
      context: ./workspace/frontend
      target: test
    command: npm run test
    environment:
      - NODE_ENV=test

  backend-test:
    build:
      context: ./workspace/backend
      target: test
    command: npm run test
    environment:
      - NODE_ENV=test
      - DATABASE_URL=postgresql://test:test@postgres-test:5432/websys_test

  postgres-test:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=test
      - POSTGRES_PASSWORD=test
      - POSTGRES_DB=websys_test
```

### E2Eテスト設定
```typescript
// playwright.config.ts
export default defineConfig({
  testDir: './tests/e2e',
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure'
  },
  projects: [
    { name: 'chrome', use: { ...devices['Desktop Chrome'] } },
    { name: 'firefox', use: { ...devices['Desktop Firefox'] } },
    { name: 'mobile', use: { ...devices['iPhone 12'] } }
  ],
  webServer: {
    command: 'docker-compose up',
    port: 3000,
    reuseExistingServer: !process.env.CI
  }
})
```

## 🚀 デプロイ・運用

### ビルド最適化
```typescript
// 本番ビルド設定
export default defineConfig({
  build: {
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: true,
        drop_debugger: true
      }
    },
    rollupOptions: {
      output: {
        manualChunks: {
          vendor: ['vue', 'vue-router', 'pinia'],
          ui: ['element-plus'],
          utils: ['axios', 'dayjs']
        }
      }
    }
  }
})
```

### 本番用 Docker
```dockerfile
# Multi-stage build
FROM node:18-alpine AS build
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

FROM node:18-alpine AS production
WORKDIR /app
COPY --from=build /app/node_modules ./node_modules
COPY . .
EXPOSE 3000
CMD ["npm", "start"]
```

## 📋 運用手順

### 日常運用コマンド
```bash
# 環境起動
docker-compose up -d

# 環境停止
docker-compose down

# ログ確認
docker-compose logs -f frontend
docker-compose logs -f backend

# データベース接続
docker-compose exec postgres psql -U user -d websys

# 環境リセット
docker-compose down -v
docker-compose up -d
```

### トラブルシューティング
```bash
# コンテナ状態確認
docker-compose ps

# リソース使用量確認
docker stats

# ネットワーク確認
docker network ls
docker network inspect websys_default
```

## 📊 実装状況

### 完了済み
- ✅ Docker Compose 環境構築
- ✅ フロントエンド・バックエンド分離
- ✅ 開発用ホットリロード
- ✅ PostgreSQL データベース
- ✅ セットアップスクリプト

### 今後の実装
- ⚠️ CI/CD パイプライン
- ⚠️ 本番環境用設定
- ⚠️ モニタリング・ログ集約
- ⚠️ 自動バックアップ
- ⚠️ セキュリティスキャン

## 📋 関連ドキュメント

- [全機能設計書](../機能一覧と01_概要.md)
- [共通コンポーネント設計書](../04_共通コンポーネント/)
- [レスポンシブ対応設計書](../05_レスポンシブ対応/)

---

**作成日**: 2025年1月20日
**最終更新**: 2025年1月20日
**作成者**: Claude
**レビュー者**: -