# å½¹è·ãƒ»æ¨©é™ä½“ç³»è¨­è¨ˆæ›¸

**ä½œæˆæ—¥**: 2025-10-05
**å¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ **: WebSys ç¤¾å†…ã‚·ã‚¹ãƒ†ãƒ åŸºç›¤
**å¯¾è±¡Phase**: Phase 3 - å½¹è·ãƒ»æ¨©é™ä½“ç³»ã®å†è¨­è¨ˆ
**é–¢é€£ã‚¿ã‚¹ã‚¯**: T014, T015, T016

---

## ğŸ“‹ ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [ç¾çŠ¶åˆ†æ](#ç¾çŠ¶åˆ†æ)
3. [T014: MANAGERæ¨©é™ã®å†å®šç¾©](#t014-manageræ¨©é™ã®å†å®šç¾©)
4. [T015: éƒ¨ç½²åˆ¥æ¨©é™ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ](#t015-éƒ¨ç½²åˆ¥æ¨©é™ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ)
5. [T016: ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ©Ÿèƒ½](#t016-ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ©Ÿèƒ½)
6. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ](#ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ)
7. [APIä»•æ§˜](#apiä»•æ§˜)
8. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–](#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–)
9. [å®Ÿè£…è¨ˆç”»](#å®Ÿè£…è¨ˆç”»)

---

## æ¦‚è¦

### ç›®çš„
ç¾è¡Œã®å½¹è·ãƒ»æ¨©é™ä½“ç³»ã‚’å†è¨­è¨ˆã—ã€ä»¥ä¸‹ã®èª²é¡Œã‚’è§£æ±ºã—ã¾ã™ï¼š

1. **MANAGERæ¨©é™ã®æ›–æ˜§æ€§**: ç¾åœ¨ã®MANAGERæ¨©é™ã®å…·ä½“çš„ãªæ¨©é™ç¯„å›²ãŒä¸æ˜ç¢º
2. **éƒ¨ç½²åˆ¥æ¨©é™è¨­å®šã®éåŠ¹ç‡æ€§**: éƒ¨ç½²ã”ã¨ã«å€‹åˆ¥è¨­å®šãŒå¿…è¦ã§ç®¡ç†ãŒç…©é›‘
3. **å¤–éƒ¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œã®æ¬ å¦‚**: ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ©Ÿèƒ½ãŒæœªå®Ÿè£…

### å¯¾è±¡ç¯„å›²
- **T014**: MANAGERæ¨©é™ã®æ˜ç¢ºãªå®šç¾©ãƒ»æ¨©é™ãƒãƒˆãƒªã‚¯ã‚¹ä½œæˆ
- **T015**: éƒ¨ç½²åˆ¥ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ¨©é™ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆãƒ»è‡ªå‹•é©ç”¨
- **T016**: ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ©Ÿèƒ½å®Ÿè£…ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶ç´„

### æœŸå¾…åŠ¹æœ
- âœ… æ¨©é™ç®¡ç†ã®æ˜ç¢ºåŒ–ãƒ»å±äººåŒ–æ’é™¤
- âœ… æ–°è¦éƒ¨ç½²ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ ã®åŠ¹ç‡åŒ–ï¼ˆ80%æ™‚é–“å‰Šæ¸›ï¼‰
- âœ… å¤–éƒ¨å”åŠ›è€…ãƒ»ç›£æŸ»å¯¾å¿œã®å®Ÿç¾
- âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ä½æ¸›

---

## ç¾çŠ¶åˆ†æ

### ç¾è¡Œå½¹è·ä½“ç³»ï¼ˆUserRole enumï¼‰
```prisma
enum UserRole {
  ADMIN    // ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…
  USER     // ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼
  GUEST    // ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆæœªå®Ÿè£…ï¼‰
  MANAGER  // ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼ˆæ¨©é™ä¸æ˜ç¢ºï¼‰
}
```

### ç¾çŠ¶ã®å•é¡Œç‚¹

#### 1. MANAGERæ¨©é™ã®æ›–æ˜§æ€§
| é …ç›® | ç¾çŠ¶ | å•é¡Œ |
|------|------|------|
| **å®šç¾©** | ã€Œãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã€ã®ã¿ | å…·ä½“çš„æ¨©é™ãŒä¸æ˜ |
| **ä½¿ç”¨ç®‡æ‰€** | seed.tsã€ApprovalService.tsç­‰ | å®Ÿè£…ãŒãƒãƒ©ãƒãƒ© |
| **æ¨©é™ç¯„å›²** | æš—é»™çš„ã«ã€Œéƒ¨ç½²ç®¡ç†è€…ã€æ‰±ã„ | æ˜æ–‡åŒ–ã•ã‚Œã¦ã„ãªã„ |
| **ADMINã¨ã®é•ã„** | ä¸æ˜ç¢º | æ¨©é™é‡è¤‡ã®å¯èƒ½æ€§ |

**å…·ä½“ä¾‹ï¼ˆç¾è¡Œã‚³ãƒ¼ãƒ‰ï¼‰**:
```typescript
// ApprovalService.ts:185
if (user.role === 'MANAGER') {
  // æš—é»™çš„ã«ã€Œéƒ¨ç½²ã®æ‰¿èªè€…ã€ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹
  // å…·ä½“çš„ã«ã©ã®æ¨©é™ãŒã‚ã‚‹ã‹ã¯ä¸æ˜
}

// EmergencyApprovalService.ts:40
if (admin.role !== 'ADMIN') {
  // MANAGERã¯ç·Šæ€¥æ‰¿èªä¸å¯
  // ã—ã‹ã—ã€Œéƒ¨ç½²å†…ã®ç·Šæ€¥æ“ä½œã¯å¯èƒ½ã€ç­‰ã®å®šç¾©ãŒãªã„
}
```

#### 2. éƒ¨ç½²åˆ¥æ¨©é™è¨­å®šã®éåŠ¹ç‡æ€§
| é …ç›® | ç¾çŠ¶ | å•é¡Œ |
|------|------|------|
| **æ–°è¦éƒ¨ç½²ä½œæˆæ™‚** | æ‰‹å‹•ã§æ¨©é™è¨­å®š | è¨­å®šæ¼ã‚Œãƒªã‚¹ã‚¯ |
| **æ¨©é™ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ** | ã‚ã‚Šï¼ˆpermission_templatesï¼‰ | è‡ªå‹•é©ç”¨ãªã— |
| **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ¨©é™** | ãªã— | æ¯å›å€‹åˆ¥è¨­å®š |
| **ä¸€è²«æ€§** | éƒ¨ç½²é–“ã§ãƒãƒ©ã¤ã | æ¨™æº–åŒ–å›°é›£ |

**ç¾çŠ¶ãƒ•ãƒ­ãƒ¼**:
```
1. éƒ¨ç½²ä½œæˆ
2. æ‰‹å‹•ã§ permission_templates é¸æŠ
3. æ‰‹å‹•ã§ features ä¸€ã¤ãšã¤è¨­å®š
4. ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ æ™‚ã‚‚åŒæ§˜ã«æ‰‹å‹•è¨­å®š
â†’ æ™‚é–“ãŒã‹ã‹ã‚Šã€è¨­å®šãƒŸã‚¹ã®æ¸©åºŠ
```

#### 3. ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ©Ÿèƒ½ã®æœªå®Ÿè£…
| é …ç›® | ç¾çŠ¶ | å•é¡Œ |
|------|------|------|
| **GUEST enum** | å®šç¾©ã®ã¿å­˜åœ¨ | å®Ÿè£…ãªã— |
| **å¤–éƒ¨ãƒ¦ãƒ¼ã‚¶ãƒ¼** | å¯¾å¿œä¸å¯ | ç›£æŸ»ãƒ»å”åŠ›è€…æ‹›å¾…ä¸å¯ |
| **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶ç´„** | ãªã— | ãƒªã‚¹ã‚¯ç®¡ç†ä¸å¯ |
| **æœ‰åŠ¹æœŸé™** | ãªã— | ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ”¾ç½®ãƒªã‚¹ã‚¯ |

---

## T014: MANAGERæ¨©é™ã®å†å®šç¾©

### è¨­è¨ˆæ–¹é‡

#### 1. MANAGERæ¨©é™ã®æ˜ç¢ºãªå®šç¾©
MANAGERã¯ã€Œéƒ¨ç½²ç®¡ç†è€…ã€ã¨ã—ã¦ä»¥ä¸‹ã®æ¨©é™ã‚’æŒã¡ã¾ã™ï¼š

| æ¨©é™ã‚«ãƒ†ã‚´ãƒª | æ¨©é™å†…å®¹ | ADMIN | MANAGER | USER |
|-------------|---------|-------|---------|------|
| **ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ç®¡ç†** | å…¨ç¤¾è¨­å®šãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† | âœ… | âŒ | âŒ |
| **éƒ¨ç½²ç®¡ç†** | è‡ªéƒ¨ç½²ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç† | âœ… | âœ… | âŒ |
| **éƒ¨ç½²æ¨©é™è¨­å®š** | è‡ªéƒ¨ç½²æ¨©é™å¤‰æ›´ | âœ… | âœ… | âŒ |
| **æ‰¿èªç®¡ç†** | è‡ªéƒ¨ç½²æ‰¿èªãƒ«ãƒ¼ãƒˆè¨­å®š | âœ… | âœ… | âŒ |
| **ãƒ¬ãƒãƒ¼ãƒˆé–²è¦§** | è‡ªéƒ¨ç½²ãƒ¬ãƒãƒ¼ãƒˆ | âœ… | âœ… | âŒ |
| **å…¨ç¤¾ãƒ¬ãƒãƒ¼ãƒˆ** | å…¨éƒ¨ç½²çµ±è¨ˆ | âœ… | âŒ | âŒ |
| **ç·Šæ€¥æ‰¿èª** | ç·Šæ€¥æ™‚ç›´æ¥æ“ä½œ | âœ… | âš ï¸ è‡ªéƒ¨ç½²ã®ã¿ | âŒ |
| **ç›£æŸ»ãƒ­ã‚°** | å…¨ãƒ­ã‚°é–²è¦§ | âœ… | âš ï¸ è‡ªéƒ¨ç½²ã®ã¿ | âŒ |
| **ã‚·ã‚¹ãƒ†ãƒ è¨­å®š** | å…¨ä½“è¨­å®šå¤‰æ›´ | âœ… | âŒ | âŒ |

**å‡¡ä¾‹**:
- âœ…: æ¨©é™ã‚ã‚Šï¼ˆå…¨ç¯„å›²ï¼‰
- âš ï¸: æ¡ä»¶ä»˜ãæ¨©é™ï¼ˆã‚¹ã‚³ãƒ¼ãƒ—åˆ¶é™ï¼‰
- âŒ: æ¨©é™ãªã—

#### 2. ã‚¹ã‚³ãƒ¼ãƒ—åˆ¶é™ã®å®Ÿè£…

**éƒ¨ç½²ã‚¹ã‚³ãƒ¼ãƒ—åˆ¶å¾¡**:
```typescript
// æ–°è¦å®Ÿè£…: RolePermissionService.ts
export class RolePermissionService {
  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ã‚¹ã‚³ãƒ¼ãƒ—ã‚’å–å¾—
   */
  async getUserPermissionScope(userId: number): Promise<{
    role: UserRole
    scope: 'GLOBAL' | 'DEPARTMENT' | 'SELF'
    departmentIds: number[]
  }> {
    // âœ… N+1ã‚¯ã‚¨ãƒªå¯¾ç­–: includeã§user_departmentsã‚’1ã‚¯ã‚¨ãƒªã§å–å¾—
    // ã€€ è¤‡æ•°éƒ¨ç½²æ‰€å±ã®å ´åˆã§ã‚‚JOINã§ä¸€åº¦ã«å–å¾—ã—ã€N+1å•é¡Œã‚’é˜²æ­¢
    const user = await prisma.users.findUnique({
      where: { id: userId },
      include: { user_departments: true }
    })

    if (user.role === 'ADMIN') {
      return {
        role: 'ADMIN',
        scope: 'GLOBAL',
        departmentIds: [] // å…¨éƒ¨ç½²ã‚¢ã‚¯ã‚»ã‚¹å¯
      }
    }

    if (user.role === 'MANAGER') {
      return {
        role: 'MANAGER',
        scope: 'DEPARTMENT',
        departmentIds: user.user_departments.map(ud => ud.departmentId)
      }
    }

    return {
      role: 'USER',
      scope: 'SELF',
      departmentIds: []
    }
  }

  /**
   * æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¹ã‚³ãƒ¼ãƒ—è€ƒæ…®ï¼‰
   */
  async checkPermission(
    userId: number,
    action: string,
    targetDepartmentId?: number
  ): Promise<boolean> {
    const scope = await this.getUserPermissionScope(userId)

    // ADMIN: å…¨æ¨©é™
    if (scope.role === 'ADMIN') {
      return true
    }

    // MANAGER: è‡ªéƒ¨ç½²ã®ã¿
    if (scope.role === 'MANAGER') {
      if (!targetDepartmentId) {
        return false // éƒ¨ç½²æŒ‡å®šãªã—ã¯æ‹’å¦
      }
      return scope.departmentIds.includes(targetDepartmentId)
    }

    // USER: è‡ªåˆ†ã®ã¿
    return false
  }
}
```

#### 3. æ©Ÿèƒ½åˆ¥æ¨©é™ãƒãƒˆãƒªã‚¯ã‚¹

**ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†**:
| æ©Ÿèƒ½ | ADMIN | MANAGER | USER |
|------|-------|---------|------|
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ | å…¨ç¤¾ | è‡ªéƒ¨ç½² | ä¸å¯ |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›† | å…¨ç¤¾ | è‡ªéƒ¨ç½² | è‡ªåˆ†ã®ã¿ |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ | å…¨ç¤¾ | è‡ªéƒ¨ç½² | ä¸å¯ |
| ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ | å…¨ç¤¾ | è‡ªéƒ¨ç½² | è‡ªåˆ†ã®ã¿ |
| å½¹è·å¤‰æ›´ | å…¨ç¤¾ | ä¸å¯ | ä¸å¯ |

**ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç®¡ç†**:
| æ©Ÿèƒ½ | ADMIN | MANAGER | USER |
|------|-------|---------|------|
| ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä½œæˆ | å…¨ç¤¾ | è‡ªéƒ¨ç½² | ä¸å¯ |
| æ‰¿èªãƒ«ãƒ¼ãƒˆè¨­å®š | å…¨ç¤¾ | è‡ªéƒ¨ç½² | ä¸å¯ |
| ç·Šæ€¥æ‰¿èªå®Ÿè¡Œ | å…¨ç¤¾ | è‡ªéƒ¨ç½² | ä¸å¯ |
| å§”ä»»è¨­å®šé–²è¦§ | å…¨ç¤¾ | è‡ªéƒ¨ç½² | è‡ªåˆ†ã®ã¿ |
| è‡ªå‹•æ‰¿èªãƒ«ãƒ¼ãƒ« | å…¨ç¤¾ | è‡ªéƒ¨ç½² | ä¸å¯ |

**ãƒ¬ãƒãƒ¼ãƒˆãƒ»ç›£æŸ»**:
| æ©Ÿèƒ½ | ADMIN | MANAGER | USER |
|------|-------|---------|------|
| ç›£æŸ»ãƒ­ã‚°é–²è¦§ | å…¨ç¤¾ | è‡ªéƒ¨ç½² | ä¸å¯ |
| çµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆ | å…¨ç¤¾ | è‡ªéƒ¨ç½² | ä¸å¯ |
| ãƒ­ã‚°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ | å…¨ç¤¾ | è‡ªéƒ¨ç½² | ä¸å¯ |
| ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š | å…¨ç¤¾ | è‡ªéƒ¨ç½² | ä¸å¯ |

#### 4. APIå®Ÿè£…ä¾‹

**æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢æ‹¡å¼µ**:
```typescript
// æ–°è¦: middleware/roleScope.ts
import { Request, Response, NextFunction } from 'express'
import { RolePermissionService } from '../services/RolePermissionService'

const roleService = new RolePermissionService()

/**
 * éƒ¨ç½²ã‚¹ã‚³ãƒ¼ãƒ—ãƒã‚§ãƒƒã‚¯ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
 */
export const checkDepartmentScope = (action: string) => {
  return async (req: Request, res: Response, next: NextFunction) => {
    try {
      const userId = (req as any).user.id
      const targetDepartmentId = req.params.departmentId
        ? parseInt(req.params.departmentId)
        : req.body.departmentId

      const hasPermission = await roleService.checkPermission(
        userId,
        action,
        targetDepartmentId
      )

      if (!hasPermission) {
        return res.status(403).json({
          success: false,
          error: {
            code: 'DEPARTMENT_SCOPE_DENIED',
            message: 'æŒ‡å®šã•ã‚ŒãŸéƒ¨ç½²ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“'
          }
        })
      }

      next()
    } catch (error) {
      next(error)
    }
  }
}

/**
 * ä½¿ç”¨ä¾‹
 */
router.post(
  '/users',
  authenticate,
  checkDepartmentScope('USER_CREATE'),
  UserController.create
)

router.put(
  '/departments/:departmentId/permissions',
  authenticate,
  checkDepartmentScope('PERMISSION_UPDATE'),
  PermissionController.update
)
```

---

## T015: éƒ¨ç½²åˆ¥æ¨©é™ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

### è¨­è¨ˆæ–¹é‡

#### 1. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ¨©é™ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½“ç³»

**ãƒ—ãƒªã‚»ãƒƒãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆ5ç¨®é¡ï¼‰**:

| ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå | å¯¾è±¡éƒ¨ç½² | æ¨©é™ãƒ¬ãƒ™ãƒ« | ä¸»è¦æ©Ÿèƒ½ |
|--------------|---------|-----------|---------|
| **ADMIN_DEPT** | æƒ…å ±ã‚·ã‚¹ãƒ†ãƒ éƒ¨ | æœ€é«˜ | å…¨æ©Ÿèƒ½ã‚¢ã‚¯ã‚»ã‚¹ãƒ»ã‚·ã‚¹ãƒ†ãƒ è¨­å®š |
| **SALES_DEPT** | å–¶æ¥­éƒ¨ | é«˜ | é¡§å®¢ç®¡ç†ãƒ»è¦‹ç©ãƒ»å—æ³¨ãƒ»ãƒ¬ãƒãƒ¼ãƒˆ |
| **HR_DEPT** | äººäº‹éƒ¨ | é«˜ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ»æ¨©é™è¨­å®šãƒ»ç›£æŸ» |
| **FINANCE_DEPT** | çµŒç†éƒ¨ | ä¸­ | è²¡å‹™ãƒ¬ãƒãƒ¼ãƒˆãƒ»æ‰¿èªãƒ»ç›£æŸ»ãƒ­ã‚° |
| **GENERAL_DEPT** | ä¸€èˆ¬éƒ¨ç½² | ä½ | åŸºæœ¬æ©Ÿèƒ½ã®ã¿ |

#### 2. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè©³ç´°è¨­è¨ˆ

**ADMIN_DEPTï¼ˆæƒ…å ±ã‚·ã‚¹ãƒ†ãƒ éƒ¨ï¼‰**:
```json
{
  "name": "æƒ…å ±ã‚·ã‚¹ãƒ†ãƒ éƒ¨æ¨©é™",
  "category": "PRESET",
  "description": "ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†éƒ¨ç½²å‘ã‘ã®å…¨æ¨©é™ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ",
  "features": [
    { "featureCode": "USER_MGMT", "canView": true, "canCreate": true, "canEdit": true, "canDelete": true },
    { "featureCode": "DEPT_MGMT", "canView": true, "canCreate": true, "canEdit": true, "canDelete": true },
    { "featureCode": "PERMISSION", "canView": true, "canCreate": true, "canEdit": true, "canDelete": true },
    { "featureCode": "WORKFLOW", "canView": true, "canCreate": true, "canEdit": true, "canDelete": true },
    { "featureCode": "AUDIT", "canView": true, "canCreate": false, "canEdit": false, "canDelete": false },
    { "featureCode": "LOG", "canView": true, "canCreate": false, "canEdit": false, "canDelete": true },
    { "featureCode": "REPORT", "canView": true, "canCreate": true, "canEdit": true, "canDelete": true },
    { "featureCode": "SYSTEM", "canView": true, "canCreate": true, "canEdit": true, "canDelete": true }
  ]
}
```

**SALES_DEPTï¼ˆå–¶æ¥­éƒ¨ï¼‰**:
```json
{
  "name": "å–¶æ¥­éƒ¨æ¨©é™",
  "category": "PRESET",
  "description": "å–¶æ¥­éƒ¨é–€å‘ã‘ã®æ¨™æº–æ¨©é™ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ",
  "features": [
    { "featureCode": "USER_MGMT", "canView": true, "canCreate": false, "canEdit": false, "canDelete": false },
    { "featureCode": "CUSTOMER", "canView": true, "canCreate": true, "canEdit": true, "canDelete": false },
    { "featureCode": "QUOTATION", "canView": true, "canCreate": true, "canEdit": true, "canDelete": false },
    { "featureCode": "ORDER", "canView": true, "canCreate": true, "canEdit": true, "canDelete": false },
    { "featureCode": "WORKFLOW", "canView": true, "canCreate": true, "canEdit": false, "canDelete": false },
    { "featureCode": "REPORT", "canView": true, "canCreate": true, "canEdit": false, "canDelete": false }
  ]
}
```

**HR_DEPTï¼ˆäººäº‹éƒ¨ï¼‰**:
```json
{
  "name": "äººäº‹éƒ¨æ¨©é™",
  "category": "PRESET",
  "description": "äººäº‹éƒ¨é–€å‘ã‘ã®æ¨©é™ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ",
  "features": [
    { "featureCode": "USER_MGMT", "canView": true, "canCreate": true, "canEdit": true, "canDelete": true },
    { "featureCode": "DEPT_MGMT", "canView": true, "canCreate": true, "canEdit": true, "canDelete": false },
    { "featureCode": "PERMISSION", "canView": true, "canCreate": true, "canEdit": true, "canDelete": false },
    { "featureCode": "AUDIT", "canView": true, "canCreate": false, "canEdit": false, "canDelete": false },
    { "featureCode": "REPORT", "canView": true, "canCreate": true, "canEdit": false, "canDelete": false }
  ]
}
```

**FINANCE_DEPTï¼ˆçµŒç†éƒ¨ï¼‰**:
```json
{
  "name": "çµŒç†éƒ¨æ¨©é™",
  "category": "PRESET",
  "description": "çµŒç†éƒ¨é–€å‘ã‘ã®æ¨©é™ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ",
  "features": [
    { "featureCode": "FINANCIAL", "canView": true, "canCreate": true, "canEdit": true, "canDelete": false },
    { "featureCode": "WORKFLOW", "canView": true, "canCreate": true, "canEdit": false, "canDelete": false },
    { "featureCode": "AUDIT", "canView": true, "canCreate": false, "canEdit": false, "canDelete": false },
    { "featureCode": "REPORT", "canView": true, "canCreate": true, "canEdit": false, "canDelete": false }
  ]
}
```

**GENERAL_DEPTï¼ˆä¸€èˆ¬éƒ¨ç½²ï¼‰**:
```json
{
  "name": "ä¸€èˆ¬éƒ¨ç½²æ¨©é™",
  "category": "PRESET",
  "description": "ä¸€èˆ¬éƒ¨ç½²å‘ã‘ã®æœ€å°æ¨©é™ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ",
  "features": [
    { "featureCode": "WORKFLOW", "canView": true, "canCreate": true, "canEdit": false, "canDelete": false },
    { "featureCode": "REPORT", "canView": true, "canCreate": false, "canEdit": false, "canDelete": false }
  ]
}
```

#### 3. è‡ªå‹•é©ç”¨ãƒ­ã‚¸ãƒƒã‚¯

**æ–°è¦éƒ¨ç½²ä½œæˆæ™‚ã®è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé©ç”¨**:
```typescript
// æ–°è¦å®Ÿè£…: services/DepartmentTemplateService.ts
export class DepartmentTemplateService {
  /**
   * éƒ¨ç½²åã‹ã‚‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è‡ªå‹•æ¨å®š
   */
  private detectTemplateByName(departmentName: string): string {
    const mappings = {
      'ADMIN_DEPT': ['æƒ…å ±ã‚·ã‚¹ãƒ†ãƒ ', 'IT', 'ã‚·ã‚¹ãƒ†ãƒ ', 'ã‚¤ãƒ³ãƒ•ãƒ©'],
      'SALES_DEPT': ['å–¶æ¥­', 'ã‚»ãƒ¼ãƒ«ã‚¹', 'è²©å£²'],
      'HR_DEPT': ['äººäº‹', 'ç·å‹™', 'åŠ´å‹™'],
      'FINANCE_DEPT': ['çµŒç†', 'è²¡å‹™', 'ä¼šè¨ˆ'],
      'GENERAL_DEPT': [] // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
    }

    for (const [template, keywords] of Object.entries(mappings)) {
      for (const keyword of keywords) {
        if (departmentName.includes(keyword)) {
          return template
        }
      }
    }

    return 'GENERAL_DEPT' // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
  }

  /**
   * æ–°è¦éƒ¨ç½²ä½œæˆæ™‚ã®è‡ªå‹•æ¨©é™è¨­å®š
   */
  async createDepartmentWithTemplate(data: {
    companyId: number
    name: string
    code: string
    parentId?: number
    autoApplyTemplate?: boolean
    templateOverride?: string
  }): Promise<Department> {
    const { companyId, name, code, parentId, autoApplyTemplate = true, templateOverride } = data

    // 1. éƒ¨ç½²ä½œæˆ
    const department = await prisma.departments.create({
      data: {
        companyId,
        name,
        code,
        parentId,
        isActive: true
      }
    })

    // 2. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè‡ªå‹•é©ç”¨
    if (autoApplyTemplate) {
      const templateName = templateOverride || this.detectTemplateByName(name)
      const template = await prisma.permission_templates.findFirst({
        where: {
          companyId,
          category: 'PRESET',
          name: { contains: templateName }
        },
        include: { permission_template_features: true }
      })

      if (template) {
        // æ¨©é™è‡ªå‹•è¨­å®š
        await this.applyTemplateToDéƒ¨ç½²(department.id, template.id)

        console.log(`âœ… éƒ¨ç½²ã€Œ${name}ã€ã«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ${template.name}ã€ã‚’è‡ªå‹•é©ç”¨ã—ã¾ã—ãŸ`)
      } else {
        console.warn(`âš ï¸ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ${templateName}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é©ç”¨ã—ã¾ã™ã€‚`)
        await this.applyDefaultTemplate(department.id, companyId)
      }
    }

    return department
  }

  /**
   * ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé©ç”¨
   */
  private async applyDefaultTemplate(departmentId: number, companyId: number): Promise<void> {
    const defaultTemplate = await prisma.permission_templates.findFirst({
      where: {
        companyId,
        category: 'PRESET',
        name: { contains: 'GENERAL' }
      },
      include: { permission_template_features: true }
    })

    if (defaultTemplate) {
      await this.applyTemplateToDepartment(departmentId, defaultTemplate.id)
    }
  }

  /**
   * ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé©ç”¨å®Ÿè¡Œ
   */
  private async applyTemplateToDepartment(
    departmentId: number,
    templateId: number
  ): Promise<void> {
    const template = await prisma.permission_templates.findUnique({
      where: { id: templateId },
      include: {
        permission_template_features: {
          include: { features: true }
        }
      }
    })

    if (!template) {
      throw new Error('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')
    }

    // æ—¢å­˜æ¨©é™å‰Šé™¤
    await prisma.department_feature_permissions.deleteMany({
      where: { departmentId }
    })

    // æ–°è¦æ¨©é™ä½œæˆ
    const permissions = template.permission_template_features.map(ptf => ({
      departmentId,
      featureId: ptf.featureId,
      canView: ptf.canView,
      canCreate: ptf.canCreate,
      canEdit: ptf.canEdit,
      canDelete: ptf.canDelete,
      createdAt: new Date(),
      updatedAt: new Date()
    }))

    await prisma.department_feature_permissions.createMany({
      data: permissions
    })

    // ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²
    await prisma.audit_logs.create({
      data: {
        action: 'TEMPLATE_APPLIED',
        targetType: 'DEPARTMENT',
        targetId: departmentId,
        details: {
          templateId,
          templateName: template.name,
          permissionsCount: permissions.length
        }
      }
    })
  }
}
```

#### 4. ç®¡ç†UIè¨­è¨ˆ

**éƒ¨ç½²ä½œæˆç”»é¢ã®æ”¹å–„**:
```vue
<!-- æ–°è¦å®Ÿè£…: components/DepartmentCreateDialog.vue -->
<template>
  <el-dialog title="æ–°è¦éƒ¨ç½²ä½œæˆ" v-model="visible">
    <el-form :model="form" label-width="150px">
      <el-form-item label="éƒ¨ç½²å" required>
        <el-input v-model="form.name" @input="onNameChange" />
      </el-form-item>

      <el-form-item label="éƒ¨ç½²ã‚³ãƒ¼ãƒ‰" required>
        <el-input v-model="form.code" />
      </el-form-item>

      <el-form-item label="è¦ªéƒ¨ç½²">
        <el-select v-model="form.parentId" clearable>
          <el-option
            v-for="dept in departments"
            :key="dept.id"
            :label="dept.name"
            :value="dept.id"
          />
        </el-select>
      </el-form-item>

      <el-divider />

      <el-form-item label="æ¨©é™ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ">
        <el-radio-group v-model="templateMode">
          <el-radio label="auto">è‡ªå‹•æ¨å®š</el-radio>
          <el-radio label="manual">æ‰‹å‹•é¸æŠ</el-radio>
          <el-radio label="none">å¾Œã§è¨­å®š</el-radio>
        </el-radio-group>
      </el-form-item>

      <!-- è‡ªå‹•æ¨å®šæ™‚ -->
      <el-alert
        v-if="templateMode === 'auto' && detectedTemplate"
        type="info"
        :closable="false"
        show-icon
      >
        <template #title>
          æ¨å®šã•ã‚ŒãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: {{ detectedTemplate.name }}
        </template>
        <div>{{ detectedTemplate.description }}</div>
        <div class="mt-2">
          <el-tag
            v-for="feature in detectedTemplate.features"
            :key="feature.code"
            size="small"
            class="mr-1"
          >
            {{ feature.name }}
          </el-tag>
        </div>
      </el-alert>

      <!-- æ‰‹å‹•é¸æŠæ™‚ -->
      <el-form-item v-if="templateMode === 'manual'" label="ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ">
        <el-select v-model="form.templateId">
          <el-option
            v-for="template in templates"
            :key="template.id"
            :label="template.name"
            :value="template.id"
          >
            <div>{{ template.name }}</div>
            <div class="text-xs text-gray-500">{{ template.description }}</div>
          </el-option>
        </el-select>
      </el-form-item>
    </el-form>

    <template #footer>
      <el-button @click="visible = false">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</el-button>
      <el-button type="primary" @click="handleSubmit">ä½œæˆ</el-button>
    </template>
  </el-dialog>
</template>

<script setup lang="ts">
import { ref, computed, watch } from 'vue'

const templateMode = ref<'auto' | 'manual' | 'none'>('auto')
const form = ref({
  name: '',
  code: '',
  parentId: null,
  templateId: null
})

const detectedTemplate = ref(null)

const onNameChange = () => {
  if (templateMode.value === 'auto') {
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè‡ªå‹•æ¨å®š
    detectTemplate(form.value.name)
  }
}

const detectTemplate = async (name: string) => {
  const response = await fetch('/api/templates/detect', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ departmentName: name })
  })
  detectedTemplate.value = await response.json()
}

const handleSubmit = async () => {
  const data = {
    ...form.value,
    autoApplyTemplate: templateMode.value !== 'none',
    templateOverride: templateMode.value === 'manual' ? form.value.templateId : null
  }

  await fetch('/api/departments', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })

  ElMessage.success('éƒ¨ç½²ã‚’ä½œæˆã—ã€æ¨©é™ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é©ç”¨ã—ã¾ã—ãŸ')
  visible.value = false
}
</script>
```

---

## T016: ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ©Ÿèƒ½

### è¨­è¨ˆæ–¹é‡

#### 1. ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å®šç¾©

**ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆGUESTï¼‰ã®ç‰¹æ€§**:
| é …ç›® | å†…å®¹ |
|------|------|
| **ç›®çš„** | å¤–éƒ¨å”åŠ›è€…ãƒ»ç›£æŸ»æ³•äººãƒ»ä¸€æ™‚çš„ãªã‚¢ã‚¯ã‚»ã‚¹æä¾› |
| **æ¨©é™ãƒ¬ãƒ™ãƒ«** | æœ€å°æ¨©é™ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ãŒåŸºæœ¬ï¼‰ |
| **æœ‰åŠ¹æœŸé™** | å¿…é ˆï¼ˆæœ€å¤§90æ—¥ï¼‰ |
| **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£** | å³æ ¼ãªåˆ¶ç´„ãƒ»ç›£æŸ»ãƒ­ã‚°å®Œå…¨è¨˜éŒ² |
| **éƒ¨ç½²æ‰€å±** | ä¸å¯ï¼ˆã‚²ã‚¹ãƒˆå°‚ç”¨ã‚°ãƒ«ãƒ¼ãƒ—ï¼‰ |
| **æ‰¿èªæ¨©é™** | ãªã— |
| **ãƒ‡ãƒ¼ã‚¿ä½œæˆ** | åŸå‰‡ä¸å¯ |

#### 2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶ç´„

**ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¶ç´„ä¸€è¦§**:
```typescript
// æ–°è¦å®Ÿè£…: middleware/guestRestrictions.ts
export const GUEST_RESTRICTIONS = {
  // ç¦æ­¢æ“ä½œ
  FORBIDDEN_ACTIONS: [
    'USER_CREATE',
    'USER_DELETE',
    'DEPT_CREATE',
    'DEPT_DELETE',
    'PERMISSION_EDIT',
    'SYSTEM_SETTING',
    'WORKFLOW_APPROVE',
    'DATA_DELETE',
    'DATA_EXPORT_ALL'
  ],

  // è¨±å¯æ“ä½œï¼ˆæ˜ç¤ºçš„ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆï¼‰
  ALLOWED_ACTIONS: [
    'DATA_VIEW',
    'REPORT_VIEW',
    'AUDIT_VIEW_LIMITED', // è‡ªåˆ†ã®ãƒ­ã‚°ã®ã¿
    'PROFILE_EDIT_SELF'
  ],

  // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
  SECURITY: {
    MAX_VALIDITY_DAYS: 90,        // æœ€å¤§æœ‰åŠ¹æœŸé™
    SESSION_TIMEOUT_MINUTES: 30,  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆé€šå¸¸60åˆ†ï¼‰
    MFA_REQUIRED: true,            // å¤šè¦ç´ èªè¨¼å¿…é ˆ
    IP_WHITELIST_REQUIRED: false,  // IPåˆ¶é™ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    AUDIT_LOG_DETAIL: 'FULL',      // ç›£æŸ»ãƒ­ã‚°è©³ç´°åº¦ï¼ˆæœ€å¤§ï¼‰
    PASSWORD_RESET_FORBIDDEN: true // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆä¸å¯ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰
  },

  // ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™
  ACCESS_LIMITS: {
    MAX_LOGIN_ATTEMPTS: 3,         // æœ€å¤§ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œå›æ•°
    LOCKOUT_DURATION_MINUTES: 60,  // ãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ™‚é–“
    MAX_CONCURRENT_SESSIONS: 1,    // åŒæ™‚ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°
    DOWNLOAD_SIZE_LIMIT_MB: 10     // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸Šé™
  }
}
```

#### 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ‹¡å¼µ

**ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼å°‚ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«**:
```prisma
// è¿½åŠ : schema.prisma
model guest_users {
  id                  Int       @id @default(autoincrement())
  userId              Int       @unique
  invitedBy           Int       // æ‹›å¾…è€…
  organization        String?   // æ‰€å±çµ„ç¹”
  purpose             String    // åˆ©ç”¨ç›®çš„
  validFrom           DateTime  @default(now())
  validUntil          DateTime  // æœ‰åŠ¹æœŸé™ï¼ˆå¿…é ˆï¼‰
  ipWhitelist         String[]  // IPåˆ¶é™ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  allowedFeatures     String[]  // è¨±å¯æ©Ÿèƒ½ã‚³ãƒ¼ãƒ‰
  isActive            Boolean   @default(true)
  lastAccessAt        DateTime?
  accessCount         Int       @default(0)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  users               users     @relation(fields: [userId], references: [id])
  inviter             users     @relation("guest_inviter", fields: [invitedBy], references: [id])

  @@index([userId])
  @@index([validUntil])
  @@index([isActive])
}

// ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ï¼ˆæ—¢å­˜æ‹¡å¼µï¼‰
model security_events {
  id         Int      @id @default(autoincrement())
  userId     Int
  eventType  String   // LOGIN_ATTEMPT, ACCESS_DENIED, etc.
  severity   String   // LOW, MEDIUM, HIGH, CRITICAL
  ipAddress  String?
  userAgent  String?
  details    Json?
  createdAt  DateTime @default(now())

  users      users    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([eventType])
  @@index([severity])
  @@index([createdAt])
}
```

#### 4. ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ‹›å¾…ãƒ•ãƒ­ãƒ¼

**å®Ÿè£…: GuestUserService.ts**:
```typescript
export class GuestUserService {
  /**
   * ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ‹›å¾…
   */
  async inviteGuest(data: {
    email: string
    name: string
    organization?: string
    purpose: string
    validDays: number // 1-90æ—¥
    allowedFeatures: string[]
    invitedBy: number
  }): Promise<GuestInvitation> {
    const { email, name, organization, purpose, validDays, allowedFeatures, invitedBy } = data

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (validDays < 1 || validDays > GUEST_RESTRICTIONS.SECURITY.MAX_VALIDITY_DAYS) {
      throw new Error(`æœ‰åŠ¹æœŸé™ã¯1ã€œ${GUEST_RESTRICTIONS.SECURITY.MAX_VALIDITY_DAYS}æ—¥ä»¥å†…ã§è¨­å®šã—ã¦ãã ã•ã„`)
    }

    // æ‹›å¾…è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
    const inviter = await prisma.users.findUnique({
      where: { id: invitedBy }
    })

    if (!inviter || !['ADMIN', 'MANAGER'].includes(inviter.role)) {
      throw new Error('ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‹›å¾…ã¯ADMINã¾ãŸã¯MANAGERæ¨©é™ãŒå¿…è¦ã§ã™')
    }

    // 1. ä¸€æ™‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ
    const tempPassword = this.generateSecurePassword(16)
    const hashedPassword = await bcrypt.hash(tempPassword, 10)

    // 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
    const user = await prisma.users.create({
      data: {
        username: `guest_${Date.now()}`,
        email,
        name,
        password: hashedPassword,
        role: 'GUEST',
        isActive: true,
        isFirstLogin: true,
        companyId: inviter.companyId
      }
    })

    // 3. ã‚²ã‚¹ãƒˆæƒ…å ±ä½œæˆ
    const validUntil = new Date()
    validUntil.setDate(validUntil.getDate() + validDays)

    const guestUser = await prisma.guest_users.create({
      data: {
        userId: user.id,
        invitedBy,
        organization,
        purpose,
        validUntil,
        allowedFeatures,
        isActive: true
      }
    })

    // 4. æ‹›å¾…ãƒ¡ãƒ¼ãƒ«é€ä¿¡
    await this.sendInvitationEmail({
      email,
      name,
      tempPassword,
      validUntil,
      inviterName: inviter.name
    })

    // 5. ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²
    await prisma.audit_logs.create({
      data: {
        userId: invitedBy,
        action: 'GUEST_USER_INVITED',
        targetType: 'USER',
        targetId: user.id,
        details: {
          guestEmail: email,
          validUntil,
          allowedFeatures
        }
      }
    })

    return {
      guestUser,
      user,
      tempPassword // ç®¡ç†è€…ã«ã®ã¿è¿”ã™ï¼ˆãƒ¡ãƒ¼ãƒ«é€ä¿¡å¾Œã¯ä¿å­˜ã—ãªã„ï¼‰
    }
  }

  /**
   * ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
   */
  async checkGuestAccess(userId: number, action: string): Promise<boolean> {
    const guestUser = await prisma.guest_users.findUnique({
      where: { userId }
    })

    if (!guestUser || !guestUser.isActive) {
      return false
    }

    // æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯
    if (new Date() > guestUser.validUntil) {
      await this.expireGuestUser(userId)
      return false
    }

    // ç¦æ­¢æ“ä½œãƒã‚§ãƒƒã‚¯
    if (GUEST_RESTRICTIONS.FORBIDDEN_ACTIONS.includes(action)) {
      await this.logSecurityEvent(userId, 'ACCESS_DENIED', 'MEDIUM', {
        action,
        reason: 'FORBIDDEN_ACTION'
      })
      return false
    }

    // è¨±å¯æ©Ÿèƒ½ãƒã‚§ãƒƒã‚¯
    if (!guestUser.allowedFeatures.includes(action)) {
      await this.logSecurityEvent(userId, 'ACCESS_DENIED', 'LOW', {
        action,
        reason: 'NOT_IN_ALLOWED_FEATURES'
      })
      return false
    }

    // ã‚¢ã‚¯ã‚»ã‚¹ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
    await prisma.guest_users.update({
      where: { userId },
      data: {
        lastAccessAt: new Date(),
        accessCount: { increment: 1 }
      }
    })

    return true
  }

  /**
   * ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼æœ‰åŠ¹æœŸé™åˆ‡ã‚Œå‡¦ç†
   */
  async expireGuestUser(userId: number): Promise<void> {
    await prisma.$transaction([
      prisma.guest_users.update({
        where: { userId },
        data: { isActive: false }
      }),
      prisma.users.update({
        where: { id: userId },
        data: { isActive: false }
      }),
      prisma.audit_logs.create({
        data: {
          userId,
          action: 'GUEST_USER_EXPIRED',
          targetType: 'USER',
          targetId: userId,
          details: { reason: 'VALIDITY_PERIOD_EXCEEDED' }
        }
      })
    ])
  }

  /**
   * ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ
   */
  private generateSecurePassword(length: number): string {
    const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*'
    let password = ''
    const crypto = require('crypto')
    for (let i = 0; i < length; i++) {
      password += charset[crypto.randomInt(charset.length)]
    }
    return password
  }

  /**
   * ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°è¨˜éŒ²
   */
  private async logSecurityEvent(
    userId: number,
    eventType: string,
    severity: string,
    details: any
  ): Promise<void> {
    await prisma.security_events.create({
      data: {
        userId,
        eventType,
        severity,
        details
      }
    })
  }
}
```

#### 5. ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†UI

**ã‚²ã‚¹ãƒˆæ‹›å¾…ç”»é¢**:
```vue
<!-- æ–°è¦å®Ÿè£…: components/GuestUserInviteDialog.vue -->
<template>
  <el-dialog title="ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ‹›å¾…" v-model="visible" width="600px">
    <el-form :model="form" label-width="150px">
      <el-form-item label="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" required>
        <el-input v-model="form.email" type="email" />
      </el-form-item>

      <el-form-item label="æ°å" required>
        <el-input v-model="form.name" />
      </el-form-item>

      <el-form-item label="æ‰€å±çµ„ç¹”">
        <el-input v-model="form.organization" placeholder="ä¾‹: ABCç›£æŸ»æ³•äºº" />
      </el-form-item>

      <el-form-item label="åˆ©ç”¨ç›®çš„" required>
        <el-input
          v-model="form.purpose"
          type="textarea"
          :rows="3"
          placeholder="ä¾‹: 2025å¹´åº¦æ±ºç®—ç›£æŸ»ã®ãŸã‚"
        />
      </el-form-item>

      <el-form-item label="æœ‰åŠ¹æœŸé™" required>
        <el-select v-model="form.validDays">
          <el-option label="7æ—¥é–“" :value="7" />
          <el-option label="14æ—¥é–“" :value="14" />
          <el-option label="30æ—¥é–“" :value="30" />
          <el-option label="60æ—¥é–“" :value="60" />
          <el-option label="90æ—¥é–“ï¼ˆæœ€å¤§ï¼‰" :value="90" />
        </el-select>
        <div class="text-xs text-gray-500 mt-1">
          æœ‰åŠ¹æœŸé™: {{ expirationDate }}
        </div>
      </el-form-item>

      <el-form-item label="è¨±å¯æ©Ÿèƒ½" required>
        <el-checkbox-group v-model="form.allowedFeatures">
          <el-checkbox label="DATA_VIEW">ãƒ‡ãƒ¼ã‚¿é–²è¦§</el-checkbox>
          <el-checkbox label="REPORT_VIEW">ãƒ¬ãƒãƒ¼ãƒˆé–²è¦§</el-checkbox>
          <el-checkbox label="AUDIT_VIEW_LIMITED">ç›£æŸ»ãƒ­ã‚°é–²è¦§ï¼ˆåˆ¶é™ä»˜ãï¼‰</el-checkbox>
        </el-checkbox-group>
      </el-form-item>

      <el-alert type="warning" :closable="false" show-icon class="mb-4">
        <template #title>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š</template>
        <ul class="text-sm">
          <li>âœ… å¤šè¦ç´ èªè¨¼ï¼ˆMFAï¼‰å¿…é ˆ</li>
          <li>âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: 30åˆ†</li>
          <li>âœ… åŒæ™‚ãƒ­ã‚°ã‚¤ãƒ³: 1ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã¿</li>
          <li>âœ… å…¨æ“ä½œã‚’ç›£æŸ»ãƒ­ã‚°ã«è¨˜éŒ²</li>
        </ul>
      </el-alert>
    </el-form>

    <template #footer>
      <el-button @click="visible = false">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</el-button>
      <el-button type="primary" @click="handleInvite">æ‹›å¾…ã‚’é€ä¿¡</el-button>
    </template>
  </el-dialog>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue'
import { ElMessage } from 'element-plus'

const form = ref({
  email: '',
  name: '',
  organization: '',
  purpose: '',
  validDays: 30,
  allowedFeatures: ['DATA_VIEW', 'REPORT_VIEW']
})

const expirationDate = computed(() => {
  const date = new Date()
  date.setDate(date.getDate() + form.value.validDays)
  return date.toLocaleDateString('ja-JP')
})

const handleInvite = async () => {
  try {
    const response = await fetch('/api/guest/invite', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(form.value)
    })

    if (!response.ok) throw new Error('æ‹›å¾…ã«å¤±æ•—ã—ã¾ã—ãŸ')

    ElMessage.success('ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ‹›å¾…ã—ã¾ã—ãŸã€‚æ‹›å¾…ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚')
    visible.value = false
  } catch (error) {
    ElMessage.error(error.message)
  }
}
</script>
```

---

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ ãƒ»å¤‰æ›´

**1. guest_usersï¼ˆæ–°è¦ï¼‰**:
```sql
CREATE TABLE guest_users (
  id SERIAL PRIMARY KEY,
  user_id INTEGER UNIQUE NOT NULL REFERENCES users(id),
  invited_by INTEGER NOT NULL REFERENCES users(id),
  organization VARCHAR(255),
  purpose TEXT NOT NULL,
  valid_from TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  valid_until TIMESTAMP NOT NULL,
  ip_whitelist TEXT[],
  allowed_features TEXT[] NOT NULL,
  is_active BOOLEAN DEFAULT TRUE,
  last_access_at TIMESTAMP,
  access_count INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_guest_users_user_id ON guest_users(user_id);
CREATE INDEX idx_guest_users_valid_until ON guest_users(valid_until);
CREATE INDEX idx_guest_users_is_active ON guest_users(is_active);
```

**2. security_eventsï¼ˆæ–°è¦ï¼‰**:
```sql
CREATE TABLE security_events (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL REFERENCES users(id),
  event_type VARCHAR(50) NOT NULL,
  severity VARCHAR(20) NOT NULL,
  ip_address VARCHAR(45),
  user_agent TEXT,
  details JSONB,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_security_events_user_id ON security_events(user_id);
CREATE INDEX idx_security_events_event_type ON security_events(event_type);
CREATE INDEX idx_security_events_severity ON security_events(severity);
CREATE INDEX idx_security_events_created_at ON security_events(created_at);
```

**3. role_permissionsï¼ˆæ–°è¦ï¼‰**:
```sql
CREATE TABLE role_permissions (
  id SERIAL PRIMARY KEY,
  role VARCHAR(20) NOT NULL,
  action VARCHAR(100) NOT NULL,
  scope VARCHAR(20) NOT NULL, -- GLOBAL, DEPARTMENT, SELF
  description TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(role, action)
);

-- åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥
INSERT INTO role_permissions (role, action, scope, description) VALUES
-- ADMINæ¨©é™
('ADMIN', 'USER_CREATE', 'GLOBAL', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆï¼ˆå…¨ç¤¾ï¼‰'),
('ADMIN', 'USER_EDIT', 'GLOBAL', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†ï¼ˆå…¨ç¤¾ï¼‰'),
('ADMIN', 'USER_DELETE', 'GLOBAL', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ï¼ˆå…¨ç¤¾ï¼‰'),
('ADMIN', 'EMERGENCY_APPROVAL', 'GLOBAL', 'ç·Šæ€¥æ‰¿èªå®Ÿè¡Œï¼ˆå…¨ç¤¾ï¼‰'),
('ADMIN', 'AUDIT_LOG_VIEW', 'GLOBAL', 'ç›£æŸ»ãƒ­ã‚°é–²è¦§ï¼ˆå…¨ç¤¾ï¼‰'),
('ADMIN', 'SYSTEM_SETTING', 'GLOBAL', 'ã‚·ã‚¹ãƒ†ãƒ è¨­å®šå¤‰æ›´'),

-- MANAGERæ¨©é™
('MANAGER', 'USER_CREATE', 'DEPARTMENT', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆï¼ˆè‡ªéƒ¨ç½²ï¼‰'),
('MANAGER', 'USER_EDIT', 'DEPARTMENT', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†ï¼ˆè‡ªéƒ¨ç½²ï¼‰'),
('MANAGER', 'PERMISSION_EDIT', 'DEPARTMENT', 'æ¨©é™ç·¨é›†ï¼ˆè‡ªéƒ¨ç½²ï¼‰'),
('MANAGER', 'EMERGENCY_APPROVAL', 'DEPARTMENT', 'ç·Šæ€¥æ‰¿èªå®Ÿè¡Œï¼ˆè‡ªéƒ¨ç½²ï¼‰'),
('MANAGER', 'AUDIT_LOG_VIEW', 'DEPARTMENT', 'ç›£æŸ»ãƒ­ã‚°é–²è¦§ï¼ˆè‡ªéƒ¨ç½²ï¼‰'),
('MANAGER', 'WORKFLOW_CREATE', 'DEPARTMENT', 'ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä½œæˆï¼ˆè‡ªéƒ¨ç½²ï¼‰'),

-- USERæ¨©é™
('USER', 'USER_EDIT', 'SELF', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†ï¼ˆè‡ªåˆ†ã®ã¿ï¼‰'),
('USER', 'PASSWORD_RESET', 'SELF', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆï¼ˆè‡ªåˆ†ã®ã¿ï¼‰'),
('USER', 'WORKFLOW_CREATE', 'SELF', 'ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä½œæˆï¼ˆè‡ªåˆ†ã®ã¿ï¼‰'),

-- GUESTæ¨©é™
('GUEST', 'DATA_VIEW', 'SELF', 'ãƒ‡ãƒ¼ã‚¿é–²è¦§ï¼ˆè¨±å¯ç¯„å›²ã®ã¿ï¼‰'),
('GUEST', 'REPORT_VIEW', 'SELF', 'ãƒ¬ãƒãƒ¼ãƒˆé–²è¦§ï¼ˆè¨±å¯ç¯„å›²ã®ã¿ï¼‰'),
('GUEST', 'AUDIT_VIEW_LIMITED', 'SELF', 'ç›£æŸ»ãƒ­ã‚°é–²è¦§ï¼ˆè‡ªåˆ†ã®ã¿ï¼‰');
```

---

## APIä»•æ§˜

### æ–°è¦ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

#### 1. å½¹è·æ¨©é™ç®¡ç†

**GET /api/roles/permissions**
- å½¹è·åˆ¥æ¨©é™ä¸€è¦§å–å¾—
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹:
```json
{
  "success": true,
  "data": {
    "ADMIN": [
      { "action": "USER_CREATE", "scope": "GLOBAL", "description": "..." },
      ...
    ],
    "MANAGER": [...],
    "USER": [...],
    "GUEST": [...]
  }
}
```

**GET /api/roles/:role/scope**
- æŒ‡å®šå½¹è·ã®ã‚¹ã‚³ãƒ¼ãƒ—æƒ…å ±å–å¾—
- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: `role` (ADMIN/MANAGER/USER/GUEST)

**POST /api/roles/check-permission**
- æ¨©é™ãƒã‚§ãƒƒã‚¯
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:
```json
{
  "userId": 1,
  "action": "USER_CREATE",
  "targetDepartmentId": 2
}
```

#### 2. éƒ¨ç½²ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†

**POST /api/templates/detect**
- éƒ¨ç½²åã‹ã‚‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè‡ªå‹•æ¨å®š
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: `{ "departmentName": "å–¶æ¥­éƒ¨" }`
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹: `{ "templateName": "SALES_DEPT", ... }`

**GET /api/templates/presets**
- ãƒ—ãƒªã‚»ãƒƒãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§

**POST /api/departments/with-template**
- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè‡ªå‹•é©ç”¨ã§éƒ¨ç½²ä½œæˆ
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:
```json
{
  "name": "å–¶æ¥­ç¬¬ä¸€éƒ¨",
  "code": "SALES01",
  "autoApplyTemplate": true,
  "templateOverride": null
}
```

#### 3. ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†

**POST /api/guest/invite**
- ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ‹›å¾…
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:
```json
{
  "email": "auditor@example.com",
  "name": "ç›£æŸ» å¤ªéƒ",
  "organization": "ABCç›£æŸ»æ³•äºº",
  "purpose": "2025å¹´åº¦æ±ºç®—ç›£æŸ»",
  "validDays": 30,
  "allowedFeatures": ["DATA_VIEW", "REPORT_VIEW"]
}
```

**GET /api/guest/list**
- ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ï¼ˆADMIN/MANAGER ã®ã¿ï¼‰

**DELETE /api/guest/:userId**
- ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç„¡åŠ¹åŒ–

**POST /api/guest/:userId/extend**
- æœ‰åŠ¹æœŸé™å»¶é•·

**GET /api/guest/:userId/access-log**
- ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–

### 1. å½¹è·æ¨©é™åˆ¶å¾¡

| å¯¾ç­–é …ç›® | å†…å®¹ |
|---------|------|
| **ã‚¹ã‚³ãƒ¼ãƒ—åˆ¶é™** | MANAGERæ¨©é™ã¯è‡ªéƒ¨ç½²ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯ |
| **æ¨©é™ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é˜²æ­¢** | å½¹è·å¤‰æ›´ã¯ADMINã®ã¿å®Ÿè¡Œå¯ |
| **ç›£æŸ»ãƒ­ã‚°** | å…¨æ¨©é™å¤‰æ›´ã‚’è¨˜éŒ² |
| **ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡** | ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã«ã‚ˆã‚‹è‡ªå‹•ãƒã‚§ãƒƒã‚¯ |

### 2. ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

| å¯¾ç­–é …ç›® | å†…å®¹ |
|---------|------|
| **æœ‰åŠ¹æœŸé™å¿…é ˆ** | æœ€å¤§90æ—¥ã€è‡ªå‹•ç„¡åŠ¹åŒ– |
| **å¤šè¦ç´ èªè¨¼** | MFAå¼·åˆ¶ |
| **ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ¶é™** | 30åˆ†ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€1ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã¿ |
| **æ“ä½œåˆ¶é™** | ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆæ–¹å¼ |
| **ç›£æŸ»ãƒ­ã‚°è©³ç´°** | å…¨æ“ä½œã‚’FULLè¨˜éŒ² |
| **ã‚¢ã‚¯ã‚»ã‚¹å›æ•°åˆ¶é™** | ç•°å¸¸æ¤œçŸ¥ãƒ»è‡ªå‹•ãƒ­ãƒƒã‚¯ |

### 3. éƒ¨ç½²ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿è­·

| å¯¾ç­–é …ç›® | å†…å®¹ |
|---------|------|
| **ãƒ—ãƒªã‚»ãƒƒãƒˆä¿è­·** | PRESET ã‚«ãƒ†ã‚´ãƒªã¯å‰Šé™¤ä¸å¯ |
| **å¤‰æ›´å±¥æ­´** | ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé©ç”¨ã‚’ç›£æŸ»ãƒ­ã‚°ã«è¨˜éŒ² |
| **æ¨©é™ãƒã‚§ãƒƒã‚¯** | ADMIN/MANAGER ã®ã¿é©ç”¨å¯ |

---

## æ€§èƒ½è¦ä»¶

### 1. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ ç›®æ¨™

| å‡¦ç† | ç›®æ¨™ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ  | æœ€å¤§è¨±å®¹æ™‚é–“ | å‚™è€ƒ |
|------|---------------------|-------------|------|
| **getUserPermissionScope** | 10msä»¥å†… | 50ms | ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ä¿æŒ |
| **checkPermission** | 10msä»¥å†… | 50ms | ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢é«˜é€ŸåŒ–ãƒ»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ´»ç”¨ |
| **æ¨©é™ãƒãƒˆãƒªã‚¯ã‚¹å–å¾—** | 100msä»¥å†… | 300ms | å…¨å½¹è·Ã—å…¨æ©Ÿèƒ½ã®ãƒãƒˆãƒªã‚¯ã‚¹ |
| **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè‡ªå‹•æ¨å®š** | 50msä»¥å†… | 100ms | éƒ¨ç½²åã‹ã‚‰ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒ |
| **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè‡ªå‹•é©ç”¨** | 500msä»¥å†… | 1,000ms | ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å®Ÿè¡Œå¯èƒ½ |
| **ã‚²ã‚¹ãƒˆæ‹›å¾…å‡¦ç†** | 1,000msä»¥å†… | 2,000ms | ãƒ¡ãƒ¼ãƒ«é€ä¿¡å«ã‚€éåŒæœŸå‡¦ç† |
| **ã‚²ã‚¹ãƒˆã‚¢ã‚¯ã‚»ã‚¹ãƒã‚§ãƒƒã‚¯** | 20msä»¥å†… | 100ms | ã‚»ãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ |

### 2. ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆç›®æ¨™

| å‡¦ç† | ç›®æ¨™ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ | å‚™è€ƒ |
|------|-----------------|------|
| **æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆåŒæ™‚ï¼‰** | 1,000 req/sec | ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§é«˜é »åº¦å®Ÿè¡Œ |
| **éƒ¨ç½²ä½œæˆï¼ˆåŒæ™‚ï¼‰** | 10 req/sec | é€šå¸¸ã¯ä½é »åº¦ |
| **ã‚²ã‚¹ãƒˆæ‹›å¾…ï¼ˆåŒæ™‚ï¼‰** | 5 req/sec | ç®¡ç†è€…ã®ã¿å®Ÿè¡Œ |

### 3. ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨é‡ç›®æ¨™

| ãƒªã‚½ãƒ¼ã‚¹ | ç›®æ¨™å€¤ | æœ€å¤§è¨±å®¹å€¤ | å‚™è€ƒ |
|---------|--------|-----------|------|
| **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡** | +10MB | +50MB | æ¨©é™ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† |
| **CPUä½¿ç”¨ç‡** | +5% | +15% | æ¨©é™ãƒã‚§ãƒƒã‚¯å‡¦ç† |
| **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š** | +0 | +2 | æ—¢å­˜æ¥ç¶šãƒ—ãƒ¼ãƒ«ã‚’ä½¿ç”¨ |
| **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å¢—åŠ ** | +100MB/å¹´ | +500MB/å¹´ | ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ç›£æŸ»ãƒ­ã‚° |

### 4. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–æˆ¦ç•¥

#### æ¨©é™ãƒã‚§ãƒƒã‚¯æœ€é©åŒ–
```typescript
// ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥
const permissionCache = new Map<number, {
  scope: PermissionScope
  expiry: number
}>()

async getUserPermissionScope(userId: number) {
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä½¿ç”¨ï¼ˆ5åˆ†é–“æœ‰åŠ¹ï¼‰
  const cached = permissionCache.get(userId)
  if (cached && cached.expiry > Date.now()) {
    return cached.scope
  }

  // âœ… N+1å¯¾ç­–: includeã§ user_departments ã‚’1ã‚¯ã‚¨ãƒªã§å–å¾—
  const user = await prisma.users.findUnique({
    where: { id: userId },
    include: { user_departments: true }
  })

  const scope = this.calculateScope(user)

  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜ï¼ˆ5åˆ†é–“ï¼‰
  permissionCache.set(userId, {
    scope,
    expiry: Date.now() + 5 * 60 * 1000
  })

  return scope
}
```

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªæœ€é©åŒ–
```typescript
// ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé©ç”¨æ™‚ã®ä¸€æ‹¬å‡¦ç†
async applyTemplateToDepartment(departmentId: number, templateId: number) {
  // âœ… ä¸€æ‹¬å‰Šé™¤ãƒ»ä¸€æ‹¬æŒ¿å…¥ã§ã‚¯ã‚¨ãƒªæ•°å‰Šæ¸›
  await prisma.$transaction([
    prisma.department_feature_permissions.deleteMany({
      where: { departmentId }
    }),
    prisma.department_feature_permissions.createMany({
      data: permissions  // ä¸€æ‹¬æŒ¿å…¥
    })
  ])
}
```

#### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ´»ç”¨
```sql
-- æ€§èƒ½å‘ä¸Šã®ãŸã‚ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_role_permissions_role_action ON role_permissions(role, action);
CREATE INDEX idx_guest_users_valid_until ON guest_users(valid_until);
CREATE INDEX idx_security_events_user_created ON security_events(user_id, created_at);
```

### 5. æ€§èƒ½è©¦é¨“é …ç›®

| è©¦é¨“é …ç›® | åˆæ ¼åŸºæº– | è©¦é¨“æ–¹æ³• |
|---------|---------|---------|
| **æ¨©é™ãƒã‚§ãƒƒã‚¯è² è·è©¦é¨“** | 1,000 req/sec ã§å¹³å‡10msä»¥å†… | Apache Bench (ab) |
| **åŒæ™‚ã‚²ã‚¹ãƒˆæ‹›å¾…** | 5ä¸¦åˆ—ã§å…¨ã¦1ç§’ä»¥å†…å®Œäº† | ä¸¦åˆ—å®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ |
| **æ¨©é™ãƒãƒˆãƒªã‚¯ã‚¹å–å¾—** | 100msä»¥å†… | ãƒ–ãƒ©ã‚¦ã‚¶DevToolsè¨ˆæ¸¬ |
| **ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯æ¤œè¨¼** | 24æ™‚é–“ç¨¼åƒã§ãƒ¡ãƒ¢ãƒªå¢—åŠ +50MBä»¥å†… | ãƒ¡ãƒ¢ãƒªãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ© |

### 6. æ€§èƒ½åŠ£åŒ–æ™‚ã®å¯¾å¿œ

| é–¾å€¤ | ã‚¢ãƒ©ãƒ¼ãƒˆ | å¯¾å¿œ |
|------|---------|------|
| **æ¨©é™ãƒã‚§ãƒƒã‚¯ > 50ms** | WARNING | ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®šè¦‹ç›´ã— |
| **æ¨©é™ãƒã‚§ãƒƒã‚¯ > 100ms** | ERROR | ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç¢ºèªãƒ»ã‚¯ã‚¨ãƒªæœ€é©åŒ– |
| **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ > 50MB** | WARNING | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µã‚¤ã‚ºå‰Šæ¸› |
| **CPUä½¿ç”¨ç‡ > 15%** | ERROR | å‡¦ç†ã®ä¸¦åˆ—åŒ–ãƒ»æœ€é©åŒ– |

---

## å®Ÿè£…è¨ˆç”»

### Phase 3-1: T014å®Ÿè£…ï¼ˆ1é€±é–“ï¼‰
- [ ] RolePermissionServiceå®Ÿè£…
- [ ] role_permissions ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] ã‚¹ã‚³ãƒ¼ãƒ—ãƒã‚§ãƒƒã‚¯ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢å®Ÿè£…
- [ ] æ¨©é™ãƒãƒˆãƒªã‚¯ã‚¹UIä½œæˆ
- [ ] å˜ä½“è©¦é¨“å®Ÿæ–½

### Phase 3-2: T015å®Ÿè£…ï¼ˆ1é€±é–“ï¼‰
- [ ] DepartmentTemplateServiceå®Ÿè£…
- [ ] ãƒ—ãƒªã‚»ãƒƒãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ5ç¨®é¡ä½œæˆ
- [ ] è‡ªå‹•é©ç”¨ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…
- [ ] éƒ¨ç½²ä½œæˆUIæ”¹å–„
- [ ] å˜ä½“è©¦é¨“å®Ÿæ–½

### Phase 3-3: T016å®Ÿè£…ï¼ˆ2é€±é–“ï¼‰
- [ ] guest_users ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] security_events ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] GuestUserServiceå®Ÿè£…
- [ ] ã‚²ã‚¹ãƒˆåˆ¶ç´„ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢å®Ÿè£…
- [ ] æ‹›å¾…UIãƒ»ç®¡ç†UIå®Ÿè£…
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è©¦é¨“å®Ÿæ–½

### Phase 3-4: çµ±åˆè©¦é¨“ï¼ˆ1é€±é–“ï¼‰
- [ ] æ¨©é™ãƒãƒˆãƒªã‚¯ã‚¹å‹•ä½œç¢ºèª
- [ ] éƒ¨ç½²ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè‡ªå‹•é©ç”¨ç¢ºèª
- [ ] ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç¢ºèª
- [ ] æ€§èƒ½è©¦é¨“
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™

**ç·æ‰€è¦æœŸé–“**: 5é€±é–“

---

## ä»˜éŒ²

### A. é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [æ”¹å–„å®Ÿè£…ã‚¿ã‚¹ã‚¯ç®¡ç†è¡¨](../../legacy/numbered-docs/51-æ”¹å–„å®Ÿè£…ã‚¿ã‚¹ã‚¯ç®¡ç†è¡¨.md)
- [Phase 2å®Œäº†ç·åˆå ±å‘Š](../../08_å ±å‘Š/46_Phase2å®Œäº†ç·åˆå ±å‘Š.md)
- [æ¨©é™ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå˜ä½“è©¦é¨“ä»•æ§˜æ›¸](../../04_è©¦é¨“/04_æ¨©é™ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå˜ä½“è©¦é¨“ä»•æ§˜æ›¸.md)

### B. ç”¨èªé›†
- **RBAC**: Role-Based Access Controlï¼ˆå½¹è·ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ï¼‰
- **ã‚¹ã‚³ãƒ¼ãƒ—**: æ¨©é™ã®é©ç”¨ç¯„å›²ï¼ˆGLOBAL/DEPARTMENT/SELFï¼‰
- **ãƒ—ãƒªã‚»ãƒƒãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ**: ã‚·ã‚¹ãƒ†ãƒ æ¨™æº–ã®æ¨©é™è¨­å®š
- **ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼**: ä¸€æ™‚çš„ãªå¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹ãƒ¦ãƒ¼ã‚¶ãƒ¼

---

**ä½œæˆæ—¥**: 2025-10-05
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0
**æ‰¿èªçŠ¶æ…‹**: è¨­è¨ˆä¸­
