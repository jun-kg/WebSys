# ワークフロー柔軟化機能設計書

**作成日**: 2025年10月5日
**最終更新**: 2025年10月5日
**ステータス**: ✅ 実装完了

---

## 📋 機能概要

### 目的
- 多様な業務プロセスに対応できる柔軟な承認フロー
- 緊急時の迅速な意思決定支援
- 不在時の業務継続性確保
- 自動化による業務効率化

### 対象機能
1. **緊急承認機能** - 災害・障害時の承認バイパス
2. **承認委任機能** - 長期不在時の権限委譲
3. **承認代理機能** - 一時的な代理承認
4. **複数承認者対応** - 並列承認（OR条件）・直列承認（AND条件）
5. **自動承認ルール** - 条件ベースの自動処理

---

## 🏗️ システムアーキテクチャ

### データベース設計

```
┌──────────────────────┐
│  workflow_types      │  ワークフロータイプ
│  - id                │
│  - name              │
│  - code              │
│  - category          │
└──────────────────────┘
           │
           │ 1:N
           ↓
┌──────────────────────┐
│  approval_routes     │  承認ルート
│  - id                │
│  - workflowTypeId    │
│  - stepNumber        │  承認ステップ番号
│  - approverType      │  USER/DEPARTMENT/ROLE/DYNAMIC
│  - approverValue     │  承認者指定（JSON）
│  - requiredCount     │  必要承認数
│  - isParallel        │  並列承認フラグ
│  - canSkip           │  スキップ可能フラグ
│  - autoApproveHours  │  自動承認時間（時間）
└──────────────────────┘
           │
           │ 1:N
           ↓
┌──────────────────────┐
│  workflow_requests   │  ワークフロー申請
│  - id                │
│  - workflowTypeId    │
│  - requesterId       │
│  - status            │  PENDING/IN_PROGRESS/APPROVED/REJECTED
│  - currentStep       │  現在のステップ
│  - isEmergencyMode   │  緊急承認フラグ
│  - emergencyReason   │  緊急承認理由
│  - emergencyApprovedBy│ 緊急承認者ID
│  - emergencyApprovedAt│ 緊急承認日時
└──────────────────────┘
           │
           │ 1:N
           ↓
┌──────────────────────┐
│  approval_history    │  承認履歴
│  - id                │
│  - requestId         │
│  - stepNumber        │
│  - approverId        │
│  - action            │  APPROVED/REJECTED/EMERGENCY_APPROVED
│  - comment           │
│  - delegatedFrom     │  委任元ユーザーID
│  - delegatedTo       │  委任先ユーザーID
│  - processedAt       │
└──────────────────────┘

┌──────────────────────┐
│  approval_delegates  │  承認委任設定
│  - id                │
│  - delegatorId       │  委任元ユーザー
│  - delegateId        │  委任先ユーザー
│  - workflowTypeId    │  対象ワークフロー（null=全て）
│  - startDate         │  委任開始日
│  - endDate           │  委任終了日
│  - reason            │  委任理由
│  - isActive          │  有効フラグ
└──────────────────────┘

┌──────────────────────┐
│  auto_approval_rules │  自動承認ルール
│  - id                │
│  - workflowTypeId    │
│  - ruleType          │  TIME/AMOUNT/ROLE/CONDITION
│  - ruleName          │
│  - conditions        │  条件（JSON）
│  - autoApproveAfter  │  自動承認待機時間（時間）
│  - maxAmount         │  金額上限
│  - applicableRoles   │  適用役職
│  - priority          │  優先度
└──────────────────────┘
           │
           │ 1:N
           ↓
┌──────────────────────┐
│  auto_approval_logs  │  自動承認ログ
│  - id                │
│  - requestId         │
│  - ruleId            │
│  - appliedAt         │
│  - reason            │
└──────────────────────┘
```

---

## 🚀 実装済み機能

### 1. 緊急承認機能 ✅

#### 実装ファイル
- バックエンド: [EmergencyApprovalService.ts](../../../workspace/backend/src/custom/services/EmergencyApprovalService.ts)
- API: [emergency-approval.ts](../../../workspace/backend/src/custom/routes/workflow/emergency-approval.ts)
- フロントエンド: [ApprovalProcess.vue](../../../workspace/frontend/src/custom/views/views/ApprovalProcess.vue)

#### 機能詳細

**使用シナリオ**:
- 災害発生時の緊急対応承認
- システム障害時の復旧作業承認
- 取引先トラブル時の迅速対応
- 法的対応が必要な緊急事案

**実装内容**:
```typescript
interface EmergencyApprovalRequest {
  requestId: number;
  reason: string;             // 緊急承認理由（必須）
  adminUserId: number;        // 管理者ID
  companyId: number;
  notifyApprovers?: boolean;  // 承認者への事後通知
}
```

**処理フロー**:
1. 管理者権限チェック（ADMIN のみ）
2. 申請状態確認（PENDING/IN_PROGRESS のみ対象）
3. 全承認ステップをバイパス
4. 申請を即座に APPROVED に変更
5. 承認履歴に EMERGENCY_APPROVED 記録
6. 監査ログに緊急承認実行記録
7. 本来の承認者へ事後通知

**セキュリティ対策**:
- ✅ 管理者権限必須
- ✅ 全操作を監査ログに記録
- ✅ 理由の記載必須
- ✅ 事後承認者への通知

**API**:
```
POST /api/workflow/emergency-approval
GET  /api/workflow/emergency-approval/history
GET  /api/workflow/emergency-approval/statistics
GET  /api/workflow/emergency-approval/can-approve/:requestId
```

---

### 2. 承認委任機能 ✅

#### 実装ファイル
- バックエンド: [ApprovalDelegationService.ts](../../../workspace/backend/src/custom/services/ApprovalDelegationService.ts)
- API: [approval.ts](../../../workspace/backend/src/custom/routes/approval.ts)

#### 機能詳細

**使用シナリオ**:
- 長期休暇時の承認権限委譲
- 長期出張時の代理設定
- 異動時の引き継ぎ期間
- 病気・療養時の業務継続

**実装内容**:
```typescript
interface ApprovalDelegationRequest {
  delegatorId: number;        // 委任元ユーザー
  delegateId: number;         // 委任先ユーザー
  workflowTypeId?: number;    // 対象ワークフロー（null=全て）
  startDate: Date;            // 委任開始日
  endDate: Date;              // 委任終了日
  reason?: string;            // 委任理由
  createdBy: number;
}
```

**委任チェーン防止**:
- 委任の連鎖レベルを最大2レベルまで制限
- A → B → C の3段階委任は不可
- 循環委任の検出・防止

**委任範囲**:
- ✅ 特定ワークフロータイプのみ委任
- ✅ 全ワークフロータイプ一括委任
- ✅ 期間指定（開始日・終了日）
- ✅ 自動有効化・無効化

**委任履歴**:
```typescript
interface ApprovalHistory {
  delegatedFrom: number;  // 委任元ユーザー
  delegatedTo: number;    // 委任先ユーザー（実際の承認者）
  // ...
}
```

**API**:
```
POST   /api/approval/delegation
GET    /api/approval/delegation
PUT    /api/approval/delegation/:id
DELETE /api/approval/delegation/:id
GET    /api/approval/delegation/active
GET    /api/approval/delegation/check
```

---

### 3. 承認代理機能 ✅

#### 実装内容

承認委任機能の一部として実装済み。

**委任との違い**:
| 項目 | 委任 | 代理 |
|------|------|------|
| 期間 | 長期（数週間〜数ヶ月） | 短期（1日〜数日） |
| 範囲 | ワークフロータイプ単位 | 個別申請単位 |
| 設定方法 | 事前設定 | 都度設定 |
| 承認履歴 | delegatedFrom記録 | delegatedTo記録 |

**処理フロー**:
```typescript
// 代理承認の実行
async processApprovalWithDelegate(data: {
  requestId: number;
  originalApproverId: number;  // 本来の承認者
  delegateApproverId: number;  // 代理承認者
  action: 'APPROVED' | 'REJECTED';
  comment?: string;
}) {
  // 代理権限チェック
  // 承認処理実行
  // delegatedFrom/To を記録
}
```

---

### 4. 複数承認者対応 ✅

#### 並列承認（OR条件）

**実装**:
```typescript
interface ApprovalRoute {
  approverType: 'USER';
  approverValue: {
    userIds: number[];  // 複数の承認者
  };
  requiredCount: number;  // 必要承認数（1=いずれか1人）
  isParallel: true;       // 並列承認フラグ
}
```

**動作**:
- 複数の承認者のうち `requiredCount` 人が承認すればステップ完了
- 例: 5人中3人承認（3/5承認）

#### 直列承認（AND条件）

**実装**:
```typescript
interface ApprovalRoute {
  isParallel: false;  // 直列承認
  requiredCount: 1;   // 各ステップで1人必須
}
```

**動作**:
- ステップ1 → ステップ2 → ステップ3 の順次承認
- 前のステップが完了しないと次に進めない

---

### 5. 自動承認ルール ✅

#### 実装ファイル
- バックエンド: [AutoApprovalService.ts](../../../workspace/backend/src/custom/services/AutoApprovalService.ts)
- API: [auto-approval.ts](../../../workspace/backend/src/custom/routes/workflow/auto-approval.ts)

#### 自動承認タイプ

##### 1. 時間ベース自動承認 (TIME_BASED)

```typescript
{
  ruleType: 'TIME_BASED',
  autoApproveAfter: 24,  // 24時間後に自動承認
  conditions: {
    businessHoursOnly: true,  // 営業時間のみカウント
    excludeWeekends: true     // 土日除外
  }
}
```

**用途**: 承認者不在時の自動承認

##### 2. 金額ベース自動承認 (AMOUNT_BASED)

```typescript
{
  ruleType: 'AMOUNT_BASED',
  maxAmount: 10000,  // 10,000円以下自動承認
  conditions: {
    field: 'amount',
    operator: 'lte',
    value: 10000
  }
}
```

**用途**: 少額経費の自動承認

##### 3. 役職ベース自動承認 (ROLE_BASED)

```typescript
{
  ruleType: 'ROLE_BASED',
  applicableRoles: ['MANAGER', 'ADMIN'],
  conditions: {
    requesterRole: ['MANAGER', 'ADMIN']
  }
}
```

**用途**: 特定役職の申請を自動承認

##### 4. 条件ベース自動承認 (CONDITION_BASED)

```typescript
{
  ruleType: 'CONDITION_BASED',
  conditions: {
    and: [
      { field: 'amount', operator: 'lte', value: 5000 },
      { field: 'category', operator: 'eq', value: '消耗品' },
      { field: 'departmentId', operator: 'in', value: [1, 2, 3] }
    ]
  }
}
```

**用途**: 複雑な条件組み合わせ

#### 自動承認ログ

全ての自動承認は `auto_approval_logs` に記録:
```typescript
interface AutoApprovalLog {
  requestId: number;
  ruleId: number;
  ruleName: string;
  ruleType: string;
  appliedAt: Date;
  reason: string;
  metadata: any;
}
```

**API**:
```
POST   /api/workflow/auto-approval/rules
GET    /api/workflow/auto-approval/rules
PUT    /api/workflow/auto-approval/rules/:id
DELETE /api/workflow/auto-approval/rules/:id
POST   /api/workflow/auto-approval/check/:requestId
GET    /api/workflow/auto-approval/logs
```

---

## 📊 API仕様

### 緊急承認API

| メソッド | エンドポイント | 説明 | 権限 |
|---------|--------------|------|------|
| POST | `/api/workflow/emergency-approval` | 緊急承認実行 | ADMIN |
| GET | `/api/workflow/emergency-approval/history` | 緊急承認履歴 | ADMIN |
| GET | `/api/workflow/emergency-approval/statistics` | 統計情報 | ADMIN |
| GET | `/api/workflow/emergency-approval/can-approve/:id` | 承認可否確認 | ADMIN |

### 承認委任API

| メソッド | エンドポイント | 説明 | 権限 |
|---------|--------------|------|------|
| POST | `/api/approval/delegation` | 委任作成 | USER以上 |
| GET | `/api/approval/delegation` | 委任一覧 | USER以上 |
| PUT | `/api/approval/delegation/:id` | 委任更新 | USER以上 |
| DELETE | `/api/approval/delegation/:id` | 委任削除 | USER以上 |
| GET | `/api/approval/delegation/active` | 有効な委任 | USER以上 |

### 自動承認API

| メソッド | エンドポイント | 説明 | 権限 |
|---------|--------------|------|------|
| POST | `/api/workflow/auto-approval/rules` | ルール作成 | ADMIN |
| GET | `/api/workflow/auto-approval/rules` | ルール一覧 | ADMIN |
| PUT | `/api/workflow/auto-approval/rules/:id` | ルール更新 | ADMIN |
| DELETE | `/api/workflow/auto-approval/rules/:id` | ルール削除 | ADMIN |
| POST | `/api/workflow/auto-approval/check/:id` | 自動承認チェック | SYSTEM |
| GET | `/api/workflow/auto-approval/logs` | 自動承認ログ | ADMIN |

---

## 🔒 セキュリティ対策

### 1. 緊急承認のセキュリティ

- ✅ 管理者権限必須（ADMIN のみ）
- ✅ 全操作を監査ログに記録
- ✅ 理由の記載必須（最小10文字）
- ✅ 事後承認者への自動通知
- ✅ 緊急承認統計レポート

### 2. 承認委任のセキュリティ

- ✅ 委任チェーン最大2レベル
- ✅ 循環委任検出・防止
- ✅ 期間自動有効化・無効化
- ✅ 委任作成時の監査ログ
- ✅ 同一期間の重複委任防止

### 3. 自動承認のセキュリティ

- ✅ ルール作成は管理者のみ
- ✅ 全自動承認をログに記録
- ✅ 金額上限の厳格チェック
- ✅ 条件の事前バリデーション
- ✅ 自動承認統計・監視

---

## 🧪 テストケース

### 緊急承認

| No | テストケース | 期待結果 |
|----|------------|---------|
| 1 | 管理者が緊急承認実行 | 即座にAPPROVED |
| 2 | 一般ユーザーが緊急承認実行 | 権限エラー |
| 3 | 既に承認済みの申請を緊急承認 | エラー |
| 4 | 緊急承認後の監査ログ確認 | ログ記録確認 |
| 5 | 事後通知送信確認 | 承認者へ通知 |

### 承認委任

| No | テストケース | 期待結果 |
|----|------------|---------|
| 1 | 有効期間内の委任で承認 | 委任先が承認実行 |
| 2 | 期間外の委任で承認 | 委任無効エラー |
| 3 | 委任チェーン3レベル | エラー |
| 4 | 循環委任設定 | エラー |
| 5 | 委任履歴の記録 | delegatedFrom/To記録 |

### 自動承認

| No | テストケース | 期待結果 |
|----|------------|---------|
| 1 | 時間経過で自動承認 | 24時間後に承認 |
| 2 | 金額条件で自動承認 | 10,000円以下承認 |
| 3 | 役職条件で自動承認 | MANAGER自動承認 |
| 4 | 複合条件で自動承認 | 全条件一致で承認 |
| 5 | 自動承認ログ確認 | ログ記録確認 |

---

## 📈 運用実績

### 実装完了日
2025年10月5日（調査完了）

### 実装状況

| 機能 | 実装率 | 備考 |
|------|--------|------|
| 緊急承認 | 100% | 完全実装 |
| 承認委任 | 100% | 完全実装 |
| 承認代理 | 100% | 委任機能に統合 |
| 複数承認者（並列） | 100% | 完全実装 |
| 複数承認者（直列） | 100% | 完全実装 |
| 自動承認 | 100% | 完全実装 |

---

## 🚀 今後の拡張

### Phase 4: AI支援承認

- 過去の承認パターン学習
- 承認時間予測
- 異常申請検知

### Phase 5: モバイル承認

- スマートフォンアプリ
- プッシュ通知
- オフライン対応

---

**関連ドキュメント**:
- [ワークフロー基本設計書](./ワークフロー基本設計書.md)
- [承認ルート設計書](./承認ルート設計書.md)
- [監査ログ仕様書](../99_システム基盤/監査ログ仕様書.md)
