# WebSys ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå“è³ªä¿è¨¼ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# ä½œæˆæ—¥: 2025-09-30
# ç›®çš„: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ç¶™ç¶šçš„å“è³ªç®¡ç†ã¨CI/CDçµ±åˆ

name: ğŸ“š Documentation Quality Assurance

on:
  push:
    branches: [ main, master, develop ]
    paths: [ 'docs/**/*.md', 'scripts/**' ]
  pull_request:
    branches: [ main, master ]
    paths: [ 'docs/**/*.md', 'scripts/**' ]
  schedule:
    # æ¯æ—¥åˆå‰9æ™‚ã«å®Ÿè¡Œï¼ˆJSTï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      check_external_links:
        description: 'å¤–éƒ¨ãƒªãƒ³ã‚¯ã‚‚ãƒã‚§ãƒƒã‚¯ã™ã‚‹'
        required: false
        default: 'false'
        type: boolean
      output_format:
        description: 'å‡ºåŠ›å½¢å¼'
        required: false
        default: 'console'
        type: choice
        options:
        - console
        - json
        - html

env:
  NODE_VERSION: '18'

jobs:
  document-quality-check:
    name: ğŸ“‹ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå“è³ªãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ“‚ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
      run: |
        mkdir -p docs/quality-reports
        mkdir -p docs/artifacts

    - name: ğŸ” Phase1 åŸºæœ¬å“è³ªãƒã‚§ãƒƒã‚¯
      run: |
        echo "ğŸ” Phase1 åŸºæœ¬å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ"
        ./scripts/quality-check.sh
      id: basic_quality_check
      continue-on-error: true

    - name: ğŸ”® Phase2 é«˜åº¦å“è³ªãƒã‚§ãƒƒã‚¯
      run: |
        echo "ğŸ”® Phase2 é«˜åº¦å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ"
        ./scripts/advanced-quality-check.sh false comprehensive
      id: advanced_quality_check
      continue-on-error: true

    - name: ğŸ“Š Phase2 å‹•çš„ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
      run: |
        echo "ğŸ“Š Phase2 å‹•çš„ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ"
        python3 scripts/dynamic-report-generator.py --format both
      id: dynamic_report
      continue-on-error: true

    - name: ğŸ”— ãƒªãƒ³ã‚¯ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
      run: |
        echo "ğŸ”— ãƒªãƒ³ã‚¯ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ"
        CHECK_EXTERNAL="${{ inputs.check_external_links || 'false' }}"
        OUTPUT_FORMAT="${{ inputs.output_format || 'console' }}"
        ./scripts/link-check.sh $CHECK_EXTERNAL $OUTPUT_FORMAT
      id: link_check
      continue-on-error: true

    - name: ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆçµ±åˆ
      run: |
        cat > docs/quality-reports/summary-$(date +%Y%m%d-%H%M%S).md << 'EOF'
        # WebSys ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå“è³ªãƒ¬ãƒãƒ¼ãƒˆ

        ## å®Ÿè¡Œæƒ…å ±
        - **å®Ÿè¡Œæ—¥æ™‚**: $(date)
        - **ãƒ–ãƒ©ãƒ³ãƒ**: ${{ github.ref_name }}
        - **ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}
        - **ãƒˆãƒªã‚¬ãƒ¼**: ${{ github.event_name }}

        ## ãƒã‚§ãƒƒã‚¯çµæœã‚µãƒãƒªãƒ¼
        - **å“è³ªãƒã‚§ãƒƒã‚¯**: ${{ steps.quality_check.outcome }}
        - **ãƒªãƒ³ã‚¯ãƒã‚§ãƒƒã‚¯**: ${{ steps.link_check.outcome }}

        ## è©³ç´°
        å“è³ªãƒã‚§ãƒƒã‚¯ã¨ãƒªãƒ³ã‚¯ãƒã‚§ãƒƒã‚¯ã®è©³ç´°ãƒ­ã‚°ã¯ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§:
        - `docs/quality-check-*.log`
        - `docs/link-check-*.*`

        ## æ”¹å–„ææ¡ˆ
        ã‚¨ãƒ©ãƒ¼ã‚„è­¦å‘ŠãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆ:
        1. è©²å½“ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿®æ­£
        2. MASTER_REFERENCE.md ã¨ã®æ•´åˆæ€§ç¢ºèª
        3. ãƒªãƒ³ã‚¯åˆ‡ã‚Œã®ä¿®æ­£
        4. æ—¥ä»˜å½¢å¼ã®çµ±ä¸€ï¼ˆYYYY-MM-DDï¼‰

        ## CI/CDçµ±åˆçŠ¶æ³
        ã“ã®ãƒã‚§ãƒƒã‚¯ã¯ä»¥ä¸‹ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§è‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™:
        - Pull Requestä½œæˆæ™‚
        - ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã¸ã®pushæ™‚
        - æ¯æ—¥åˆå‰9æ™‚ï¼ˆå®šæœŸå®Ÿè¡Œï¼‰
        - æ‰‹å‹•å®Ÿè¡Œï¼ˆworkflow_dispatchï¼‰

        EOF

    - name: ğŸ“¤ ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: documentation-quality-reports-${{ github.run_number }}
        path: |
          docs/quality-check-*.log
          docs/link-check-*.*
          docs/quality-reports/
          docs/artifacts/
        retention-days: 30

    - name: ğŸ’¬ PR ã‚³ãƒ¡ãƒ³ãƒˆä½œæˆ
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');

          // å“è³ªãƒã‚§ãƒƒã‚¯çµæœã®å–å¾—
          const basicQualityResult = '${{ steps.basic_quality_check.outcome }}';
          const advancedQualityResult = '${{ steps.advanced_quality_check.outcome }}';
          const dynamicReportResult = '${{ steps.dynamic_report.outcome }}';
          const linkResult = '${{ steps.link_check.outcome }}';

          // ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          const logFiles = fs.readdirSync('docs').filter(f => f.includes('quality-check-') && f.endsWith('.log'));
          let logContent = '';

          if (logFiles.length > 0) {
            const latestLog = logFiles.sort().pop();
            logContent = fs.readFileSync(`docs/${latestLog}`, 'utf8').slice(0, 1000);
          }

          const comment = `## ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå“è³ªãƒã‚§ãƒƒã‚¯çµæœ

          | ãƒã‚§ãƒƒã‚¯é …ç›® | çµæœ |
          |------------|------|
          | Phase1 åŸºæœ¬å“è³ª | ${basicQualityResult === 'success' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'} |
          | Phase2 é«˜åº¦å“è³ª | ${advancedQualityResult === 'success' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'} |
          | Phase2 å‹•çš„ãƒ¬ãƒãƒ¼ãƒˆ | ${dynamicReportResult === 'success' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'} |
          | ãƒªãƒ³ã‚¯ãƒã‚§ãƒƒã‚¯ | ${linkResult === 'success' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'} |

          ${basicQualityResult !== 'success' || advancedQualityResult !== 'success' || dynamicReportResult !== 'success' || linkResult !== 'success' ?
            '### âš ï¸ æ”¹å–„ãŒå¿…è¦ãªé …ç›®ãŒã‚ã‚Šã¾ã™\n\nè©³ç´°ãªåˆ†æãƒ¬ãƒãƒ¼ãƒˆã¯ Actions ã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\n**Phase2æ©Ÿèƒ½**: é«˜åº¦å“è³ªãƒã‚§ãƒƒã‚¯ãƒ»å‹•çš„ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆãƒ»AIåˆ†æãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚' :
            '### ğŸ‰ Phase2 ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ã¾ã—ãŸï¼\n\n**æ–°æ©Ÿèƒ½**: é«˜åº¦å“è³ªåˆ†æãƒ»å‹•çš„ãƒ¬ãƒãƒ¼ãƒˆãƒ»ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æãŒå®Œå…¨ç¨¼åƒä¸­ã§ã™ã€‚'}

          <details>
          <summary>å“è³ªãƒã‚§ãƒƒã‚¯ãƒ­ã‚°ï¼ˆæŠœç²‹ï¼‰</summary>

          \`\`\`
          ${logContent}
          ${logContent.length >= 1000 ? '\n... (è©³ç´°ã¯ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’å‚ç…§)' : ''}
          \`\`\`
          </details>

          ### ğŸ”— é–¢é€£ãƒªãƒ³ã‚¯
          - [å“è³ªæ”¹å–„ã‚¬ã‚¤ãƒ‰](docs/72-ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç·åˆãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœãƒ»æ”¹å–„è¨ˆç”»æ›¸.md)
          - [æŠ€è¡“ä»•æ§˜çµ±ä¸€](docs/MASTER_REFERENCE.md)
          - [ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒãƒ–](docs/README.md)
          `;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: âŒ å“è³ªãƒã‚§ãƒƒã‚¯å¤±æ•—æ™‚
      if: steps.quality_check.outcome == 'failure' || steps.link_check.outcome == 'failure'
      run: |
        echo "::error title=ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå“è³ªãƒã‚§ãƒƒã‚¯å¤±æ•—::å“è³ªãƒã‚§ãƒƒã‚¯ã¾ãŸã¯ãƒªãƒ³ã‚¯ãƒã‚§ãƒƒã‚¯ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
        echo "å“è³ªãƒã‚§ãƒƒã‚¯çµæœ: ${{ steps.quality_check.outcome }}"
        echo "ãƒªãƒ³ã‚¯ãƒã‚§ãƒƒã‚¯çµæœ: ${{ steps.link_check.outcome }}"
        echo ""
        echo "æ”¹å–„æ–¹æ³•:"
        echo "1. ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã§è©³ç´°ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª"
        echo "2. å£Šã‚ŒãŸãƒªãƒ³ã‚¯ã®ä¿®æ­£"
        echo "3. MASTER_REFERENCE.mdå‚ç…§ã®è¿½åŠ "
        echo "4. æ—¥ä»˜å½¢å¼ã®çµ±ä¸€ï¼ˆYYYY-MM-DDï¼‰"
        echo "5. æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’UTF-8ã«çµ±ä¸€"
        exit 1

  markdown-lint:
    name: ğŸ“ Markdown æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: ğŸ”§ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: ğŸ“¦ markdownlint-cli ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: npm install -g markdownlint-cli

    - name: ğŸ“ Markdown æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
      run: |
        markdownlint docs/**/*.md --config .markdownlint.json || true
      continue-on-error: true

    - name: ğŸ“‹ æ§‹æ–‡ãƒã‚§ãƒƒã‚¯çµæœ
      run: |
        echo "Markdownæ§‹æ–‡ãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸ"
        echo "è©³ç´°ãªæ§‹æ–‡è¦å‰‡ã«ã¤ã„ã¦ã¯ .markdownlint.json ã‚’å‚ç…§ã—ã¦ãã ã•ã„"

  spell-check:
    name: âœï¸ ã‚¹ãƒšãƒ«ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: ğŸ”§ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: ğŸ“¦ cspell ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: npm install -g cspell

    - name: âœï¸ ã‚¹ãƒšãƒ«ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
      run: |
        # æŠ€è¡“ç”¨èªè¾æ›¸ã‚’ä½œæˆ
        cat > .cspell-tech-words.txt << 'EOF'
        WebSys
        Vue.js
        Element Plus
        TypeScript
        Prisma
        PostgreSQL
        Docker
        GitHub
        API
        REST
        JSON
        JWT
        RBAC
        CI/CD
        OAuth
        CORS
        Nginx
        Redis
        Grafana
        Prometheus
        Elasticsearch
        Kibana
        Fluentd
        Jaeger
        EOF

        # åŸºæœ¬çš„ãªè‹±å˜èªã‚¹ãƒšãƒ«ãƒã‚§ãƒƒã‚¯ï¼ˆæ—¥æœ¬èªé™¤å¤–ï¼‰
        cspell "docs/**/*.md" --config .cspell.json --words-only --unique || true
      continue-on-error: true

  summary:
    name: ğŸ“Š å“è³ªãƒã‚§ãƒƒã‚¯ç·åˆçµæœ
    runs-on: ubuntu-latest
    needs: [document-quality-check, markdown-lint, spell-check]
    if: always()

    steps:
    - name: ğŸ“Š ç·åˆçµæœåˆ¤å®š
      run: |
        echo "## ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå“è³ªãƒã‚§ãƒƒã‚¯ç·åˆçµæœ"
        echo "| ãƒã‚§ãƒƒã‚¯é …ç›® | çµæœ |"
        echo "|------------|------|"
        echo "| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå“è³ª | ${{ needs.document-quality-check.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }} |"
        echo "| Markdownæ§‹æ–‡ | ${{ needs.markdown-lint.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }} |"
        echo "| ã‚¹ãƒšãƒ«ãƒã‚§ãƒƒã‚¯ | ${{ needs.spell-check.result == 'success' && 'âœ… æˆåŠŸ' || 'âš ï¸ è­¦å‘Š' }} |"
        echo ""

        if [ "${{ needs.document-quality-check.result }}" = "success" ]; then
          echo "ğŸ‰ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå“è³ªã¯è‰¯å¥½ã§ã™ï¼"
        else
          echo "âš ï¸ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå“è³ªã®æ”¹å–„ãŒæ¨å¥¨ã•ã‚Œã¾ã™"
          echo "è©³ç´°ã¯å„ã‚¸ãƒ§ãƒ–ã®ãƒ­ã‚°ã¨ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„"
        fi