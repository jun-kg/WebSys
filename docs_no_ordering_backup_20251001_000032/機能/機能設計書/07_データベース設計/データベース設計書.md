# データベース設計書

## 1. 概要

### 1.1 データベース基本情報
- **DBMS**: PostgreSQL 15-Alpine
- **データベース名**: websys_db
- **文字コード**: UTF-8
- **タイムゾーン**: Asia/Tokyo
- **接続情報**: localhost:5433 (開発環境)

### 1.2 設計方針
- **正規化**: 第3正規形まで適用
- **命名規則**: PascalCase (テーブル名、カラム名)
- **主キー**: 自動増分ID (Integer)
- **外部キー**: 参照整合性制約を設定
- **インデックス**: パフォーマンス要件に基づき設定
- **タイムスタンプ**: createdAt, updatedAt を全テーブルに設定

## 2. テーブル設計

### 2.1 User テーブル (ユーザー情報)

#### 概要
システム利用ユーザーの基本情報を管理

#### テーブル構造
| カラム名 | データ型 | NULL | デフォルト値 | 制約 | 説明 |
|----------|----------|------|-------------|------|------|
| id | INTEGER | NOT NULL | 自動増分 | PRIMARY KEY | ユーザーID |
| username | TEXT | NOT NULL | - | UNIQUE | ログイン用ユーザー名 |
| email | TEXT | NOT NULL | - | UNIQUE | メールアドレス |
| password | TEXT | NOT NULL | - | - | ハッシュ化パスワード |
| name | TEXT | NOT NULL | - | - | 表示名 |
| department | TEXT | NULL | NULL | - | 所属部署 |
| role | UserRole | NOT NULL | 'USER' | ENUM | ユーザー権限 |
| isActive | BOOLEAN | NOT NULL | true | - | アカウント有効フラグ |
| createdAt | TIMESTAMP(3) | NOT NULL | CURRENT_TIMESTAMP | - | 作成日時 |
| updatedAt | TIMESTAMP(3) | NOT NULL | - | - | 更新日時 |

#### インデックス
- PRIMARY KEY: id
- UNIQUE INDEX: username
- UNIQUE INDEX: email
- INDEX: role (検索最適化)
- INDEX: department (検索最適化)

#### ENUM定義
```sql
CREATE TYPE "UserRole" AS ENUM ('ADMIN', 'USER', 'GUEST');
```

#### 制約
- username: 3-50文字、英数字とアンダースコアのみ
- email: RFC 5322準拠メール形式
- password: bcrypt ハッシュ化 (saltRounds=10)
- name: 1-100文字

## 3. セキュリティ設計

### 3.1 パスワード管理
- **ハッシュ化**: bcrypt (saltRounds=12)
- **最小長**: 6文字以上
- **複雑性**: 英数字混合推奨

### 3.2 アクセス制御
- **権限レベル**:
  - ADMIN: 全機能アクセス可能
  - USER: 一般機能アクセス可能
  - GUEST: 参照のみ可能

### 3.3 データ保護
- **暗号化**: パスワードのみ (bcrypt)
- **ログ制御**: 機密情報の出力禁止
- **アクセスログ**: 認証・認可の記録

## 4. 運用設計

### 4.1 バックアップ戦略
- **フル バックアップ**: 日次 (3:00 AM)
- **差分バックアップ**: 6時間毎
- **保存期間**: 30日間
- **復旧テスト**: 月次実施

### 4.2 パフォーマンス監視
- **スロークエリ**: 1秒以上のクエリをログ出力
- **接続数監視**: 最大接続数の80%で警告
- **容量監視**: ディスク使用率90%で警告

### 4.3 メンテナンス
- **VACUUM**: 週次実行
- **ANALYZE**: 日次実行
- **インデックス再構築**: 月次実行

## 5. 初期データ設計

### 5.1 システム管理者
```sql
INSERT INTO "User" (username, email, password, name, department, role) VALUES
('admin', 'admin@websys.local', '$2a$12$hashed_password', 'システム管理者', 'IT部', 'ADMIN');
```

### 5.2 デモユーザー
```sql
INSERT INTO "User" (username, email, password, name, department, role) VALUES
('demo_user', 'demo@websys.local', '$2a$12$hashed_password', 'デモユーザー', '営業部', 'USER'),
('guest_user', 'guest@websys.local', '$2a$12$hashed_password', 'ゲストユーザー', NULL, 'GUEST');
```

## 6. 拡張設計

### 6.1 将来的なテーブル追加予定
1. **Department テーブル**: 部署マスタ
2. **UserSession テーブル**: セッション管理
3. **AuditLog テーブル**: 操作ログ
4. **UserProfile テーブル**: ユーザープロフィール拡張
5. **Permission テーブル**: 詳細権限管理

### 6.2 スケーラビリティ
- **レプリケーション**: 読み書き分離対応
- **パーティショニング**: 大量データ対応
- **コネクションプーリング**: 同時接続数最適化

## 7. 現在の構築状況

### 7.1 データベース接続確認
```bash
✅ PostgreSQL 15-Alpine コンテナ起動済み
✅ ポート: localhost:5433
✅ データベース: websys_db 作成済み
✅ ユーザー: admin/password 設定済み
```

### 7.2 テーブル作成状況
```bash
✅ User テーブル作成済み
✅ UserRole ENUM 作成済み
✅ インデックス設定済み
✅ 制約設定済み
```

### 7.3 初期データ投入状況
```bash
✅ 管理者ユーザー (admin) 作成済み
✅ デモユーザー (demo_user) 作成済み
✅ ゲストユーザー (guest_user) 作成済み
```

### 7.4 API接続確認
```bash
✅ Prisma ORM 接続済み
✅ マイグレーション実行済み
✅ CRUD操作動作確認済み
```

## 8. 運用コマンド

### 8.1 データベース操作
```bash
# マイグレーション実行
npx prisma migrate dev

# スキーマ同期
npx prisma db push

# シードデータ投入
npx prisma db seed

# データベース接続
docker exec -it websys_postgres_dev psql -U admin -d websys_db
```

### 8.2 バックアップ・復元
```bash
# バックアップ
docker exec websys_postgres_dev pg_dump -U admin websys_db > backup.sql

# 復元
docker exec -i websys_postgres_dev psql -U admin websys_db < backup.sql
```

## 9. トラブルシューティング

### 9.1 一般的な問題と解決策

#### 接続エラー
```bash
# コンテナ状態確認
docker compose ps

# ログ確認
docker compose logs postgres
```

#### パフォーマンス問題
```bash
# スロークエリ確認
docker exec websys_postgres_dev psql -U admin -d websys_db -c "
SELECT query, mean_time, calls
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 10;"
```

#### 容量確認
```bash
# テーブルサイズ確認
docker exec websys_postgres_dev psql -U admin -d websys_db -c "
SELECT schemaname, tablename,
       pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables
WHERE schemaname = 'public';"
```

---

**更新履歴**
- 2025-09-20: 初版作成
- 2025-09-20: 構築状況更新、運用コマンド追加