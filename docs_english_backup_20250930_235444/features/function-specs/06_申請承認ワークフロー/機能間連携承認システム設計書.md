# æ©Ÿèƒ½é–“é€£æºæ‰¿èªã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆæ›¸

## 1. æ¦‚è¦

æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã®å…¨æ©Ÿèƒ½ã«å¯¾ã—ã¦ã€å¿…è¦ã«å¿œã˜ã¦æ‰¿èªãƒ•ãƒ­ãƒ¼ã‚’çµ„ã¿è¾¼ã‚€çµ±åˆæ‰¿èªã‚·ã‚¹ãƒ†ãƒ ã‚’è¨­è¨ˆã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ä¼æ¥­ã®ã‚¬ãƒãƒŠãƒ³ã‚¹è¦ä»¶ã«å¿œã˜ã¦æŸ”è»Ÿãªæ‰¿èªåˆ¶å¾¡ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

## 2. æ‰¿èªå¯¾è±¡æ©Ÿèƒ½ã®åˆ†æ

### 2.1 æ—¢å­˜æ©Ÿèƒ½ã®æ‰¿èªãƒ¬ãƒ™ãƒ«åˆ†é¡

| æ©Ÿèƒ½ã‚«ãƒ†ã‚´ãƒª | æ©Ÿèƒ½å | æ‰¿èªãƒ¬ãƒ™ãƒ« | ç†ç”± |
|-------------|---------|------------|------|
| **ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†** | ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ  | å¿…é ˆ | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é‡è¦ |
| | ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ | å¿…é ˆ | å½±éŸ¿åº¦å¤§ |
| | æ¨©é™å¤‰æ›´ | æ¡ä»¶ä»˜ã | æ¨©é™æ˜‡æ ¼æ™‚ã®ã¿ |
| | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ | ä»»æ„ | ä»–äººã®å ´åˆã®ã¿ |
| **çµ„ç¹”ç®¡ç†** | éƒ¨ç½²è¿½åŠ /å‰Šé™¤ | å¿…é ˆ | çµ„ç¹”æ§‹é€ å¤‰æ›´ |
| | éƒ¨ç½²æ¨©é™å¤‰æ›´ | å¿…é ˆ | æ¨©é™å½±éŸ¿å¤§ |
| **æ¨©é™ç®¡ç†** | æ¨©é™ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ›´ | æ¡ä»¶ä»˜ã | ã‚·ã‚¹ãƒ†ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ™‚ |
| | æ¨©é™ãƒãƒˆãƒªã‚¯ã‚¹å¤‰æ›´ | å¿…é ˆ | å…¨ç¤¾å½±éŸ¿ |
| **ã‚·ã‚¹ãƒ†ãƒ è¨­å®š** | ä¼šç¤¾æƒ…å ±å¤‰æ›´ | å¿…é ˆ | åŸºæœ¬è¨­å®šå¤‰æ›´ |
| | ãƒ­ã‚°è¨­å®šå¤‰æ›´ | æ¡ä»¶ä»˜ã | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£æ™‚ |
| **ãƒ‡ãƒ¼ã‚¿æ“ä½œ** | å¤§é‡ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ | å¿…é ˆ | ãƒ‡ãƒ¼ã‚¿ä¿è­· |
| | ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ | æ¡ä»¶ä»˜ã | æ©Ÿå¯†æƒ…å ±æ™‚ |

## 3. æ‰¿èªåˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ

### 3.1 æ‰¿èªãƒãƒªã‚·ãƒ¼ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
-- æ‰¿èªãƒãƒªã‚·ãƒ¼å®šç¾©ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE approval_policies (
    id SERIAL PRIMARY KEY,
    feature_code VARCHAR(50) NOT NULL,  -- æ©Ÿèƒ½ã‚³ãƒ¼ãƒ‰
    action_type VARCHAR(50) NOT NULL,   -- CREATE, UPDATE, DELETE, EXPORTç­‰
    policy_name VARCHAR(100) NOT NULL,
    is_approval_required BOOLEAN DEFAULT false,
    conditions JSON,                     -- æ‰¿èªãŒå¿…è¦ãªæ¡ä»¶
    workflow_type_id INT,               -- ä½¿ç”¨ã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
    bypass_roles JSON,                  -- æ‰¿èªã‚’ãƒã‚¤ãƒ‘ã‚¹ã§ãã‚‹å½¹å‰²
    company_id INT,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (workflow_type_id) REFERENCES workflow_types(id),
    FOREIGN KEY (company_id) REFERENCES companies(id),
    UNIQUE(company_id, feature_code, action_type)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_approval_policies_feature ON approval_policies(feature_code, action_type);
CREATE INDEX idx_approval_policies_company ON approval_policies(company_id);
```

### 3.2 æ‰¿èªãƒãƒªã‚·ãƒ¼è¨­å®šä¾‹

```json
[
  {
    "feature_code": "USER_MANAGEMENT",
    "action_type": "CREATE",
    "policy_name": "ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ æ‰¿èª",
    "is_approval_required": true,
    "conditions": {},
    "workflow_type_id": 1,
    "bypass_roles": ["SUPER_ADMIN"]
  },
  {
    "feature_code": "USER_MANAGEMENT",
    "action_type": "UPDATE",
    "policy_name": "ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å¤‰æ›´æ‰¿èª",
    "is_approval_required": true,
    "conditions": {
      "require_approval_when": [
        {"field": "role", "change_type": "upgrade"},
        {"field": "permissions", "change_type": "expand"}
      ]
    },
    "workflow_type_id": 1,
    "bypass_roles": ["ADMIN"]
  },
  {
    "feature_code": "DEPARTMENT_MANAGEMENT",
    "action_type": "DELETE",
    "policy_name": "éƒ¨ç½²å‰Šé™¤æ‰¿èª",
    "is_approval_required": true,
    "conditions": {
      "require_approval_when": [
        {"field": "has_users", "operator": "greater_than", "value": 0}
      ]
    },
    "workflow_type_id": 2
  },
  {
    "feature_code": "DATA_EXPORT",
    "action_type": "EXPORT",
    "policy_name": "ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ‰¿èª",
    "is_approval_required": true,
    "conditions": {
      "require_approval_when": [
        {"field": "data_type", "operator": "in", "value": ["personal_info", "financial"]},
        {"field": "record_count", "operator": "greater_than", "value": 1000}
      ]
    },
    "workflow_type_id": 3
  }
]
```

## 4. æ‰¿èªåˆ¶å¾¡ã‚¨ãƒ³ã‚¸ãƒ³

### 4.1 æ‰¿èªåˆ¤å®šã‚µãƒ¼ãƒ“ã‚¹

```typescript
export class ApprovalPolicyService {

  /**
   * æŒ‡å®šã•ã‚ŒãŸæ“ä½œã«æ‰¿èªãŒå¿…è¦ã‹ã©ã†ã‹ã‚’åˆ¤å®š
   */
  async requiresApproval(
    featureCode: string,
    actionType: string,
    operationData: any,
    currentUser: User,
    companyId: number
  ): Promise<ApprovalRequirement> {

    // 1. è©²å½“ã™ã‚‹æ‰¿èªãƒãƒªã‚·ãƒ¼ã‚’å–å¾—
    const policy = await prisma.approval_policies.findFirst({
      where: {
        feature_code: featureCode,
        action_type: actionType,
        company_id: companyId,
        is_active: true
      },
      include: {
        workflow_types: true
      }
    });

    if (!policy) {
      return { required: false };
    }

    // 2. ãƒã‚¤ãƒ‘ã‚¹æ¨©é™ãƒã‚§ãƒƒã‚¯
    if (this.canBypassApproval(currentUser, policy.bypass_roles)) {
      return { required: false, reason: 'BYPASSED_BY_ROLE' };
    }

    // 3. æ¡ä»¶ãƒ™ãƒ¼ã‚¹åˆ¤å®š
    if (!policy.is_approval_required) {
      return { required: false };
    }

    const conditionsMet = await this.evaluateConditions(
      policy.conditions,
      operationData,
      currentUser
    );

    if (!conditionsMet) {
      return { required: false, reason: 'CONDITIONS_NOT_MET' };
    }

    return {
      required: true,
      policy: policy,
      workflowType: policy.workflow_types,
      estimatedDuration: this.estimateApprovalDuration(policy.workflow_type_id)
    };
  }

  /**
   * æ¡ä»¶è©•ä¾¡ã‚¨ãƒ³ã‚¸ãƒ³
   */
  private async evaluateConditions(
    conditions: any,
    operationData: any,
    currentUser: User
  ): Promise<boolean> {

    if (!conditions?.require_approval_when) {
      return true; // æ¡ä»¶æœªæŒ‡å®šã®å ´åˆã¯æ‰¿èªå¿…è¦
    }

    for (const condition of conditions.require_approval_when) {
      if (await this.evaluateSingleCondition(condition, operationData, currentUser)) {
        return true; // ã„ãšã‚Œã‹ã®æ¡ä»¶ã«åˆè‡´ã™ã‚Œã°æ‰¿èªå¿…è¦
      }
    }

    return false;
  }

  /**
   * å˜ä¸€æ¡ä»¶ã®è©•ä¾¡
   */
  private async evaluateSingleCondition(
    condition: any,
    operationData: any,
    currentUser: User
  ): Promise<boolean> {

    const { field, operator, value, change_type } = condition;

    switch (field) {
      case 'role':
        if (change_type === 'upgrade') {
          return this.isRoleUpgrade(operationData.oldRole, operationData.newRole);
        }
        break;

      case 'permissions':
        if (change_type === 'expand') {
          return this.isPermissionExpansion(operationData.oldPermissions, operationData.newPermissions);
        }
        break;

      case 'has_users':
        if (operator === 'greater_than') {
          const userCount = await this.getUserCountInDepartment(operationData.departmentId);
          return userCount > value;
        }
        break;

      case 'data_type':
        if (operator === 'in') {
          return value.includes(operationData.dataType);
        }
        break;

      case 'record_count':
        if (operator === 'greater_than') {
          return operationData.recordCount > value;
        }
        break;

      case 'amount':
        if (operator === 'greater_than') {
          return parseFloat(operationData.amount) > value;
        }
        break;
    }

    return false;
  }
}

interface ApprovalRequirement {
  required: boolean;
  reason?: string;
  policy?: any;
  workflowType?: any;
  estimatedDuration?: number; // æ‰¿èªå®Œäº†äºˆæƒ³æ™‚é–“ï¼ˆæ™‚é–“ï¼‰
}
```

## 5. æ—¢å­˜æ©Ÿèƒ½ã¸ã®çµ±åˆ

### 5.1 æ‰¿èªçµ±åˆãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼

```typescript
/**
 * æ‰¿èªåˆ¶å¾¡ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼
 */
export function RequiresApproval(featureCode: string, actionType: string) {
  return function (target: any, propertyName: string, descriptor: PropertyDescriptor) {
    const method = descriptor.value;

    descriptor.value = async function (...args: any[]) {
      const [operationData, currentUser] = args;

      // 1. æ‰¿èªè¦å¦åˆ¤å®š
      const requirement = await approvalPolicyService.requiresApproval(
        featureCode,
        actionType,
        operationData,
        currentUser,
        currentUser.companyId
      );

      if (!requirement.required) {
        // æ‰¿èªä¸è¦ - ç›´æ¥å®Ÿè¡Œ
        return await method.apply(this, args);
      }

      // 2. æ‰¿èªãƒ—ãƒ­ã‚»ã‚¹é–‹å§‹
      const approvalRequest = await this.startApprovalProcess(
        requirement,
        operationData,
        currentUser
      );

      return {
        status: 'PENDING_APPROVAL',
        approvalRequestId: approvalRequest.id,
        message: 'æ‰¿èªç”³è«‹ã‚’é–‹å§‹ã—ã¾ã—ãŸ',
        estimatedDuration: requirement.estimatedDuration
      };
    };
  };
}

// ä½¿ç”¨ä¾‹
export class UserService {

  @RequiresApproval('USER_MANAGEMENT', 'CREATE')
  async createUser(userData: CreateUserRequest, currentUser: User) {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆãƒ­ã‚¸ãƒƒã‚¯
    return await prisma.users.create({
      data: userData
    });
  }

  @RequiresApproval('USER_MANAGEMENT', 'UPDATE')
  async updateUser(userId: number, updateData: UpdateUserRequest, currentUser: User) {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯
    return await prisma.users.update({
      where: { id: userId },
      data: updateData
    });
  }
}
```

### 5.2 æ‰¿èªå®Œäº†æ™‚ã®è‡ªå‹•å®Ÿè¡Œ

```typescript
export class ApprovalCompletionService {

  /**
   * æ‰¿èªå®Œäº†æ™‚ã«å…ƒã®æ“ä½œã‚’å®Ÿè¡Œ
   */
  async executeApprovedOperation(approvalRequestId: number): Promise<any> {

    const request = await prisma.workflow_requests.findUnique({
      where: { id: approvalRequestId },
      include: {
        workflow_types: true
      }
    });

    if (!request || request.status !== 'APPROVED') {
      throw new Error('Invalid or unapproved request');
    }

    const { feature_code, action_type } = this.parseWorkflowType(request.workflow_types.code);
    const operationData = request.formData;

    // å…ƒã®æ“ä½œã‚’å®Ÿè¡Œ
    switch (feature_code) {
      case 'USER_MANAGEMENT':
        return await this.executeUserManagementOperation(action_type, operationData);

      case 'DEPARTMENT_MANAGEMENT':
        return await this.executeDepartmentOperation(action_type, operationData);

      case 'PERMISSION_MANAGEMENT':
        return await this.executePermissionOperation(action_type, operationData);

      default:
        throw new Error(`Unknown feature code: ${feature_code}`);
    }
  }

  private async executeUserManagementOperation(actionType: string, data: any) {
    switch (actionType) {
      case 'CREATE':
        return await prisma.users.create({
          data: {
            ...data,
            isActive: true,
            approval_status: 'APPROVED'
          }
        });

      case 'UPDATE':
        return await prisma.users.update({
          where: { id: data.userId },
          data: data.updateData
        });

      case 'DELETE':
        return await prisma.users.update({
          where: { id: data.userId },
          data: { isActive: false }
        });
    }
  }
}
```

## 6. ä¸€æ™‚æ“ä½œç®¡ç†

### 6.1 ä¸€æ™‚æ“ä½œãƒ†ãƒ¼ãƒ–ãƒ«

```sql
-- æ‰¿èªå¾…ã¡æ“ä½œãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE pending_operations (
    id SERIAL PRIMARY KEY,
    approval_request_id INT NOT NULL,
    operation_type VARCHAR(50) NOT NULL,  -- CREATE, UPDATE, DELETEç­‰
    target_table VARCHAR(50) NOT NULL,
    target_id INT,
    operation_data JSON NOT NULL,        -- æ“ä½œãƒ‡ãƒ¼ã‚¿
    original_data JSON,                  -- å¤‰æ›´å‰ãƒ‡ãƒ¼ã‚¿ï¼ˆUPDATE/DELETEæ™‚ï¼‰
    scheduled_execution_at TIMESTAMP,    -- å®Ÿè¡Œäºˆå®šæ—¥æ™‚
    executed_at TIMESTAMP,
    execution_result JSON,
    status VARCHAR(20) DEFAULT 'PENDING', -- PENDING, EXECUTED, FAILED, CANCELLED
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (approval_request_id) REFERENCES workflow_requests(id)
);
```

## 7. è¨­å®šç”»é¢ã§ã®æ‰¿èªãƒãƒªã‚·ãƒ¼ç®¡ç†

### 7.1 æ‰¿èªãƒãƒªã‚·ãƒ¼è¨­å®šUI

```vue
<template>
  <div class="approval-policy-settings">
    <el-card header="æ‰¿èªãƒãƒªã‚·ãƒ¼è¨­å®š">
      <el-table :data="policies" style="width: 100%">
        <el-table-column prop="feature_name" label="æ©Ÿèƒ½" />
        <el-table-column prop="action_type" label="æ“ä½œ" />
        <el-table-column label="æ‰¿èªè¦å¦">
          <template #default="{ row }">
            <el-switch
              v-model="row.is_approval_required"
              @change="updatePolicy(row)"
            />
          </template>
        </el-table-column>
        <el-table-column label="æ¡ä»¶">
          <template #default="{ row }">
            <el-button @click="editConditions(row)">è¨­å®š</el-button>
          </template>
        </el-table-column>
        <el-table-column label="ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼">
          <template #default="{ row }">
            <el-select v-model="row.workflow_type_id">
              <el-option
                v-for="workflow in workflowTypes"
                :key="workflow.id"
                :label="workflow.name"
                :value="workflow.id"
              />
            </el-select>
          </template>
        </el-table-column>
      </el-table>
    </el-card>

    <!-- æ¡ä»¶è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
    <el-dialog v-model="showConditionDialog" title="æ‰¿èªæ¡ä»¶è¨­å®š">
      <approval-condition-editor
        v-model="currentConditions"
        :feature-code="currentPolicy.feature_code"
      />
    </el-dialog>
  </div>
</template>
```

## 8. æ‰¿èªçŠ¶æ³ã®å¯è¦–åŒ–

### 8.1 æ‰¿èªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

```vue
<template>
  <div class="approval-dashboard">
    <!-- æ‰¿èªå¾…ã¡ä»¶æ•°ã‚µãƒãƒªãƒ¼ -->
    <el-row :gutter="20">
      <el-col :span="6" v-for="category in approvalSummary" :key="category.name">
        <el-card>
          <div class="summary-item">
            <h3>{{ category.name }}</h3>
            <p class="count">{{ category.pending_count }}</p>
            <p class="avg-time">å¹³å‡å‡¦ç†æ™‚é–“: {{ category.avg_processing_time }}æ™‚é–“</p>
          </div>
        </el-card>
      </el-col>
    </el-row>

    <!-- æ‰¿èªå¾…ã¡ä¸€è¦§ -->
    <el-card header="æ‰¿èªå¾…ã¡ä¸€è¦§">
      <el-table :data="pendingApprovals">
        <el-table-column prop="request_number" label="ç”³è«‹ç•ªå·" />
        <el-table-column prop="title" label="ç”³è«‹å†…å®¹" />
        <el-table-column prop="requester_name" label="ç”³è«‹è€…" />
        <el-table-column prop="current_step" label="æ‰¿èªæ®µéš" />
        <el-table-column prop="submitted_at" label="ç”³è«‹æ—¥æ™‚" />
        <el-table-column label="æ“ä½œ">
          <template #default="{ row }">
            <el-button @click="approveRequest(row)">æ‰¿èª</el-button>
            <el-button @click="rejectRequest(row)">å´ä¸‹</el-button>
          </template>
        </el-table-column>
      </el-table>
    </el-card>
  </div>
</template>
```

## 9. é«˜åº¦ãªæ‰¿èªåˆ¶å¾¡

### 9.1 æ™‚é–“ãƒ™ãƒ¼ã‚¹æ‰¿èª

```typescript
// å–¶æ¥­æ™‚é–“å¤–ã®æ“ä½œã¯ç¿Œå–¶æ¥­æ—¥ã¾ã§è‡ªå‹•ä¿ç•™
const timeBasedPolicy = {
  "feature_code": "SYSTEM_MAINTENANCE",
  "conditions": {
    "require_approval_when": [
      {
        "field": "execution_time",
        "operator": "outside_business_hours"
      }
    ],
    "auto_approve_during": "maintenance_window"
  }
};
```

### 9.2 é‡‘é¡ãƒ™ãƒ¼ã‚¹æ®µéšæ‰¿èª

```typescript
// é‡‘é¡ã«å¿œã˜ãŸæ®µéšçš„æ‰¿èªãƒ«ãƒ¼ãƒˆ
const amountBasedApproval = {
  "feature_code": "EXPENSE_APPROVAL",
  "approval_routes": [
    {
      "condition": {"amount": {"less_than": 10000}},
      "steps": [{"approver_type": "MANAGER"}]
    },
    {
      "condition": {"amount": {"between": [10000, 100000]}},
      "steps": [
        {"approver_type": "MANAGER"},
        {"approver_type": "DEPARTMENT_HEAD"}
      ]
    },
    {
      "condition": {"amount": {"greater_than": 100000}},
      "steps": [
        {"approver_type": "MANAGER"},
        {"approver_type": "DEPARTMENT_HEAD"},
        {"approver_type": "FINANCE_DIRECTOR"}
      ]
    }
  ]
};
```

### 9.3 ãƒªã‚¹ã‚¯ãƒ™ãƒ¼ã‚¹æ‰¿èª

```typescript
// ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸæ‰¿èªåˆ¶å¾¡
const riskBasedPolicy = {
  "feature_code": "DATA_ACCESS",
  "conditions": {
    "require_approval_when": [
      {
        "field": "data_sensitivity",
        "operator": "in",
        "value": ["CONFIDENTIAL", "TOP_SECRET"]
      },
      {
        "field": "access_time",
        "operator": "outside_normal_hours"
      },
      {
        "field": "access_location",
        "operator": "not_in_whitelist"
      }
    ]
  }
};
```

## 10. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 10.1 æ‰¿èªãƒãƒªã‚·ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥

```typescript
export class ApprovalPolicyCache {
  private cache = new Map<string, ApprovalPolicy>();
  private readonly TTL = 300000; // 5åˆ†

  async getPolicy(companyId: number, featureCode: string, actionType: string): Promise<ApprovalPolicy> {
    const key = `${companyId}:${featureCode}:${actionType}`;

    if (this.cache.has(key)) {
      return this.cache.get(key);
    }

    const policy = await this.loadPolicyFromDB(companyId, featureCode, actionType);
    this.cache.set(key, policy);

    // TTLè¨­å®š
    setTimeout(() => this.cache.delete(key), this.TTL);

    return policy;
  }
}
```

## 11. ç›£æŸ»ã¨ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹

### 11.1 æ‰¿èªæ“ä½œã®å®Œå…¨ç›£æŸ»

```typescript
export class ApprovalAuditService {

  async logApprovalAction(action: ApprovalAuditLog) {
    await prisma.audit_logs.create({
      data: {
        userId: action.userId,
        action: 'APPROVAL_ACTION',
        targetType: 'WORKFLOW_REQUEST',
        targetId: action.requestId,
        oldPermissions: action.beforeState,
        newPermissions: action.afterState,
        reason: action.reason,
        ipAddress: action.ipAddress,
        userAgent: action.userAgent,
        metadata: {
          approval_action: action.approvalAction,
          step_number: action.stepNumber,
          processing_time: action.processingTime,
          delegation_info: action.delegationInfo
        }
      }
    });
  }
}
```

## 12. ã¾ã¨ã‚

ã“ã®æ©Ÿèƒ½é–“é€£æºæ‰¿èªã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚Šï¼š

### âœ… å®Ÿç¾å¯èƒ½ãªæ©Ÿèƒ½

1. **æŸ”è»Ÿãªæ‰¿èªåˆ¶å¾¡**: æ©Ÿèƒ½ãƒ»æ“ä½œãƒ»æ¡ä»¶ã«å¿œã˜ãŸæ‰¿èªè¦å¦åˆ¤å®š
2. **æ—¢å­˜æ©Ÿèƒ½çµ±åˆ**: ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚ˆã‚‹éä¾µè¥²çš„çµ±åˆ
3. **æ¡ä»¶ãƒ™ãƒ¼ã‚¹æ‰¿èª**: é‡‘é¡ãƒ»æ™‚é–“ãƒ»ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ç­‰ã«ã‚ˆã‚‹å‹•çš„åˆ¶å¾¡
4. **æ®µéšçš„æ‰¿èª**: è¤‡é›‘ãªæ‰¿èªãƒ«ãƒ¼ãƒˆã®è¨­å®š
5. **è‡ªå‹•å®Ÿè¡Œ**: æ‰¿èªå®Œäº†æ™‚ã®æ“ä½œè‡ªå‹•å®Ÿè¡Œ
6. **å®Œå…¨ç›£æŸ»**: ã™ã¹ã¦ã®æ‰¿èªæ“ä½œã®è¿½è·¡

### ğŸš€ å°å…¥åŠ¹æœ

- **ã‚¬ãƒãƒŠãƒ³ã‚¹å¼·åŒ–**: ä¼æ¥­ãƒãƒªã‚·ãƒ¼ã«æº–æ‹ ã—ãŸé‹ç”¨
- **ãƒªã‚¹ã‚¯è»½æ¸›**: é‡è¦æ“ä½œã®äº‹å‰ãƒã‚§ãƒƒã‚¯
- **åŠ¹ç‡åŒ–**: æ¡ä»¶ã«å¿œã˜ãŸè‡ªå‹•æ‰¿èª
- **é€æ˜æ€§**: æ‰¿èªãƒ—ãƒ­ã‚»ã‚¹ã®å¯è¦–åŒ–
- **ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹**: å®Œå…¨ãªç›£æŸ»è¨¼è·¡

ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚Šã€ä¼æ¥­ã®æˆé•·æ®µéšã‚„æ¥­ç•Œè¦ä»¶ã«å¿œã˜ã¦ã€æŸ”è»Ÿã‹ã¤å³æ ¼ãªæ‰¿èªåˆ¶å¾¡ãŒå®Ÿç¾ã§ãã¾ã™ã€‚

<function_calls>
<invoke name="TodoWrite">
<parameter name="todos">[{"content": "\u7533\u8acb\u30fb\u627f\u8a8d\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u6a5f\u80fd\u306e\u8a2d\u8a08", "status": "completed", "activeForm": "\u7533\u8acb\u30fb\u627f\u8a8d\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u6a5f\u80fd\u3092\u8a2d\u8a08\u4e2d"}, {"content": "\u6a5f\u80fd\u8a2d\u8a08\u66f8\u306e\u4f5c\u6210", "status": "completed", "activeForm": "\u6a5f\u80fd\u8a2d\u8a08\u66f8\u3092\u4f5c\u6210\u4e2d"}, {"content": "\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u8a2d\u8a08\uff08\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u95a2\u9023\u30c6\u30fc\u30d6\u30eb\uff09", "status": "completed", "activeForm": "\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u8a2d\u8a08\u4e2d"}, {"content": "Prisma\u30b9\u30ad\u30fc\u30de\u4f5c\u6210\uff08\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u95a2\u9023\u30c6\u30fc\u30d6\u30eb\uff09", "status": "completed", "activeForm": "Prisma\u30b9\u30ad\u30fc\u30de\u3092\u4f5c\u6210\u4e2d"}, {"content": "\u30e6\u30fc\u30b6\u30fc\u8ffd\u52a0\u627f\u8a8d\u30d5\u30ed\u30fc\u8a2d\u8a08", "status": "completed", "activeForm": "\u30e6\u30fc\u30b6\u30fc\u8ffd\u52a0\u627f\u8a8d\u30d5\u30ed\u30fc\u3092\u8a2d\u8a08\u4e2d"}, {"content": "\u6a5f\u80fd\u9593\u9023\u643a\u627f\u8a8d\u30b7\u30b9\u30c6\u30e0\u8a2d\u8a08", "status": "completed", "activeForm": "\u6a5f\u80fd\u9593\u9023\u643a\u627f\u8a8d\u30b7\u30b9\u30c6\u30e0\u3092\u8a2d\u8a08\u4e2d"}, {"content": "\u30d0\u30c3\u30af\u30a8\u30f3\u30c9API\u5b9f\u88c5", "status": "pending", "activeForm": "\u30d0\u30c3\u30af\u30a8\u30f3\u30c9API\u3092\u5b9f\u88c5\u4e2d"}, {"content": "\u30d5\u30ed\u30f3\u30c8\u30a8\u30f3\u30c9\u753b\u9762\u5b9f\u88c5", "status": "pending", "activeForm": "\u30d5\u30ed\u30f3\u30c8\u30a8\u30f3\u30c9\u753b\u9762\u3092\u5b9f\u88c5\u4e2d"}, {"content": "\u5358\u4f53\u8a66\u9a13\u5b9f\u88c5", "status": "pending", "activeForm": "\u5358\u4f53\u8a66\u9a13\u3092\u5b9f\u88c5\u4e2d"}]