# 権限テンプレート機能 単体試験仕様書

## 概要
権限テンプレート機能の単体試験仕様書です。バックエンドAPI、フロントエンドコンポーネント、データベース操作の各層について試験項目を定義します。

**作成日**: 2025-09-25
**対象機能**: 権限テンプレート管理システム
**対象ファイル**:
- Backend: `/src/routes/permissions.ts` (テンプレート関連API)
- Frontend: `/src/views/PermissionTemplate.vue`
- Database: `permission_templates`, `permission_template_features` テーブル

---

## 1. バックエンドAPI単体試験

### 1.1 権限テンプレート一覧取得API

**エンドポイント**: `GET /api/permissions/templates`

| テストケースID | テスト項目 | 入力値 | 期待値 | テスト分類 |
|-------------|-----------|--------|--------|-----------|
| PT-API-001 | 正常系：会社IDが有効な場合 | `?companyId=1` (認証済み) | `200 OK`, テンプレート配列 | 正常系 |
| PT-API-002 | 準正常系：該当データなし | `?companyId=999` (認証済み) | `200 OK`, 空配列 | 準正常系 |
| PT-API-003 | 異常系：認証なし | パラメータなし | `401 Unauthorized` | 異常系 |
| PT-API-004 | 異常系：companyId未指定 | リクエストパラメータなし | `400 Bad Request` | 異常系 |
| PT-API-005 | 異常系：不正なcompanyId | `?companyId=abc` | `400 Bad Request` | 異常系 |

**期待レスポンス構造**:
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "管理者テンプレート",
      "description": "管理者用権限テンプレート",
      "category": "ADMIN",
      "isPreset": true,
      "displayOrder": 1,
      "features": [
        {
          "featureId": 1,
          "featureCode": "USER_MANAGEMENT",
          "featureName": "ユーザー管理",
          "featureCategory": "ADMIN",
          "permissions": {
            "canView": true,
            "canCreate": true,
            "canEdit": true,
            "canDelete": false,
            "canApprove": true,
            "canExport": true
          }
        }
      ]
    }
  ],
  "meta": {
    "timestamp": "2025-09-25T10:00:00.000Z"
  }
}
```

### 1.2 権限テンプレート作成API

**エンドポイント**: `POST /api/permissions/templates`

| テストケースID | テスト項目 | 入力値 | 期待値 | テスト分類 |
|-------------|-----------|--------|--------|-----------|
| PT-API-006 | 正常系：有効なデータで作成 | 正常なリクエストボディ | `201 Created`, 作成されたテンプレート情報 | 正常系 |
| PT-API-007 | 正常系：最小限のデータで作成 | name, companyId, features のみ | `201 Created` | 正常系 |
| PT-API-008 | 異常系：必須フィールド不足 | name なし | `400 Bad Request`, バリデーションエラー | 異常系 |
| PT-API-009 | 異常系：companyId不足 | companyId なし | `400 Bad Request` | 異常系 |
| PT-API-010 | 異常系：features不足 | features なし | `400 Bad Request` | 異常系 |
| PT-API-011 | 異常系：不正なcompanyId | 存在しない会社ID | `404 Not Found` | 異常系 |
| PT-API-012 | 異常系：重複名 | 既存テンプレート名 | `400 Bad Request`, 重複エラー | 異常系 |
| PT-API-013 | 異常系：認証なし | 認証ヘッダーなし | `401 Unauthorized` | 異常系 |

**正常系リクエストボディ**:
```json
{
  "companyId": 1,
  "name": "新規テンプレート",
  "description": "テスト用テンプレート",
  "category": "CUSTOM",
  "features": [
    {
      "featureId": 1,
      "canView": true,
      "canCreate": false,
      "canEdit": false,
      "canDelete": false,
      "canApprove": false,
      "canExport": true
    }
  ]
}
```

### 1.3 権限テンプレート更新API

**エンドポイント**: `PUT /api/permissions/templates/:templateId`

| テストケースID | テスト項目 | 入力値 | 期待値 | テスト分類 |
|-------------|-----------|--------|--------|-----------|
| PT-API-014 | 正常系：全フィールド更新 | templateId=1, 全フィールド | `200 OK`, 更新されたテンプレート情報 | 正常系 |
| PT-API-015 | 正常系：部分更新 | templateId=1, name のみ | `200 OK` | 正常系 |
| PT-API-016 | 正常系：権限設定更新 | templateId=1, features のみ | `200 OK` | 正常系 |
| PT-API-017 | 異常系：存在しないテンプレート | templateId=999 | `404 Not Found` | 異常系 |
| PT-API-018 | 異常系：プリセットテンプレート編集 | isPreset=true のテンプレート | `403 Forbidden` | 異常系 |
| PT-API-019 | 異常系：認証なし | 認証ヘッダーなし | `401 Unauthorized` | 異常系 |

### 1.4 権限テンプレート削除API

**エンドポイント**: `DELETE /api/permissions/templates/:templateId`

| テストケースID | テスト項目 | 入力値 | 期待値 | テスト分類 |
|-------------|-----------|--------|--------|-----------|
| PT-API-020 | 正常系：カスタムテンプレート削除 | templateId=1 (カスタム) | `200 OK` | 正常系 |
| PT-API-021 | 異常系：存在しないテンプレート | templateId=999 | `404 Not Found` | 異常系 |
| PT-API-022 | 異常系：プリセットテンプレート削除 | isPreset=true のテンプレート | `403 Forbidden` | 異常系 |
| PT-API-023 | 異常系：認証なし | 認証ヘッダーなし | `401 Unauthorized` | 異常系 |

### 1.5 権限テンプレート適用API

**エンドポイント**: `POST /api/permissions/templates/:templateId/apply`

| テストケースID | テスト項目 | 入力値 | 期待値 | テスト分類 |
|-------------|-----------|--------|--------|-----------|
| PT-API-024 | 正常系：単一部署に適用 | templateId=1, departmentIds=[1] | `200 OK`, 適用結果 | 正常系 |
| PT-API-025 | 正常系：複数部署に適用 | templateId=1, departmentIds=[1,2] | `200 OK` | 正常系 |
| PT-API-026 | 正常系：既存権限上書き | 権限設定済み部署に適用 | `200 OK`, 権限上書き確認 | 正常系 |
| PT-API-027 | 異常系：存在しないテンプレート | templateId=999 | `404 Not Found` | 異常系 |
| PT-API-028 | 異常系：部署ID配列なし | departmentIds なし | `400 Bad Request` | 異常系 |
| PT-API-029 | 異常系：空の部署ID配列 | departmentIds=[] | `400 Bad Request` | 異常系 |
| PT-API-030 | 異常系：存在しない部署ID | departmentIds=[999] | `400 Bad Request` | 異常系 |

---

## 2. フロントエンドコンポーネント単体試験

### 2.1 PermissionTemplate.vue コンポーネント

| テストケースID | テスト項目 | 操作 | 期待結果 | テスト分類 |
|-------------|-----------|------|----------|-----------|
| PT-FE-001 | 初期表示 | コンポーネントマウント | テンプレート一覧表示、ローディング終了 | 正常系 |
| PT-FE-002 | テンプレート一覧表示 | API成功レスポンス | 各テンプレートの情報正しく表示 | 正常系 |
| PT-FE-003 | 新規作成ダイアログ表示 | 「新規作成」ボタンクリック | ダイアログ表示、空フォーム | 正常系 |
| PT-FE-004 | テンプレート作成 | フォーム入力→保存 | 作成成功、一覧更新 | 正常系 |
| PT-FE-005 | 編集ダイアログ表示 | 「編集」ボタンクリック | ダイアログ表示、既存値セット | 正常系 |
| PT-FE-006 | テンプレート更新 | データ変更→保存 | 更新成功、一覧更新 | 正常系 |
| PT-FE-007 | 削除確認 | 「削除」ボタンクリック | 確認ダイアログ表示 | 正常系 |
| PT-FE-008 | テンプレート削除 | 削除確認→実行 | 削除成功、一覧から除去 | 正常系 |
| PT-FE-009 | 適用ダイアログ表示 | 「適用」ボタンクリック | 適用ダイアログ、部署選択 | 正常系 |
| PT-FE-010 | テンプレート適用 | 部署選択→適用 | 適用成功メッセージ | 正常系 |
| PT-FE-011 | 権限一括設定 | 「全て選択」ボタン | 全ての権限チェックボックスON | 正常系 |
| PT-FE-012 | 権限一括解除 | 「全て解除」ボタン | 全ての権限チェックボックスOFF | 正常系 |
| PT-FE-013 | プリセット制御 | プリセットテンプレート | 編集・削除ボタン無効化 | 正常系 |
| PT-FE-014 | バリデーション | 必須項目空白で保存 | バリデーションエラー表示 | 異常系 |
| PT-FE-015 | APIエラーハンドリング | API失敗レスポンス | エラーメッセージ表示 | 異常系 |

### 2.2 権限設定テーブル

| テストケースID | テスト項目 | 操作 | 期待結果 | テスト分類 |
|-------------|-----------|------|----------|-----------|
| PT-FE-016 | 閲覧権限連動 | 閲覧権限OFF | 他の権限も全てOFF | 正常系 |
| PT-FE-017 | 権限チェック制御 | 閲覧権限OFF状態 | 他の権限チェックボックス無効 | 正常系 |
| PT-FE-018 | 機能別権限表示 | 機能一覧読み込み | 各機能の権限設定表示 | 正常系 |

---

## 3. データベース操作単体試験

### 3.1 permission_templates テーブル

| テストケースID | テスト項目 | 操作 | 期待結果 | テスト分類 |
|-------------|-----------|------|----------|-----------|
| PT-DB-001 | テンプレート挿入 | INSERT文実行 | 正常挿入、ID自動生成 | 正常系 |
| PT-DB-002 | 一意制約チェック | 同名テンプレート挿入 | 制約違反エラー | 異常系 |
| PT-DB-003 | 外部キー制約 | 存在しないcompanyId | 外部キー制約エラー | 異常系 |
| PT-DB-004 | 削除処理 | DELETE文実行 | カスケード削除確認 | 正常系 |

### 3.2 permission_template_features テーブル

| テストケースID | テスト項目 | 操作 | 期待結果 | テスト分類 |
|-------------|-----------|------|----------|-----------|
| PT-DB-005 | 権限設定挿入 | INSERT文実行 | 正常挿入 | 正常系 |
| PT-DB-006 | 一意制約チェック | 同一templateId+featureId | 制約違反エラー | 異常系 |
| PT-DB-007 | カスケード削除 | テンプレート削除 | 関連権限設定も削除 | 正常系 |

---

## 4. 統合試験項目

### 4.1 エンドツーエンド試験

| テストケースID | テスト項目 | 操作手順 | 期待結果 | テスト分類 |
|-------------|-----------|----------|----------|-----------|
| PT-E2E-001 | 完全なテンプレート作成フロー | 画面からテンプレート作成→DB確認 | 全層でデータ整合性確保 | 統合試験 |
| PT-E2E-002 | テンプレート適用フロー | テンプレート適用→部署権限確認 | 権限正しく適用 | 統合試験 |
| PT-E2E-003 | 権限継承確認 | テンプレート→部署→ユーザー | 権限継承チェーン確認 | 統合試験 |

---

## 5. 性能試験項目

### 5.1 負荷試験

| テストケースID | テスト項目 | 条件 | 期待結果 | テスト分類 |
|-------------|-----------|------|----------|-----------|
| PT-PERF-001 | 大量テンプレート取得 | 1000件のテンプレート | 2秒以内で応答 | 性能試験 |
| PT-PERF-002 | 同時作成リクエスト | 10並行リクエスト | エラー無し、整合性確保 | 性能試験 |

---

## 6. セキュリティ試験項目

### 6.1 認証・認可

| テストケースID | テスト項目 | 条件 | 期待結果 | テスト分類 |
|-------------|-----------|------|----------|-----------|
| PT-SEC-001 | 認証なしアクセス | 認証トークンなし | 401エラー | セキュリティ |
| PT-SEC-002 | 他社データアクセス | 異なる会社のテンプレート | 403エラーまたはデータなし | セキュリティ |
| PT-SEC-003 | SQLインジェクション | 悪意のあるクエリ | エスケープ処理、エラーなし | セキュリティ |

---

## 7. 試験実行計画

### 7.1 試験環境
- **開発環境**: Docker Development Environment
- **データベース**: PostgreSQL (テスト用DB)
- **認証**: JWT トークンベース

### 7.2 試験データ
- 会社データ: 3社
- 部署データ: 各社5部署
- ユーザーデータ: 各部署3ユーザー
- 機能データ: 10機能
- プリセットテンプレート: 3種類

### 7.3 実行順序
1. データベース単体試験
2. バックエンドAPI単体試験
3. フロントエンド単体試験
4. 統合試験
5. 性能・セキュリティ試験

### 7.4 成功基準
- **単体試験**: 全項目パス率 100%
- **統合試験**: 主要フロー 100% 動作確認
- **性能試験**: レスポンス時間基準内
- **セキュリティ試験**: 脆弱性なし

---

**作成者**: Claude Code Assistant
**レビュー要**: 設計書との整合性確認
**次回更新**: 試験実行後