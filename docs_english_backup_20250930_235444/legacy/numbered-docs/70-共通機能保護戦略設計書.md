# 共通機能保護戦略設計書

## 文書情報
- **文書名**: 共通機能保護戦略設計書
- **バージョン**: 1.0
- **作成日**: 2025-09-30
- **作成者**: システム設計チーム
- **承認者**: プロジェクトマネージャー
- **最終更新日**: 2025-09-30

## 1. 概要

### 1.1 背景と目的
本設計書は、企業向けカスタマイズ時に共通機能（コア機能）を適切に保護し、システムの安定性と拡張性を両立させるための戦略と実装方法を定義する。

### 1.2 スコープ
- **対象**: WebSysプラットフォームの全共通機能
- **範囲**: アーキテクチャ設計、実装ガイドライン、運用手順
- **期間**: 2025年度第4四半期〜2026年度第1四半期

### 1.3 想定される利用シーン
- 企業別カスタマイズプロジェクト
- SaaS型マルチテナント展開
- パートナー企業によるOEM提供
- 業界別パッケージ開発

## 2. 保護レベル定義

### 2.1 保護レベルマトリクス

| レベル | 名称 | 変更可否 | 拡張可否 | 上書き可否 | 対象機能例 |
|--------|------|----------|----------|------------|------------|
| L1 | CORE | ✗ | ✗ | ✗ | 認証、監査ログ、セキュリティ |
| L2 | PROTECTED | ✗ | ✓ | ✗ | 権限管理、基本API |
| L3 | EXTENSIBLE | ✗ | ✓ | ✓ | ワークフロー、通知 |
| L4 | CUSTOMIZABLE | ✓ | ✓ | ✓ | UI、レポート、業務機能 |

### 2.2 保護対象機能一覧

#### L1: CORE（完全保護）
```
- 認証システム（JWT、セッション管理）
- 監査ログ（改ざん防止）
- セキュリティ機能（暗号化、XSS/CSRF対策）
- システム基盤（データベース接続、キャッシュ）
```

#### L2: PROTECTED（拡張可能）
```
- 権限管理（RBAC）
- ユーザー管理
- 基本API構造
- ログ収集機能
```

#### L3: EXTENSIBLE（上書き可能）
```
- ワークフロー定義
- 通知システム
- レポート生成
- データインポート/エクスポート
```

#### L4: CUSTOMIZABLE（完全カスタマイズ可能）
```
- UIコンポーネント
- ダッシュボード
- 業務固有機能
- カスタムレポート
```

## 3. アーキテクチャ設計

### 3.1 全体構成

```
websys-platform/
├── packages/
│   ├── @websys/core/              # L1: 完全保護
│   │   ├── auth/
│   │   ├── security/
│   │   └── audit/
│   ├── @websys/protected/         # L2: 保護（拡張可能）
│   │   ├── permissions/
│   │   ├── users/
│   │   └── api-base/
│   ├── @websys/extensible/        # L3: 拡張可能
│   │   ├── workflow/
│   │   ├── notifications/
│   │   └── reports/
│   └── @websys/components/        # L4: カスタマイズ可能
│       ├── ui/
│       └── widgets/
├── extensions/                     # 企業別拡張
│   └── {company-id}/
│       ├── overrides/
│       ├── plugins/
│       └── config/
└── deployments/                    # デプロイメント設定
    ├── standalone/
    ├── multi-tenant/
    └── enterprise/
```

### 3.2 技術スタック

| レイヤー | 技術 | 用途 |
|----------|------|------|
| パッケージ管理 | npm/yarn workspaces | モノレポ管理 |
| ビルド | TypeScript + Rollup | トランスパイル・バンドル |
| 依存性注入 | InversifyJS | 拡張ポイント管理 |
| 設定管理 | JSON Schema | バリデーション |
| テスト | Jest + Contract Testing | 互換性保証 |

### 3.3 保護メカニズム

#### 3.3.1 コンパイル時保護
```typescript
// core/decorators.ts
export function CoreFeature(options: { protected: boolean }) {
  return function (constructor: Function) {
    Object.freeze(constructor);
    Object.freeze(constructor.prototype);
  }
}

@CoreFeature({ protected: true })
export class AuthenticationService {
  // 変更不可能なコア機能
}
```

#### 3.3.2 実行時保護
```typescript
// runtime/protection.ts
export class ProtectionManager {
  validateExtension(extension: IExtension): void {
    if (extension.overrides?.includes('core')) {
      throw new SecurityError('Core features cannot be overridden');
    }
  }
}
```

## 4. 実装計画

### 4.1 フェーズ1: 基盤構築（2025年10月〜11月）

| タスク | 優先度 | 工数 | 担当 | 完了条件 |
|--------|--------|------|------|----------|
| モノレポ環境構築 | 高 | 3日 | インフラ | packages構成完了 |
| Core機能の分離 | 高 | 5日 | 開発 | 認証・監査ログ分離 |
| 保護デコレータ実装 | 高 | 2日 | 開発 | 単体テスト完了 |
| CI/CDパイプライン | 中 | 3日 | インフラ | 自動ビルド確認 |

### 4.2 フェーズ2: 拡張機能実装（2025年12月）

| タスク | 優先度 | 工数 | 担当 | 完了条件 |
|--------|--------|------|------|----------|
| 拡張インターフェース定義 | 高 | 3日 | 設計 | I/F文書完成 |
| プラグインシステム実装 | 高 | 5日 | 開発 | サンプル動作 |
| 設定スキーマ定義 | 中 | 2日 | 開発 | バリデーション動作 |
| 拡張機能テンプレート | 低 | 2日 | 開発 | テンプレート提供 |

### 4.3 フェーズ3: カスタマイズ対応（2026年1月）

| タスク | 優先度 | 工数 | 担当 | 完了条件 |
|--------|--------|------|------|----------|
| UIテーマシステム | 中 | 3日 | フロント | テーマ切替動作 |
| カスタムコンポーネント | 中 | 3日 | フロント | サンプル実装 |
| 企業別設定管理 | 高 | 2日 | 開発 | マルチテナント対応 |
| ドキュメント整備 | 高 | 5日 | 全員 | 開発者ガイド完成 |

## 5. 実装ガイドライン

### 5.1 コア機能の実装規則

```typescript
// ✅ 正しい実装
import { CoreFeature, sealed } from '@websys/core';

@CoreFeature({ level: 'L1' })
@sealed
export class JWTAuthService {
  private readonly secret = process.env.JWT_SECRET;

  // publicメソッドもfinalとして扱う
  public async verifyToken(token: string): Promise<User> {
    // 実装
  }
}

// ❌ 避けるべき実装
export class JWTAuthService {
  public secret = 'hardcoded'; // 設定値の露出
  public verifyToken() { }     // 型定義なし
}
```

### 5.2 拡張ポイントの定義

```typescript
// extensible/interfaces.ts
export interface IWorkflowExtension {
  // 必須実装
  name: string;
  version: string;

  // 拡張ポイント（オプション）
  beforeApprove?: (context: WorkflowContext) => Promise<void>;
  afterApprove?: (context: WorkflowContext) => Promise<void>;
  customValidation?: (data: any) => ValidationResult;
}

// 企業実装例
export class CompanyAWorkflow implements IWorkflowExtension {
  name = 'company-a-workflow';
  version = '1.0.0';

  async beforeApprove(context: WorkflowContext) {
    // 企業固有の承認前処理
    await this.notifyManager(context);
  }
}
```

### 5.3 カスタマイズ設定

```json
// extensions/{company}/config/customization.json
{
  "$schema": "../../../schemas/customization.schema.json",
  "companyId": "company-a",
  "features": {
    "core": {
      "protected": true,
      "overrides": [] // 上書き不可
    },
    "extensible": {
      "workflow": {
        "extensions": ["company-a-workflow"],
        "config": {
          "approvalLevels": 3,
          "timeoutHours": 48
        }
      }
    },
    "customizable": {
      "ui": {
        "theme": "company-a-theme",
        "logo": "/assets/company-a/logo.png"
      }
    }
  }
}
```

## 6. テスト戦略

### 6.1 テストレベル

| レベル | 対象 | 手法 | 自動化 |
|--------|------|------|--------|
| 単体テスト | 各パッケージ | Jest | ✓ |
| 統合テスト | パッケージ間連携 | Jest + Supertest | ✓ |
| Contract Test | 拡張I/F | Pact | ✓ |
| E2Eテスト | 全体フロー | Cypress | ✓ |
| 互換性テスト | バージョン間 | カスタムスクリプト | ✓ |

### 6.2 保護機能のテスト

```typescript
// tests/protection.test.ts
describe('Core Protection Tests', () => {
  test('Core機能の変更を防ぐ', () => {
    const authService = new JWTAuthService();
    expect(() => {
      authService.verifyToken = jest.fn(); // 上書き試行
    }).toThrow('Cannot assign to read only property');
  });

  test('不正な拡張を検出', () => {
    const extension = {
      overrides: ['core.auth']
    };
    expect(() => {
      protectionManager.validateExtension(extension);
    }).toThrow(SecurityError);
  });
});
```

## 7. 運用・保守

### 7.1 バージョン管理

```
@websys/core: 1.0.0     # メジャーバージョンは年1回
@websys/protected: 1.x.x # マイナーは四半期ごと
@websys/extensible: 1.x.x # パッチは随時
```

### 7.2 後方互換性ポリシー

- **L1 (CORE)**: 破壊的変更は最小2年前に予告
- **L2 (PROTECTED)**: 1年前に予告
- **L3 (EXTENSIBLE)**: 6ヶ月前に予告
- **L4 (CUSTOMIZABLE)**: 3ヶ月前に予告

### 7.3 移行支援

```typescript
// migration/v1-to-v2.ts
export class MigrationHelper {
  async migrate(fromVersion: string, toVersion: string) {
    // 自動移行スクリプト
    const migrations = this.getMigrations(fromVersion, toVersion);
    for (const migration of migrations) {
      await migration.run();
    }
  }
}
```

## 8. セキュリティ考慮事項

### 8.1 脅威モデル

| 脅威 | リスクレベル | 対策 |
|------|-------------|------|
| コア機能の改ざん | 高 | コード署名、実行時検証 |
| 権限昇格 | 高 | RBAC、最小権限の原則 |
| 不正なプラグイン | 中 | サンドボックス、署名検証 |
| 設定の改ざん | 中 | スキーマ検証、暗号化 |

### 8.2 監査要件

```typescript
// audit/requirements.ts
export interface AuditRequirements {
  // 全ての保護レベル変更を記録
  logProtectionChange: boolean;
  // 拡張機能のロードを記録
  logExtensionLoad: boolean;
  // 設定変更を記録
  logConfigChange: boolean;
  // 改ざん検知
  integrityCheck: boolean;
}
```

## 9. 成功指標（KPI）

| 指標 | 目標値 | 測定方法 |
|------|--------|----------|
| コア機能の安定性 | 99.99% | 障害発生率 |
| カスタマイズ工数削減 | 50%削減 | 開発時間計測 |
| 拡張機能の再利用率 | 70%以上 | 利用統計 |
| セキュリティインシデント | 0件 | インシデント記録 |
| 開発者満足度 | 4.0/5.0以上 | アンケート |

## 10. リスク管理

### 10.1 技術的リスク

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| パッケージ依存地獄 | 高 | 中 | 厳格なバージョン管理 |
| パフォーマンス劣化 | 中 | 低 | ベンチマークテスト |
| 複雑性の増大 | 中 | 中 | シンプルな設計維持 |

### 10.2 ビジネスリスク

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| 開発期間の遅延 | 高 | 中 | 段階的リリース |
| 顧客要望との乖離 | 高 | 低 | 早期フィードバック |
| 保守コスト増大 | 中 | 低 | 自動化推進 |

## 11. 承認と改訂

### 11.1 承認履歴

| 版数 | 承認日 | 承認者 | 主な変更内容 |
|------|--------|--------|-------------|
| 1.0 | 2025-09-30 | PM | 初版作成 |

### 11.2 レビュー計画

- **定期レビュー**: 四半期ごと
- **臨時レビュー**: 重大な問題発生時
- **年次レビュー**: アーキテクチャ全体の見直し

## 12. 付録

### A. 用語集

| 用語 | 定義 |
|------|------|
| コア機能 | システムの基盤となる変更不可能な機能 |
| 拡張ポイント | カスタマイズ可能な接続点 |
| プラグイン | 独立して追加可能な機能モジュール |
| マルチテナント | 複数企業で共有するシステム構成 |

### B. 参考資料

1. [プラグインアーキテクチャ設計パターン](https://docs.example.com/plugin-architecture)
2. [セキュアコーディングガイドライン](https://docs.example.com/secure-coding)
3. [npm workspaces公式ドキュメント](https://docs.npmjs.com/cli/v7/using-npm/workspaces)

### C. 連絡先

- **設計チーム**: design-team@websys.com
- **開発チーム**: dev-team@websys.com
- **運用チーム**: ops-team@websys.com

---

**文書管理番号**: DOC-2025-070
**次回レビュー予定日**: 2025-12-31