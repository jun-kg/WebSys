# 修正・水平展開チェックリスト

## 修正プロセス (必須手順)

### Phase 1: 不具合発見・記録
- [ ] 不具合管理表に新規エントリを作成
- [ ] 症状を詳細に記録（エラーメッセージ、再現手順等）
- [ ] 影響範囲と重要度を設定
- [ ] 担当者と対応開始日を記録

### Phase 2: 原因調査・修正
- [ ] 根本原因を特定し記録
- [ ] 修正方針を決定し記録
- [ ] 修正実装（コード変更、設定変更等）
- [ ] ローカル環境で動作確認

### Phase 3: 水平展開チェック（必須）
- [ ] **同様の問題が他の箇所にないかチェック**
- [ ] チェック対象リストを作成
- [ ] 体系的なチェック実施
- [ ] 発見した問題があれば即座に修正
- [ ] チェック結果を不具合管理表に記録

### Phase 4: 最終確認・記録更新
- [ ] 修正後の動作確認（エンドツーエンド）
- [ ] 不具合管理表のステータス更新
- [ ] 再発防止策を検討し記録
- [ ] 必要に応じて開発ガイドライン更新

---

## 水平展開チェックマトリックス

### A. Prismaモデル名関連チェック

**対象パターン:**
- `prisma.xxxs.findMany()` のタイポ
- `prisma.xxx_sessions` vs `prisma.xxxSessions`
- リレーション名の不一致

**チェック箇所:**
- [ ] `src/services/` 配下の全ファイル
- [ ] `src/routes/` 配下の全ファイル
- [ ] `src/controllers/` 配下の全ファイル
- [ ] `src/middleware/` 配下の全ファイル

**チェックコマンド:**
```bash
# モデル名のタイポチェック
grep -rn "prisma\.[a-zA-Z_]*[sS]\.find\|prisma\.[a-zA-Z_]*[sS]\.count" --include="*.ts" src/

# リレーション名の一貫性チェック
grep -rn "\.(company|department|primaryDepartment):" --include="*.ts" src/
```

### B. 認証・セッション関連チェック

**対象パターン:**
- パスワードハッシュ不整合
- JWTトークン処理エラー
- セッション管理エラー

**チェック箇所:**
- [ ] AuthService.ts
- [ ] auth.ts (routes)
- [ ] auth.ts (middleware)
- [ ] ログイン関連のフロントエンドコード

### C. API エンドポイント関連チェック

**対象パターン:**
- レスポンス形式不整合
- エラーハンドリング不備
- 権限チェック漏れ

**チェック箇所:**
- [ ] 全ルートファイル (`src/routes/*.ts`)
- [ ] コントローラーファイル (`src/controllers/*.ts`)
- [ ] ミドルウェア (`src/middleware/*.ts`)

---

## 品質チェック自動化コマンド

### 1. Prismaモデル名チェック
```bash
# 全ファイルでのPrismaモデル参照をチェック
find src -name "*.ts" -exec grep -l "prisma\." {} \; | xargs -I {} sh -c 'echo "=== {} ==="; grep -n "prisma\." "{}"'
```

### 2. TypeScriptコンパイルチェック
```bash
npx tsc --noEmit
```

### 3. ESLintチェック
```bash
npm run lint
```

### 4. API疎通テスト
```bash
# 主要エンドポイントの疎通確認
curl -X POST http://localhost:8000/api/auth/login -H "Content-Type: application/json" -d '{"username": "admin", "password": "password123"}'
curl -H "Authorization: Bearer {TOKEN}" http://localhost:8000/api/users
curl -H "Authorization: Bearer {TOKEN}" http://localhost:8000/api/companies
```

---

## プロジェクト固有のチェック項目

### 1. Prisma関連
- [ ] スキーマとモデル名の一致確認
- [ ] リレーション名の統一性確認
- [ ] マイグレーション適用状況確認

### 2. 認証システム
- [ ] JWT シークレット設定確認
- [ ] パスワードハッシュ化処理確認
- [ ] セッション管理ロジック確認

### 3. API設計
- [ ] エラーレスポンス統一確認
- [ ] 権限チェック実装確認
- [ ] バリデーション実装確認

### 4. データベース
- [ ] 初期データ整合性確認
- [ ] インデックス設定確認
- [ ] 外部キー制約確認

---

## 緊急時対応手順

### 1. 本番環境で問題発生時
1. 即座に影響範囲を特定
2. ロールバック可能性を判断
3. 不具合管理表に緊急エントリ作成
4. 修正後は**必ず水平展開チェック実施**

### 2. データベース関連問題
1. バックアップ取得確認
2. マイグレーション履歴確認
3. データ整合性チェック
4. 関連テーブルへの影響調査

---

## 月次レビュー項目

- [ ] 不具合管理表の統計分析
- [ ] 再発防止策の効果測定
- [ ] チェックリストの有効性検証
- [ ] 開発プロセス改善提案

---

*作成日: 2025-09-24*
*最終更新: 2025-09-24*