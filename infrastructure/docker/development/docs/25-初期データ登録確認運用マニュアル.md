# 初期データ登録確認運用マニュアル

## 📋 概要

本マニュアルは、初期データが変更された際のデータ登録確認手順を定義します。
システムの整合性と信頼性を保つため、初期データ変更時は必ずこの手順に従って確認作業を実施してください。

**最終更新**: 2025年9月23日
**対象バージョン**: v1.0.0以降
**対象者**: システム管理者、開発者

---

## 🎯 適用タイミング

以下の場合に本マニュアルの手順を実施してください：

### 🔴 必須実施ケース
- 初期データ（シードデータ）の変更・追加
- データベーススキーマの変更
- 新しい企業・ユーザー・機能の追加
- システム初期化後の動作確認
- 本番環境へのデプロイ前確認

### 🟡 推奨実施ケース
- 定期メンテナンス後
- 大規模なコード変更後
- 環境移行後
- パフォーマンス問題発生時

---

## 🛠️ 確認ツール一覧

本システムには3つの確認スクリプトが用意されています：

### 1. **初期データ登録確認スクリプト** (`verify-initial-data.js`)
**目的**: 期待される初期データが正しく登録されているかを確認

**実行方法**:
```bash
# Dockerコンテナ内で実行
docker exec websys_backend_dev node scripts/verify-initial-data.js

# または、バックエンドコンテナ内で直接実行
cd /app && node scripts/verify-initial-data.js
```

**確認項目**:
- 企業データの存在と内容
- ユーザーデータの存在と内容
- 機能データの存在と内容
- データ間の関連性

### 2. **データ整合性チェックスクリプト** (`data-integrity-check.js`)
**目的**: データベース全体の整合性を確認

**実行方法**:
```bash
docker exec websys_backend_dev node scripts/data-integrity-check.js
```

**確認項目**:
- 基本データの存在
- 外部キー整合性
- 一意制約の遵守
- 必須フィールドの充足
- ビジネスロジック整合性

### 3. **自動化テストスイート** (`automated-test-suite.js`)
**目的**: 包括的なシステム動作確認

**実行方法**:
```bash
docker exec websys_backend_dev node scripts/automated-test-suite.js
```

**確認項目**:
- 環境設定
- データベース接続
- 初期データ確認
- データ整合性
- API エンドポイント
- セキュリティ
- パフォーマンス

---

## 📋 標準確認手順

### Phase 1: 基本確認（所要時間: 5分）

1. **環境状況確認**
   ```bash
   # Dockerコンテナ状況確認
   docker ps

   # ヘルスチェック
   curl -X GET http://localhost:8000/health
   curl -X GET http://localhost:3000 -I
   ```

2. **初期データ登録確認**
   ```bash
   # 初期データ確認スクリプト実行
   docker exec websys_backend_dev node scripts/verify-initial-data.js
   ```

   **期待される結果**:
   ```
   🎉 初期データ確認完了: すべてのチェックが成功しました!
   ✅ システムは正常に初期化されています。
   ```

### Phase 2: 整合性確認（所要時間: 3分）

3. **データ整合性チェック**
   ```bash
   # データ整合性確認スクリプト実行
   docker exec websys_backend_dev node scripts/data-integrity-check.js
   ```

   **期待される結果**:
   ```
   🎉 データ整合性チェック完了: すべての整合性が確認されました!
   ✅ データベースは一貫性のある状態です。
   ```

### Phase 3: 包括的確認（所要時間: 10分）

4. **自動化テストスイート実行**
   ```bash
   # 包括的テスト実行
   docker exec websys_backend_dev node scripts/automated-test-suite.js
   ```

   **期待される結果**:
   ```
   🎉 自動化テストスイート完了: すべてのテストが成功しました!
   ✅ システムは正常に動作しており、初期データも適切に設定されています。
   ```

---

## ⚠️ 問題発生時の対応

### 初期データ問題の対応

**症状**: 初期データ確認で失敗が発生
```
❌ 企業数: 期待値=1, 実際=0
❌ admin.email: 期待値=admin@sample.co.jp, 実際=undefined
```

**対応手順**:
1. **データ再投入**
   ```bash
   # 初期データ再生成スクリプト実行
   docker exec websys_backend_dev node -e "
   const { PrismaClient } = require('@prisma/client');
   const bcrypt = require('bcryptjs');

   const prisma = new PrismaClient();

   async function reseedData() {
     // 既存データクリア
     await prisma.users.deleteMany({});
     await prisma.companies.deleteMany({});

     // 企業作成
     const company = await prisma.companies.create({
       data: {
         code: 'SAMPLE001',
         name: 'サンプル株式会社',
         industry: 'IT・ソフトウェア',
         updatedAt: new Date()
       }
     });

     // 管理者作成
     await prisma.users.create({
       data: {
         username: 'admin',
         companyId: company.id,
         email: 'admin@sample.co.jp',
         name: 'システム管理者',
         password: await bcrypt.hash('admin123', 10),
         role: 'ADMIN',
         isActive: true,
         updatedAt: new Date()
       }
     });

     await prisma.\$disconnect();
     console.log('✅ データ再投入完了');
   }

   reseedData();
   "
   ```

2. **再確認実行**
   ```bash
   docker exec websys_backend_dev node scripts/verify-initial-data.js
   ```

### データ整合性問題の対応

**症状**: 整合性チェックで警告や失敗が発生

**対応手順**:
1. **問題箇所の特定**
   - エラーメッセージから問題箇所を特定
   - 関連するテーブルやレコードを確認

2. **データ修正**
   ```bash
   # データベース直接確認
   docker exec websys_postgres_dev psql -U admin -d websys_db -c "
   SELECT * FROM users WHERE companyId IS NULL;
   SELECT * FROM companies WHERE isActive = false;
   "
   ```

3. **修正後の再確認**
   ```bash
   docker exec websys_backend_dev node scripts/data-integrity-check.js
   ```

### API エンドポイント問題の対応

**症状**: API テストで失敗が発生

**対応手順**:
1. **ログ確認**
   ```bash
   # バックエンドログ確認
   docker logs websys_backend_dev --tail=50

   # フロントエンドログ確認
   docker logs websys_frontend_dev --tail=50
   ```

2. **コンテナ再起動**
   ```bash
   # 問題のあるコンテナを再起動
   docker restart websys_backend_dev
   docker restart websys_frontend_dev
   ```

3. **再テスト実行**
   ```bash
   docker exec websys_backend_dev node scripts/automated-test-suite.js
   ```

---

## 📊 期待値設定

### 初期データ期待値

**企業データ**:
- 件数: 1社
- 企業コード: `SAMPLE001`
- 企業名: `サンプル株式会社`
- 業界: `IT・ソフトウェア`
- 契約プラン: `STANDARD`
- 状態: アクティブ

**ユーザーデータ**:
- 件数: 2名以上
- 管理者ユーザー:
  - ユーザー名: `admin`
  - メール: `admin@sample.co.jp`
  - 権限: `ADMIN`
  - 状態: アクティブ
- 一般ユーザー:
  - ユーザー名: `user01`
  - メール: `user01@sample.co.jp`
  - 権限: `USER`
  - 状態: アクティブ

**機能データ**:
- 件数: 5機能以上
- 必須機能:
  - `USER_MANAGEMENT`
  - `FEATURE_MANAGEMENT`
  - `LOG_MONITORING`
  - `PERMISSION_MANAGEMENT`
  - `DASHBOARD`

### パフォーマンス期待値

- **データベースクエリ**: 1秒以内
- **API レスポンス**: 3秒以内
- **メモリ使用量**: 100MB以内

---

## 🔄 定期確認スケジュール

### 日次確認（自動化推奨）
- 初期データ登録確認スクリプト実行
- ヘルスチェック API 確認

### 週次確認
- データ整合性チェック実行
- パフォーマンス監視

### 月次確認
- 自動化テストスイート全実行
- セキュリティチェック
- バックアップデータ整合性確認

---

## 📞 エスカレーション

### Level 1: 軽微な問題
- 初期データの軽微な不整合
- パフォーマンス警告
- **対応者**: システム管理者
- **対応時間**: 1時間以内

### Level 2: 中程度の問題
- データ整合性の問題
- API エンドポイントの一部失敗
- **対応者**: 開発チーム
- **対応時間**: 4時間以内

### Level 3: 重大な問題
- 初期データの完全失敗
- データベース接続不可
- セキュリティ問題
- **対応者**: 開発チーム + インフラチーム
- **対応時間**: 1時間以内

---

## 📝 記録とレポート

### 確認結果の記録

各確認実行時は以下を記録してください：

1. **実行日時**
2. **実行者**
3. **使用スクリプト**
4. **実行結果**（成功/失敗）
5. **問題が発生した場合の詳細**
6. **対応内容**
7. **再確認結果**

### レポート形式例

```markdown
## 初期データ確認レポート

**実行日時**: 2025-09-23 14:30:00
**実行者**: システム管理者
**確認種別**: 定期確認

### 実行結果
- ✅ 初期データ登録確認: 成功
- ✅ データ整合性チェック: 成功
- ✅ 自動化テストスイート: 成功

### 所要時間
- 総実行時間: 8.5秒

### 備考
- 全ての確認項目で問題なし
- システムは正常に動作中
```

---

## 🚀 自動化の推奨

### CI/CD パイプライン組み込み

```yaml
# GitHub Actions例
name: Data Verification
on:
  push:
    paths:
      - 'backend/prisma/**'
      - 'backend/src/services/**'

jobs:
  verify-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Start Docker Environment
        run: docker-compose up -d

      - name: Wait for Services
        run: sleep 30

      - name: Run Data Verification
        run: |
          docker exec websys_backend_dev node scripts/verify-initial-data.js
          docker exec websys_backend_dev node scripts/data-integrity-check.js
          docker exec websys_backend_dev node scripts/automated-test-suite.js
```

### 監視アラート設定

```bash
# cron設定例（日次確認）
# /etc/crontab
0 6 * * * root docker exec websys_backend_dev node scripts/verify-initial-data.js > /var/log/data-check.log 2>&1 || echo "Data verification failed" | mail -s "Alert" admin@company.com
```

---

## 📚 関連ドキュメント

- [システム概要](./01-システム概要.md)
- [開発ガイド](./03-開発ガイド.md)
- [トラブルシューティング](./06-トラブルシューティング.md)
- [API仕様書](./07-API仕様書.md)

---

**重要**: 本マニュアルに従って定期的な確認を実施することで、システムの信頼性と安定性を維持できます。問題が発生した場合は、速やかに対応し、必要に応じて開発チームにエスカレーションしてください。